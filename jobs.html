<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skysoft Job Market</title>
    <script src="https://cdn.jsdelivr.net/npm/ipfs/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dat-sdk@latest/dist/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p/dist/libp2p.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p-webrtc-star/dist/libp2p-webrtc-star.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p-bootstrap/dist/libp2p-bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p-mdns/dist/libp2p-mdns.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --border-radius: 5px;
            --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar styles */
        .sidebar {
            width: 250px;
            background-color: var(--dark-color);
            color: white;
            padding: 20px 0;
            transition: all 0.3s;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h3 {
            color: white;
            margin-bottom: 5px;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }

        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .menu-item i {
            margin-right: 10px;
        }

        .menu-item.active {
            background-color: var(--primary-color);
        }

        /* Main content styles */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
            transition: all 0.3s;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: white;
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--dark-color);
        }

        .user-profile {
            display: flex;
            align-items: center;
            position: relative;
            cursor: pointer;
        }

        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }

        .profile-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background-color: white;
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            width: 200px;
            display: none;
            z-index: 101;
        }

        .profile-dropdown.show {
            display: block;
        }

        .dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .dropdown-item:hover {
            background-color: #f5f5f5;
        }

        .dropdown-divider {
            height: 1px;
            background-color: #eee;
            margin: 5px 0;
        }

        .notification-bell {
            position: relative;
            margin-right: 20px;
            cursor: pointer;
        }

        .notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        /* Card styles */
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* Job card styles */
        .job-card {
            margin-bottom: 20px;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .job-header {
            background-color: var(--light-color);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .job-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--dark-color);
        }

        .company-name {
            color: var(--primary-color);
            font-weight: 500;
        }

        .blue-tick {
            color: var(--primary-color);
            margin-left: 5px;
        }

        .job-meta {
            display: flex;
            flex-wrap: wrap;
            margin-top: 5px;
            font-size: 0.9rem;
        }

        .meta-item {
            margin-right: 15px;
            display: flex;
            align-items: center;
        }

        .meta-item i {
            margin-right: 5px;
            color: var(--secondary-color);
        }

        .job-body {
            padding: 15px;
        }

        .job-description {
            margin-bottom: 15px;
        }

        .job-footer {
            padding: 10px 15px;
            background-color: #f9f9f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .deadline {
            color: var(--accent-color);
            font-weight: 500;
        }

        .job-actions button {
            margin-left: 10px;
        }

        /* Button styles */
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn i {
            margin-right: 5px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
        }

        /* Form styles */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: flex;
            margin: 0 -10px;
        }

        .form-col {
            flex: 1;
            padding: 0 10px;
        }

        /* Login/Signup page */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--light-color);
        }

        .auth-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 100%;
            max-width: 400px;
            padding: 30px;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--dark-color);
            margin-bottom: 10px;
        }

        .auth-subtitle {
            color: #777;
        }

        .auth-footer {
            text-align: center;
            margin-top: 20px;
            color: #777;
        }

        .auth-link {
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 500;
        }

        /* Alert styles */
        .alert {
            padding: 10px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .alert i {
            margin-right: 10px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
        }

        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
        }

        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        /* Broadcast message */
        .broadcast-message {
            background-color: var(--warning-color);
            color: white;
            padding: 10px 20px;
            text-align: center;
            position: fixed;
            top: 0;
            left: 250px;
            right: 0;
            z-index: 1001;
            display: none;
        }

        .broadcast-message.show {
            display: block;
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
                overflow: hidden;
            }
            
            .sidebar-header h3, .menu-item span {
                display: none;
            }
            
            .menu-item {
                justify-content: center;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            .broadcast-message {
                left: 70px;
            }
        }

        @media (max-width: 576px) {
            .sidebar {
                width: 0;
                position: fixed;
                z-index: 1000;
            }
            
            .sidebar.show {
                width: 250px;
            }
            
            .sidebar.show .sidebar-header h3, 
            .sidebar.show .menu-item span {
                display: block;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .menu-toggle {
                display: block;
            }
            
            .broadcast-message {
                left: 0;
            }
        }

        /* Additional utility classes */
        .text-center {
            text-align: center;
        }
        
        .text-muted {
            color: #777;
        }
        
        .mb-3 {
            margin-bottom: 15px;
        }
        
        .mt-3 {
            margin-top: 15px;
        }
        
        .d-flex {
            display: flex;
        }
        
        .align-items-center {
            align-items: center;
        }
        
        .justify-content-between {
            justify-content: space-between;
        }
        
        .w-100 {
            width: 100%;
        }
        
        .loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }
        
        .loading:after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* File upload styles */
        .file-upload {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .file-upload-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        /* Badge styles */
        .badge {
            display: inline-block;
            padding: 3px 7px;
            font-size: 0.75rem;
            font-weight: 500;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 10px;
        }
        
        .badge-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .badge-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .badge-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .badge-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        /* Interview room styles */
        .interview-room {
            display: flex;
            flex-direction: column;
            height: 80vh;
        }
        
        .video-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            flex: 1;
            margin-bottom: 10px;
        }
        
        .video-box {
            flex: 1 1 300px;
            min-height: 200px;
            background-color: #333;
            border-radius: var(--border-radius);
            position: relative;
        }
        
        .video-box video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--border-radius);
        }
        
        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8rem;
        }
        
        .interview-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: var(--border-radius);
        }
        
        .control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: white;
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn.end-call {
            background-color: var(--danger-color);
            color: white;
        }
        
        /* Application status styles */
        .status-pending {
            color: var(--warning-color);
        }
        
        .status-accepted {
            color: var(--success-color);
        }
        
        .status-rejected {
            color: var(--danger-color);
        }
        
        /* Online status indicator */
        .online-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .online {
            background-color: var(--success-color);
        }
        
        .offline {
            background-color: #ccc;
        }
        
        /* Nearby indicator */
        .nearby-badge {
            background-color: var(--primary-color);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.7rem;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <!-- Broadcast message -->
    <div class="broadcast-message" id="broadcastMessage">
        <span id="broadcastContent"></span>
    </div>

    <!-- Auth container (shown when not logged in) -->
    <div class="auth-container" id="authContainer">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-title">Skysoft Job Market</div>
                <div class="auth-subtitle" id="authSubtitle">Sign in to your account</div>
            </div>
            
            <div id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="loginUsername">Username or Phone</label>
                    <input type="text" class="form-control" id="loginUsername" placeholder="Enter your username or phone">
                </div>
                <div class="form-group">
                    <label class="form-label" for="loginPassword">Password</label>
                    <input type="password" class="form-control" id="loginPassword" placeholder="Enter your password">
                </div>
                <button class="btn btn-primary w-100" id="loginBtn">Sign In</button>
                
                <div class="auth-footer">
                    Don't have an account? <span class="auth-link" id="showSignup">Sign up</span>
                </div>
            </div>
            
            <div id="signupForm" style="display: none;">
                <div class="form-group">
                    <label class="form-label" for="signupFullName">Full Name</label>
                    <input type="text" class="form-control" id="signupFullName" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label class="form-label" for="signupUsername">Username</label>
                    <input type="text" class="form-control" id="signupUsername" placeholder="Choose a username">
                    <small class="text-muted" id="usernameAvailability"></small>
                </div>
                <div class="form-group">
                    <label class="form-label" for="signupEmail">Email</label>
                    <input type="email" class="form-control" id="signupEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label class="form-label" for="signupPhone">Phone Number</label>
                    <input type="tel" class="form-control" id="signupPhone" placeholder="Enter your phone number">
                </div>
                <div class="form-group">
                    <label class="form-label" for="signupPassword">Password</label>
                    <input type="password" class="form-control" id="signupPassword" placeholder="Create a password">
                </div>
                <div class="form-group">
                    <label class="form-label" for="signupConfirmPassword">Confirm Password</label>
                    <input type="password" class="form-control" id="signupConfirmPassword" placeholder="Confirm your password">
                </div>
                <div class="form-group">
                    <label class="form-label">Profile Picture</label>
                    <div class="file-upload">
                        <button class="btn btn-outline w-100" id="profileUploadBtn">
                            <i class="fas fa-upload"></i> Upload Photo
                        </button>
                        <input type="file" class="file-upload-input" id="profilePicture" accept="image/*">
                    </div>
                    <small class="text-muted">Max 2MB (JPEG, PNG)</small>
                </div>
                <button class="btn btn-primary w-100" id="signupBtn">Create Account</button>
                
                <div class="auth-footer">
                    Already have an account? <span class="auth-link" id="showLogin">Sign in</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main container (shown when logged in) -->
    <div class="container" id="mainContainer" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>Skysoft Job Market</h3>
                <div class="text-muted" id="sidebarSubtitle">Peer-to-Peer Network</div>
            </div>
            
            <div class="sidebar-menu">
                <div class="menu-item active" data-section="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </div>
                <div class="menu-item" data-section="jobs">
                    <i class="fas fa-briefcase"></i>
                    <span>Job Listings</span>
                </div>
                <div class="menu-item" data-section="postJob">
                    <i class="fas fa-plus-circle"></i>
                    <span>Post a Job</span>
                </div>
                <div class="menu-item" data-section="applications">
                    <i class="fas fa-file-alt"></i>
                    <span>My Applications</span>
                </div>
                <div class="menu-item" data-section="myJobs">
                    <i class="fas fa-list-ul"></i>
                    <span>My Job Posts</span>
                </div>
                <div class="menu-item" data-section="messages">
                    <i class="fas fa-envelope"></i>
                    <span>Messages</span>
                    <span class="badge badge-primary ml-auto" id="unreadCount">0</span>
                </div>
                <div class="menu-item" data-section="network">
                    <i class="fas fa-users"></i>
                    <span>Network</span>
                </div>
                <div class="menu-item" data-section="companies">
                    <i class="fas fa-building"></i>
                    <span>Companies</span>
                </div>
                <div class="menu-item admin-only" data-section="admin" style="display: none;">
                    <i class="fas fa-shield-alt"></i>
                    <span>Admin Panel</span>
                </div>
            </div>
        </div>
        
        <!-- Main content -->
        <div class="main-content">
            <div class="header">
                <div class="header-title" id="headerTitle">Dashboard</div>
                <div class="d-flex align-items-center">
                    <div class="notification-bell">
                        <i class="fas fa-bell"></i>
                        <span class="notification-count" id="notificationCount">0</span>
                    </div>
                    <div class="user-profile" id="userProfile">
                        <img src="" class="profile-pic" id="userProfilePic" alt="Profile">
                        <span id="userDisplayName">User</span>
                        <div class="profile-dropdown" id="profileDropdown">
                            <div class="dropdown-item" data-action="profile">
                                <i class="fas fa-user"></i> My Profile
                            </div>
                            <div class="dropdown-item" data-action="settings">
                                <i class="fas fa-cog"></i> Settings
                            </div>
                            <div class="dropdown-item admin-only" data-action="admin" style="display: none;">
                                <i class="fas fa-shield-alt"></i> Admin Panel
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-item" data-action="logout">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Dashboard section -->
            <div class="content-section" id="dashboardSection">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Welcome, <span id="welcomeName"></span></div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> You are connected to <span id="peerCount">0</span> peers in the network.
                        </div>
                        
                        <h4 class="mb-3">Recent Job Listings</h4>
                        <div id="recentJobs"></div>
                    </div>
                </div>
            </div>
            
            <!-- Job Listings section -->
            <div class="content-section" id="jobsSection" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Job Listings</div>
                        <div class="form-group" style="margin-bottom: 0; width: 300px;">
                            <input type="text" class="form-control" id="jobSearch" placeholder="Search jobs...">
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-row mb-3">
                            <div class="form-col">
                                <select class="form-control" id="jobCategoryFilter">
                                    <option value="">All Categories</option>
                                </select>
                            </div>
                            <div class="form-col">
                                <select class="form-control" id="jobLocationFilter">
                                    <option value="">All Locations</option>
                                </select>
                            </div>
                            <div class="form-col">
                                <select class="form-control" id="jobTypeFilter">
                                    <option value="">All Types</option>
                                    <option value="full-time">Full-time</option>
                                    <option value="part-time">Part-time</option>
                                    <option value="contract">Contract</option>
                                    <option value="internship">Internship</option>
                                    <option value="remote">Remote</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="jobListings"></div>
                    </div>
                </div>
            </div>
            
            <!-- Post Job section -->
            <div class="content-section" id="postJobSection" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Post a Job</div>
                    </div>
                    <div class="card-body">
                        <form id="postJobForm">
                            <div class="form-group">
                                <label class="form-label" for="jobTitle">Job Title *</label>
                                <input type="text" class="form-control" id="jobTitle" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="jobCategory">Category *</label>
                                        <select class="form-control" id="jobCategory" required>
                                            <option value="">Select a category</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="jobType">Job Type *</label>
                                        <select class="form-control" id="jobType" required>
                                            <option value="">Select type</option>
                                            <option value="full-time">Full-time</option>
                                            <option value="part-time">Part-time</option>
                                            <option value="contract">Contract</option>
                                            <option value="internship">Internship</option>
                                            <option value="remote">Remote</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="jobCompany">Company *</label>
                                <select class="form-control" id="jobCompany" required>
                                    <option value="">Select a company</option>
                                    <option value="add-new">+ Add New Company</option>
                                </select>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="jobPositions">Number of Positions *</label>
                                        <input type="number" class="form-control" id="jobPositions" min="1" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="jobDeadline">Application Deadline *</label>
                                        <input type="date" class="form-control" id="jobDeadline" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="jobLocation">Location *</label>
                                <input type="text" class="form-control" id="jobLocation" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="jobSalaryFrom">Salary From</label>
                                        <input type="number" class="form-control" id="jobSalaryFrom" placeholder="Minimum">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="jobSalaryTo">Salary To</label>
                                        <input type="number" class="form-control" id="jobSalaryTo" placeholder="Maximum">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="jobSalaryCurrency">Currency</label>
                                        <select class="form-control" id="jobSalaryCurrency">
                                            <option value="UGX">UGX</option>
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                            <option value="GBP">GBP</option>
                                            <option value="KES">KES</option>
                                            <option value="TZS">TZS</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="jobDescription">Job Description *</label>
                                <textarea class="form-control" id="jobDescription" rows="5" required></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Job Image (Optional)</label>
                                <div class="file-upload">
                                    <button class="btn btn-outline w-100" id="jobImageUploadBtn">
                                        <i class="fas fa-upload"></i> Upload Image
                                    </button>
                                    <input type="file" class="file-upload-input" id="jobImage" accept="image/*">
                                </div>
                                <small class="text-muted">Max 2MB (JPEG, PNG)</small>
                                <div id="jobImagePreview" class="mt-2" style="display: none;">
                                    <img src="" alt="Job Image Preview" style="max-width: 200px; max-height: 150px;">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="allowComments" checked>
                                    <label class="form-check-label" for="allowComments">Allow comments and reactions</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="allowPrivateMessages" checked>
                                    <label class="form-check-label" for="allowPrivateMessages">Allow private messages from applicants</label>
                                </div>
                            </div>
                            
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i> This job is free to apply! No one should ask for money. If asked for money report the job immediately.
                            </div>
                            
                            <button type="submit" class="btn btn-primary" id="postJobBtn">Post Job</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- My Applications section -->
            <div class="content-section" id="applicationsSection" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">My Job Applications</div>
                    </div>
                    <div class="card-body">
                        <div id="myApplications">
                            <p>You haven't applied to any jobs yet.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- My Job Posts section -->
            <div class="content-section" id="myJobsSection" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">My Job Posts</div>
                    </div>
                    <div class="card-body">
                        <div id="myJobPosts">
                            <p>You haven't posted any jobs yet.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Messages section -->
            <div class="content-section" id="messagesSection" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Messages</div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="list-group" id="messageContacts">
                                    <!-- Contacts list will be populated here -->
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="chat-container" id="chatContainer" style="display: none;">
                                    <div class="chat-header">
                                        <h5 id="chatRecipientName"></h5>
                                    </div>
                                    <div class="chat-messages" id="chatMessages"></div>
                                    <div class="chat-input">
                                        <textarea class="form-control" id="messageInput" placeholder="Type your message..."></textarea>
                                        <button class="btn btn-primary" id="sendMessageBtn">Send</button>
                                    </div>
                                </div>
                                <div id="noChatSelected" style="text-align: center; padding: 20px;">
                                    <p>Select a contact to start chatting</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Network section -->
            <div class="content-section" id="networkSection" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Network</div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <input type="text" class="form-control" id="networkSearch" placeholder="Search members...">
                        </div>
                        
                        <div id="networkMembers">
                            <!-- Members list will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Companies section -->
            <div class="content-section" id="companiesSection" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Companies</div>
                        <button class="btn btn-primary" id="addCompanyBtn">Add Company</button>
                    </div>
                    <div class="card-body">
                        <div id="companiesList">
                            <!-- Companies list will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Admin section -->
            <div class="content-section" id="adminSection" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Admin Panel</div>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="adminTabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-toggle="tab" href="#adminUsers">Users</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#adminReports">Reports</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#adminBlueTicks">Blue Tick Requests</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#adminSettings">Settings</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#adminBroadcast">Broadcast</a>
                            </li>
                        </ul>
                        
                        <div class="tab-content">
                            <div class="tab-pane active" id="adminUsers">
                                <div class="mt-3">
                                    <div class="form-group">
                                        <input type="text" class="form-control" id="adminUserSearch" placeholder="Search users...">
                                    </div>
                                    
                                    <div id="adminUsersList">
                                        <!-- Users list will be populated here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-pane" id="adminReports">
                                <div class="mt-3">
                                    <div id="adminReportsList">
                                        <!-- Reports list will be populated here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-pane" id="adminBlueTicks">
                                <div class="mt-3">
                                    <div id="adminBlueTicksList">
                                        <!-- Blue tick requests will be populated here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-pane" id="adminSettings">
                                <div class="mt-3">
                                    <form id="adminSettingsForm">
                                        <div class="form-group">
                                            <label class="form-label">App Title</label>
                                            <input type="text" class="form-control" id="appTitle" value="Skysoft Job Market">
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label">System Email</label>
                                            <input type="email" class="form-control" id="systemEmail" placeholder="Enter system email">
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label">Inactivity Timeout (minutes)</label>
                                            <input type="number" class="form-control" id="inactivityTimeout" value="30" min="1">
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label">Default Currency</label>
                                            <select class="form-control" id="defaultCurrency">
                                                <option value="UGX">UGX - Ugandan Shilling</option>
                                                <option value="USD">USD - US Dollar</option>
                                                <option value="EUR">EUR - Euro</option>
                                                <option value="GBP">GBP - British Pound</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label">Admin Inheritance</label>
                                            <div class="alert alert-info">
                                                Set the order of admin inheritance if you're inactive for 6 months.
                                            </div>
                                            <div id="adminInheritanceList">
                                                <!-- Inheritance list will be populated here -->
                                            </div>
                                            <button type="button" class="btn btn-outline mt-2" id="addInheritanceBtn">Add Successor</button>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary">Save Settings</button>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="tab-pane" id="adminBroadcast">
                                <div class="mt-3">
                                    <form id="broadcastForm">
                                        <div class="form-group">
                                            <label class="form-label">Message Type</label>
                                            <select class="form-control" id="broadcastType">
                                                <option value="info">Information</option>
                                                <option value="warning">Warning</option>
                                                <option value="alert">Alert</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label">Message</label>
                                            <textarea class="form-control" id="broadcastMessage" rows="3" required></textarea>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary">Send Broadcast</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Edit Profile</div>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="profileForm">
                    <div class="form-group">
                        <label class="form-label">Profile Picture</label>
                        <div class="file-upload">
                            <button class="btn btn-outline w-100" id="profilePictureUploadBtn">
                                <i class="fas fa-upload"></i> Upload Photo
                            </button>
                            <input type="file" class="file-upload-input" id="profilePictureInput" accept="image/*">
                        </div>
                        <div class="mt-2 text-center">
                            <img src="" alt="Profile Picture" id="profilePicturePreview" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="editFullName">Full Name *</label>
                        <input type="text" class="form-control" id="editFullName" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="editUsername">Username *</label>
                        <input type="text" class="form-control" id="editUsername" required>
                        <small class="text-muted" id="editUsernameAvailability"></small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="editEmail">Email *</label>
                        <input type="email" class="form-control" id="editEmail" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="editPhone">Phone Number *</label>
                        <input type="tel" class="form-control" id="editPhone" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="editProfession">Profession</label>
                        <input type="text" class="form-control" id="editProfession">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="editJobTitle">Job Title</label>
                        <input type="text" class="form-control" id="editJobTitle">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="editWorkplace">Place of Work</label>
                        <input type="text" class="form-control" id="editWorkplace">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="editLocation">Location</label>
                        <input type="text" class="form-control" id="editLocation">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="editBio">Bio</label>
                        <textarea class="form-control" id="editBio" rows="3"></textarea>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" id="cancelProfileEdit">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Change Password</div>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="passwordForm">
                    <div class="form-group">
                        <label class="form-label" for="currentPassword">Current Password *</label>
                        <input type="password" class="form-control" id="currentPassword" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="newPassword">New Password *</label>
                        <input type="password" class="form-control" id="newPassword" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="confirmPassword">Confirm New Password *</label>
                        <input type="password" class="form-control" id="confirmPassword" required>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" id="cancelPasswordChange">Cancel</button>
                        <button type="submit" class="btn btn-primary">Change Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Company Modal -->
    <div class="modal" id="companyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="companyModalTitle">Add Company</div>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="companyForm">
                    <input type="hidden" id="companyId">
                    
                    <div class="form-group">
                        <label class="form-label" for="companyName">Company Name *</label>
                        <input type="text" class="form-control" id="companyName" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="companyDescription">Description</label>
                        <textarea class="form-control" id="companyDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="companyWebsite">Website</label>
                        <input type="url" class="form-control" id="companyWebsite">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="companyLogo">Logo</label>
                        <div class="file-upload">
                            <button class="btn btn-outline w-100" id="companyLogoUploadBtn">
                                <i class="fas fa-upload"></i> Upload Logo
                            </button>
                            <input type="file" class="file-upload-input" id="companyLogoInput" accept="image/*">
                        </div>
                        <div class="mt-2 text-center">
                            <img src="" alt="Company Logo" id="companyLogoPreview" style="max-width: 200px; max-height: 100px; display: none;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="companyLocation">Location</label>
                        <input type="text" class="form-control" id="companyLocation">
                    </div>
                    
                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="requestBlueTick">
                            <label class="form-check-label" for="requestBlueTick">Request Blue Tick Verification</label>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" id="cancelCompanyEdit">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Company</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Job Application Modal -->
    <div class="modal" id="applicationModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Apply for <span id="applicationJobTitle"></span></div>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="applicationForm">
                    <input type="hidden" id="applicationJobId">
                    
                    <div class="form-group">
                        <label class="form-label" for="applicantName">Full Name *</label>
                        <input type="text" class="form-control" id="applicantName" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="applicantAge">Age *</label>
                                <input type="number" class="form-control" id="applicantAge" min="18" max="99" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="applicantGender">Gender *</label>
                                <select class="form-control" id="applicantGender" required>
                                    <option value="">Select</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                    <option value="prefer-not-to-say">Prefer not to say</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="applicantLocation">Current Location *</label>
                        <input type="text" class="form-control" id="applicantLocation" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="applicantExperience">Years of Experience *</label>
                        <input type="number" class="form-control" id="applicantExperience" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="applicantQualifications">Qualifications *</label>
                        <textarea class="form-control" id="applicantQualifications" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="applicantSkills">Skills *</label>
                        <textarea class="form-control" id="applicantSkills" rows="3" required></textarea>
                        <small class="text-muted">List your skills separated by commas</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Portrait Photo *</label>
                        <div class="file-upload">
                            <button class="btn btn-outline w-100" id="applicantPhotoUploadBtn">
                                <i class="fas fa-upload"></i> Upload Photo
                            </button>
                            <input type="file" class="file-upload-input" id="applicantPhoto" accept="image/*" required>
                        </div>
                        <small class="text-muted">Max 2MB (JPEG, PNG)</small>
                        <div id="applicantPhotoPreview" class="mt-2" style="display: none;">
                            <img src="" alt="Applicant Photo Preview" style="max-width: 150px; max-height: 150px;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">CV/Resume *</label>
                        <div class="file-upload">
                            <button class="btn btn-outline w-100" id="applicantCvUploadBtn">
                                <i class="fas fa-upload"></i> Upload CV
                            </button>
                            <input type="file" class="file-upload-input" id="applicantCv" accept=".pdf,.doc,.docx" required>
                        </div>
                        <small class="text-muted">Max 5MB (PDF, DOC, DOCX)</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="applicantCoverLetter">Cover Letter (Optional)</label>
                        <textarea class="form-control" id="applicantCoverLetter" rows="5"></textarea>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" id="cancelApplication">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit Application</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Job Details Modal -->
    <div class="modal" id="jobDetailsModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title" id="jobDetailsTitle"></div>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-4">
                            <h4 id="jobDetailsCompany"></h4>
                            <div class="text-muted mb-2" id="jobDetailsMeta"></div>
                            <div class="mb-3" id="jobDetailsDescription"></div>
                            
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i> This job is free to apply! No one should ask for money. If asked for money report the job immediately.
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h5>About the Company</h5>
                            <div id="jobDetailsAboutCompany"></div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Job Overview</h5>
                                
                                <div class="mb-3">
                                    <strong>Posted on:</strong>
                                    <span id="jobDetailsPostedDate"></span>
                                </div>
                                
                                <div class="mb-3">
                                    <strong>Deadline:</strong>
                                    <span id="jobDetailsDeadline"></span>
                                </div>
                                
                                <div class="mb-3">
                                    <strong>Location:</strong>
                                    <span id="jobDetailsLocation"></span>
                                </div>
                                
                                <div class="mb-3">
                                    <strong>Job Type:</strong>
                                    <span id="jobDetailsType"></span>
                                </div>
                                
                                <div class="mb-3">
                                    <strong>Positions:</strong>
                                    <span id="jobDetailsPositions"></span>
                                </div>
                                
                                <div class="mb-3">
                                    <strong>Salary:</strong>
                                    <span id="jobDetailsSalary"></span>
                                </div>
                                
                                <div class="text-center mt-4">
                                    <button class="btn btn-primary w-100" id="applyNowBtn">Apply Now</button>
                                    <button class="btn btn-outline w-100 mt-2" id="saveJobBtn">Save Job</button>
                                    <button class="btn btn-outline w-100 mt-2" id="reportJobBtn">Report Job</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4" id="jobCommentsSection" style="display: none;">
                    <h5>Comments</h5>
                    <div id="jobComments"></div>
                    
                    <div class="mt-3">
                        <textarea class="form-control" id="jobCommentInput" placeholder="Add a comment..."></textarea>
                        <button class="btn btn-primary mt-2" id="postCommentBtn">Post Comment</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Job Modal -->
    <div class="modal" id="reportModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Report Job</div>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="reportForm">
                    <input type="hidden" id="reportJobId">
                    
                    <div class="form-group">
                        <label class="form-label" for="reportReason">Reason for Reporting *</label>
                        <select class="form-control" id="reportReason" required>
                            <option value="">Select a reason</option>
                            <option value="fraud">Fraudulent Activity</option>
                            <option value="money">Asking for Money</option>
                            <option value="fake">Fake Job Posting</option>
                            <option value="discrimination">Discriminatory Content</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="otherReasonGroup" style="display: none;">
                        <label class="form-label" for="reportOtherReason">Please specify *</label>
                        <input type="text" class="form-control" id="reportOtherReason">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="reportDetails">Details *</label>
                        <textarea class="form-control" id="reportDetails" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Evidence (Optional)</label>
                        <div class="file-upload">
                            <button class="btn btn-outline w-100" id="reportEvidenceUploadBtn">
                                <i class="fas fa-upload"></i> Upload Screenshots/Audio
                            </button>
                            <input type="file" class="file-upload-input" id="reportEvidence" accept="image/*,audio/*" multiple>
                        </div>
                        <small class="text-muted">Max 5MB per file (JPEG, PNG, MP3)</small>
                        <div id="reportEvidencePreview" class="mt-2"></div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" id="cancelReport">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit Report</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Interview Modal -->
    <div class="modal" id="interviewModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">Schedule Interview</div>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="interviewForm">
                    <input type="hidden" id="interviewApplicationId">
                    
                    <div class="form-group">
                        <label class="form-label" for="interviewDate">Date *</label>
                        <input type="date" class="form-control" id="interviewDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="interviewTime">Time *</label>
                        <input type="time" class="form-control" id="interviewTime" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="interviewType">Type *</label>
                        <select class="form-control" id="interviewType" required>
                            <option value="">Select type</option>
                            <option value="in-person">In-Person</option>
                            <option value="online">Online</option>
                            <option value="phone">Phone Call</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="interviewLocationGroup">
                        <label class="form-label" for="interviewLocation">Location *</label>
                        <input type="text" class="form-control" id="interviewLocation">
                    </div>
                    
                    <div class="form-group" id="interviewLinkGroup" style="display: none;">
                        <label class="form-label" for="interviewLink">Meeting Link *</label>
                        <input type="url" class="form-control" id="interviewLink" placeholder="https://">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="interviewNotes">Notes for Candidate</label>
                        <textarea class="form-control" id="interviewNotes" rows="3"></textarea>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" id="cancelInterview">Cancel</button>
                        <button type="submit" class="btn btn-primary">Schedule Interview</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Interview Room Modal -->
    <div class="modal" id="interviewRoomModal">
        <div class="modal-content" style="max-width: 1000px; width: 95%;">
            <div class="modal-header">
                <div class="modal-title">Interview Room - <span id="interviewRoomTitle"></span></div>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="interview-room">
                    <div class="video-container" id="videoContainer">
                        <div class="video-box">
                            <video id="localVideo" autoplay muted></video>
                            <div class="video-label">You</div>
                        </div>
                        <div class="video-box">
                            <video id="remoteVideo" autoplay></video>
                            <div class="video-label" id="remoteParticipantName"></div>
                        </div>
                    </div>
                    
                    <div class="interview-controls">
                        <button class="control-btn" id="toggleVideoBtn">
                            <i class="fas fa-video"></i>
                        </button>
                        <button class="control-btn" id="toggleAudioBtn">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="control-btn" id="screenShareBtn">
                            <i class="fas fa-desktop"></i>
                        </button>
                        <button class="control-btn end-call" id="endCallBtn">
                            <i class="fas fa-phone-slash"></i>
                        </button>
                    </div>
                    
                    <div class="mt-3">
                        <h5>Interview Notes</h5>
                        <textarea class="form-control" id="interviewRoomNotes" rows="3" placeholder="Take notes during the interview..."></textarea>
                        <button class="btn btn-primary mt-2" id="saveInterviewNotesBtn">Save Notes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Details Modal -->
    <div class="modal" id="applicationDetailsModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">Application Details</div>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <h4 id="applicationJobTitleDetails"></h4>
                    <div class="text-muted mb-2" id="applicationCompanyDetails"></div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <strong>Applicant:</strong>
                            <span id="applicationApplicantName"></span>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Age:</strong>
                            <span id="applicationApplicantAge"></span>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Gender:</strong>
                            <span id="applicationApplicantGender"></span>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Location:</strong>
                            <span id="applicationApplicantLocation"></span>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Experience:</strong>
                            <span id="applicationApplicantExperience"></span> years
                        </div>
                    </div>
                    
                    <div class="col-md-6 text-center">
                        <img src="" alt="Applicant Photo" id="applicationApplicantPhoto" style="max-width: 150px; max-height: 150px; border-radius: 5px; margin-bottom: 10px;">
                        <div>
                            <a href="#" class="btn btn-outline" id="viewApplicantCv">View CV</a>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h5>Qualifications</h5>
                    <div id="applicationApplicantQualifications"></div>
                </div>
                
                <div class="mt-3">
                    <h5>Skills</h5>
                    <div id="applicationApplicantSkills"></div>
                </div>
                
                <div class="mt-3">
                    <h5>Cover Letter</h5>
                    <div id="applicationApplicantCoverLetter"></div>
                </div>
                
                <div class="mt-3">
                    <h5>Status: <span id="applicationStatusBadge"></span></h5>
                    <div id="applicationStatusDetails"></div>
                </div>
                
                <div class="mt-4" id="applicationActions">
                    <!-- Actions will be populated based on user role and application status -->
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Settings</div>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="settingsTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-toggle="tab" href="#accountSettings">Account</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#notificationSettings">Notifications</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#privacySettings">Privacy</a>
                    </li>
                </ul>
                
                <div class="tab-content mt-3">
                    <div class="tab-pane active" id="accountSettings">
                        <div class="form-group">
                            <label class="form-label">Default Currency</label>
                            <select class="form-control" id="userCurrency">
                                <option value="UGX">UGX - Ugandan Shilling</option>
                                <option value="USD">USD - US Dollar</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="GBP">GBP - British Pound</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Location Sharing</label>
                            <select class="form-control" id="locationSharing">
                                <option value="enabled">Enabled</option>
                                <option value="disabled">Disabled</option>
                            </select>
                            <small class="text-muted">Allow the system to detect and share your location for better job matching</small>
                        </div>
                        
                        <button class="btn btn-primary" id="saveAccountSettings">Save Settings</button>
                    </div>
                    
                    <div class="tab-pane" id="notificationSettings">
                        <div class="form-group">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="notifyNewJobs" checked>
                                <label class="form-check-label" for="notifyNewJobs">New job postings</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="notifyApplicationUpdates" checked>
                                <label class="form-check-label" for="notifyApplicationUpdates">Application updates</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="notifyMessages" checked>
                                <label class="form-check-label" for="notifyMessages">New messages</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="notifyBroadcasts" checked>
                                <label class="form-check-label" for="notifyBroadcasts">Broadcast messages</label>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" id="saveNotificationSettings">Save Settings</button>
                    </div>
                    
                    <div class="tab-pane" id="privacySettings">
                        <div class="form-group">
                            <label class="form-label">Profile Visibility</label>
                            <select class="form-control" id="profileVisibility">
                                <option value="public">Public</option>
                                <option value="network">Only to Network</option>
                                <option value="private">Private</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Who can message you</label>
                            <select class="form-control" id="messagePrivacy">
                                <option value="anyone">Anyone</option>
                                <option value="network">Only people in your network</option>
                                <option value="none">No one</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="showOnlineStatus" checked>
                                <label class="form-check-label" for="showOnlineStatus">Show when I'm online</label>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" id="savePrivacySettings">Save Settings</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 9999;">
        <div style="background-color: white; padding: 20px; border-radius: 5px; text-align: center;">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <p class="mt-2" id="loadingText">Initializing application...</p>
        </div>
    </div>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <script>
        // Main application class
        class SkysoftJobMarket {
            constructor() {
                this.db = null;
                this.ipfs = null;
                this.dat = null;
                this.libp2p = null;
                this.peerId = null;
                this.currentUser = null;
                this.isAdmin = false;
                this.peers = new Map();
                this.initialized = false;
                this.inactivityTimeout = 30 * 60 * 1000; // 30 minutes
                this.inactivityTimer = null;
                this.onlineStatus = true;
                
                // Initialize the application
                this.init();
            }
            
            async init() {
                try {
                    // Show loading overlay
                    this.showLoading("Initializing databases...");
                    
                    // Initialize IndexedDB
                    await this.initDatabases();
                    
                    // Initialize P2P network
                    await this.initNetwork();
                    
                    // Check if user is logged in
                    await this.checkAuthState();
                    
                    // Initialize UI
                    this.initUI();
                    
                    // Set up event listeners
                    this.setupEventListeners();
                    
                    // Start inactivity timer
                    this.resetInactivityTimer();
                    
                    // Hide loading overlay
                    this.hideLoading();
                    
                    this.initialized = true;
                    
                    console.log("Skysoft Job Market initialized successfully");
                } catch (error) {
                    console.error("Initialization error:", error);
                    this.showError("Failed to initialize application. Please refresh the page.");
                }
            }
            
            async initDatabases() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open("SkysoftJobMarketDB", 1);
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        // Create users store
                        if (!db.objectStoreNames.contains('users')) {
                            const usersStore = db.createObjectStore('users', { keyPath: 'id' });
                            usersStore.createIndex('username', 'username', { unique: true });
                            usersStore.createIndex('email', 'email', { unique: true });
                            usersStore.createIndex('phone', 'phone', { unique: true });
                        }
                        
                        // Create jobs store
                        if (!db.objectStoreNames.contains('jobs')) {
                            const jobsStore = db.createObjectStore('jobs', { keyPath: 'id' });
                            jobsStore.createIndex('posterId', 'posterId');
                            jobsStore.createIndex('company', 'company');
                            jobsStore.createIndex('category', 'category');
                            jobsStore.createIndex('location', 'location');
                            jobsStore.createIndex('deadline', 'deadline');
                        }
                        
                        // Create applications store
                        if (!db.objectStoreNames.contains('applications')) {
                            const appsStore = db.createObjectStore('applications', { keyPath: 'id' });
                            appsStore.createIndex('jobId', 'jobId');
                            appsStore.createIndex('applicantId', 'applicantId');
                            appsStore.createIndex('status', 'status');
                        }
                        
                        // Create companies store
                        if (!db.objectStoreNames.contains('companies')) {
                            const companiesStore = db.createObjectStore('companies', { keyPath: 'id' });
                            companiesStore.createIndex('ownerId', 'ownerId');
                            companiesStore.createIndex('name', 'name', { unique: true });
                        }
                        
                        // Create messages store
                        if (!db.objectStoreNames.contains('messages')) {
                            const messagesStore = db.createObjectStore('messages', { keyPath: 'id' });
                            messagesStore.createIndex('senderId', 'senderId');
                            messagesStore.createIndex('receiverId', 'receiverId');
                            messagesStore.createIndex('timestamp', 'timestamp');
                        }
                        
                        // Create reports store
                        if (!db.objectStoreNames.contains('reports')) {
                            const reportsStore = db.createObjectStore('reports', { keyPath: 'id' });
                            reportsStore.createIndex('jobId', 'jobId');
                            reportsStore.createIndex('reporterId', 'reporterId');
                            reportsStore.createIndex('status', 'status');
                        }
                        
                        // Create blue tick requests store
                        if (!db.objectStoreNames.contains('blueTickRequests')) {
                            const btStore = db.createObjectStore('blueTickRequests', { keyPath: 'id' });
                            btStore.createIndex('userId', 'userId');
                            btStore.createIndex('companyId', 'companyId');
                            btStore.createIndex('status', 'status');
                        }
                        
                        // Create notifications store
                        if (!db.objectStoreNames.contains('notifications')) {
                            const notifStore = db.createObjectStore('notifications', { keyPath: 'id' });
                            notifStore.createIndex('userId', 'userId');
                            notifStore.createIndex('read', 'read');
                        }
                        
                        // Create activity log store
                        if (!db.objectStoreNames.contains('activityLog')) {
                            const activityStore = db.createObjectStore('activityLog', { keyPath: 'id' });
                            activityStore.createIndex('userId', 'userId');
                            activityStore.createIndex('timestamp', 'timestamp');
                        }
                        
                        // Create settings store
                        if (!db.objectStoreNames.contains('settings')) {
                            const settingsStore = db.createObjectStore('settings', { keyPath: 'key' });
                        }
                        
                        console.log("Database schema created/upgraded");
                    };
                    
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        console.log("Database initialized successfully");
                        resolve();
                    };
                    
                    request.onerror = (event) => {
                        console.error("Database error:", event.target.error);
                        reject(new Error("Failed to initialize database"));
                    };
                });
            }
            
            async initNetwork() {
                try {
                    // Initialize IPFS
                    this.ipfs = await Ipfs.create({
                        repo: 'skysoft-job-market-ipfs',
                        config: {
                            Addresses: {
                                Swarm: [
                                    '/dns4/wrtc-star1.par.dwebops.pub/tcp/443/wss/p2p-webrtc-star',
                                    '/dns4/wrtc-star2.sjc.dwebops.pub/tcp/443/wss/p2p-webrtc-star'
                                ]
                            },
                            Bootstrap: [
                                '/dns4/bootstrap.libp2p.io/tcp/443/wss/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN',
                                '/dns4/ipfs.io/tcp/443/wss/p2p/QmQZv6pFzH6hZqZzJQZv6pFzH6hZqZzJQZv6pFzH6hZqZzJQZv6pFzH6hZqZzJQ'
                            ]
                        }
                    });
                    
                    console.log("IPFS initialized");
                    
                    // Initialize DAT
                    this.dat = await DatSdk.create({
                        persist: true,
                        storage: await DatSdk.storage('indexeddb')
                    });
                    
                    console.log("DAT initialized");
                    
                    // Initialize libp2p
                    this.libp2p = await Libp2p.create({
                        modules: {
                            transport: [WebrtcStar],
                            peerDiscovery: [Bootstrap, MulticastDNS],
                            // Add other modules as needed
                        },
                        config: {
                            peerDiscovery: {
                                bootstrap: {
                                    interval: 60e3,
                                    enabled: true,
                                    list: [
                                        '/dns4/bootstrap.libp2p.io/tcp/443/wss/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN',
                                        '/dns4/ipfs.io/tcp/443/wss/p2p/QmQZv6pFzH6hZqZzJQZv6pFzH6hZqZzJQZv6pFzH6hZqZzJQZv6pFzH6hZqZzJQ'
                                    ]
                                },
                                multicastDNS: {
                                    interval: 1e3,
                                    enabled: true
                                }
                            }
                        }
                    });
                    
                    await this.libp2p.start();
                    this.peerId = this.libp2p.peerId;
                    
                    console.log("libp2p initialized with peer ID:", this.peerId.toB58String());
                    
                    // Set up network event listeners
                    this.setupNetworkListeners();
                    
                    // Start peer discovery
                    this.discoverPeers();
                    
                } catch (error) {
                    console.error("Network initialization error:", error);
                    throw new Error("Failed to initialize P2P network");
                }
            }
            
            setupNetworkListeners() {
                // IPFS event listeners
                this.ipfs.libp2p.connectionManager.on('peer:connect', (connection) => {
                    const peerId = connection.remotePeer.toB58String();
                    console.log(`Connected to peer: ${peerId}`);
                    this.peers.set(peerId, { connected: true, lastSeen: Date.now() });
                    this.updatePeerList();
                });
                
                this.ipfs.libp2p.connectionManager.on('peer:disconnect', (connection) => {
                    const peerId = connection.remotePeer.toB58String();
                    console.log(`Disconnected from peer: ${peerId}`);
                    if (this.peers.has(peerId)) {
                        this.peers.set(peerId, { ...this.peers.get(peerId), connected: false });
                        this.updatePeerList();
                    }
                });
                
                // DAT event listeners
                this.dat.on('join', (name) => {
                    console.log(`Joined DAT network: ${name}`);
                });
                
                this.dat.on('peer-add', (peer) => {
                    console.log(`New DAT peer: ${peer}`);
                });
                
                // libp2p event listeners
                this.libp2p.on('peer:discovery', (peerId) => {
                    console.log(`Discovered peer: ${peerId.toB58String()}`);
                });
                
                // Set up pubsub for real-time updates
                this.ipfs.pubsub.subscribe('skysoft-job-market', (msg) => {
                    this.handlePubSubMessage(msg);
                });
            }
            
            async discoverPeers() {
                try {
                    // Bootstrap peers
                    await this.libp2p.peerStore.addressBook.add(this.libp2p.peerId, this.libp2p.multiaddrs);
                    
                    // Multicast DNS discovery
                    this.libp2p.peerDiscovery.on('peer', (peerId) => {
                        console.log(`Discovered peer via mDNS: ${peerId.toB58String()}`);
                        this.connectToPeer(peerId);
                    });
                    
                    console.log("Peer discovery started");
                } catch (error) {
                    console.error("Peer discovery error:", error);
                }
            }
            
            async connectToPeer(peerId) {
                try {
                    if (!this.peers.has(peerId.toB58String())) {
                        await this.libp2p.dial(peerId);
                        this.peers.set(peerId.toB58String(), { connected: true, lastSeen: Date.now() });
                        this.updatePeerList();
                    }
                } catch (error) {
                    console.error(`Failed to connect to peer ${peerId.toB58String()}:`, error);
                }
            }
            
            updatePeerList() {
                if (!this.currentUser) return;
                
                const peerCount = Array.from(this.peers.values()).filter(p => p.connected).length;
                document.getElementById('peerCount').textContent = peerCount;
                
                // Update network section if visible
                if (document.getElementById('networkSection').style.display === 'block') {
                    this.renderNetworkMembers();
                }
            }
            
            async handlePubSubMessage(msg) {
                try {
                    const data = JSON.parse(new TextDecoder().decode(msg.data));
                    console.log("Received pubsub message:", data);
                    
                    if (data.type === 'job') {
                        await this.syncJob(data.job);
                    } else if (data.type === 'application') {
                        await this.syncApplication(data.application);
                    } else if (data.type === 'message') {
                        await this.syncMessage(data.message);
                    } else if (data.type === 'report') {
                        await this.syncReport(data.report);
                    } else if (data.type === 'broadcast') {
                        this.showBroadcastMessage(data.message, data.messageType);
                    } else if (data.type === 'user') {
                        await this.syncUser(data.user);
                    } else if (data.type === 'company') {
                        await this.syncCompany(data.company);
                    }
                } catch (error) {
                    console.error("Error handling pubsub message:", error);
                }
            }
            
            async broadcastData(type, data) {
                try {
                    const message = {
                        type,
                        [type]: data,
                        timestamp: Date.now(),
                        sender: this.peerId.toB58String()
                    };
                    
                    await this.ipfs.pubsub.publish('skysoft-job-market', new TextEncoder().encode(JSON.stringify(message)));
                    console.log(`Broadcasted ${type} data`);
                } catch (error) {
                    console.error(`Error broadcasting ${type} data:`, error);
                }
            }
            
            async syncJob(job) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['jobs'], 'readwrite');
                    const store = transaction.objectStore('jobs');
                    
                    const request = store.get(job.id);
                    
                    request.onsuccess = (event) => {
                        const existingJob = event.target.result;
                        
                        if (!existingJob || job.updatedAt > existingJob.updatedAt) {
                            const putRequest = store.put(job);
                            
                            putRequest.onsuccess = () => {
                                console.log(`Synced job ${job.id}`);
                                
                                // Update UI if this job is currently being viewed
                                if (document.getElementById('jobDetailsModal').classList.contains('show') && 
                                    document.getElementById('jobDetailsTitle').textContent === job.title) {
                                    this.renderJobDetails(job.id);
                                }
                                
                                resolve();
                            };
                            
                            putRequest.onerror = (error) => {
                                console.error(`Error syncing job ${job.id}:`, error);
                                reject(error);
                            };
                        } else {
                            resolve();
                        }
                    };
                    
                    request.onerror = (error) => {
                        console.error(`Error checking job ${job.id}:`, error);
                        reject(error);
                    };
                });
            }
            
            async syncApplication(application) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['applications'], 'readwrite');
                    const store = transaction.objectStore('applications');
                    
                    const request = store.get(application.id);
                    
                    request.onsuccess = (event) => {
                        const existingApp = event.target.result;
                        
                        if (!existingApp || application.updatedAt > existingApp.updatedAt) {
                            const putRequest = store.put(application);
                            
                            putRequest.onsuccess = () => {
                                console.log(`Synced application ${application.id}`);
                                
                                // Update UI if this application is currently being viewed
                                if (document.getElementById('applicationDetailsModal').classList.contains('show') && 
                                    document.getElementById('applicationJobTitleDetails').textContent.includes(application.jobTitle)) {
                                    this.renderApplicationDetails(application.id);
                                }
                                
                                resolve();
                            };
                            
                            putRequest.onerror = (error) => {
                                console.error(`Error syncing application ${application.id}:`, error);
                                reject(error);
                            };
                        } else {
                            resolve();
                        }
                    };
                    
                    request.onerror = (error) => {
                        console.error(`Error checking application ${application.id}:`, error);
                        reject(error);
                    };
                });
            }
            
            async syncMessage(message) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['messages'], 'readwrite');
                    const store = transaction.objectStore('messages');
                    
                    const request = store.get(message.id);
                    
                    request.onsuccess = (event) => {
                        const existingMsg = event.target.result;
                        
                        if (!existingMsg || message.timestamp > existingMsg.timestamp) {
                            const putRequest = store.put(message);
                            
                            putRequest.onsuccess = () => {
                                console.log(`Synced message ${message.id}`);
                                
                                // Update UI if this message is in the current chat
                                if (document.getElementById('messagesSection').style.display === 'block' && 
                                    document.getElementById('chatContainer').style.display === 'block' &&
                                    (message.senderId === this.currentChatUserId || message.receiverId === this.currentChatUserId)) {
                                    this.renderChatMessages(this.currentChatUserId);
                                }
                                
                                // Update unread count
                                if (message.receiverId === this.currentUser?.id && !message.read) {
                                    this.updateUnreadCount();
                                }
                                
                                resolve();
                            };
                            
                            putRequest.onerror = (error) => {
                                console.error(`Error syncing message ${message.id}:`, error);
                                reject(error);
                            };
                        } else {
                            resolve();
                        }
                    };
                    
                    request.onerror = (error) => {
                        console.error(`Error checking message ${message.id}:`, error);
                        reject(error);
                    };
                });
            }
            
            async syncReport(report) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['reports'], 'readwrite');
                    const store = transaction.objectStore('reports');
                    
                    const request = store.get(report.id);
                    
                    request.onsuccess = (event) => {
                        const existingReport = event.target.result;
                        
                        if (!existingReport || report.updatedAt > existingReport.updatedAt) {
                            const putRequest = store.put(report);
                            
                            putRequest.onsuccess = () => {
                                console.log(`Synced report ${report.id}`);
                                resolve();
                            };
                            
                            putRequest.onerror = (error) => {
                                console.error(`Error syncing report ${report.id}:`, error);
                                reject(error);
                            };
                        } else {
                            resolve();
                        }
                    };
                    
                    request.onerror = (error) => {
                        console.error(`Error checking report ${report.id}:`, error);
                        reject(error);
                    };
                });
            }
            
            async syncUser(user) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['users'], 'readwrite');
                    const store = transaction.objectStore('users');
                    
                    const request = store.get(user.id);
                    
                    request.onsuccess = (event) => {
                        const existingUser = event.target.result;
                        
                        if (!existingUser || user.updatedAt > existingUser.updatedAt) {
                            const putRequest = store.put(user);
                            
                            putRequest.onsuccess = () => {
                                console.log(`Synced user ${user.id}`);
                                resolve();
                            };
                            
                            putRequest.onerror = (error) => {
                                console.error(`Error syncing user ${user.id}:`, error);
                                reject(error);
                            };
                        } else {
                            resolve();
                        }
                    };
                    
                    request.onerror = (error) => {
                        console.error(`Error checking user ${user.id}:`, error);
                        reject(error);
                    };
                });
            }
            
            async syncCompany(company) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['companies'], 'readwrite');
                    const store = transaction.objectStore('companies');
                    
                    const request = store.get(company.id);
                    
                    request.onsuccess = (event) => {
                        const existingCompany = event.target.result;
                        
                        if (!existingCompany || company.updatedAt > existingCompany.updatedAt) {
                            const putRequest = store.put(company);
                            
                            putRequest.onsuccess = () => {
                                console.log(`Synced company ${company.id}`);
                                resolve();
                            };
                            
                            putRequest.onerror = (error) => {
                                console.error(`Error syncing company ${company.id}:`, error);
                                reject(error);
                            };
                        } else {
                            resolve();
                        }
                    };
                    
                    request.onerror = (error) => {
                        console.error(`Error checking company ${company.id}:`, error);
                        reject(error);
                    };
                });
            }
            
            async checkAuthState() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['users'], 'readonly');
                    const store = transaction.objectStore('users');
                    const index = store.index('username');
                    
                    // Check if there are any users (first run)
                    const countRequest = store.count();
                    
                    countRequest.onsuccess = (event) => {
                        if (event.target.result === 0) {
                            // First run, no users yet
                            console.log("First run - no users in database");
                            resolve(false);
                        } else {
                            // Check if a user is logged in from session
                            const sessionRequest = this.db.transaction(['settings'], 'readonly')
                                .objectStore('settings')
                                .get('currentUser');
                            
                            sessionRequest.onsuccess = (e) => {
                                if (e.target.result) {
                                    const userRequest = store.get(e.target.result.value);
                                    
                                    userRequest.onsuccess = (ev) => {
                                        if (ev.target.result) {
                                            this.currentUser = ev.target.result;
                                            this.isAdmin = this.currentUser.isAdmin;
                                            console.log("User is logged in:", this.currentUser.username);
                                            resolve(true);
                                        } else {
                                            resolve(false);
                                        }
                                    };
                                    
                                    userRequest.onerror = () => resolve(false);
                                } else {
                                    resolve(false);
                                }
                            };
                            
                            sessionRequest.onerror = () => resolve(false);
                        }
                    };
                    
                    countRequest.onerror = () => reject(new Error("Failed to check user count"));
                });
            }
            
            initUI() {
                if (this.currentUser) {
                    // User is logged in, show main interface
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'flex';
                    
                    // Update user profile in sidebar
                    this.updateUserProfile();
                    
                    // Show dashboard by default
                    this.showSection('dashboard');
                    
                    // Load initial data
                    this.loadInitialData();
                } else {
                    // User is not logged in, show auth interface
                    document.getElementById('authContainer').style.display = 'flex';
                    document.getElementById('mainContainer').style.display = 'none';
                    
                    // Show login form by default
                    document.getElementById('loginForm').style.display = 'block';
                    document.getElementById('signupForm').style.display = 'none';
                }
            }
            
            setupEventListeners() {
                // Auth form toggles
                document.getElementById('showSignup').addEventListener('click', () => {
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('signupForm').style.display = 'block';
                    document.getElementById('authSubtitle').textContent = 'Create a new account';
                });
                
                document.getElementById('showLogin').addEventListener('click', () => {
                    document.getElementById('signupForm').style.display = 'none';
                    document.getElementById('loginForm').style.display = 'block';
                    document.getElementById('authSubtitle').textContent = 'Sign in to your account';
                });
                
                // Auth form submissions
                document.getElementById('loginBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });
                
                document.getElementById('signupBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.handleSignup();
                });
                
                // Username availability check
                document.getElementById('signupUsername').addEventListener('blur', () => {
                    this.checkUsernameAvailability(document.getElementById('signupUsername').value);
                });
                
                // Profile picture upload
                document.getElementById('profilePicture').addEventListener('change', (e) => {
                    this.previewImage(e.target, 'profilePicturePreview');
                });
                
                // Sidebar navigation
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const section = item.getAttribute('data-section');
                        this.showSection(section);
                    });
                });
                
                // User profile dropdown
                document.getElementById('userProfile').addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.getElementById('profileDropdown').classList.toggle('show');
                });
                
                // Profile dropdown actions
                document.querySelectorAll('.dropdown-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const action = item.getAttribute('data-action');
                        this.handleProfileAction(action);
                        document.getElementById('profileDropdown').classList.remove('show');
                    });
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', () => {
                    document.getElementById('profileDropdown').classList.remove('show');
                });
                
                // Job search
                document.getElementById('jobSearch').addEventListener('input', (e) => {
                    this.filterJobs();
                });
                
                // Job category filter
                document.getElementById('jobCategoryFilter').addEventListener('change', () => {
                    this.filterJobs();
                });
                
                // Job location filter
                document.getElementById('jobLocationFilter').addEventListener('change', () => {
                    this.filterJobs();
                });
                
                // Job type filter
                document.getElementById('jobTypeFilter').addEventListener('change', () => {
                    this.filterJobs();
                });
                
                // Post job form
                document.getElementById('postJobForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.postJob();
                });
                
                // Job image upload
                document.getElementById('jobImage').addEventListener('change', (e) => {
                    this.previewImage(e.target, 'jobImagePreview');
                });
                
                // Company selection in job post
                document.getElementById('jobCompany').addEventListener('change', (e) => {
                    if (e.target.value === 'add-new') {
                        this.showCompanyModal();
                        e.target.value = '';
                    }
                });
                
                // Interview type change
                document.getElementById('interviewType').addEventListener('change', (e) => {
                    if (e.target.value === 'online') {
                        document.getElementById('interviewLocationGroup').style.display = 'none';
                        document.getElementById('interviewLinkGroup').style.display = 'block';
                    } else {
                        document.getElementById('interviewLocationGroup').style.display = 'block';
                        document.getElementById('interviewLinkGroup').style.display = 'none';
                    }
                });
                
                // Report reason change
                document.getElementById('reportReason').addEventListener('change', (e) => {
                    if (e.target.value === 'other') {
                        document.getElementById('otherReasonGroup').style.display = 'block';
                    } else {
                        document.getElementById('otherReasonGroup').style.display = 'none';
                    }
                });
                
                // Modal close buttons
                document.querySelectorAll('.modal-close').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.closeModal(btn.closest('.modal'));
                    });
                });
                
                // Window events for inactivity timer
                window.addEventListener('mousemove', () => this.resetInactivityTimer());
                window.addEventListener('keypress', () => this.resetInactivityTimer());
                window.addEventListener('scroll', () => this.resetInactivityTimer());
                window.addEventListener('click', () => this.resetInactivityTimer());
                
                // Add more event listeners as needed...
            }
            
            resetInactivityTimer() {
                if (this.inactivityTimer) {
                    clearTimeout(this.inactivityTimer);
                }
                
                this.inactivityTimer = setTimeout(() => {
                    if (this.currentUser) {
                        this.logout();
                        alert('You have been logged out due to inactivity.');
                    }
                }, this.inactivityTimeout);
            }
            
            async handleLogin() {
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                if (!username || !password) {
                    this.showError('Please enter both username and password');
                    return;
                }
                
                this.showLoading("Signing in...");
                
                try {
                    const user = await this.authenticateUser(username, password);
                    
                    if (user) {
                        this.currentUser = user;
                        this.isAdmin = user.isAdmin;
                        
                        // Save login state
                        await this.saveSession(user.id);
                        
                        // Update UI
                        this.initUI();
                        
                        // Show welcome message
                        this.showSuccess(`Welcome back, ${user.username || user.fullName}!`);
                    } else {
                        this.showError('Invalid username or password');
                    }
                } catch (error) {
                    console.error("Login error:", error);
                    this.showError('Failed to login. Please try again.');
                } finally {
                    this.hideLoading();
                }
            }
            
            async authenticateUser(username, password) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['users'], 'readonly');
                    const store = transaction.objectStore('users');
                    const usernameIndex = store.index('username');
                    const phoneIndex = store.index('phone');
                    
                    // Try username first
                    const usernameRequest = usernameIndex.get(username);
                    
                    usernameRequest.onsuccess = (e) => {
                        const user = e.target.result;
                        
                        if (user) {
                            this.verifyPassword(password, user.passwordHash)
                                .then(match => {
                                    if (match) {
                                        resolve(user);
                                    } else {
                                        // If username didn't work, try phone number
                                        const phoneRequest = phoneIndex.get(username);
                                        
                                        phoneRequest.onsuccess = (ev) => {
                                            const phoneUser = ev.target.result;
                                            
                                            if (phoneUser) {
                                                this.verifyPassword(password, phoneUser.passwordHash)
                                                    .then(phoneMatch => {
                                                        if (phoneMatch) {
                                                            resolve(phoneUser);
                                                        } else {
                                                            resolve(null);
                                                        }
                                                    });
                                            } else {
                                                resolve(null);
                                            }
                                        };
                                        
                                        phoneRequest.onerror = () => resolve(null);
                                    }
                                });
                        } else {
                            // Try phone number if username not found
                            const phoneRequest = phoneIndex.get(username);
                            
                            phoneRequest.onsuccess = (ev) => {
                                const phoneUser = ev.target.result;
                                
                                if (phoneUser) {
                                    this.verifyPassword(password, phoneUser.passwordHash)
                                        .then(match => {
                                            if (match) {
                                                resolve(phoneUser);
                                            } else {
                                                resolve(null);
                                            }
                                        });
                                } else {
                                    resolve(null);
                                }
                            };
                            
                            phoneRequest.onerror = () => resolve(null);
                        }
                    };
                    
                    usernameRequest.onerror = () => reject(new Error("Failed to query users"));
                });
            }
            
            async handleSignup() {
                const fullName = document.getElementById('signupFullName').value.trim();
                const username = document.getElementById('signupUsername').value.trim();
                const email = document.getElementById('signupEmail').value.trim();
                const phone = document.getElementById('signupPhone').value.trim();
                const password = document.getElementById('signupPassword').value;
                const confirmPassword = document.getElementById('signupConfirmPassword').value;
                
                // Basic validation
                if (!fullName || !username || !email || !phone || !password || !confirmPassword) {
                    this.showError('Please fill in all fields');
                    return;
                }
                
                if (password !== confirmPassword) {
                    this.showError('Passwords do not match');
                    return;
                }
                
                if (password.length < 8) {
                    this.showError('Password must be at least 8 characters');
                    return;
                }
                
                // Check if username is available
                const usernameAvailable = await this.checkUsernameAvailability(username, true);
                if (!usernameAvailable) return;
                
                this.showLoading("Creating account...");
                
                try {
                    // Hash password
                    const passwordHash = await this.hashPassword(password);
                    
                    // Create user object
                    const user = {
                        id: this.generateId(),
                        fullName,
                        username,
                        email,
                        phone,
                        passwordHash,
                        isAdmin: false, // First user will be set as admin in the next step
                        profilePicture: '',
                        profession: '',
                        jobTitle: '',
                        workplace: '',
                        location: '',
                        bio: '',
                        createdAt: Date.now(),
                        updatedAt: Date.now()
                    };
                    
                    // Handle profile picture if uploaded
                    const profilePicInput = document.getElementById('profilePicture');
                    if (profilePicInput.files.length > 0) {
                        const file = profilePicInput.files[0];
                        const fileBuffer = await this.readFileAsBuffer(file);
                        const cid = await this.ipfs.add(fileBuffer);
                        user.profilePicture = cid.path;
                    }
                    
                    // Check if this is the first user (make them admin)
                    const isFirstUser = await this.isFirstUser();
                    if (isFirstUser) {
                        user.isAdmin = true;
                    }
                    
                    // Save user to database
                    await this.saveUser(user);
                    
                    // Set as current user
                    this.currentUser = user;
                    this.isAdmin = user.isAdmin;
                    
                    // Save session
                    await this.saveSession(user.id);
                    
                    // Update UI
                    this.initUI();
                    
                    // Show success message
                    this.showSuccess(`Welcome to Skysoft Job Market, ${fullName}!`);
                    
                    // If this is the first user, initialize system settings
                    if (isFirstUser) {
                        await this.initializeSystemSettings();
                    }
                } catch (error) {
                    console.error("Signup error:", error);
                    this.showError('Failed to create account. Please try again.');
                } finally {
                    this.hideLoading();
                }
            }
            
            async checkUsernameAvailability(username, showError = false) {
                if (!username) return false;
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['users'], 'readonly');
                    const store = transaction.objectStore('users');
                    const index = store.index('username');
                    
                    const request = index.get(username);
                    
                    request.onsuccess = (e) => {
                        const existingUser = e.target.result;
                        
                        if (existingUser) {
                            if (showError) {
                                this.showError('Username is already taken');
                                document.getElementById('usernameAvailability').textContent = 'Username is not available';
                                document.getElementById('usernameAvailability').style.color = 'red';
                            }
                            resolve(false);
                        } else {
                            document.getElementById('usernameAvailability').textContent = 'Username is available';
                            document.getElementById('usernameAvailability').style.color = 'green';
                            resolve(true);
                        }
                    };
                    
                    request.onerror = () => {
                        if (showError) {
                            this.showError('Failed to check username availability');
                        }
                        reject(new Error("Failed to check username availability"));
                    };
                });
            }
            
            async isFirstUser() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['users'], 'readonly');
                    const store = transaction.objectStore('users');
                    
                    const countRequest = store.count();
                    
                    countRequest.onsuccess = (e) => {
                        resolve(e.target.result === 0);
                    };
                    
                    countRequest.onerror = () => reject(new Error("Failed to check user count"));
                });
            }
            
            async saveUser(user) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['users'], 'readwrite');
                    const store = transaction.objectStore('users');
                    
                    const request = store.put(user);
                    
                    request.onsuccess = () => {
                        // Broadcast user update to network
                        this.broadcastData('user', user);
                        resolve();
                    };
                    
                    request.onerror = () => reject(new Error("Failed to save user"));
                });
            }
            
            async saveSession(userId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['settings'], 'readwrite');
                    const store = transaction.objectStore('settings');
                    
                    const request = store.put({ key: 'currentUser', value: userId });
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(new Error("Failed to save session"));
                });
            }
            
            async initializeSystemSettings() {
                const settings = {
                    appTitle: 'Skysoft Job Market',
                    inactivityTimeout: 30, // minutes
                    defaultCurrency: 'UGX',
                    systemEmail: '',
                    adminInheritance: []
                };
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['settings'], 'readwrite');
                    const store = transaction.objectStore('settings');
                    
                    const request = store.put({ key: 'systemSettings', value: settings });
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(new Error("Failed to initialize system settings"));
                });
            }
            
            async hashPassword(password) {
                // Convert the password to an ArrayBuffer
                const encoder = new TextEncoder();
                const data = encoder.encode(password);
                
                // Hash the password using SHA-256
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                
                // Convert the hash to a hexadecimal string
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                
                return hashHex;
            }
            
            async verifyPassword(password, hash) {
                const computedHash = await this.hashPassword(password);
                return computedHash === hash;
            }
            
            generateId() {
                return crypto.randomUUID();
            }
            
            async readFileAsBuffer(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        resolve(e.target.result);
                    };
                    
                    reader.onerror = (e) => {
                        reject(new Error("Failed to read file"));
                    };
                    
                    reader.readAsArrayBuffer(file);
                });
            }
            
            previewImage(inputElement, previewElementId) {
                const file = inputElement.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    const preview = document.getElementById(previewElementId);
                    preview.querySelector('img').src = e.target.result;
                    preview.style.display = 'block';
                };
                
                reader.readAsDataURL(file);
            }
            
            async loadInitialData() {
                // Load jobs
                this.renderRecentJobs();
                this.renderJobCategories();
                this.renderJobLocations();
                
                // Load companies
                this.renderUserCompanies();
                
                // Load notifications
                this.updateUnreadCount();
                
                // Load network members
                this.renderNetworkMembers();
                
                // Load admin data if admin
                if (this.isAdmin) {
                    this.renderAdminUsers();
                    this.renderAdminReports();
                    this.renderAdminBlueTickRequests();
                    this.renderAdminSettings();
                    
                    // Show admin menu items
                    document.querySelectorAll('.admin-only').forEach(el => {
                        el.style.display = 'flex';
                    });
                }
            }
            
            updateUserProfile() {
                if (!this.currentUser) return;
                
                // Update profile picture
                const profilePic = document.getElementById('userProfilePic');
                if (this.currentUser.profilePicture) {
                    profilePic.src = `https://ipfs.io/ipfs/${this.currentUser.profilePicture}`;
                } else {
                    profilePic.src = 'https://via.placeholder.com/150';
                }
                
                // Update display name
                const displayName = this.currentUser.username || this.currentUser.fullName;
                document.getElementById('userDisplayName').textContent = displayName;
                document.getElementById('welcomeName').textContent = displayName;
                
                // Update profile dropdown
                const profileDropdown = document.getElementById('profileDropdown');
                profileDropdown.querySelector('.dropdown-item[data-action="profile"] span').textContent = displayName;
            }
            
            showSection(section) {
                // Hide all sections
                document.querySelectorAll('.content-section').forEach(sec => {
                    sec.style.display = 'none';
                });
                
                // Show selected section
                document.getElementById(`${section}Section`).style.display = 'block';
                
                // Update header title
                document.getElementById('headerTitle').textContent = this.getSectionTitle(section);
                
                // Update active menu item
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                document.querySelector(`.menu-item[data-section="${section}"]`).classList.add('active');
                
                // Load section data if needed
                switch (section) {
                    case 'dashboard':
                        this.renderRecentJobs();
                        break;
                    case 'jobs':
                        this.renderJobListings();
                        break;
                    case 'applications':
                        this.renderMyApplications();
                        break;
                    case 'myJobs':
                        this.renderMyJobPosts();
                        break;
                    case 'messages':
                        this.renderMessageContacts();
                        break;
                    case 'network':
                        this.renderNetworkMembers();
                        break;
                    case 'companies':
                        this.renderUserCompanies();
                        break;
                    case 'admin':
                        this.renderAdminUsers();
                        this.renderAdminReports();
                        this.renderAdminBlueTickRequests();
                        this.renderAdminSettings();
                        break;
                }
            }
            
            getSectionTitle(section) {
                const titles = {
                    'dashboard': 'Dashboard',
                    'jobs': 'Job Listings',
                    'postJob': 'Post a Job',
                    'applications': 'My Applications',
                    'myJobs': 'My Job Posts',
                    'messages': 'Messages',
                    'network': 'Network',
                    'companies': 'Companies',
                    'admin': 'Admin Panel'
                };
                
                return titles[section] || section;
            }
            
            async renderRecentJobs() {
                const jobs = await this.getRecentJobs();
                const container = document.getElementById('recentJobs');
                
                if (jobs.length === 0) {
                    container.innerHTML = '<p>No recent job listings found.</p>';
                    return;
                }
                
                let html = '';
                jobs.forEach(job => {
                    html += this.createJobCardHtml(job);
                });
                
                container.innerHTML = html;
                
                // Add event listeners to job cards
                document.querySelectorAll('.view-job-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const jobId = btn.getAttribute('data-job-id');
                        this.showJobDetails(jobId);
                    });
                });
            }
            
            async getRecentJobs(limit = 5) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['jobs'], 'readonly');
                    const store = transaction.objectStore('jobs');
                    const index = store.index('deadline');
                    
                    // Get jobs with deadline in the future, sorted by deadline (ascending)
                    const request = index.getAll();
                    
                    request.onsuccess = (e) => {
                        const allJobs = e.target.result;
                        const now = Date.now();
                        
                        // Filter out expired jobs and sort by creation date (newest first)
                        const validJobs = allJobs
                            .filter(job => new Date(job.deadline).getTime() > now)
                            .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime())
                            .slice(0, limit);
                        
                        resolve(validJobs);
                    };
                    
                    request.onerror = () => reject(new Error("Failed to get recent jobs"));
                });
            }
            
            async renderJobListings() {
                const jobs = await this.getAllJobs();
                const container = document.getElementById('jobListings');
                
                if (jobs.length === 0) {
                    container.innerHTML = '<p>No job listings found.</p>';
                    return;
                }
                
                let html = '';
                jobs.forEach(job => {
                    html += this.createJobCardHtml(job);
                });
                
                container.innerHTML = html;
                
                // Add event listeners to job cards
                document.querySelectorAll('.view-job-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const jobId = btn.getAttribute('data-job-id');
                        this.showJobDetails(jobId);
                    });
                });
            }
            
            async getAllJobs() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['jobs'], 'readonly');
                    const store = transaction.objectStore('jobs');
                    const index = store.index('deadline');
                    
                    const request = index.getAll();
                    
                    request.onsuccess = (e) => {
                        const allJobs = e.target.result;
                        const now = Date.now();
                        
                        // Filter out expired jobs and sort by creation date (newest first)
                        const validJobs = allJobs
                            .filter(job => new Date(job.deadline).getTime() > now)
                            .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
                        
                        resolve(validJobs);
                    };
                    
                    request.onerror = () => reject(new Error("Failed to get all jobs"));
                });
            }
            
            createJobCardHtml(job) {
                const deadline = new Date(job.deadline).toLocaleDateString();
                const postedDate = new Date(job.createdAt).toLocaleDateString();
                const salary = job.salaryFrom ? 
                    `${this.formatCurrency(job.salaryFrom, job.salaryCurrency)} - ${this.formatCurrency(job.salaryTo, job.salaryCurrency)}` : 
                    'Not disclosed';
                
                return `
                    <div class="job-card">
                        <div class="job-header">
                            <div>
                                <div class="job-title">${job.title}</div>
                                <div class="company-name">
                                    ${job.company}
                                    ${job.blueTick ? '<i class="fas fa-check-circle blue-tick"></i>' : ''}
                                </div>
                                <div class="job-meta">
                                    <div class="meta-item">
                                        <i class="fas fa-map-marker-alt"></i> ${job.location}
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-clock"></i> ${job.type}
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-money-bill-wave"></i> ${salary}
                                    </div>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-primary btn-sm view-job-btn" data-job-id="${job.id}">View Details</button>
                            </div>
                        </div>
                        <div class="job-body">
                            <div class="job-description">${job.description.substring(0, 200)}...</div>
                        </div>
                        <div class="job-footer">
                            <div class="deadline">
                                <i class="fas fa-calendar-times"></i> Deadline: ${deadline}
                            </div>
                            <div class="job-actions">
                                <small class="text-muted">Posted: ${postedDate}</small>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            formatCurrency(amount, currency) {
                if (!amount) return '';
                
                const formatter = new Intl.NumberFormat(undefined, {
                    style: 'currency',
                    currency: currency || 'UGX'
                });
                
                return formatter.format(amount);
            }
            
            async showJobDetails(jobId) {
                this.showLoading("Loading job details...");
                
                try {
                    const job = await this.getJobById(jobId);
                    
                    if (!job) {
                        this.showError('Job not found');
                        return;
                    }
                    
                    // Populate modal with job data
                    document.getElementById('jobDetailsTitle').textContent = job.title;
                    document.getElementById('jobDetailsCompany').textContent = job.company;
                    document.getElementById('jobDetailsDescription').textContent = job.description;
                    document.getElementById('jobDetailsPostedDate').textContent = new Date(job.createdAt).toLocaleDateString();
                    document.getElementById('jobDetailsDeadline').textContent = new Date(job.deadline).toLocaleDateString();
                    document.getElementById('jobDetailsLocation').textContent = job.location;
                    document.getElementById('jobDetailsType').textContent = job.type;
                    document.getElementById('jobDetailsPositions').textContent = job.positions;
                    
                    const salary = job.salaryFrom ? 
                        `${this.formatCurrency(job.salaryFrom, job.salaryCurrency)} - ${this.formatCurrency(job.salaryTo, job.salaryCurrency)}` : 
                        'Not disclosed';
                    document.getElementById('jobDetailsSalary').textContent = salary;
                    
                    // Set application button
                    const applyBtn = document.getElementById('applyNowBtn');
                    applyBtn.textContent = 'Apply Now';
                    applyBtn.onclick = () => {
                        this.showApplicationModal(jobId);
                    };
                    
                    // Show/hide comments section
                    const commentsSection = document.getElementById('jobCommentsSection');
                    if (job.allowComments) {
                        commentsSection.style.display = 'block';
                        this.renderJobComments(jobId);
                    } else {
                        commentsSection.style.display = 'none';
                    }
                    
                    // Show modal
                    this.showModal('jobDetailsModal');
                } catch (error) {
                    console.error("Error showing job details:", error);
                    this.showError('Failed to load job details');
                } finally {
                    this.hideLoading();
                }
            }
            
            async getJobById(jobId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['jobs'], 'readonly');
                    const store = transaction.objectStore('jobs');
                    
                    const request = store.get(jobId);
                    
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = () => reject(new Error("Failed to get job by ID"));
                });
            }
            
            async renderJobComments(jobId) {
                // TODO: Implement job comments functionality
                document.getElementById('jobComments').innerHTML = '<p>No comments yet.</p>';
            }
            
            async showApplicationModal(jobId) {
                const job = await this.getJobById(jobId);
                if (!job) return;
                
                document.getElementById('applicationJobTitle').textContent = job.title;
                document.getElementById('applicationJobId').value = jobId;
                
                // Pre-fill applicant details if available
                if (this.currentUser) {
                    document.getElementById('applicantName').value = this.currentUser.fullName || '';
                    document.getElementById('applicantLocation').value = this.currentUser.location || '';
                    
                    if (this.currentUser.profilePicture) {
                        document.getElementById('applicantPhotoPreview').querySelector('img').src = 
                            `https://ipfs.io/ipfs/${this.currentUser.profilePicture}`;
                        document.getElementById('applicantPhotoPreview').style.display = 'block';
                    }
                }
                
                this.showModal('applicationModal');
            }
            
            async postJob() {
                const title = document.getElementById('jobTitle').value.trim();
                const category = document.getElementById('jobCategory').value;
                const type = document.getElementById('jobType').value;
                const company = document.getElementById('jobCompany').value;
                const positions = document.getElementById('jobPositions').value;
                const deadline = document.getElementById('jobDeadline').value;
                const location = document.getElementById('jobLocation').value.trim();
                const salaryFrom = document.getElementById('jobSalaryFrom').value;
                const salaryTo = document.getElementById('jobSalaryTo').value;
                const salaryCurrency = document.getElementById('jobSalaryCurrency').value;
                const description = document.getElementById('jobDescription').value.trim();
                const allowComments = document.getElementById('allowComments').checked;
                const allowPrivateMessages = document.getElementById('allowPrivateMessages').checked;
                
                // Validation
                if (!title || !category || !type || !company || !positions || !deadline || !location || !description) {
                    this.showError('Please fill in all required fields');
                    return;
                }
                
                if (new Date(deadline) < new Date()) {
                    this.showError('Deadline must be in the future');
                    return;
                }
                
                this.showLoading("Posting job...");
                
                try {
                    // Create job object
                    const job = {
                        id: this.generateId(),
                        title,
                        category,
                        type,
                        company,
                        positions: parseInt(positions),
                        deadline,
                        location,
                        salaryFrom: salaryFrom ? parseFloat(salaryFrom) : null,
                        salaryTo: salaryTo ? parseFloat(salaryTo) : null,
                        salaryCurrency,
                        description,
                        allowComments,
                        allowPrivateMessages,
                        posterId: this.currentUser.id,
                        posterName: this.currentUser.fullName || this.currentUser.username,
                        blueTick: false, // Will be set if company has blue tick
                        createdAt: Date.now(),
                        updatedAt: Date.now()
                    };
                    
                    // Handle job image if uploaded
                    const jobImageInput = document.getElementById('jobImage');
                    if (jobImageInput.files.length > 0) {
                        const file = jobImageInput.files[0];
                        const fileBuffer = await this.readFileAsBuffer(file);
                        const cid = await this.ipfs.add(fileBuffer);
                        job.image = cid.path;
                    }
                    
                    // Check if company has blue tick
                    const companyData = await this.getCompanyByName(company);
                    if (companyData && companyData.blueTick) {
                        job.blueTick = true;
                    }
                    
                    // Save job to database
                    await this.saveJob(job);
                    
                    // Broadcast job to network
                    await this.broadcastData('job', job);
                    
                    // Show success message
                    this.showSuccess('Job posted successfully!');
                    
                    // Close modal and refresh job listings
                    this.closeModal('postJobModal');
                    this.renderJobListings();
                    this.renderMyJobPosts();
                } catch (error) {
                    console.error("Error posting job:", error);
                    this.showError('Failed to post job. Please try again.');
                } finally {
                    this.hideLoading();
                }
            }
            
            async saveJob(job) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['jobs'], 'readwrite');
                    const store = transaction.objectStore('jobs');
                    
                    const request = store.put(job);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(new Error("Failed to save job"));
                });
            }
            
            async getCompanyByName(name) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['companies'], 'readonly');
                    const store = transaction.objectStore('companies');
                    const index = store.index('name');
                    
                    const request = index.get(name);
                    
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = () => reject(new Error("Failed to get company by name"));
                });
            }
            
            async renderJobCategories() {
                // TODO: Implement job categories from settings or database
                const categories = [
                    'Technology', 'Healthcare', 'Education', 'Finance', 
                    'Construction', 'Hospitality', 'Retail', 'Other'
                ];
                
                const categorySelects = [
                    document.getElementById('jobCategory'),
                    document.getElementById('jobCategoryFilter')
                ];
                
                categorySelects.forEach(select => {
                    // Clear existing options except the first one
                    while (select.options.length > 1) {
                        select.remove(1);
                    }
                    
                    // Add categories
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        select.appendChild(option);
                    });
                });
            }
            
            async renderJobLocations() {
                // TODO: Implement job locations from database or geolocation API
                const locations = [
                    'Kampala', 'Entebbe', 'Jinja', 'Mbarara', 'Gulu', 'Mbale', 'Other'
                ];
                
                const locationSelect = document.getElementById('jobLocationFilter');
                
                // Clear existing options except the first one
                while (locationSelect.options.length > 1) {
                    locationSelect.remove(1);
                }
                
                // Add locations
                locations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location;
                    option.textContent = location;
                    locationSelect.appendChild(option);
                });
            }
            
            async filterJobs() {
                const searchTerm = document.getElementById('jobSearch').value.toLowerCase();
                const category = document.getElementById('jobCategoryFilter').value;
                const location = document.getElementById('jobLocationFilter').value;
                const type = document.getElementById('jobTypeFilter').value;
                
                const jobs = await this.getAllJobs();
                
                const filteredJobs = jobs.filter(job => {
                    // Search term filter
                    if (searchTerm && 
                        !job.title.toLowerCase().includes(searchTerm) && 
                        !job.company.toLowerCase().includes(searchTerm) && 
                        !job.description.toLowerCase().includes(searchTerm)) {
                        return false;
                    }
                    
                    // Category filter
                    if (category && job.category !== category) {
                        return false;
                    }
                    
                    // Location filter
                    if (location && job.location !== location) {
                        return false;
                    }
                    
                    // Type filter
                    if (type && job.type !== type) {
                        return false;
                    }
                    
                    return true;
                });
                
                const container = document.getElementById('jobListings');
                
                if (filteredJobs.length === 0) {
                    container.innerHTML = '<p>No jobs match your filters.</p>';
                    return;
                }
                
                let html = '';
                filteredJobs.forEach(job => {
                    html += this.createJobCardHtml(job);
                });
                
                container.innerHTML = html;
                
                // Add event listeners to job cards
                document.querySelectorAll('.view-job-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const jobId = btn.getAttribute('data-job-id');
                        this.showJobDetails(jobId);
                    });
                });
            }
            
            async renderMyApplications() {
                if (!this.currentUser) return;
                
                const applications = await this.getUserApplications(this.currentUser.id);
                const container = document.getElementById('myApplications');
                
                if (applications.length === 0) {
                    container.innerHTML = '<p>You haven\'t applied to any jobs yet.</p>';
                    return;
                }
                
                let html = '<div class="list-group">';
                applications.forEach(app => {
                    const statusClass = this.getApplicationStatusClass(app.status);
                    const statusText = this.getApplicationStatusText(app.status);
                    
                    html += `
                        <div class="list-group-item list-group-item-action">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5>${app.jobTitle}</h5>
                                    <p class="mb-1">${app.company}</p>
                                    <small>Applied on ${new Date(app.appliedAt).toLocaleDateString()}</small>
                                </div>
                                <div>
                                    <span class="badge ${statusClass}">${statusText}</span>
                                    <button class="btn btn-sm btn-outline view-application-btn" data-app-id="${app.id}">View</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-application-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const appId = btn.getAttribute('data-app-id');
                        this.showApplicationDetails(appId);
                    });
                });
            }
            
            async getUserApplications(userId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['applications'], 'readonly');
                    const store = transaction.objectStore('applications');
                    const index = store.index('applicantId');
                    
                    const request = index.getAll(userId);
                    
                    request.onsuccess = async (e) => {
                        const applications = e.target.result;
                        
                        // Get job details for each application
                        const appsWithDetails = await Promise.all(
                            applications.map(async app => {
                                const job = await this.getJobById(app.jobId);
                                return {
                                    ...app,
                                    jobTitle: job?.title || 'Unknown Job',
                                    company: job?.company || 'Unknown Company'
                                };
                            })
                        );
                        
                        // Sort by application date (newest first)
                        appsWithDetails.sort((a, b) => new Date(b.appliedAt).getTime() - new Date(a.appliedAt).getTime());
                        
                        resolve(appsWithDetails);
                    };
                    
                    request.onerror = () => reject(new Error("Failed to get user applications"));
                });
            }
            
            getApplicationStatusClass(status) {
                switch (status) {
                    case 'pending': return 'badge-warning';
                    case 'accepted': return 'badge-success';
                    case 'rejected': return 'badge-danger';
                    case 'withdrawn': return 'badge-secondary';
                    default: return 'badge-light';
                }
            }
            
            getApplicationStatusText(status) {
                switch (status) {
                    case 'pending': return 'Pending';
                    case 'accepted': return 'Accepted';
                    case 'rejected': return 'Rejected';
                    case 'withdrawn': return 'Withdrawn';
                    default: return status;
                }
            }
            
            async showApplicationDetails(appId) {
                this.showLoading("Loading application details...");
                
                try {
                    const application = await this.getApplicationById(appId);
                    if (!application) {
                        this.showError('Application not found');
                        return;
                    }
                    
                    const job = await this.getJobById(application.jobId);
                    
                    // Populate modal with application data
                    document.getElementById('applicationJobTitleDetails').textContent = job?.title || 'Unknown Job';
                    document.getElementById('applicationCompanyDetails').textContent = job?.company || 'Unknown Company';
                    document.getElementById('applicationApplicantName').textContent = application.applicantName;
                    document.getElementById('applicationApplicantAge').textContent = application.age;
                    document.getElementById('applicationApplicantGender').textContent = this.capitalizeFirstLetter(application.gender);
                    document.getElementById('applicationApplicantLocation').textContent = application.location;
                    document.getElementById('applicationApplicantExperience').textContent = application.experience;
                    document.getElementById('applicationApplicantQualifications').textContent = application.qualifications;
                    document.getElementById('applicationApplicantSkills').textContent = application.skills;
                    document.getElementById('applicationApplicantCoverLetter').textContent = application.coverLetter || 'No cover letter provided';
                    
                    // Set applicant photo
                    const photoPreview = document.getElementById('applicationApplicantPhoto');
                    if (application.photo) {
                        photoPreview.src = `https://ipfs.io/ipfs/${application.photo}`;
                    } else {
                        photoPreview.src = 'https://via.placeholder.com/150';
                    }
                    
                    // Set status badge
                    const statusBadge = document.getElementById('applicationStatusBadge');
                    statusBadge.textContent = this.getApplicationStatusText(application.status);
                    statusBadge.className = `badge ${this.getApplicationStatusClass(application.status)}`;
                    
                    // Set status details
                    const statusDetails = document.getElementById('applicationStatusDetails');
                    if (application.status === 'accepted' && application.interviewDetails) {
                        const interviewDate = new Date(application.interviewDetails.date).toLocaleString();
                        statusDetails.innerHTML = `
                            <p>You've been invited for an interview!</p>
                            <p><strong>Date:</strong> ${interviewDate}</p>
                            <p><strong>Type:</strong> ${application.interviewDetails.type}</p>
                            ${application.interviewDetails.type === 'in-person' ? 
                                `<p><strong>Location:</strong> ${application.interviewDetails.location}</p>` : 
                                `<p><strong>Link:</strong> <a href="${application.interviewDetails.link}" target="_blank">Join Interview</a></p>`}
                            <p><strong>Notes:</strong> ${application.interviewDetails.notes || 'None'}</p>
                            <button class="btn btn-primary" id="joinInterviewBtn">Join Interview</button>
                        `;
                        
                        document.getElementById('joinInterviewBtn').addEventListener('click', () => {
                            this.joinInterview(application);
                        });
                    } else {
                        statusDetails.textContent = 'No additional details available.';
                    }
                    
                    // Set actions based on user role and application status
                    const actionsContainer = document.getElementById('applicationActions');
                    actionsContainer.innerHTML = '';
                    
                    if (this.currentUser.id === application.applicantId) {
                        // Applicant view
                        if (application.status === 'pending') {
                            const withdrawBtn = document.createElement('button');
                            withdrawBtn.className = 'btn btn-danger';
                            withdrawBtn.textContent = 'Withdraw Application';
                            withdrawBtn.addEventListener('click', () => {
                                this.withdrawApplication(application.id);
                            });
                            actionsContainer.appendChild(withdrawBtn);
                        }
                    } else if (this.currentUser.id === job?.posterId) {
                        // Employer view
                        if (application.status === 'pending') {
                            const acceptBtn = document.createElement('button');
                            acceptBtn.className = 'btn btn-success mr-2';
                            acceptBtn.textContent = 'Accept';
                            acceptBtn.addEventListener('click', () => {
                                this.showInterviewModal(application.id);
                            });
                            
                            const rejectBtn = document.createElement('button');
                            rejectBtn.className = 'btn btn-danger';
                            rejectBtn.textContent = 'Reject';
                            rejectBtn.addEventListener('click', () => {
                                this.rejectApplication(application.id);
                            });
                            
                            actionsContainer.appendChild(acceptBtn);
                            actionsContainer.appendChild(rejectBtn);
                        }
                    }
                    
                    // Show modal
                    this.showModal('applicationDetailsModal');
                } catch (error) {
                    console.error("Error showing application details:", error);
                    this.showError('Failed to load application details');
                } finally {
                    this.hideLoading();
                }
            }
            
            async getApplicationById(appId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['applications'], 'readonly');
                    const store = transaction.objectStore('applications');
                    
                    const request = store.get(appId);
                    
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = () => reject(new Error("Failed to get application by ID"));
                });
            }
            
            capitalizeFirstLetter(string) {
                return string.charAt(0).toUpperCase() + string.slice(1);
            }
            
            async withdrawApplication(appId) {
                if (!confirm('Are you sure you want to withdraw this application?')) return;
                
                this.showLoading("Withdrawing application...");
                
                try {
                    const application = await this.getApplicationById(appId);
                    if (!application) {
                        this.showError('Application not found');
                        return;
                    }
                    
                    // Update application status
                    application.status = 'withdrawn';
                    application.updatedAt = Date.now();
                    
                    // Save to database
                    await this.saveApplication(application);
                    
                    // Broadcast update
                    await this.broadcastData('application', application);
                    
                    // Show success message
                    this.showSuccess('Application withdrawn successfully');
                    
                    // Close modal and refresh applications list
                    this.closeModal('applicationDetailsModal');
                    this.renderMyApplications();
                } catch (error) {
                    console.error("Error withdrawing application:", error);
                    this.showError('Failed to withdraw application');
                } finally {
                    this.hideLoading();
                }
            }
            
            async saveApplication(application) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['applications'], 'readwrite');
                    const store = transaction.objectStore('applications');
                    
                    const request = store.put(application);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(new Error("Failed to save application"));
                });
            }
            
            async rejectApplication(appId) {
                if (!confirm('Are you sure you want to reject this application?')) return;
                
                this.showLoading("Rejecting application...");
                
                try {
                    const application = await this.getApplicationById(appId);
                    if (!application) {
                        this.showError('Application not found');
                        return;
                    }
                    
                    // Update application status
                    application.status = 'rejected';
                    application.updatedAt = Date.now();
                    
                    // Save to database
                    await this.saveApplication(application);
                    
                    // Broadcast update
                    await this.broadcastData('application', application);
                    
                    // Show success message
                    this.showSuccess('Application rejected successfully');
                    
                    // Close modal and refresh applications list
                    this.closeModal('applicationDetailsModal');
                    this.renderMyJobPosts();
                } catch (error) {
                    console.error("Error rejecting application:", error);
                    this.showError('Failed to reject application');
                } finally {
                    this.hideLoading();
                }
            }
            
            async showInterviewModal(appId) {
                const application = await this.getApplicationById(appId);
                if (!application) return;
                
                document.getElementById('interviewApplicationId').value = appId;
                
                // Set default date to tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('interviewDate').valueAsDate = tomorrow;
                
                // Set default time to 10:00 AM
                document.getElementById('interviewTime').value = '10:00';
                
                this.showModal('interviewModal');
            }
            
            async joinInterview(application) {
                if (!application.interviewDetails) return;
                
                if (application.interviewDetails.type === 'online') {
                    // Show interview room modal
                    document.getElementById('interviewRoomTitle').textContent = `Interview for ${application.jobTitle}`;
                    document.getElementById('remoteParticipantName').textContent = 
                        application.interviewerName || 'Interviewer';
                    
                    this.showModal('interviewRoomModal');
                    
                    // Initialize WebRTC connection
                    await this.initWebRTC(application);
                } else {
                    // For in-person interviews, just show details
                    alert(`Your interview is scheduled at ${application.interviewDetails.location} on ${new Date(application.interviewDetails.date).toLocaleString()}`);
                }
            }
            
            async initWebRTC(application) {
                // TODO: Implement WebRTC for video interviews
                console.log("Initializing WebRTC for interview with", application);
                
                try {
                    // Get user media
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: true, 
                        audio: true 
                    });
                    
                    // Display local video
                    const localVideo = document.getElementById('localVideo');
                    localVideo.srcObject = stream;
                    
                    // Here you would normally set up WebRTC connection with the other participant
                    // This would involve signaling through the P2P network to establish the connection
                    // For this example, we'll just show a placeholder for the remote video
                    
                    // Simulate remote connection after a delay
                    setTimeout(() => {
                        const remoteVideo = document.getElementById('remoteVideo');
                        remoteVideo.srcObject = null; // In a real app, this would be the remote stream
                    }, 2000);
                    
                    // Set up control buttons
                    document.getElementById('toggleVideoBtn').addEventListener('click', () => {
                        const videoTracks = stream.getVideoTracks();
                        videoTracks.forEach(track => {
                            track.enabled = !track.enabled;
                            document.getElementById('toggleVideoBtn').innerHTML = track.enabled ? 
                                '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
                        });
                    });
                    
                    document.getElementById('toggleAudioBtn').addEventListener('click', () => {
                        const audioTracks = stream.getAudioTracks();
                        audioTracks.forEach(track => {
                            track.enabled = !track.enabled;
                            document.getElementById('toggleAudioBtn').innerHTML = track.enabled ? 
                                '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
                        });
                    });
                    
                    document.getElementById('screenShareBtn').addEventListener('click', async () => {
                        try {
                            const screenStream = await navigator.mediaDevices.getDisplayMedia({ 
                                video: true,
                                audio: false
                            });
                            
                            // Replace video track with screen share
                            const videoTracks = stream.getVideoTracks();
                            videoTracks.forEach(track => track.stop());
                            
                            const screenVideoTrack = screenStream.getVideoTracks()[0];
                            stream.addTrack(screenVideoTrack);
                            localVideo.srcObject = stream;
                            
                            // Handle when screen sharing is stopped
                            screenVideoTrack.onended = () => {
                                // Restore camera video
                                navigator.mediaDevices.getUserMedia({ video: true })
                                    .then(camStream => {
                                        const camVideoTrack = camStream.getVideoTracks()[0];
                                        stream.addTrack(camVideoTrack);
                                        localVideo.srcObject = stream;
                                    });
                            };
                        } catch (error) {
                            console.error("Screen share error:", error);
                        }
                    });
                    
                    document.getElementById('endCallBtn').addEventListener('click', () => {
                        // Stop all tracks
                        stream.getTracks().forEach(track => track.stop());
                        
                        // Close modal
                        this.closeModal('interviewRoomModal');
                    });
                    
                } catch (error) {
                    console.error("Error initializing WebRTC:", error);
                    this.showError('Failed to initialize video call');
                }
            }
            
            async renderMyJobPosts() {
                if (!this.currentUser) return;
                
                const jobs = await this.getUserJobs(this.currentUser.id);
                const container = document.getElementById('myJobPosts');
                
                if (jobs.length === 0) {
                    container.innerHTML = '<p>You haven\'t posted any jobs yet.</p>';
                    return;
                }
                
                let html = '<div class="list-group">';
                jobs.forEach(job => {
                    const deadline = new Date(job.deadline).toLocaleDateString();
                    const applications = job.applications || 0;
                    
                    html += `
                        <div class="list-group-item list-group-item-action">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5>${job.title}</h5>
                                    <p class="mb-1">${job.company}</p>
                                    <small>Deadline: ${deadline}  ${applications} application(s)</small>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-primary view-job-btn mr-2" data-job-id="${job.id}">View</button>
                                    <button class="btn btn-sm btn-danger delete-job-btn" data-job-id="${job.id}">Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-job-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const jobId = btn.getAttribute('data-job-id');
                        this.showJobDetails(jobId);
                    });
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-job-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const jobId = btn.getAttribute('data-job-id');
                        this.deleteJob(jobId);
                    });
                });
            }
            
            async getUserJobs(userId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['jobs'], 'readonly');
                    const store = transaction.objectStore('jobs');
                    const index = store.index('posterId');
                    
                    const request = index.getAll(userId);
                    
                    request.onsuccess = async (e) => {
                        const jobs = e.target.result;
                        
                        // Get application count for each job
                        const jobsWithApps = await Promise.all(
                            jobs.map(async job => {
                                const apps = await this.getJobApplications(job.id);
                                return {
                                    ...job,
                                    applications: apps.length
                                };
                            })
                        );
                        
                        // Sort by creation date (newest first)
                        jobsWithApps.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
                        
                        resolve(jobsWithApps);
                    };
                    
                    request.onerror = () => reject(new Error("Failed to get user jobs"));
                });
            }
            
            async getJobApplications(jobId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['applications'], 'readonly');
                    const store = transaction.objectStore('applications');
                    const index = store.index('jobId');
                    
                    const request = index.getAll(jobId);
                    
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = () => reject(new Error("Failed to get job applications"));
                });
            }
            
            async deleteJob(jobId) {
                if (!confirm('Are you sure you want to delete this job post?')) return;
                
                this.showLoading("Deleting job...");
                
                try {
                    // Delete job from database
                    await this.deleteJobFromDb(jobId);
                    
                    // Broadcast deletion to network
                    await this.broadcastData('jobDelete', { id: jobId });
                    
                    // Show success message
                    this.showSuccess('Job deleted successfully');
                    
                    // Refresh job listings
                    this.renderJobListings();
                    this.renderMyJobPosts();
                } catch (error) {
                    console.error("Error deleting job:", error);
                    this.showError('Failed to delete job');
                } finally {
                    this.hideLoading();
                }
            }
            
            async deleteJobFromDb(jobId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['jobs'], 'readwrite');
                    const store = transaction.objectStore('jobs');
                    
                    const request = store.delete(jobId);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(new Error("Failed to delete job"));
                });
            }
            
            async renderMessageContacts() {
                if (!this.currentUser) return;
                
                const contacts = await this.getMessageContacts(this.currentUser.id);
                const container = document.getElementById('messageContacts');
                
                if (contacts.length === 0) {
                    container.innerHTML = '<p>No contacts yet.</p>';
                    document.getElementById('chatContainer').style.display = 'none';
                    document.getElementById('noChatSelected').style.display = 'block';
                    return;
                }
                
                let html = '';
                contacts.forEach(contact => {
                    const lastMessage = contact.lastMessage ? 
                        contact.lastMessage.substring(0, 30) + (contact.lastMessage.length > 30 ? '...' : '') : 
                        'No messages yet';
                    
                    const unreadClass = contact.unreadCount > 0 ? 'font-weight-bold' : '';
                    const unreadBadge = contact.unreadCount > 0 ? 
                        `<span class="badge badge-primary float-right">${contact.unreadCount}</span>` : '';
                    
                    html += `
                        <a href="#" class="list-group-item list-group-item-action contact-item ${unreadClass}" 
                           data-user-id="${contact.userId}">
                            <div class="d-flex align-items-center">
                                <img src="${contact.profilePicture ? `https://ipfs.io/ipfs/${contact.profilePicture}` : 'https://via.placeholder.com/40'}" 
                                     class="rounded-circle mr-3" width="40" height="40">
                                <div>
                                    <h6 class="mb-0">${contact.username || contact.fullName} ${unreadBadge}</h6>
                                    <small class="text-muted">${lastMessage}</small>
                                </div>
                            </div>
                        </a>
                    `;
                });
                
                container.innerHTML = html;
                
                // Add event listeners to contact items
                document.querySelectorAll('.contact-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const userId = item.getAttribute('data-user-id');
                        this.showChat(userId);
                    });
                });
                
                // Show "no chat selected" by default
                document.getElementById('chatContainer').style.display = 'none';
                document.getElementById('noChatSelected').style.display = 'block';
            }
            
            async getMessageContacts(userId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['messages'], 'readonly');
                    const store = transaction.objectStore('messages');
                    
                    // Get all messages where the user is either sender or receiver
                    const request = store.getAll();
                    
                    request.onsuccess = async (e) => {
                        const allMessages = e.target.result;
                        
                        // Filter messages involving the current user
                        const userMessages = allMessages.filter(msg => 
                            msg.senderId === userId || msg.receiverId === userId
                        );
                        
                        // Get unique contact IDs
                        const contactIds = [...new Set(
                            userMessages.map(msg => 
                                msg.senderId === userId ? msg.receiverId : msg.senderId
                            )
                        )];
                        
                        // Get contact details and last message info
                        const contacts = await Promise.all(
                            contactIds.map(async contactId => {
                                const user = await this.getUserById(contactId);
                                if (!user) return null;
                                
                                // Get messages with this contact
                                const messagesWithContact = userMessages.filter(msg => 
                                    msg.senderId === contactId || msg.receiverId === contactId
                                ).sort((a, b) => b.timestamp - a.timestamp);
                                
                                const lastMessage = messagesWithContact[0];
                                const unreadCount = messagesWithContact.filter(msg => 
                                    msg.receiverId === userId && !msg.read
                                ).length;
                                
                                return {
                                    userId: contactId,
                                    username: user.username,
                                    fullName: user.fullName,
                                    profilePicture: user.profilePicture,
                                    lastMessage: lastMessage?.content,
                                    lastMessageTime: lastMessage?.timestamp,
                                    unreadCount
                                };
                            })
                        );
                        
                        // Filter out null contacts and sort by last message time
                        const validContacts = contacts.filter(c => c !== null)
                            .sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0));
                        
                        resolve(validContacts);
                    };
                    
                    request.onerror = () => reject(new Error("Failed to get message contacts"));
                });
            }
            
            async getUserById(userId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['users'], 'readonly');
                    const store = transaction.objectStore('users');
                    
                    const request = store.get(userId);
                    
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = () => reject(new Error("Failed to get user by ID"));
                });
            }
            
            async showChat(userId) {
                this.showLoading("Loading chat...");
                
                try {
                    const user = await this.getUserById(userId);
                    if (!user) {
                        this.showError('User not found');
                        return;
                    }
                    
                    // Set current chat user
                    this.currentChatUserId = userId;
                    
                    // Update chat header
                    document.getElementById('chatRecipientName').textContent = 
                        user.username || user.fullName;
                    
                    // Render messages
                    await this.renderChatMessages(userId);
                    
                    // Mark messages as read
                    await this.markMessagesAsRead(userId);
                    
                    // Update unread count
                    this.updateUnreadCount();
                    
                    // Show chat container
                    document.getElementById('chatContainer').style.display = 'block';
                    document.getElementById('noChatSelected').style.display = 'none';
                    
                    // Scroll to bottom of chat
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } catch (error) {
                    console.error("Error showing chat:", error);
                    this.showError('Failed to load chat');
                } finally {
                    this.hideLoading();
                }
            }
            
            async renderChatMessages(userId) {
                if (!this.currentUser) return;
                
                const messages = await this.getMessagesBetweenUsers(this.currentUser.id, userId);
                const container = document.getElementById('chatMessages');
                
                if (messages.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted">No messages yet. Start the conversation!</p>';
                    return;
                }
                
                let html = '';
                let lastDate = null;
                
                messages.forEach(msg => {
                    const messageDate = new Date(msg.timestamp).toLocaleDateString();
                    const messageTime = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    // Add date separator if date changed
                    if (messageDate !== lastDate) {
                        html += `<div class="text-center text-muted small my-2">${messageDate}</div>`;
                        lastDate = messageDate;
                    }
                    
                    const isCurrentUser = msg.senderId === this.currentUser.id;
                    const profilePic = isCurrentUser ? 
                        (this.currentUser.profilePicture ? `https://ipfs.io/ipfs/${this.currentUser.profilePicture}` : 'https://via.placeholder.com/40') :
                        (msg.senderProfilePicture ? `https://ipfs.io/ipfs/${msg.senderProfilePicture}` : 'https://via.placeholder.com/40');
                    
                    html += `
                        <div class="d-flex mb-3 ${isCurrentUser ? 'justify-content-end' : 'justify-content-start'}">
                            ${!isCurrentUser ? `
                                <img src="${profilePic}" class="rounded-circle mr-2" width="40" height="40">
                            ` : ''}
                            <div>
                                <div class="p-3 rounded ${isCurrentUser ? 'bg-primary text-white' : 'bg-light'}">
                                    ${msg.content}
                                </div>
                                <small class="text-muted d-block text-${isCurrentUser ? 'right' : 'left'}">${messageTime}</small>
                            </div>
                            ${isCurrentUser ? `
                                <img src="${profilePic}" class="rounded-circle ml-2" width="40" height="40">
                            ` : ''}
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
            
            async getMessagesBetweenUsers(userId1, userId2) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['messages'], 'readonly');
                    const store = transaction.objectStore('messages');
                    
                    const request = store.getAll();
                    
                    request.onsuccess = async (e) => {
                        const allMessages = e.target.result;
                        
                        // Filter messages between the two users
                        const messages = allMessages.filter(msg => 
                            (msg.senderId === userId1 && msg.receiverId === userId2) ||
                            (msg.senderId === userId2 && msg.receiverId === userId1)
                        ).sort((a, b) => a.timestamp - b.timestamp);
                        
                        // Get sender details for each message
                        const messagesWithDetails = await Promise.all(
                            messages.map(async msg => {
                                if (msg.senderId === userId1) {
                                    return {
                                        ...msg,
                                        senderProfilePicture: this.currentUser.profilePicture
                                    };
                                } else {
                                    const sender = await this.getUserById(msg.senderId);
                                    return {
                                        ...msg,
                                        senderProfilePicture: sender?.profilePicture
                                    };
                                }
                            })
                        );
                        
                        resolve(messagesWithDetails);
                    };
                    
                    request.onerror = () => reject(new Error("Failed to get messages between users"));
                });
            }
            
            async markMessagesAsRead(userId) {
                if (!this.currentUser) return;
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['messages'], 'readwrite');
                    const store = transaction.objectStore('messages');
                    const index = store.index('receiverId');
                    
                    const request = index.getAll(this.currentUser.id);
                    
                    request.onsuccess = async (e) => {
                        const messages = e.target.result.filter(msg => 
                            msg.senderId === userId && !msg.read
                        );
                        
                        if (messages.length === 0) {
                            resolve();
                            return;
                        }
                        
                        // Update each message
                        const updatePromises = messages.map(msg => {
                            msg.read = true;
                            return new Promise((res, rej) => {
                                const updateRequest = store.put(msg);
                                updateRequest.onsuccess = () => res();
                                updateRequest.onerror = () => rej();
                            });
                        });
                        
                        try {
                            await Promise.all(updatePromises);
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    };
                    
                    request.onerror = () => reject(new Error("Failed to mark messages as read"));
                });
            }
            
            async sendMessage() {
                if (!this.currentUser || !this.currentChatUserId) return;
                
                const messageInput = document.getElementById('messageInput');
                const content = messageInput.value.trim();
                
                if (!content) return;
                
                // Create message object
                const message = {
                    id: this.generateId(),
                    senderId: this.currentUser.id,
                    receiverId: this.currentChatUserId,
                    content,
                    read: false,
                    timestamp: Date.now()
                };
                
                try {
                    // Save message to database
                    await this.saveMessage(message);
                    
                    // Broadcast message to network
                    await this.broadcastData('message', message);
                    
                    // Clear input
                    messageInput.value = '';
                    
                    // Refresh chat
                    await this.renderChatMessages(this.currentChatUserId);
                    
                    // Scroll to bottom
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } catch (error) {
                    console.error("Error sending message:", error);
                    this.showError('Failed to send message');
                }
            }
            
            async saveMessage(message) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['messages'], 'readwrite');
                    const store = transaction.objectStore('messages');
                    
                    const request = store.put(message);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(new Error("Failed to save message"));
                });
            }
            
            async updateUnreadCount() {
                if (!this.currentUser) return;
                
                const unreadCount = await this.getUnreadMessageCount(this.currentUser.id);
                
                document.getElementById('unreadCount').textContent = unreadCount;
                document.getElementById('notificationCount').textContent = unreadCount;
                
                if (unreadCount > 0) {
                    document.getElementById('notificationCount').style.display = 'flex';
                } else {
                    document.getElementById('notificationCount').style.display = 'none';
                }
            }
            
            async getUnreadMessageCount(userId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['messages'], 'readonly');
                    const store = transaction.objectStore('messages');
                    const index = store.index('receiverId');
                    
                    const request = index.getAll(userId);
                    
                    request.onsuccess = (e) => {
                        const messages = e.target.result;
                        const unread = messages.filter(msg => !msg.read).length;
                        resolve(unread);
                    };
                    
                    request.onerror = () => reject(new Error("Failed to get unread message count"));
                });
            }
            
            async renderNetworkMembers() {
                const members = await this.getAllUsers();
                const container = document.getElementById('networkMembers');
                
                if (members.length === 0) {
                    container.innerHTML = '<p>No members found.</p>';
                    return;
                }
                
                // Filter out current user
                const otherMembers = members.filter(m => m.id !== this.currentUser?.id);
                
                let html = '<div class="row">';
                otherMembers.forEach(member => {
                    const isOnline = this.peers.has(member.id) && this.peers.get(member.id).connected;
                    const isNearby = false; // TODO: Implement location-based proximity
                    
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <img src="${member.profilePicture ? `https://ipfs.io/ipfs/${member.profilePicture}` : 'https://via.placeholder.com/50'}" 
                                             class="rounded-circle mr-3" width="50" height="50">
                                        <div>
                                            <h5 class="mb-0">
                                                ${member.username || member.fullName}
                                                <span class="online-status ${isOnline ? 'online' : 'offline'}"></span>
                                                ${isNearby ? '<span class="nearby-badge">Nearby</span>' : ''}
                                            </h5>
                                            <small class="text-muted">${member.profession || 'No profession specified'}</small>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <button class="btn btn-sm btn-outline message-member-btn mr-2" data-user-id="${member.id}">
                                            <i class="fas fa-envelope"></i> Message
                                        </button>
                                        <button class="btn btn-sm btn-outline view-profile-btn" data-user-id="${member.id}">
                                            <i class="fas fa-user"></i> Profile
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
                
                // Add event listeners to buttons
                document.querySelectorAll('.message-member-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const userId = btn.getAttribute('data-user-id');
                        this.showChat(userId);
                        this.showSection('messages');
                    });
                });
                
                document.querySelectorAll('.view-profile-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const userId = btn.getAttribute('data-user-id');
                        this.showUserProfile(userId);
                    });
                });
            }
            
            async getAllUsers() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['users'], 'readonly');
                    const store = transaction.objectStore('users');
                    
                    const request = store.getAll();
                    
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = () => reject(new Error("Failed to get all users"));
                });
            }
            
            async showUserProfile(userId) {
                // TODO: Implement user profile view
                alert(`Showing profile for user ${userId}`);
            }
            
            async renderUserCompanies() {
                if (!this.currentUser) return;
                
                const companies = await this.getUserCompanies(this.currentUser.id);
                const container = document.getElementById('companiesList');
                
                if (companies.length === 0) {
                    container.innerHTML = '<p>You haven\'t registered any companies yet.</p>';
                    return;
                }
                
                let html = '<div class="row">';
                companies.forEach(company => {
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        ${company.logo ? `
                                            <img src="https://ipfs.io/ipfs/${company.logo}" 
                                                 class="rounded mr-3" width="60" height="60">
                                        ` : ''}
                                        <div>
                                            <h5 class="mb-0">
                                                ${company.name}
                                                ${company.blueTick ? '<i class="fas fa-check-circle blue-tick"></i>' : ''}
                                            </h5>
                                            <small class="text-muted">${company.location || 'No location specified'}</small>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <button class="btn btn-sm btn-primary edit-company-btn mr-2" data-company-id="${company.id}">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        ${!company.blueTick ? `
                                            <button class="btn btn-sm btn-success request-blue-tick-btn" data-company-id="${company.id}">
                                                <i class="fas fa-check-circle"></i> Request Blue Tick
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
                
                // Add event listeners to buttons
                document.querySelectorAll('.edit-company-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const companyId = btn.getAttribute('data-company-id');
                        this.showCompanyModal(companyId);
                    });
                });
                
                document.querySelectorAll('.request-blue-tick-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const companyId = btn.getAttribute('data-company-id');
                        this.requestBlueTick(companyId);
                    });
                });
            }
            
            async getUserCompanies(userId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['companies'], 'readonly');
                    const store = transaction.objectStore('companies');
                    const index = store.index('ownerId');
                    
                    const request = index.getAll(userId);
                    
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = () => reject(new Error("Failed to get user companies"));
                });
            }
            
            async showCompanyModal(companyId = null) {
                const modal = document.getElementById('companyModal');
                const form = document.getElementById('companyForm');
                
                if (companyId) {
                    // Edit existing company
                    document.getElementById('companyModalTitle').textContent = 'Edit Company';
                    
                    const company = await this.getCompanyById(companyId);
                    if (!company) return;
                    
                    // Populate form
                    form.reset();
                    document.getElementById('companyId').value = company.id;
                    document.getElementById('companyName').value = company.name;
                    document.getElementById('companyDescription').value = company.description || '';
                    document.getElementById('companyWebsite').value = company.website || '';
                    document.getElementById('companyLocation').value = company.location || '';
                    document.getElementById('requestBlueTick').checked = false;
                    
                    // Show logo if exists
                    const logoPreview = document.getElementById('companyLogoPreview');
                    if (company.logo) {
                        logoPreview.src = `https://ipfs.io/ipfs/${company.logo}`;
                        logoPreview.style.display = 'block';
                    } else {
                        logoPreview.style.display = 'none';
                    }
                } else {
                    // Add new company
                    document.getElementById('companyModalTitle').textContent = 'Add Company';
                    form.reset();
                    document.getElementById('companyId').value = '';
                    document.getElementById('companyLogoPreview').style.display = 'none';
                }
                
                this.showModal('companyModal');
            }
            
            async getCompanyById(companyId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['companies'], 'readonly');
                    const store = transaction.objectStore('companies');
                    
                    const request = store.get(companyId);
                    
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = () => reject(new Error("Failed to get company by ID"));
                });
            }
            
            async saveCompany() {
                const form = document.getElementById('companyForm');
                const companyId = document.getElementById('companyId').value;
                const name = document.getElementById('companyName').value.trim();
                const description = document.getElementById('companyDescription').value.trim();
                const website = document.getElementById('companyWebsite').value.trim();
                const location = document.getElementById('companyLocation').value.trim();
                const requestBlueTick = document.getElementById('requestBlueTick').checked;
                
                if (!name) {
                    this.showError('Company name is required');
                    return;
                }
                
                this.showLoading("Saving company...");
                
                try {
                    let company;
                    
                    if (companyId) {
                        // Update existing company
                        company = await this.getCompanyById(companyId);
                        if (!company) {
                            this.showError('Company not found');
                            return;
                        }
                        
                        company.name = name;
                        company.description = description;
                        company.website = website;
                        company.location = location;
                        company.updatedAt = Date.now();
                    } else {
                        // Create new company
                        company = {
                            id: this.generateId(),
                            name,
                            description,
                            website,
                            location,
                            ownerId: this.currentUser.id,
                            blueTick: false,
                            logo: '',
                            createdAt: Date.now(),
                            updatedAt: Date.now()
                        };
                    }
                    
                    // Handle logo upload
                    const logoInput = document.getElementById('companyLogoInput');
                    if (logoInput.files.length > 0) {
                        const file = logoInput.files[0];
                        const fileBuffer = await this.readFileAsBuffer(file);
                        const cid = await this.ipfs.add(fileBuffer);
                        company.logo = cid.path;
                    }
                    
                    // Save company to database
                    await this.saveCompanyToDb(company);
                    
                    // Broadcast company update
                    await this.broadcastData('company', company);
                    
                    // Request blue tick if selected
                    if (requestBlueTick && !company.blueTick) {
                        await this.requestBlueTick(company.id);
                    }
                    
                    // Show success message
                    this.showSuccess(companyId ? 'Company updated successfully!' : 'Company added successfully!');
                    
                    // Close modal and refresh companies list
                    this.closeModal('companyModal');
                    this.renderUserCompanies();
                    
                    // Update company select in job post form
                    this.renderCompanySelect();
                } catch (error) {
                    console.error("Error saving company:", error);
                    this.showError('Failed to save company. Please try again.');
                } finally {
                    this.hideLoading();
                }
            }
            
            async saveCompanyToDb(company) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['companies'], 'readwrite');
                    const store = transaction.objectStore('companies');
                    
                    const request = store.put(company);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(new Error("Failed to save company"));
                });
            }
            
            async renderCompanySelect() {
                if (!this.currentUser) return;
                
                const companies = await this.getUserCompanies(this.currentUser.id);
                const select = document.getElementById('jobCompany');
                
                // Clear existing options except the first two
                while (select.options.length > 2) {
                    select.remove(2);
                }
                
                // Add companies
                companies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.name;
                    option.textContent = company.name;
                    select.appendChild(option);
                });
            }
            
            async requestBlueTick(companyId) {
                if (!confirm('Request blue tick verification for this company?')) return;
                
                this.showLoading("Requesting blue tick...");
                
                try {
                    const company = await this.getCompanyById(companyId);
                    if (!company) {
                        this.showError('Company not found');
                        return;
                    }
                    
                    // Check if request already exists
                    const existingRequest = await this.getBlueTickRequest(companyId);
                    if (existingRequest) {
                        this.showError('Blue tick request already exists for this company');
                        return;
                    }
                    
                    // Create request
                    const request = {
                        id: this.generateId(),
                        companyId,
                        companyName: company.name,
                        userId: this.currentUser.id,
                        userName: this.currentUser.username || this.currentUser.fullName,
                        status: 'pending',
                        createdAt: Date.now(),
                        updatedAt: Date.now()
                    };
                    
                    // Save request to database
                    await this.saveBlueTickRequest(request);
                    
                    // Broadcast request to network (admins will receive it)
                    await this.broadcastData('blueTickRequest', request);
                    
                    // Show success message
                    this.showSuccess('Blue tick request submitted successfully! Admins will review your request.');
                    
                    // Refresh companies list
                    this.renderUserCompanies();
                } catch (error) {
                    console.error("Error requesting blue tick:", error);
                    this.showError('Failed to request blue tick. Please try again.');
                } finally {
                    this.hideLoading();
                }
            }
            
            async getBlueTickRequest(companyId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['blueTickRequests'], 'readonly');
                    const store = transaction.objectStore('blueTickRequests');
                    const index = store.index('companyId');
                    
                    const request = index.get(companyId);
                    
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = () => reject(new Error("Failed to get blue tick request"));
                });
            }
            
            async saveBlueTickRequest(request) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['blueTickRequests'], 'readwrite');
                    const store = transaction.objectStore('blueTickRequests');
                    
                    const request = store.put(request);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(new Error("Failed to save blue tick request"));
                });
            }
            
            async renderAdminUsers() {
                if (!this.isAdmin) return;
                
                const users = await this.getAllUsers();
                const container = document.getElementById('adminUsersList');
                
                if (users.length === 0) {
                    container.innerHTML = '<p>No users found.</p>';
                    return;
                }
                
                let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr>' +
                    '<th>Name</th><th>Username</th><th>Email</th><th>Phone</th><th>Status</th><th>Actions</th>' +
                    '</tr></thead><tbody>';
                
                users.forEach(user => {
                    const isOnline = this.peers.has(user.id) && this.peers.get(user.id).connected;
                    
                    html += `
                        <tr>
                            <td>${user.fullName || 'N/A'}</td>
                            <td>${user.username || 'N/A'}</td>
                            <td>${user.email || 'N/A'}</td>
                            <td>${user.phone || 'N/A'}</td>
                            <td>
                                <span class="badge ${isOnline ? 'badge-success' : 'badge-secondary'}">
                                    ${isOnline ? 'Online' : 'Offline'}
                                </span>
                                ${user.isAdmin ? '<span class="badge badge-primary ml-1">Admin</span>' : ''}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline view-user-btn mr-1" data-user-id="${user.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${!user.isAdmin ? `
                                    <button class="btn btn-sm btn-outline make-admin-btn mr-1" data-user-id="${user.id}">
                                        <i class="fas fa-shield-alt"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline ban-user-btn" data-user-id="${user.id}">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
                
                // Add event listeners to buttons
                document.querySelectorAll('.view-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const userId = btn.getAttribute('data-user-id');
                        this.showUserProfile(userId);
                    });
                });
                
                document.querySelectorAll('.make-admin-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const userId = btn.getAttribute('data-user-id');
                        this.makeAdmin(userId);
                    });
                });
                
                document.querySelectorAll('.ban-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const userId = btn.getAttribute('data-user-id');
                        this.banUser(userId);
                    });
                });
            }
            
            async makeAdmin(userId) {
                if (!confirm('Make this user an admin?')) return;
                
                this.showLoading("Updating user...");
                
                try {
                    const user = await this.getUserById(userId);
                    if (!user) {
                        this.showError('User not found');
                        return;
                    }
                    
                    if (user.isAdmin) {
                        this.showError('User is already an admin');
                        return;
                    }
                    
                    // Update user
                    user.isAdmin = true;
                    user.updatedAt = Date.now();
                    
                    // Save to database
                    await this.saveUser(user);
                    
                    // Broadcast update
                    await this.broadcastData('user', user);
                    
                    // Show success message
                    this.showSuccess('User is now an admin');
                    
                    // Refresh admin users list
                    this.renderAdminUsers();
                } catch (error) {
                    console.error("Error making user admin:", error);
                    this.showError('Failed to make user admin');
                } finally {
                    this.hideLoading();
                }
            }
            
            async banUser(userId) {
                if (!confirm('Ban this user? They will not be able to access the system for 1 year.')) return;
                
                this.showLoading("Banning user...");
                
                try {
                    // TODO: Implement user banning
                    // This would involve adding a bannedUntil field to the user and checking it on login
                    
                    // For now, just show a success message
                    this.showSuccess('User has been banned for 1 year');
                    
                    // Refresh admin users list
                    this.renderAdminUsers();
                } catch (error) {
                    console.error("Error banning user:", error);
                    this.showError('Failed to ban user');
                } finally {
                    this.hideLoading();
                }
            }
            
            async renderAdminReports() {
                if (!this.isAdmin) return;
                
                const reports = await this.getAllReports();
                const container = document.getElementById('adminReportsList');
                
                if (reports.length === 0) {
                    container.innerHTML = '<p>No reports found.</p>';
                    return;
                }
                
                let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr>' +
                    '<th>Job</th><th>Reporter</th><th>Reason</th><th>Status</th><th>Date</th><th>Actions</th>' +
                    '</tr></thead><tbody>';
                
                reports.forEach(report => {
                    html += `
                        <tr>
                            <td>${report.jobTitle || 'Unknown Job'}</td>
                            <td>${report.reporterName || 'Unknown User'}</td>
                            <td>${report.reason}</td>
                            <td>
                                <span class="badge ${this.getReportStatusClass(report.status)}">
                                    ${this.getReportStatusText(report.status)}
                                </span>
                            </td>
                            <td>${new Date(report.createdAt).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-sm btn-outline view-report-btn mr-1" data-report-id="${report.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${report.status === 'pending' ? `
                                    <button class="btn btn-sm btn-outline approve-report-btn mr-1" data-report-id="${report.id}">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline reject-report-btn" data-report-id="${report.id}">
                                        <i class="fas fa-times"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
                
                // Add event listeners to buttons
                document.querySelectorAll('.view-report-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const reportId = btn.getAttribute('data-report-id');
                        this.viewReport(reportId);
                    });
                });
                
                document.querySelectorAll('.approve-report-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const reportId = btn.getAttribute('data-report-id');
                        this.approveReport(reportId);
                    });
                });
                
                document.querySelectorAll('.reject-report-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const reportId = btn.getAttribute('data-report-id');
                        this.rejectReport(reportId);
                    });
                });
            }
            
            async getAllReports() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['reports'], 'readonly');
                    const store = transaction.objectStore('reports');
                    
                    const request = store.getAll();
                    
                    request.onsuccess = async (e) => {
                        const reports = e.target.result;
                        
                        // Get job and reporter details for each report
                        const reportsWithDetails = await Promise.all(
                            reports.map(async report => {
                                const job = await this.getJobById(report.jobId);
                                const reporter = await this.getUserById(report.reporterId);
                                
                                return {
                                    ...report,
                                    jobTitle: job?.title,
                                    reporterName: reporter?.username || reporter?.fullName
                                };
                            })
                        );
                        
                        // Sort by creation date (newest first)
                        reportsWithDetails.sort((a, b) => b.createdAt - a.createdAt);
                        
                        resolve(reportsWithDetails);
                    };
                    
                    request.onerror = () => reject(new Error("Failed to get all reports"));
                });
            }
            
            getReportStatusClass(status) {
                switch (status) {
                    case 'pending': return 'badge-warning';
                    case 'approved': return 'badge-success';
                    case 'rejected': return 'badge-danger';
                    default: return 'badge-light';
                }
            }
            
            getReportStatusText(status) {
                switch (status) {
                    case 'pending': return 'Pending';
                    case 'approved': return 'Approved';
                    case 'rejected': return 'Rejected';
                    default: return status;
                }
            }
            
            async viewReport(reportId) {
                const report = await this.getReportById(reportId);
                if (!report) return;
                
                // TODO: Implement report viewing modal
                alert(`Viewing report: ${report.reason}\n\nDetails: ${report.details}`);
            }
            
            async getReportById(reportId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['reports'], 'readonly');
                    const store = transaction.objectStore('reports');
                    
                    const request = store.get(reportId);
                    
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = () => reject(new Error("Failed to get report by ID"));
                });
            }
            
            async approveReport(reportId) {
                if (!confirm('Approve this report? The job will be hidden and the poster will be notified.')) return;
                
                this.showLoading("Processing report...");
                
                try {
                    const report = await this.getReportById(reportId);
                    if (!report) {
                        this.showError('Report not found');
                        return;
                    }
                    
                    if (report.status !== 'pending') {
                        this.showError('Report has already been processed');
                        return;
                    }
                    
                    // Update report status
                    report.status = 'approved';
                    report.updatedAt = Date.now();
                    report.adminId = this.currentUser.id;
                    
                    // Save to database
                    await this.saveReport(report);
                    
                    // Broadcast update
                    await this.broadcastData('report', report);
                    
                    // Hide the reported job
                    const job = await this.getJobById(report.jobId);
                    if (job) {
                        job.hidden = true;
                        job.updatedAt = Date.now();
                        
                        await this.saveJob(job);
                        await this.broadcastData('job', job);
                    }
                    
                    // Show success message
                    this.showSuccess('Report approved and job hidden');
                    
                    // Refresh reports list
                    this.renderAdminReports();
                } catch (error) {
                    console.error("Error approving report:", error);
                    this.showError('Failed to approve report');
                } finally {
                    this.hideLoading();
                }
            }
            
            async saveReport(report) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['reports'], 'readwrite');
                    const store = transaction.objectStore('reports');
                    
                    const request = store.put(report);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(new Error("Failed to save report"));
                });
            }
            
            async rejectReport(reportId) {
                if (!confirm('Reject this report? The job will remain visible.')) return;
                
                this.showLoading("Processing report...");
                
                try {
                    const report = await this.getReportById(reportId);
                    if (!report) {
                        this.showError('Report not found');
                        return;
                    }
                    
                    if (report.status !== 'pending') {
                        this.showError('Report has already been processed');
                        return;
                    }
                    
                    // Update report status
                    report.status = 'rejected';
                    report.updatedAt = Date.now();
                    report.adminId = this.currentUser.id;
                    
                    // Save to database
                    await this.saveReport(report);
                    
                    // Broadcast update
                    await this.broadcastData('report', report);
                    
                    // Show success message
                    this.showSuccess('Report rejected');
                    
                    // Refresh reports list
                    this.renderAdminReports();
                } catch (error) {
                    console.error("Error rejecting report:", error);
                    this.showError('Failed to reject report');
                } finally {
                    this.hideLoading();
                }
            }
            
            async renderAdminBlueTickRequests() {
                if (!this.isAdmin) return;
                
                const requests = await this.getBlueTickRequests();
                const container = document.getElementById('adminBlueTicksList');
                
                if (requests.length === 0) {
                    container.innerHTML = '<p>No blue tick requests found.</p>';
                    return;
                }
                
                let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr>' +
                    '<th>Company</th><th>Requested By</th><th>Status</th><th>Date</th><th>Actions</th>' +
                    '</tr></thead><tbody>';
                
                requests.forEach(request => {
                    html += `
                        <tr>
                            <td>${request.companyName}</td>
                            <td>${request.userName}</td>
                            <td>
                                <span class="badge ${this.getRequestStatusClass(request.status)}">
                                    ${this.getRequestStatusText(request.status)}
                                </span>
                            </td>
                            <td>${new Date(request.createdAt).toLocaleDateString()}</td>
                            <td>
                                ${request.status === 'pending' ? `
                                    <button class="btn btn-sm btn-outline approve-blue-tick-btn mr-1" data-request-id="${request.id}">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline reject-blue-tick-btn" data-request-id="${request.id}">
                                        <i class="fas fa-times"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
                
                // Add event listeners to buttons
                document.querySelectorAll('.approve-blue-tick-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const requestId = btn.getAttribute('data-request-id');
                        this.approveBlueTick(requestId);
                    });
                });
                
                document.querySelectorAll('.reject-blue-tick-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const requestId = btn.getAttribute('data-request-id');
                        this.rejectBlueTick(requestId);
                    });
                });
            }
            
            async getBlueTickRequests() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['blueTickRequests'], 'readonly');
                    const store = transaction.objectStore('blueTickRequests');
                    
                    const request = store.getAll();
                    
                    request.onsuccess = (e) => {
                        const requests = e.target.result;
                        
                        // Sort by creation date (newest first)
                        requests.sort((a, b) => b.createdAt - a.createdAt);
                        
                        resolve(requests);
                    };
                    
                    request.onerror = () => reject(new Error("Failed to get blue tick requests"));
                });
            }
            
            getRequestStatusClass(status) {
                switch (status) {
                    case 'pending': return 'badge-warning';
                    case 'approved': return 'badge-success';
                    case 'rejected': return 'badge-danger';
                    default: return 'badge-light';
                }
            }
            
            getRequestStatusText(status) {
                switch (status) {
                    case 'pending': return 'Pending';
                    case 'approved': return 'Approved';
                    case 'rejected': return 'Rejected';
                    default: return status;
                }
            }
            
            async approveBlueTick(requestId) {
                if (!confirm('Approve this blue tick request? The company will receive a blue tick on all its job posts.')) return;
                
                this.showLoading("Processing request...");
                
                try {
                    const request = await this.getBlueTickRequestById(requestId);
                    if (!request) {
                        this.showError('Request not found');
                        return;
                    }
                    
                    if (request.status !== 'pending') {
                        this.showError('Request has already been processed');
                        return;
                    }
                    
                    // Get the company
                    const company = await this.getCompanyById(request.companyId);
                    if (!company) {
                        this.showError('Company not found');
                        return;
                    }
                    
                    // Update request status
                    request.status = 'approved';
                    request.updatedAt = Date.now();
                    request.adminId = this.currentUser.id;
                    
                    // Update company blue tick status
                    company.blueTick = true;
                    company.updatedAt = Date.now();
                    
                    // Save to database
                    await this.saveBlueTickRequest(request);
                    await this.saveCompanyToDb(company);
                    
                    // Broadcast updates
                    await this.broadcastData('blueTickRequest', request);
                    await this.broadcastData('company', company);
                    
                    // Update all jobs for this company to show blue tick
                    const jobs = await this.getJobsByCompany(company.name);
                    for (const job of jobs) {
                        job.blueTick = true;
                        job.updatedAt = Date.now();
                        
                        await this.saveJob(job);
                        await this.broadcastData('job', job);
                    }
                    
                    // Show success message
                    this.showSuccess('Blue tick approved for company');
                    
                    // Refresh requests list
                    this.renderAdminBlueTickRequests();
                } catch (error) {
                    console.error("Error approving blue tick:", error);
                    this.showError('Failed to approve blue tick');
                } finally {
                    this.hideLoading();
                }
            }
            
            async getBlueTickRequestById(requestId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['blueTickRequests'], 'readonly');
                    const store = transaction.objectStore('blueTickRequests');
                    
                    const request = store.get(requestId);
                    
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = () => reject(new Error("Failed to get blue tick request by ID"));
                });
            }
            
            async getJobsByCompany(companyName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['jobs'], 'readonly');
                    const store = transaction.objectStore('jobs');
                    const index = store.index('company');
                    
                    const request = index.getAll(companyName);
                    
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = () => reject(new Error("Failed to get jobs by company"));
                });
            }
            
            async rejectBlueTick(requestId) {
                if (!confirm('Reject this blue tick request?')) return;
                
                this.showLoading("Processing request...");
                
                try {
                    const request = await this.getBlueTickRequestById(requestId);
                    if (!request) {
                        this.showError('Request not found');
                        return;
                    }
                    
                    if (request.status !== 'pending') {
                        this.showError('Request has already been processed');
                        return;
                    }
                    
                    // Update request status
                    request.status = 'rejected';
                    request.updatedAt = Date.now();
                    request.adminId = this.currentUser.id;
                    
                    // Save to database
                    await this.saveBlueTickRequest(request);
                    
                    // Broadcast update
                    await this.broadcastData('blueTickRequest', request);
                    
                    // Show success message
                    this.showSuccess('Blue tick request rejected');
                    
                    // Refresh requests list
                    this.renderAdminBlueTickRequests();
                } catch (error) {
                    console.error("Error rejecting blue tick:", error);
                    this.showError('Failed to reject blue tick');
                } finally {
                    this.hideLoading();
                }
            }
            
            async renderAdminSettings() {
                if (!this.isAdmin) return;
                
                const settings = await this.getSystemSettings();
                const container = document.getElementById('adminSettingsForm');
                
                // Populate form
                document.getElementById('appTitle').value = settings.appTitle || 'Skysoft Job Market';
                document.getElementById('systemEmail').value = settings.systemEmail || '';
                document.getElementById('inactivityTimeout').value = settings.inactivityTimeout || 30;
                document.getElementById('defaultCurrency').value = settings.defaultCurrency || 'UGX';
                
                // Render admin inheritance list
                const inheritanceList = document.getElementById('adminInheritanceList');
                inheritanceList.innerHTML = '';
                
                if (settings.adminInheritance && settings.adminInheritance.length > 0) {
                    settings.adminInheritance.forEach((item, index) => {
                        const div = document.createElement('div');
                        div.className = 'd-flex mb-2';
                        div.innerHTML = `
                            <select class="form-control mr-2 inheritance-type" data-index="${index}">
                                <option value="email" ${item.type === 'email' ? 'selected' : ''}>Email</option>
                                <option value="phone" ${item.type === 'phone' ? 'selected' : ''}>Phone</option>
                            </select>
                            <input type="text" class="form-control mr-2 inheritance-value" 
                                   value="${item.value}" data-index="${index}">
                            <button class="btn btn-danger remove-inheritance-btn" data-index="${index}">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        inheritanceList.appendChild(div);
                    });
                }
            }
            
            async getSystemSettings() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['settings'], 'readonly');
                    const store = transaction.objectStore('settings');
                    
                    const request = store.get('systemSettings');
                    
                    request.onsuccess = (e) => resolve(e.target.result?.value || {});
                    request.onerror = () => reject(new Error("Failed to get system settings"));
                });
            }
            
            async saveSystemSettings() {
                const settings = {
                    appTitle: document.getElementById('appTitle').value.trim(),
                    systemEmail: document.getElementById('systemEmail').value.trim(),
                    inactivityTimeout: parseInt(document.getElementById('inactivityTimeout').value) || 30,
                    defaultCurrency: document.getElementById('defaultCurrency').value,
                    adminInheritance: this.getAdminInheritanceFromForm()
                };
                
                this.showLoading("Saving settings...");
                
                try {
                    // Save to database
                    await this.saveSettingsToDb(settings);
                    
                    // Update app title in UI
                    document.title = settings.appTitle;
                    document.querySelector('.sidebar-header h3').textContent = settings.appTitle;
                    
                    // Update inactivity timeout
                    this.inactivityTimeout = settings.inactivityTimeout * 60 * 1000;
                    this.resetInactivityTimer();
                    
                    // Show success message
                    this.showSuccess('Settings saved successfully');
                } catch (error) {
                    console.error("Error saving settings:", error);
                    this.showError('Failed to save settings');
                } finally {
                    this.hideLoading();
                }
            }
            
            getAdminInheritanceFromForm() {
                const inheritance = [];
                
                document.querySelectorAll('.inheritance-type').forEach(select => {
                    const index = select.getAttribute('data-index');
                    const type = select.value;
                    const value = document.querySelector(`.inheritance-value[data-index="${index}"]`).value.trim();
                    
                    if (value) {
                        inheritance.push({ type, value });
                    }
                });
                
                return inheritance;
            }
            
            async saveSettingsToDb(settings) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['settings'], 'readwrite');
                    const store = transaction.objectStore('settings');
                    
                    const request = store.put({ key: 'systemSettings', value: settings });
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(new Error("Failed to save settings"));
                });
            }
            
            async sendBroadcastMessage() {
                const messageType = document.getElementById('broadcastType').value;
                const message = document.getElementById('broadcastMessage').value.trim();
                
                if (!message) {
                    this.showError('Please enter a message');
                    return;
                }
                
                this.showLoading("Sending broadcast...");
                
                try {
                    // Create broadcast object
                    const broadcast = {
                        id: this.generateId(),
                        type: messageType,
                        message,
                        senderId: this.currentUser.id,
                        senderName: this.currentUser.username || this.currentUser.fullName,
                        timestamp: Date.now()
                    };
                    
                    // Save to database (for history)
                    await this.saveBroadcast(broadcast);
                    
                    // Broadcast to all peers
                    await this.broadcastData('broadcast', broadcast);
                    
                    // Show success message
                    this.showSuccess('Broadcast sent successfully');
                    
                    // Clear form
                    document.getElementById('broadcastMessage').value = '';
                } catch (error) {
                    console.error("Error sending broadcast:", error);
                    this.showError('Failed to send broadcast');
                } finally {
                    this.hideLoading();
                }
            }
            
            async saveBroadcast(broadcast) {
                // TODO: Implement broadcast history storage if needed
            }
            
            showBroadcastMessage(message, messageType) {
                const broadcastMessage = document.getElementById('broadcastMessage');
                const broadcastContent = document.getElementById('broadcastContent');
                
                broadcastContent.textContent = message;
                
                // Set color based on message type
                switch (messageType) {
                    case 'warning':
                        broadcastMessage.style.backgroundColor = 'var(--warning-color)';
                        break;
                    case 'alert':
                        broadcastMessage.style.backgroundColor = 'var(--danger-color)';
                        break;
                    default: // info
                        broadcastMessage.style.backgroundColor = 'var(--primary-color)';
                }
                
                // Show message
                broadcastMessage.classList.add('show');
                
                // Hide after 10 seconds
                setTimeout(() => {
                    broadcastMessage.classList.remove('show');
                }, 10000);
            }
            
            handleProfileAction(action) {
                switch (action) {
                    case 'profile':
                        this.showProfileModal();
                        break;
                    case 'settings':
                        this.showSettingsModal();
                        break;
                    case 'admin':
                        this.showSection('admin');
                        break;
                    case 'logout':
                        this.logout();
                        break;
                }
            }
            
            showProfileModal() {
                if (!this.currentUser) return;
                
                // Populate form with current user data
                document.getElementById('editFullName').value = this.currentUser.fullName || '';
                document.getElementById('editUsername').value = this.currentUser.username || '';
                document.getElementById('editEmail').value = this.currentUser.email || '';
                document.getElementById('editPhone').value = this.currentUser.phone || '';
                document.getElementById('editProfession').value = this.currentUser.profession || '';
                document.getElementById('editJobTitle').value = this.currentUser.jobTitle || '';
                document.getElementById('editWorkplace').value = this.currentUser.workplace || '';
                document.getElementById('editLocation').value = this.currentUser.location || '';
                document.getElementById('editBio').value = this.currentUser.bio || '';
                
                // Show profile picture if exists
                const profilePicPreview = document.getElementById('profilePicturePreview');
                if (this.currentUser.profilePicture) {
                    profilePicPreview.src = `https://ipfs.io/ipfs/${this.currentUser.profilePicture}`;
                } else {
                    profilePicPreview.src = 'https://via.placeholder.com/100';
                }
                
                this.showModal('profileModal');
            }
            
            async saveProfile() {
                if (!this.currentUser) return;
                
                const fullName = document.getElementById('editFullName').value.trim();
                const username = document.getElementById('editUsername').value.trim();
                const email = document.getElementById('editEmail').value.trim();
                const phone = document.getElementById('editPhone').value.trim();
                const profession = document.getElementById('editProfession').value.trim();
                const jobTitle = document.getElementById('editJobTitle').value.trim();
                const workplace = document.getElementById('editWorkplace').value.trim();
                const location = document.getElementById('editLocation').value.trim();
                const bio = document.getElementById('editBio').value.trim();
                
                // Validation
                if (!fullName || !username || !email || !phone) {
                    this.showError('Please fill in all required fields');
                    return;
                }
                
                // Check if username changed and is available
                if (username !== this.currentUser.username) {
                    const usernameAvailable = await this.checkUsernameAvailability(username, true);
                    if (!usernameAvailable) return;
                }
                
                this.showLoading("Saving profile...");
                
                try {
                    // Update user object
                    this.currentUser.fullName = fullName;
                    this.currentUser.username = username;
                    this.currentUser.email = email;
                    this.currentUser.phone = phone;
                    this.currentUser.profession = profession;
                    this.currentUser.jobTitle = jobTitle;
                    this.currentUser.workplace = workplace;
                    this.currentUser.location = location;
                    this.currentUser.bio = bio;
                    this.currentUser.updatedAt = Date.now();
                    
                    // Handle profile picture if uploaded
                    const profilePicInput = document.getElementById('profilePictureInput');
                    if (profilePicInput.files.length > 0) {
                        const file = profilePicInput.files[0];
                        const fileBuffer = await this.readFileAsBuffer(file);
                        const cid = await this.ipfs.add(fileBuffer);
                        this.currentUser.profilePicture = cid.path;
                    }
                    
                    // Save to database
                    await this.saveUser(this.currentUser);
                    
                    // Broadcast update
                    await this.broadcastData('user', this.currentUser);
                    
                    // Update UI
                    this.updateUserProfile();
                    
                    // Show success message
                    this.showSuccess('Profile updated successfully!');
                    
                    // Close modal
                    this.closeModal('profileModal');
                } catch (error) {
                    console.error("Error saving profile:", error);
                    this.showError('Failed to update profile. Please try again.');
                } finally {
                    this.hideLoading();
                }
            }
            
            showSettingsModal() {
                this.showModal('settingsModal');
                
                // TODO: Load current settings
            }
            
            async changePassword() {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (!currentPassword || !newPassword || !confirmPassword) {
                    this.showError('Please fill in all fields');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    this.showError('New passwords do not match');
                    return;
                }
                
                if (newPassword.length < 8) {
                    this.showError('Password must be at least 8 characters');
                    return;
                }
                
                this.showLoading("Changing password...");
                
                try {
                    // Verify current password
                    const match = await this.verifyPassword(currentPassword, this.currentUser.passwordHash);
                    if (!match) {
                        this.showError('Current password is incorrect');
                        return;
                    }
                    
                    // Hash new password
                    const newHash = await this.hashPassword(newPassword);
                    
                    // Update user
                    this.currentUser.passwordHash = newHash;
                    this.currentUser.updatedAt = Date.now();
                    
                    // Save to database
                    await this.saveUser(this.currentUser);
                    
                    // Broadcast update
                    await this.broadcastData('user', this.currentUser);
                    
                    // Show success message
                    this.showSuccess('Password changed successfully!');
                    
                    // Close modal
                    this.closeModal('passwordModal');
                } catch (error) {
                    console.error("Error changing password:", error);
                    this.showError('Failed to change password. Please try again.');
                } finally {
                    this.hideLoading();
                }
            }
            
            async logout() {
                this.showLoading("Logging out...");
                
                try {
                    // Clear current user session
                    await this.clearSession();
                    
                    // Reset state
                    this.currentUser = null;
                    this.isAdmin = false;
                    
                    // Show auth interface
                    this.initUI();
                } catch (error) {
                    console.error("Error logging out:", error);
                    this.showError('Failed to logout. Please try again.');
                } finally {
                    this.hideLoading();
                }
            }
            
            async clearSession() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['settings'], 'readwrite');
                    const store = transaction.objectStore('settings');
                    
                    const request = store.delete('currentUser');
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(new Error("Failed to clear session"));
                });
            }
            
            showModal(modalId) {
                document.getElementById(modalId).classList.add('show');
            }
            
            closeModal(modalId) {
                if (typeof modalId === 'string') {
                    document.getElementById(modalId).classList.remove('show');
                } else if (modalId instanceof Element) {
                    modalId.classList.remove('show');
                }
            }
            
            showLoading(message = "Loading...") {
                document.getElementById('loadingOverlay').style.display = 'flex';
                document.getElementById('loadingText').textContent = message;
            }
            
            hideLoading() {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
            
            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger';
                errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
                
                // Prepend to body
                document.body.insertBefore(errorDiv, document.body.firstChild);
                
                // Remove after 5 seconds
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }
            
            showSuccess(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'alert alert-success';
                successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
                
                // Prepend to body
                document.body.insertBefore(successDiv, document.body.firstChild);
                
                // Remove after 5 seconds
                setTimeout(() => {
                    successDiv.remove();
                }, 5000);
            }
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.skysoftJobMarket = new SkysoftJobMarket();
        });
    </script>
</body>
</html>
