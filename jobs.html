<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Skysoft Job Market</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #sidebar { width: 250px; background-color: #2c3e50; color: white; height: 100vh; position: fixed; }
    #profile { padding: 20px; text-align: center; }
    #profilePicture { width: 80px; height: 80px; border-radius: 50%; }
    #usernameDisplay { display: block; margin-top: 10px; }
    #profileDropdown { margin-top: 10px; }
    #mainContent { margin-left: 250px; padding: 20px; }
  </style>
</head>
<body>
  <div id="loginPage">
    <h2>Login</h2>
    <input type="text" id="loginIdentifier" placeholder="Email, Phone, or Username"><br>
    <input type="password" id="loginPassword" placeholder="Password"><br>
    <button onclick="handleLogin()">Login</button>
    <h2>Register</h2>
    <input type="text" id="regUsername" placeholder="Username"><br>
    <input type="email" id="regEmail" placeholder="Email"><br>
    <input type="text" id="regPhone" placeholder="Phone"><br>
    <input type="password" id="regPassword" placeholder="Password"><br>
    <button onclick="handleRegister()">Register</button>
  </div>

  <div id="dashboard" style="display: none;">
    <aside id="sidebar">
      <div id="profile">
        <img id="profilePicture" src="https://via.placeholder.com/80" alt="Profile Picture">
        <span id="usernameDisplay"></span>
        <div id="profileDropdown">
          <button onclick="editProfile()">Edit Profile</button>
          <button onclick="logoutUser()">Logout</button>
        </div>
      </div>
    </aside>
    <main id="mainContent">
      <h1>Welcome to Skysoft Job Market</h1>
    </main>
  </div>

  <script>
    let inactivityTimer;

    function resetInactivityTimer() {
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => {
        logoutUser();
        alert('Logged out due to inactivity.');
      }, 30 * 60 * 1000);
    }

    ['click', 'mousemove', 'keydown'].forEach(event => {
      document.addEventListener(event, resetInactivityTimer);
    });

    resetInactivityTimer();

    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function initDatabase() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('SkysoftJobMarket', 1);
        request.onupgradeneeded = function (event) {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('users')) {
            const store = db.createObjectStore('users', { keyPath: 'id', autoIncrement: true });
            store.createIndex('email', 'email', { unique: true });
            store.createIndex('phone', 'phone', { unique: true });
            store.createIndex('username', 'username', { unique: true });
          }
        };
        request.onsuccess = event => resolve(event.target.result);
        request.onerror = event => reject(event.target.error);
      });
    }

    async function registerUser(user) {
      const db = await initDatabase();
      const tx = db.transaction('users', 'readwrite');
      const store = tx.objectStore('users');
      const existing = await store.index('email').get(user.email);
      if (existing) throw new Error('Email already registered');
      user.password = await hashPassword(user.password);
      return new Promise((resolve, reject) => {
        const req = store.add(user);
        req.onsuccess = () => resolve();
        req.onerror = () => reject(req.error);
      });
    }

    async function loginUser(identifier, password) {
      const db = await initDatabase();
      const tx = db.transaction('users', 'readonly');
      const store = tx.objectStore('users');
      let index = identifier.includes('@') ? store.index('email') : (/^\d+$/.test(identifier) ? store.index('phone') : store.index('username'));
      return new Promise((resolve, reject) => {
        const req = index.get(identifier);
        req.onsuccess = async () => {
          const user = req.result;
          if (!user) return reject(new Error('User not found'));
          if (user.password !== await hashPassword(password)) return reject(new Error('Incorrect password'));
          localStorage.setItem('currentUser', JSON.stringify(user));
          resolve(user);
        };
        req.onerror = () => reject(req.error);
      });
    }

    async function handleRegister() {
      const user = {
        username: document.getElementById('regUsername').value,
        email: document.getElementById('regEmail').value,
        phone: document.getElementById('regPhone').value,
        password: document.getElementById('regPassword').value
      };
      try {
        await registerUser(user);
        alert('Registration successful');
      } catch (err) {
        alert('Registration failed: ' + err.message);
      }
    }

    async function handleLogin() {
      const id = document.getElementById('loginIdentifier').value;
      const pw = document.getElementById('loginPassword').value;
      try {
        const user = await loginUser(id, pw);
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('usernameDisplay').textContent = user.username;
      } catch (err) {
        alert('Login failed: ' + err.message);
      }
    }

    function logoutUser() {
      localStorage.removeItem('currentUser');
      location.reload();
    }

    function detectLocationAndCurrency() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const res = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
          const data = await res.json();
          const code = data.countryCode;
          const currency = { 'UG': 'UGX' }[code] || 'USD';
          localStorage.setItem('currency', currency);
        });
      }
    }

    detectLocationAndCurrency();
  </script>
</body>
</html>
