<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skysoft Job Market</title>
    <!-- CSS Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/ipfs-core/dist/index.min.js"></script>
    <script src="https://bundle.run/dat-sdk@1.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p/dist/libp2p.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p-webrtc-star/dist/libp2p-webrtc-star.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p-bootstrap/dist/libp2p-bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p-mdns/dist/libp2p-mdns.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peer-id/dist/peer-id.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --border-radius: 5px;
            --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background-color: var(--dark-color);
            color: white;
            padding: 20px 0;
            transition: var(--transition);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h2 {
            color: white;
            font-size: 1.5rem;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
        }

        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .menu-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .menu-item.active {
            background-color: var(--primary-color);
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
            transition: var(--transition);
        }

        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: white;
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            border-radius: var(--border-radius);
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .header-actions {
            display: flex;
            align-items: center;
        }

        .notification-icon {
            position: relative;
            margin-right: 20px;
            cursor: pointer;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-profile {
            display: flex;
            align-items: center;
            cursor: pointer;
            position: relative;
        }

        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }

        .profile-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background-color: white;
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            width: 200px;
            z-index: 100;
            display: none;
        }

        .profile-dropdown.show {
            display: block;
        }

        .dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: var(--transition);
        }

        .dropdown-item:hover {
            background-color: var(--light-color);
        }

        /* Card Styles */
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
        }

        /* Job Card Styles */
        .job-card {
            margin-bottom: 20px;
            position: relative;
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .job-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--dark-color);
        }

        .job-company {
            color: var(--primary-color);
            font-weight: 500;
        }

        .job-location {
            display: flex;
            align-items: center;
            color: #777;
            margin: 5px 0;
        }

        .job-location i {
            margin-right: 5px;
        }

        .job-salary {
            font-weight: 500;
            color: var(--success-color);
            margin: 5px 0;
        }

        .job-deadline {
            color: var(--danger-color);
            font-size: 0.9rem;
        }

        .job-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .job-tags {
            display: flex;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        .tag {
            background-color: var(--light-color);
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8rem;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        /* Login/Signup Page */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--light-color);
        }

        .auth-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 100%;
            max-width: 400px;
            padding: 30px;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .auth-subtitle {
            color: #777;
        }

        .auth-footer {
            text-align: center;
            margin-top: 20px;
        }

        .auth-link {
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 500;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
                overflow: hidden;
            }
            .sidebar-header h2 {
                display: none;
            }
            .menu-item span {
                display: none;
            }
            .menu-item i {
                margin-right: 0;
                font-size: 1.2rem;
            }
            .main-content {
                margin-left: 70px;
            }
        }

        /* Broadcast Message */
        .broadcast-message {
            background-color: var(--warning-color);
            color: white;
            padding: 10px 20px;
            text-align: center;
            position: fixed;
            top: 0;
            left: 250px;
            right: 0;
            z-index: 1000;
            display: none;
        }

        .broadcast-message.show {
            display: block;
        }

        /* Blue Tick */
        .blue-tick {
            color: var(--primary-color);
            margin-left: 5px;
        }

        /* Online Status */
        .online-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success-color);
            margin-left: 5px;
        }

        /* Chat Styles */
        .chat-container {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 1000;
            flex-direction: column;
            max-height: 500px;
        }

        .chat-container.show {
            display: flex;
        }

        .chat-header {
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 15px;
            max-width: 80%;
        }

        .message.sent {
            margin-left: auto;
            text-align: right;
        }

        .message.received {
            margin-right: auto;
        }

        .message-content {
            padding: 10px 15px;
            border-radius: 18px;
            display: inline-block;
        }

        .message.sent .message-content {
            background-color: var(--primary-color);
            color: white;
        }

        .message.received .message-content {
            background-color: var(--light-color);
            color: var(--dark-color);
        }

        .message-time {
            font-size: 0.7rem;
            color: #777;
            margin-top: 5px;
        }

        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-right: 10px;
        }

        .chat-input button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* Interview Room */
        .interview-room {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--dark-color);
            z-index: 2000;
            flex-direction: column;
        }

        .interview-room.show {
            display: flex;
        }

        .video-container {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
        }

        .video-box {
            flex: 1;
            min-width: 300px;
            margin: 10px;
            background-color: #444;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        .video-box video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
        }

        .interview-controls {
            padding: 15px;
            background-color: #333;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .control-btn {
            background-color: #555;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .control-btn.end-call {
            background-color: var(--danger-color);
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Login/Signup Page (Shown by default) -->
    <div class="auth-container" id="authPage">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-title">Skysoft Job Market</div>
                <div class="auth-subtitle">Peer-to-Peer Job Network</div>
            </div>
            <div id="loginForm">
                <div class="form-group">
                    <label class="form-label">Username or Phone Number</label>
                    <input type="text" class="form-control" id="loginUsername" placeholder="Enter username or phone">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" id="loginPassword" placeholder="Enter password">
                </div>
                <button class="btn btn-primary" id="loginBtn" style="width: 100%;">Login</button>
                <div class="auth-footer">
                    Don't have an account? <span class="auth-link" id="showSignup">Sign up</span>
                </div>
            </div>
            <div id="signupForm" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="signupName" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label class="form-label">Username (Unique)</label>
                    <input type="text" class="form-control" id="signupUsername" placeholder="Choose a username">
                    <small id="usernameAvailability"></small>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="signupEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-control" id="signupPhone" placeholder="Enter your phone number">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" id="signupPassword" placeholder="Create password">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" class="form-control" id="signupConfirmPassword" placeholder="Confirm password">
                </div>
                <button class="btn btn-primary" id="signupBtn" style="width: 100%;">Sign Up</button>
                <div class="auth-footer">
                    Already have an account? <span class="auth-link" id="showLogin">Login</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application (Hidden by default) -->
    <div class="container" id="appContainer" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Skysoft Job Market</h2>
            </div>
            <div class="sidebar-menu">
                <div class="menu-item active" id="menuDashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </div>
                <div class="menu-item" id="menuJobs">
                    <i class="fas fa-briefcase"></i>
                    <span>Job Listings</span>
                </div>
                <div class="menu-item" id="menuPostJob">
                    <i class="fas fa-plus-circle"></i>
                    <span>Post a Job</span>
                </div>
                <div class="menu-item" id="menuApplications">
                    <i class="fas fa-file-alt"></i>
                    <span>My Applications</span>
                </div>
                <div class="menu-item" id="menuMessages">
                    <i class="fas fa-envelope"></i>
                    <span>Messages</span>
                </div>
                <div class="menu-item" id="menuProfile">
                    <i class="fas fa-user"></i>
                    <span>My Profile</span>
                </div>
                <div class="menu-item" id="menuAdmin" style="display: none;">
                    <i class="fas fa-shield-alt"></i>
                    <span>Admin Panel</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Broadcast Message -->
            <div class="broadcast-message" id="broadcastMessage">
                <span id="broadcastText"></span>
                <button class="btn btn-sm" style="margin-left: 10px; background-color: white; color: var(--warning-color);" id="closeBroadcast">Close</button>
            </div>

            <!-- Header -->
            <div class="header">
                <div class="header-title" id="pageTitle">Dashboard</div>
                <div class="header-actions">
                    <div class="notification-icon" id="notificationIcon">
                        <i class="fas fa-bell"></i>
                        <div class="notification-badge" id="notificationBadge" style="display: none;">0</div>
                    </div>
                    <div class="user-profile" id="userProfile">
                        <img src="" class="profile-pic" id="userProfilePic" alt="Profile">
                        <span id="userName">User</span>
                        <div class="profile-dropdown" id="profileDropdown">
                            <div class="dropdown-item" id="dropdownProfile">
                                <i class="fas fa-user"></i> Edit Profile
                            </div>
                            <div class="dropdown-item" id="dropdownSettings">
                                <i class="fas fa-cog"></i> Settings
                            </div>
                            <div class="dropdown-item" id="dropdownLogout">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboardContent">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Welcome, <span id="welcomeName"></span></div>
                    </div>
                    <div class="card-body">
                        <p>Welcome to Skysoft Job Market, the decentralized peer-to-peer job network.</p>
                        <div id="adminWelcome" style="display: none;">
                            <p>You are logged in as the Super Admin. You have full control over the network.</p>
                            <button class="btn btn-primary" id="adminPanelBtn">Go to Admin Panel</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Recent Job Listings</div>
                    </div>
                    <div class="card-body" id="recentJobs">
                        <!-- Jobs will be loaded here -->
                        <p>Loading jobs...</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Online Members Near You</div>
                    </div>
                    <div class="card-body" id="onlineMembers">
                        <!-- Online members will be loaded here -->
                        <p>Loading online members...</p>
                    </div>
                </div>
            </div>

            <!-- Job Listings Content -->
            <div id="jobsContent" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">All Job Listings</div>
                        <div>
                            <input type="text" class="form-control" id="jobSearch" placeholder="Search jobs...">
                        </div>
                    </div>
                    <div class="card-body" id="allJobs">
                        <!-- All jobs will be loaded here -->
                        <p>Loading jobs...</p>
                    </div>
                </div>
            </div>

            <!-- Post Job Content -->
            <div id="postJobContent" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Post a New Job</div>
                    </div>
                    <div class="card-body">
                        <form id="postJobForm">
                            <div class="form-group">
                                <label class="form-label">Job Title</label>
                                <input type="text" class="form-control" id="jobTitle" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Company</label>
                                <input type="text" class="form-control" id="jobCompany" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Job Category</label>
                                <select class="form-control" id="jobCategory" required>
                                    <option value="">Select a category</option>
                                    <!-- Categories will be loaded dynamically -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Number of Positions</label>
                                <input type="number" class="form-control" id="jobPositions" min="1" value="1" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Job Description</label>
                                <textarea class="form-control" id="jobDescription" rows="5" required></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Location</label>
                                <input type="text" class="form-control" id="jobLocation" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Salary Range</label>
                                <div style="display: flex; gap: 10px;">
                                    <select class="form-control" id="jobCurrency" style="flex: 1;">
                                        <!-- Currencies will be loaded dynamically -->
                                    </select>
                                    <input type="number" class="form-control" id="jobSalaryMin" placeholder="Min" style="flex: 1;">
                                    <input type="number" class="form-control" id="jobSalaryMax" placeholder="Max" style="flex: 1;">
                                </div>
                                <div style="margin-top: 5px;">
                                    <label><input type="checkbox" id="jobSalaryNotDisclosed"> Not Disclosed</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Application Deadline</label>
                                <input type="datetime-local" class="form-control" id="jobDeadline" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Job Image (Optional)</label>
                                <input type="file" class="form-control" id="jobImage" accept="image/*">
                            </div>
                            <div class="form-group">
                                <label><input type="checkbox" id="jobAllowComments"> Allow comments and reactions</label>
                            </div>
                            <div class="form-group">
                                <label><input type="checkbox" id="jobAllowPrivateMessages"> Allow private messages from applicants</label>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary" id="postJobBtn">Post Job</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- My Applications Content -->
            <div id="applicationsContent" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">My Job Applications</div>
                    </div>
                    <div class="card-body" id="myApplications">
                        <!-- Applications will be loaded here -->
                        <p>Loading your applications...</p>
                    </div>
                </div>
            </div>

            <!-- Messages Content -->
            <div id="messagesContent" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Messages</div>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; height: 400px;">
                            <div style="width: 30%; border-right: 1px solid #eee; overflow-y: auto;">
                                <div id="messageContacts">
                                    <!-- Contacts will be loaded here -->
                                    <p>Loading contacts...</p>
                                </div>
                            </div>
                            <div style="width: 70%; padding: 10px; display: flex; flex-direction: column;">
                                <div id="messageChat" style="flex: 1; overflow-y: auto; margin-bottom: 10px;">
                                    <p style="text-align: center; color: #777;">Select a contact to start chatting</p>
                                </div>
                                <div style="display: none;" id="messageInputContainer">
                                    <div style="display: flex;">
                                        <input type="text" class="form-control" id="messageInput" placeholder="Type your message...">
                                        <button class="btn btn-primary" id="sendMessageBtn" style="margin-left: 10px;">Send</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Content -->
            <div id="profileContent" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">My Profile</div>
                    </div>
                    <div class="card-body">
                        <form id="profileForm">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <img src="" class="profile-pic" id="profilePicture" style="width: 100px; height: 100px; cursor: pointer;">
                                <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">
                                <div style="margin-top: 10px;">
                                    <span class="auth-link" id="changeProfilePic">Change Profile Picture</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="profileName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Username</label>
                                <input type="text" class="form-control" id="profileUsername" required>
                                <small id="profileUsernameAvailability"></small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="profileEmail" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="profilePhone" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Profession</label>
                                <input type="text" class="form-control" id="profileProfession">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Job Title</label>
                                <input type="text" class="form-control" id="profileJobTitle">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Place of Work</label>
                                <input type="text" class="form-control" id="profileWorkplace">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Location</label>
                                <input type="text" class="form-control" id="profileLocation" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Currency Preference</label>
                                <select class="form-control" id="profileCurrency">
                                    <!-- Currencies will be loaded dynamically -->
                                </select>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary" id="saveProfileBtn">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <div class="card-title">Change Password</div>
                    </div>
                    <div class="card-body">
                        <form id="passwordForm">
                            <div class="form-group">
                                <label class="form-label">Current Password</label>
                                <input type="password" class="form-control" id="currentPassword" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Password</label>
                                <input type="password" class="form-control" id="newPassword" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirm New Password</label>
                                <input type="password" class="form-control" id="confirmNewPassword" required>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary" id="changePasswordBtn">Change Password</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <div class="card-title">My Companies</div>
                    </div>
                    <div class="card-body">
                        <div id="myCompaniesList">
                            <!-- Companies will be loaded here -->
                            <p>You haven't registered any companies yet.</p>
                        </div>
                        <button class="btn btn-primary" id="addCompanyBtn" style="margin-top: 10px;">Register New Company</button>
                    </div>
                </div>
            </div>

            <!-- Admin Panel Content -->
            <div id="adminContent" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Admin Dashboard</div>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button class="btn btn-primary" id="adminManageUsers">Manage Users</button>
                            <button class="btn btn-primary" id="adminManageJobs">Manage Jobs</button>
                            <button class="btn btn-primary" id="adminManageReports">Manage Reports</button>
                            <button class="btn btn-primary" id="adminSettings">System Settings</button>
                            <button class="btn btn-primary" id="adminBroadcast">Send Broadcast</button>
                        </div>

                        <div id="adminManageUsersContent">
                            <h4>User Management</h4>
                            <div class="form-group">
                                <input type="text" class="form-control" id="adminUserSearch" placeholder="Search users...">
                            </div>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background-color: #f5f5f5;">
                                            <th style="padding: 10px; text-align: left;">Name</th>
                                            <th style="padding: 10px; text-align: left;">Username</th>
                                            <th style="padding: 10px; text-align: left;">Email</th>
                                            <th style="padding: 10px; text-align: left;">Phone</th>
                                            <th style="padding: 10px; text-align: left;">Status</th>
                                            <th style="padding: 10px; text-align: left;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="adminUsersList">
                                        <!-- Users will be loaded here -->
                                        <tr>
                                            <td colspan="6" style="padding: 10px; text-align: center;">Loading users...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div id="adminManageJobsContent" style="display: none;">
                            <h4>Job Management</h4>
                            <div class="form-group">
                                <input type="text" class="form-control" id="adminJobSearch" placeholder="Search jobs...">
                            </div>
                            <div id="adminJobsList">
                                <!-- Jobs will be loaded here -->
                                <p>Loading jobs...</p>
                            </div>
                        </div>

                        <div id="adminManageReportsContent" style="display: none;">
                            <h4>Report Management</h4>
                            <div id="adminReportsList">
                                <!-- Reports will be loaded here -->
                                <p>Loading reports...</p>
                            </div>
                        </div>

                        <div id="adminSettingsContent" style="display: none;">
                            <h4>System Settings</h4>
                            <form id="adminSettingsForm">
                                <div class="form-group">
                                    <label class="form-label">Application Name</label>
                                    <input type="text" class="form-control" id="adminAppName" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">System Email</label>
                                    <input type="email" class="form-control" id="adminSystemEmail" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Inactivity Timeout (minutes)</label>
                                    <input type="number" class="form-control" id="adminInactivityTimeout" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Minimum Posts for Blue Tick</label>
                                    <input type="number" class="form-control" id="adminBlueTickPosts" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Admin Inheritance</label>
                                    <div style="margin-top: 5px;">
                                        <label>Primary Successor Email</label>
                                        <input type="email" class="form-control" id="adminSuccessor1" style="margin-bottom: 5px;">
                                        <label>Secondary Successor Email</label>
                                        <input type="email" class="form-control" id="adminSuccessor2" style="margin-bottom: 5px;">
                                        <small>These users will inherit admin rights if you're inactive for 6 months</small>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
                                </div>
                            </form>

                            <h4 style="margin-top: 30px;">Job Categories</h4>
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <input type="text" class="form-control" id="adminNewCategory" placeholder="New category name">
                                <button class="btn btn-primary" id="adminAddCategory">Add Category</button>
                            </div>
                            <div id="adminCategoriesList">
                                <!-- Categories will be loaded here -->
                                <p>Loading categories...</p>
                            </div>
                        </div>

                        <div id="adminBroadcastContent" style="display: none;">
                            <h4>Send Broadcast Message</h4>
                            <form id="adminBroadcastForm">
                                <div class="form-group">
                                    <label class="form-label">Message Type</label>
                                    <select class="form-control" id="broadcastType" required>
                                        <option value="info">Information</option>
                                        <option value="warning">Warning</option>
                                        <option value="alert">Alert</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Message</label>
                                    <textarea class="form-control" id="broadcastMessageText" rows="5" required></textarea>
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary" id="sendBroadcastBtn">Send Broadcast</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <span id="chatTitle">Chat</span>
            <button class="chat-close" id="closeChat">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be loaded here -->
        </div>
        <div class="chat-input">
            <input type="text" id="chatMessageInput" placeholder="Type your message...">
            <button id="sendChatMessageBtn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Interview Room -->
    <div class="interview-room" id="interviewRoom">
        <div class="video-container" id="videoContainer">
            <div class="video-box">
                <video id="localVideo" autoplay muted></video>
                <div class="video-label">You</div>
            </div>
            <div class="video-box">
                <video id="remoteVideo" autoplay></video>
                <div class="video-label" id="remoteVideoLabel">Interviewer</div>
            </div>
        </div>
        <div class="interview-controls">
            <button class="control-btn" id="muteBtn">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="control-btn" id="videoBtn">
                <i class="fas fa-video"></i>
            </button>
            <button class="control-btn end-call" id="endCallBtn">
                <i class="fas fa-phone-slash"></i>
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="jobDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Job Details</div>
                <button class="modal-close" id="closeJobDetails">&times;</button>
            </div>
            <div class="modal-body" id="jobDetailsContent">
                <!-- Job details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="applyJobBtn">Apply Now</button>
                <button class="btn" id="closeJobDetailsBtn">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="applyJobModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Apply for Job</div>
                <button class="modal-close" id="closeApplyJob">&times;</button>
            </div>
            <div class="modal-body">
                <form id="applyJobForm">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="applyName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="applyEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="applyPhone" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Age</label>
                        <input type="number" class="form-control" id="applyAge" min="18" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Gender</label>
                        <select class="form-control" id="applyGender" required>
                            <option value="">Select gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Current Location</label>
                        <input type="text" class="form-control" id="applyLocation" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Years of Experience</label>
                        <input type="number" class="form-control" id="applyExperience" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Qualifications</label>
                        <textarea class="form-control" id="applyQualifications" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Portrait Photo</label>
                        <input type="file" class="form-control" id="applyPhoto" accept="image/*" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">CV/Resume</label>
                        <input type="file" class="form-control" id="applyCV" accept=".pdf,.doc,.docx" required>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="applyTerms" required> I confirm that all information provided is accurate</label>
                    </div>
                    <div class="form-group">
                        <p style="color: var(--danger-color); font-weight: bold;">
                            <i class="fas fa-exclamation-circle"></i> This job is free to apply! No one should ask for money. If asked for money report the job immediately.
                        </p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="submitApplicationBtn">Submit Application</button>
                <button class="btn" id="cancelApplyJobBtn">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal" id="applicationDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Application Details</div>
                <button class="modal-close" id="closeApplicationDetails">&times;</button>
            </div>
            <div class="modal-body" id="applicationDetailsContent">
                <!-- Application details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="withdrawApplicationBtn">Withdraw Application</button>
                <button class="btn" id="closeApplicationDetailsBtn">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="companyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Register Company</div>
                <button class="modal-close" id="closeCompanyModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="companyForm">
                    <div class="form-group">
                        <label class="form-label">Company Name</label>
                        <input type="text" class="form-control" id="companyName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Industry</label>
                        <input type="text" class="form-control" id="companyIndustry" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-control" id="companyLocation" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Website (Optional)</label>
                        <input type="url" class="form-control" id="companyWebsite">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Logo</label>
                        <input type="file" class="form-control" id="companyLogo" accept="image/*" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="companyDescription" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="requestBlueTick"> Request blue verification tick</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="saveCompanyBtn">Register Company</button>
                <button class="btn" id="cancelCompanyBtn">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal" id="reportModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Report Job</div>
                <button class="modal-close" id="closeReportModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="reportForm">
                    <div class="form-group">
                        <label class="form-label">Reason for Reporting</label>
                        <select class="form-control" id="reportReason" required>
                            <option value="">Select a reason</option>
                            <option value="fraud">Fraudulent Activity</option>
                            <option value="spam">Spam or Misleading</option>
                            <option value="discrimination">Discrimination</option>
                            <option value="fake">Fake Job</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group" id="reportOtherContainer" style="display: none;">
                        <label class="form-label">Please specify</label>
                        <input type="text" class="form-control" id="reportOther">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Details</label>
                        <textarea class="form-control" id="reportDetails" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Evidence (Screenshots, Audio, etc.)</label>
                        <input type="file" class="form-control" id="reportEvidence" multiple>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="submitReportBtn">Submit Report</button>
                <button class="btn" id="cancelReportBtn">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal" id="viewReportModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Report Details</div>
                <button class="modal-close" id="closeViewReportModal">&times;</button>
            </div>
            <div class="modal-body" id="viewReportContent">
                <!-- Report details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="banUserBtn">Ban User</button>
                <button class="btn btn-primary" id="approveJobBtn">Approve Job</button>
                <button class="btn" id="closeViewReportBtn">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="notificationModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Notifications</div>
                <button class="modal-close" id="closeNotificationModal">&times;</button>
            </div>
            <div class="modal-body" id="notificationContent">
                <!-- Notifications will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn" id="closeNotificationBtn">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let ipfs = null;
        let orbitdb = null;
        let node = null;
        let db = null;
        let userDb = null;
        let jobDb = null;
        let applicationDb = null;
        let messageDb = null;
        let reportDb = null;
        let settingsDb = null;
        let companyDb = null;
        let categoryDb = null;
        let activityDb = null;
        
        let currentUser = null;
        let isAdmin = false;
        let peerId = null;
        let peers = [];
        let onlinePeers = [];
        let chatWith = null;
        let interviewData = null;
        
        // Currency data
        const currencies = [
            { code: 'UGX', name: 'Ugandan Shilling', symbol: 'USh' },
            { code: 'USD', name: 'US Dollar', symbol: '$' },
            { code: 'EUR', name: 'Euro', symbol: '' },
            { code: 'GBP', name: 'British Pound', symbol: '' },
            { code: 'KES', name: 'Kenyan Shilling', symbol: 'KSh' },
            { code: 'TZS', name: 'Tanzanian Shilling', symbol: 'TSh' },
            { code: 'ZAR', name: 'South African Rand', symbol: 'R' },
            { code: 'INR', name: 'Indian Rupee', symbol: '' },
            { code: 'CNY', name: 'Chinese Yuan', symbol: '' },
            { code: 'JPY', name: 'Japanese Yen', symbol: '' }
        ];
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if user is logged in
            await checkLoginStatus();
            
            // Initialize UI event listeners
            initEventListeners();
            
            // Initialize databases
            await initDatabases();
            
            // Initialize IPFS and P2P network
            await initNetwork();
            
            // Load initial data
            loadInitialData();
            
            // Check for inactivity
            startInactivityTimer();
        });
        
        // Check login status
        async function checkLoginStatus() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                currentUser = JSON.parse(loggedInUser);
                isAdmin = currentUser.isAdmin || false;
                showApp();
            } else {
                showAuth();
            }
        }
        
        // Show authentication page
        function showAuth() {
            document.getElementById('authPage').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }
        
        // Show application
        function showApp() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            
            // Update UI with user data
            document.getElementById('welcomeName').textContent = currentUser.username || currentUser.name;
            document.getElementById('userName').textContent = currentUser.username || currentUser.name;
            
            if (currentUser.profilePicture) {
                document.getElementById('userProfilePic').src = currentUser.profilePicture;
                document.getElementById('profilePicture').src = currentUser.profilePicture;
            }
            
            // Show admin section if user is admin
            if (isAdmin) {
                document.getElementById('menuAdmin').style.display = 'block';
                document.getElementById('adminWelcome').style.display = 'block';
            }
        }
        
        // Initialize UI event listeners
        function initEventListeners() {
            // Auth page
            document.getElementById('showSignup').addEventListener('click', showSignupForm);
            document.getElementById('showLogin').addEventListener('click', showLoginForm);
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('signupBtn').addEventListener('click', signup);
            document.getElementById('signupUsername').addEventListener('input', checkUsernameAvailability);
            
            // Sidebar menu
            document.getElementById('menuDashboard').addEventListener('click', () => showSection('dashboardContent'));
            document.getElementById('menuJobs').addEventListener('click', () => showSection('jobsContent'));
            document.getElementById('menuPostJob').addEventListener('click', () => showSection('postJobContent'));
            document.getElementById('menuApplications').addEventListener('click', () => showSection('applicationsContent'));
            document.getElementById('menuMessages').addEventListener('click', () => showSection('messagesContent'));
            document.getElementById('menuProfile').addEventListener('click', () => showSection('profileContent'));
            document.getElementById('menuAdmin').addEventListener('click', () => showSection('adminContent'));
            
            // User profile dropdown
            document.getElementById('userProfile').addEventListener('click', toggleProfileDropdown);
            document.getElementById('dropdownProfile').addEventListener('click', () => {
                showSection('profileContent');
                hideProfileDropdown();
            });
            document.getElementById('dropdownSettings').addEventListener('click', () => {
                // TODO: Implement settings
                hideProfileDropdown();
            });
            document.getElementById('dropdownLogout').addEventListener('click', logout);
            
            // Profile page
            document.getElementById('profileForm').addEventListener('submit', saveProfile);
            document.getElementById('passwordForm').addEventListener('submit', changePassword);
            document.getElementById('changeProfilePic').addEventListener('click', () => document.getElementById('profilePictureInput').click());
            document.getElementById('profilePictureInput').addEventListener('change', uploadProfilePicture);
            document.getElementById('profileUsername').addEventListener('input', checkProfileUsernameAvailability);
            document.getElementById('addCompanyBtn').addEventListener('click', showCompanyModal);
            
            // Job posting
            document.getElementById('postJobForm').addEventListener('submit', postJob);
            
            // Admin panel
            document.getElementById('adminManageUsers').addEventListener('click', () => showAdminSection('adminManageUsersContent'));
            document.getElementById('adminManageJobs').addEventListener('click', () => showAdminSection('adminManageJobsContent'));
            document.getElementById('adminManageReports').addEventListener('click', () => showAdminSection('adminManageReportsContent'));
            document.getElementById('adminSettings').addEventListener('click', () => showAdminSection('adminSettingsContent'));
            document.getElementById('adminBroadcast').addEventListener('click', () => showAdminSection('adminBroadcastContent'));
            document.getElementById('adminSettingsForm').addEventListener('submit', saveAdminSettings);
            document.getElementById('adminAddCategory').addEventListener('click', addCategory);
            document.getElementById('adminBroadcastForm').addEventListener('submit', sendBroadcast);
            
            // Modals
            document.getElementById('closeJobDetails').addEventListener('click', hideJobDetailsModal);
            document.getElementById('closeJobDetailsBtn').addEventListener('click', hideJobDetailsModal);
            document.getElementById('closeApplyJob').addEventListener('click', hideApplyJobModal);
            document.getElementById('cancelApplyJobBtn').addEventListener('click', hideApplyJobModal);
            document.getElementById('submitApplicationBtn').addEventListener('click', submitApplication);
            document.getElementById('closeApplicationDetails').addEventListener('click', hideApplicationDetailsModal);
            document.getElementById('closeApplicationDetailsBtn').addEventListener('click', hideApplicationDetailsModal);
            document.getElementById('withdrawApplicationBtn').addEventListener('click', withdrawApplication);
            document.getElementById('closeCompanyModal').addEventListener('click', hideCompanyModal);
            document.getElementById('cancelCompanyBtn').addEventListener('click', hideCompanyModal);
            document.getElementById('saveCompanyBtn').addEventListener('click', saveCompany);
            document.getElementById('closeReportModal').addEventListener('click', hideReportModal);
            document.getElementById('cancelReportBtn').addEventListener('click', hideReportModal);
            document.getElementById('submitReportBtn').addEventListener('click', submitReport);
            document.getElementById('closeViewReportModal').addEventListener('click', hideViewReportModal);
            document.getElementById('closeViewReportBtn').addEventListener('click', hideViewReportModal);
            document.getElementById('banUserBtn').addEventListener('click', banUser);
            document.getElementById('approveJobBtn').addEventListener('click', approveJob);
            document.getElementById('closeNotificationModal').addEventListener('click', hideNotificationModal);
            document.getElementById('closeNotificationBtn').addEventListener('click', hideNotificationModal);
            
            // Report reason change
            document.getElementById('reportReason').addEventListener('change', function() {
                document.getElementById('reportOtherContainer').style.display = 
                    this.value === 'other' ? 'block' : 'none';
            });
            
            // Chat
            document.getElementById('closeChat').addEventListener('click', hideChat);
            document.getElementById('sendChatMessageBtn').addEventListener('click', sendChatMessage);
            document.getElementById('chatMessageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendChatMessage();
            });
            
            // Interview room
            document.getElementById('endCallBtn').addEventListener('click', endInterview);
            document.getElementById('muteBtn').addEventListener('click', toggleMute);
            document.getElementById('videoBtn').addEventListener('click', toggleVideo);
            
            // Broadcast message
            document.getElementById('closeBroadcast').addEventListener('click', hideBroadcastMessage);
            
            // Notification icon
            document.getElementById('notificationIcon').addEventListener('click', showNotificationModal);
        }
        
        // Show section
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.main-content > div').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            document.getElementById(sectionId).style.display = 'block';
            
            // Update active menu item
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Set page title
            let title = 'Dashboard';
            switch(sectionId) {
                case 'jobsContent':
                    title = 'Job Listings';
                    document.getElementById('menuJobs').classList.add('active');
                    loadAllJobs();
                    break;
                case 'postJobContent':
                    title = 'Post a Job';
                    document.getElementById('menuPostJob').classList.add('active');
                    loadJobCategories();
                    loadCurrencies();
                    break;
                case 'applicationsContent':
                    title = 'My Applications';
                    document.getElementById('menuApplications').classList.add('active');
                    loadMyApplications();
                    break;
                case 'messagesContent':
                    title = 'Messages';
                    document.getElementById('menuMessages').classList.add('active');
                    loadMessageContacts();
                    break;
                case 'profileContent':
                    title = 'My Profile';
                    document.getElementById('menuProfile').classList.add('active');
                    loadProfileData();
                    loadMyCompanies();
                    loadCurrencies();
                    break;
                case 'adminContent':
                    title = 'Admin Panel';
                    document.getElementById('menuAdmin').classList.add('active');
                    showAdminSection('adminManageUsersContent');
                    loadAdminUsers();
                    loadAdminSettings();
                    break;
                default:
                    title = 'Dashboard';
                    document.getElementById('menuDashboard').classList.add('active');
                    loadRecentJobs();
                    loadOnlineMembers();
                    break;
            }
            
            document.getElementById('pageTitle').textContent = title;
        }
        
        // Show admin section
        function showAdminSection(sectionId) {
            // Hide all admin sections
            document.querySelectorAll('#adminContent > div > div').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            document.getElementById(sectionId).style.display = 'block';
        }
        
        // Toggle profile dropdown
        function toggleProfileDropdown() {
            document.getElementById('profileDropdown').classList.toggle('show');
        }
        
        // Hide profile dropdown
        function hideProfileDropdown() {
            document.getElementById('profileDropdown').classList.remove('show');
        }
        
        // Show signup form
        function showSignupForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
        }
        
        // Show login form
        function showLoginForm() {
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        }
        
        // Login function
        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }
            
            try {
                // Check if user exists in the database
                const user = await userDb.get(username.toLowerCase());
                
                if (!user) {
                    alert('User not found');
                    return;
                }
                
                // Verify password
                const hashedPassword = sha256(password);
                if (hashedPassword !== user.password) {
                    alert('Invalid password');
                    return;
                }
                
                // Set current user
                currentUser = user;
                isAdmin = user.isAdmin || false;
                
                // Save login status
                localStorage.setItem('loggedInUser', JSON.stringify(currentUser));
                
                // Update UI
                showApp();
                
                // Record activity
                await recordActivity('login', `User logged in`);
                
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
            }
        }
        
        // Signup function
        async function signup() {
            const name = document.getElementById('signupName').value.trim();
            const username = document.getElementById('signupUsername').value.trim().toLowerCase();
            const email = document.getElementById('signupEmail').value.trim().toLowerCase();
            const phone = document.getElementById('signupPhone').value.trim();
            const password = document.getElementById('signupPassword').value.trim();
            const confirmPassword = document.getElementById('signupConfirmPassword').value.trim();
            
            // Validate inputs
            if (!name || !username || !email || !phone || !password || !confirmPassword) {
                alert('Please fill in all fields');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            if (password.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }
            
            // Check if username is available
            const usernameAvailable = await checkUsernameAvailability(true);
            if (!usernameAvailable) {
                alert('Username is already taken');
                return;
            }
            
            try {
                // Hash password
                const hashedPassword = sha256(password);
                
                // Create user object
                const user = {
                    id: generateId(),
                    name,
                    username,
                    email,
                    phone,
                    password: hashedPassword,
                    profilePicture: '',
                    profession: '',
                    jobTitle: '',
                    workplace: '',
                    location: '',
                    currency: 'UGX',
                    isAdmin: false,
                    isBanned: false,
                    blueTick: false,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // Check if this is the first user (make them admin)
                const users = await userDb.all();
                if (users.length === 0) {
                    user.isAdmin = true;
                    isAdmin = true;
                }
                
                // Save user to database
                await userDb.put(username, user);
                
                // Set current user
                currentUser = user;
                
                // Save login status
                localStorage.setItem('loggedInUser', JSON.stringify(currentUser));
                
                // Update UI
                showApp();
                
                // Record activity
                await recordActivity('signup', `New user registered: ${username}`);
                
            } catch (error) {
                console.error('Signup error:', error);
                alert('Signup failed. Please try again.');
            }
        }
        
        // Check username availability
        async function checkUsernameAvailability(silent = false) {
            const username = document.getElementById('signupUsername').value.trim().toLowerCase();
            const availabilityEl = document.getElementById('usernameAvailability');
            
            if (!username) {
                availabilityEl.textContent = '';
                return false;
            }
            
            if (username.length < 3) {
                availabilityEl.textContent = 'Username must be at least 3 characters';
                availabilityEl.style.color = 'var(--danger-color)';
                return false;
            }
            
            try {
                const user = await userDb.get(username);
                
                if (user) {
                    if (!silent) {
                        availabilityEl.textContent = 'Username is not available';
                        availabilityEl.style.color = 'var(--danger-color)';
                    }
                    return false;
                } else {
                    if (!silent) {
                        availabilityEl.textContent = 'Username is available';
                        availabilityEl.style.color = 'var(--success-color)';
                    }
                    return true;
                }
            } catch (error) {
                console.error('Username check error:', error);
                if (!silent) {
                    availabilityEl.textContent = 'Error checking username';
                    availabilityEl.style.color = 'var(--danger-color)';
                }
                return false;
            }
        }
        
        // Check profile username availability
        async function checkProfileUsernameAvailability() {
            const username = document.getElementById('profileUsername').value.trim().toLowerCase();
            const availabilityEl = document.getElementById('profileUsernameAvailability');
            
            if (!username) {
                availabilityEl.textContent = '';
                return false;
            }
            
            if (username.length < 3) {
                availabilityEl.textContent = 'Username must be at least 3 characters';
                availabilityEl.style.color = 'var(--danger-color)';
                return false;
            }
            
            // Don't check if it's the same as current username
            if (username === currentUser.username) {
                availabilityEl.textContent = '';
                return true;
            }
            
            try {
                const user = await userDb.get(username);
                
                if (user) {
                    availabilityEl.textContent = 'Username is not available';
                    availabilityEl.style.color = 'var(--danger-color)';
                    return false;
                } else {
                    availabilityEl.textContent = 'Username is available';
                    availabilityEl.style.color = 'var(--success-color)';
                    return true;
                }
            } catch (error) {
                console.error('Username check error:', error);
                availabilityEl.textContent = 'Error checking username';
                availabilityEl.style.color = 'var(--danger-color)';
                return false;
            }
        }
        
        // Logout function
        function logout() {
            // Clear current user
            currentUser = null;
            isAdmin = false;
            
            // Remove login status
            localStorage.removeItem('loggedInUser');
            
            // Show auth page
            showAuth();
            
            // Reset forms
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }
        
        // Initialize databases
        async function initDatabases() {
            try {
                // Open or create databases
                const dbPromises = [
                    openDatabase('users'),
                    openDatabase('jobs'),
                    openDatabase('applications'),
                    openDatabase('messages'),
                    openDatabase('reports'),
                    openDatabase('settings'),
                    openDatabase('companies'),
                    openDatabase('categories'),
                    openDatabase('activities')
                ];
                
                const dbs = await Promise.all(dbPromises);
                
                // Assign databases
                userDb = dbs[0];
                jobDb = dbs[1];
                applicationDb = dbs[2];
                messageDb = dbs[3];
                reportDb = dbs[4];
                settingsDb = dbs[5];
                companyDb = dbs[6];
                categoryDb = dbs[7];
                activityDb = dbs[8];
                
                console.log('All databases initialized');
                
            } catch (error) {
                console.error('Database initialization error:', error);
                alert('Failed to initialize databases. Please refresh the page.');
            }
        }
        
        // Open or create IndexedDB database
        function openDatabase(name) {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(`skysoft_jobmarket_${name}`, 1);
                
                request.onupgradeneeded = function(event) {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(name)) {
                        const store = db.createObjectStore(name, { keyPath: 'key' });
                        
                        // Create indexes based on database type
                        if (name === 'users') {
                            store.createIndex('username', 'value.username', { unique: true });
                            store.createIndex('email', 'value.email', { unique: true });
                            store.createIndex('phone', 'value.phone', { unique: true });
                        } else if (name === 'jobs') {
                            store.createIndex('poster', 'value.poster');
                            store.createIndex('company', 'value.company');
                            store.createIndex('category', 'value.category');
                            store.createIndex('location', 'value.location');
                            store.createIndex('deadline', 'value.deadline');
                        } else if (name === 'applications') {
                            store.createIndex('jobId', 'value.jobId');
                            store.createIndex('applicant', 'value.applicant');
                            store.createIndex('status', 'value.status');
                        } else if (name === 'messages') {
                            store.createIndex('from', 'value.from');
                            store.createIndex('to', 'value.to');
                            store.createIndex('timestamp', 'value.timestamp');
                        }
                    }
                };
                
                request.onsuccess = function(event) {
                    const db = event.target.result;
                    
                    // Create a simple interface for CRUD operations
                    const database = {
                        get: (key) => new Promise((resolve, reject) => {
                            const transaction = db.transaction(name, 'readonly');
                            const store = transaction.objectStore(name);
                            const request = store.get(key);
                            
                            request.onsuccess = () => resolve(request.result ? request.result.value : null);
                            request.onerror = () => reject(request.error);
                        }),
                        
                        put: (key, value) => new Promise((resolve, reject) => {
                            const transaction = db.transaction(name, 'readwrite');
                            const store = transaction.objectStore(name);
                            const request = store.put({ key, value });
                            
                            request.onsuccess = () => resolve();
                            request.onerror = () => reject(request.error);
                        }),
                        
                        delete: (key) => new Promise((resolve, reject) => {
                            const transaction = db.transaction(name, 'readwrite');
                            const store = transaction.objectStore(name);
                            const request = store.delete(key);
                            
                            request.onsuccess = () => resolve();
                            request.onerror = () => reject(request.error);
                        }),
                        
                        all: () => new Promise((resolve, reject) => {
                            const transaction = db.transaction(name, 'readonly');
                            const store = transaction.objectStore(name);
                            const request = store.getAll();
                            
                            request.onsuccess = () => resolve(request.result.map(item => item.value));
                            request.onerror = () => reject(request.error);
                        }),
                        
                        query: (indexName, key) => new Promise((resolve, reject) => {
                            const transaction = db.transaction(name, 'readonly');
                            const store = transaction.objectStore(name);
                            const index = store.index(indexName);
                            const request = index.getAll(key);
                            
                            request.onsuccess = () => resolve(request.result.map(item => item.value));
                            request.onerror = () => reject(request.error);
                        })
                    };
                    
                    resolve(database);
                };
                
                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }
        
        // Initialize IPFS and P2P network
        async function initNetwork() {
            try {
                // Initialize IPFS
                ipfs = await Ipfs.create({
                    repo: `skysoft-jobmarket-${currentUser?.id || 'anonymous'}`,
                    EXPERIMENTAL: {
                        pubsub: true
                    },
                    config: {
                        Addresses: {
                            Swarm: [
                                '/dns4/wrtc-star1.par.dwebops.pub/tcp/443/wss/p2p-webrtc-star',
                                '/dns4/wrtc-star2.sjc.dwebops.pub/tcp/443/wss/p2p-webrtc-star'
                            ]
                        }
                    }
                });
                
                // Get peer ID
                const peerId = await ipfs.id();
                console.log('IPFS node ID:', peerId.id);
                
                // Initialize libp2p
                node = await Libp2p.create({
                    peerId: await PeerId.create(),
                    modules: {
                        transport: [WebrtcStar],
                        peerDiscovery: [Bootstrap, MulticastDNS],
                        pubsub: Gossipsub
                    },
                    config: {
                        peerDiscovery: {
                            bootstrap: {
                                list: [
                                    '/dns4/bootstrap.libp2p.io/tcp/443/wss/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN',
                                    '/dns4/bootstrap2.libp2p.io/tcp/443/wss/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt'
                                ]
                            },
                            multicastDNS: {
                                interval: 1000,
                                enabled: true
                            }
                        }
                    }
                });
                
                // Start libp2p
                await node.start();
                console.log('libp2p started');
                
                // Listen for peers
                node.on('peer:discovery', (peerId) => {
                    console.log('Discovered peer:', peerId.toB58String());
                    if (!peers.includes(peerId.toB58String())) {
                        peers.push(peerId.toB58String());
                        updateOnlinePeers();
                    }
                });
                
                // Handle peer connections
                node.connectionManager.on('peer:connect', (connection) => {
                    console.log('Connected to peer:', connection.remotePeer.toB58String());
                    if (!onlinePeers.includes(connection.remotePeer.toB58String())) {
                        onlinePeers.push(connection.remotePeer.toB58String());
                        updateOnlinePeers();
                    }
                });
                
                node.connectionManager.on('peer:disconnect', (connection) => {
                    console.log('Disconnected from peer:', connection.remotePeer.toB58String());
                    onlinePeers = onlinePeers.filter(p => p !== connection.remotePeer.toB58String());
                    updateOnlinePeers();
                });
                
                // Subscribe to pubsub topics
                await node.pubsub.subscribe('skysoft-jobmarket-jobs');
                await node.pubsub.subscribe('skysoft-jobmarket-messages');
                await node.pubsub.subscribe('skysoft-jobmarket-broadcast');
                
                // Handle pubsub messages
                node.pubsub.on('skysoft-jobmarket-jobs', (msg) => {
                    const job = JSON.parse(msg.data.toString());
                    console.log('New job received:', job);
                    // Update UI with new job
                    if (currentUser) {
                        loadRecentJobs();
                        loadAllJobs();
                    }
                });
                
                node.pubsub.on('skysoft-jobmarket-messages', (msg) => {
                    const message = JSON.parse(msg.data.toString());
                    console.log('New message received:', message);
                    // Update UI with new message
                    if (currentUser && (message.to === currentUser.username || message.from === currentUser.username)) {
                        loadMessageContacts();
                        if (chatWith === message.from || chatWith === message.to) {
                            loadChatMessages();
                        }
                    }
                });
                
                node.pubsub.on('skysoft-jobmarket-broadcast', (msg) => {
                    const broadcast = JSON.parse(msg.data.toString());
                    console.log('New broadcast received:', broadcast);
                    // Show broadcast message
                    showBroadcastMessage(broadcast.message, broadcast.type);
                });
                
            } catch (error) {
                console.error('Network initialization error:', error);
            }
        }
        
        // Update online peers list
        function updateOnlinePeers() {
            if (document.getElementById('onlineMembers')) {
                loadOnlineMembers();
            }
        }
        
        // Load initial data
        function loadInitialData() {
            if (currentUser) {
                loadRecentJobs();
                loadOnlineMembers();
                
                // Check for admin settings
                if (isAdmin) {
                    loadAdminSettings();
                }
            }
        }
        
        // Load recent jobs
        async function loadRecentJobs() {
            try {
                const now = new Date().toISOString();
                const allJobs = await jobDb.all();
                
                // Filter active jobs (deadline in future)
                const activeJobs = allJobs.filter(job => job.deadline > now);
                
                // Sort by newest first
                activeJobs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                // Get first 5 jobs
                const recentJobs = activeJobs.slice(0, 5);
                
                // Render jobs
                const jobsHtml = recentJobs.length > 0 ? 
                    recentJobs.map(job => renderJobCard(job)).join('') :
                    '<p>No recent job listings found.</p>';
                
                document.getElementById('recentJobs').innerHTML = jobsHtml;
                
                // Add event listeners to job cards
                recentJobs.forEach(job => {
                    document.getElementById(`viewJob-${job.id}`).addEventListener('click', () => showJobDetailsModal(job.id));
                });
                
            } catch (error) {
                console.error('Error loading recent jobs:', error);
                document.getElementById('recentJobs').innerHTML = '<p>Error loading jobs. Please try again.</p>';
            }
        }
        
        // Load all jobs
        async function loadAllJobs() {
            try {
                const now = new Date().toISOString();
                const allJobs = await jobDb.all();
                
                // Filter active jobs (deadline in future)
                const activeJobs = allJobs.filter(job => job.deadline > now);
                
                // Sort by newest first
                activeJobs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                // Render jobs
                const jobsHtml = activeJobs.length > 0 ? 
                    activeJobs.map(job => renderJobCard(job)).join('') :
                    '<p>No job listings found.</p>';
                
                document.getElementById('allJobs').innerHTML = jobsHtml;
                
                // Add event listeners to job cards
                activeJobs.forEach(job => {
                    document.getElementById(`viewJob-${job.id}`).addEventListener('click', () => showJobDetailsModal(job.id));
                });
                
                // Add search functionality
                document.getElementById('jobSearch').addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const filteredJobs = activeJobs.filter(job => 
                        job.title.toLowerCase().includes(searchTerm) || 
                        job.company.toLowerCase().includes(searchTerm) ||
                        job.description.toLowerCase().includes(searchTerm) ||
                        job.category.toLowerCase().includes(searchTerm) ||
                        job.location.toLowerCase().includes(searchTerm)
                    );
                    
                    const filteredHtml = filteredJobs.length > 0 ? 
                        filteredJobs.map(job => renderJobCard(job)).join('') :
                        '<p>No jobs match your search.</p>';
                    
                    document.getElementById('allJobs').innerHTML = filteredHtml;
                    
                    // Add event listeners to filtered job cards
                    filteredJobs.forEach(job => {
                        document.getElementById(`viewJob-${job.id}`).addEventListener('click', () => showJobDetailsModal(job.id));
                    });
                });
                
            } catch (error) {
                console.error('Error loading all jobs:', error);
                document.getElementById('allJobs').innerHTML = '<p>Error loading jobs. Please try again.</p>';
            }
        }
        
        // Render job card
        function renderJobCard(job) {
            const deadlineDate = new Date(job.deadline);
            const deadlineStr = deadlineDate.toLocaleDateString() + ' ' + deadlineDate.toLocaleTimeString();
            
            // Find currency symbol
            const currency = currencies.find(c => c.code === job.currency) || { symbol: job.currency };
            
            return `
                <div class="job-card">
                    <div class="job-header">
                        <div>
                            <div class="job-title">${job.title}</div>
                            <div class="job-company">${job.company} ${job.blueTick ? '<i class="fas fa-check-circle blue-tick"></i>' : ''}</div>
                        </div>
                        <div class="job-deadline">Deadline: ${deadlineStr}</div>
                    </div>
                    <div class="job-location">
                        <i class="fas fa-map-marker-alt"></i> ${job.location}
                    </div>
                    ${job.salaryNotDisclosed ? '' : `
                    <div class="job-salary">
                        ${currency.symbol} ${job.salaryMin} - ${currency.symbol} ${job.salaryMax}
                    </div>
                    `}
                    <div class="job-tags">
                        <span class="tag">${job.category}</span>
                        <span class="tag">${job.positions} position${job.positions > 1 ? 's' : ''}</span>
                    </div>
                    <div class="job-actions">
                        <button class="btn btn-primary" id="viewJob-${job.id}">View Details</button>
                        ${job.poster === currentUser.username ? '<button class="btn btn-danger">Delete</button>' : ''}
                    </div>
                </div>
            `;
        }
        
        // Show job details modal
        async function showJobDetailsModal(jobId) {
            try {
                const job = await jobDb.get(jobId);
                if (!job) {
                    alert('Job not found');
                    return;
                }
                
                const deadlineDate = new Date(job.deadline);
                const deadlineStr = deadlineDate.toLocaleDateString() + ' ' + deadlineDate.toLocaleTimeString();
                
                // Find currency symbol
                const currency = currencies.find(c => c.code === job.currency) || { symbol: job.currency };
                
                // Check if user has already applied
                const applications = await applicationDb.query('jobId', jobId);
                const hasApplied = applications.some(app => app.applicant === currentUser.username);
                
                // Render job details
                document.getElementById('jobDetailsContent').innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3>${job.title}</h3>
                        <h4>${job.company} ${job.blueTick ? '<i class="fas fa-check-circle blue-tick"></i>' : ''}</h4>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <p><strong>Location:</strong> ${job.location}</p>
                        <p><strong>Category:</strong> ${job.category}</p>
                        <p><strong>Positions:</strong> ${job.positions}</p>
                        ${job.salaryNotDisclosed ? '' : `
                        <p><strong>Salary Range:</strong> ${currency.symbol} ${job.salaryMin} - ${currency.symbol} ${job.salaryMax}</p>
                        `}
                        <p><strong>Deadline:</strong> ${deadlineStr}</p>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <h4>Job Description</h4>
                        <p>${job.description}</p>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <p style="color: var(--danger-color); font-weight: bold;">
                            <i class="fas fa-exclamation-circle"></i> This job is free to apply! No one should ask for money. If asked for money report the job immediately.
                        </p>
                    </div>
                `;
                
                // Show apply button if not the poster and hasn't applied
                document.getElementById('applyJobBtn').style.display = 
                    (job.poster !== currentUser.username && !hasApplied) ? 'block' : 'none';
                
                // Show modal
                document.getElementById('jobDetailsModal').classList.add('show');
                
            } catch (error) {
                console.error('Error showing job details:', error);
                alert('Failed to load job details. Please try again.');
            }
        }
        
        // Hide job details modal
        function hideJobDetailsModal() {
            document.getElementById('jobDetailsModal').classList.remove('show');
        }
        
        // Show apply job modal
        function showApplyJobModal(jobId) {
            document.getElementById('applyJobForm').reset();
            document.getElementById('applyName').value = currentUser.name;
            document.getElementById('applyEmail').value = currentUser.email;
            document.getElementById('applyPhone').value = currentUser.phone;
            document.getElementById('applyLocation').value = currentUser.location || '';
            
            // Store job ID in a data attribute
            document.getElementById('applyJobForm').dataset.jobId = jobId;
            
            document.getElementById('applyJobModal').classList.add('show');
        }
        
        // Hide apply job modal
        function hideApplyJobModal() {
            document.getElementById('applyJobModal').classList.remove('show');
        }
        
        // Submit job application
        async function submitApplication() {
            const form = document.getElementById('applyJobForm');
            const jobId = form.dataset.jobId;
            
            const name = document.getElementById('applyName').value.trim();
            const email = document.getElementById('applyEmail').value.trim();
            const phone = document.getElementById('applyPhone').value.trim();
            const age = document.getElementById('applyAge').value.trim();
            const gender = document.getElementById('applyGender').value;
            const location = document.getElementById('applyLocation').value.trim();
            const experience = document.getElementById('applyExperience').value.trim();
            const qualifications = document.getElementById('applyQualifications').value.trim();
            const photo = document.getElementById('applyPhoto').files[0];
            const cv = document.getElementById('applyCV').files[0];
            const terms = document.getElementById('applyTerms').checked;
            
            // Validate inputs
            if (!name || !email || !phone || !age || !gender || !location || !experience || !qualifications || !photo || !cv || !terms) {
                alert('Please fill in all fields and agree to the terms');
                return;
            }
            
            if (isNaN(age) {
                alert('Please enter a valid age');
                return;
            }
            
            if (isNaN(experience)) {
                alert('Please enter valid years of experience');
                return;
            }
            
            try {
                // Upload photo and CV to IPFS
                const photoHash = await uploadFileToIPFS(photo);
                const cvHash = await uploadFileToIPFS(cv);
                
                // Create application object
                const application = {
                    id: generateId(),
                    jobId,
                    applicant: currentUser.username,
                    name,
                    email,
                    phone,
                    age,
                    gender,
                    location,
                    experience,
                    qualifications,
                    photo: photoHash,
                    cv: cvHash,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // Save application to database
                await applicationDb.put(application.id, application);
                
                // Record activity
                await recordActivity('application', `Applied for job ${jobId}`);
                
                // Hide modal
                hideApplyJobModal();
                hideJobDetailsModal();
                
                // Show success message
                alert('Application submitted successfully!');
                
                // Reload applications
                loadMyApplications();
                
            } catch (error) {
                console.error('Error submitting application:', error);
                alert('Failed to submit application. Please try again.');
            }
        }
        
        // Load my applications
        async function loadMyApplications() {
            try {
                const applications = await applicationDb.query('applicant', currentUser.username);
                
                if (applications.length === 0) {
                    document.getElementById('myApplications').innerHTML = '<p>You have no applications yet.</p>';
                    return;
                }
                
                // Get job details for each application
                const applicationsWithJobs = await Promise.all(
                    applications.map(async app => {
                        const job = await jobDb.get(app.jobId);
                        return { ...app, job };
                    })
                );
                
                // Filter out applications where job might have been deleted
                const validApplications = applicationsWithJobs.filter(app => app.job);
                
                // Sort by newest first
                validApplications.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                // Render applications
                const appsHtml = validApplications.map(app => renderApplicationCard(app)).join('');
                document.getElementById('myApplications').innerHTML = appsHtml;
                
                // Add event listeners
                validApplications.forEach(app => {
                    document.getElementById(`viewApplication-${app.id}`).addEventListener('click', () => showApplicationDetailsModal(app.id));
                });
                
            } catch (error) {
                console.error('Error loading applications:', error);
                document.getElementById('myApplications').innerHTML = '<p>Error loading applications. Please try again.</p>';
            }
        }
        
        // Render application card
        function renderApplicationCard(application) {
            let statusClass = '';
            let statusText = '';
            
            switch(application.status) {
                case 'pending':
                    statusClass = 'warning';
                    statusText = 'Pending Review';
                    break;
                case 'accepted':
                    statusClass = 'success';
                    statusText = 'Accepted';
                    break;
                case 'rejected':
                    statusClass = 'danger';
                    statusText = 'Rejected';
                    break;
                case 'withdrawn':
                    statusClass = 'secondary';
                    statusText = 'Withdrawn';
                    break;
                default:
                    statusClass = 'warning';
                    statusText = 'Pending';
            }
            
            return `
                <div class="job-card">
                    <div class="job-header">
                        <div>
                            <div class="job-title">${application.job.title}</div>
                            <div class="job-company">${application.job.company}</div>
                        </div>
                        <div>
                            <span class="tag ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    <div class="job-location">
                        <i class="fas fa-map-marker-alt"></i> ${application.job.location}
                    </div>
                    <div style="margin: 10px 0;">
                        <p><strong>Applied on:</strong> ${new Date(application.createdAt).toLocaleDateString()}</p>
                    </div>
                    <div class="job-actions">
                        <button class="btn btn-primary" id="viewApplication-${application.id}">View Details</button>
                        ${application.status === 'pending' ? '<button class="btn btn-danger">Withdraw</button>' : ''}
                    </div>
                </div>
            `;
        }
        
        // Show application details modal
        async function showApplicationDetailsModal(applicationId) {
            try {
                const application = await applicationDb.get(applicationId);
                if (!application) {
                    alert('Application not found');
                    return;
                }
                
                const job = await jobDb.get(application.jobId);
                if (!job) {
                    alert('Job not found');
                    return;
                }
                
                // Render application details
                document.getElementById('applicationDetailsContent').innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3>${job.title}</h3>
                        <h4>${job.company}</h4>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <p><strong>Status:</strong> ${application.status.charAt(0).toUpperCase() + application.status.slice(1)}</p>
                        <p><strong>Applied on:</strong> ${new Date(application.createdAt).toLocaleDateString()}</p>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <h4>Your Application Details</h4>
                        <p><strong>Name:</strong> ${application.name}</p>
                        <p><strong>Email:</strong> ${application.email}</p>
                        <p><strong>Phone:</strong> ${application.phone}</p>
                        <p><strong>Age:</strong> ${application.age}</p>
                        <p><strong>Gender:</strong> ${application.gender.charAt(0).toUpperCase() + application.gender.slice(1)}</p>
                        <p><strong>Location:</strong> ${application.location}</p>
                        <p><strong>Experience:</strong> ${application.experience} years</p>
                        <p><strong>Qualifications:</strong> ${application.qualifications}</p>
                    </div>
                    ${application.status === 'accepted' && application.interviewDate ? `
                    <div style="margin-bottom: 15px; background-color: #e8f5e9; padding: 15px; border-radius: 5px;">
                        <h4>Interview Scheduled</h4>
                        <p><strong>Date:</strong> ${new Date(application.interviewDate).toLocaleString()}</p>
                        <p><strong>Location:</strong> ${application.interviewLocation || 'Online'}</p>
                        ${application.interviewLocation ? '' : '<p><strong>Interview Link:</strong> Will be provided before the interview</p>'}
                    </div>
                    ` : ''}
                `;
                
                // Show withdraw button if status is pending
                document.getElementById('withdrawApplicationBtn').style.display = 
                    application.status === 'pending' ? 'block' : 'none';
                
                // Store application ID in a data attribute
                document.getElementById('applicationDetailsContent').dataset.applicationId = applicationId;
                
                // Show modal
                document.getElementById('applicationDetailsModal').classList.add('show');
                
            } catch (error) {
                console.error('Error showing application details:', error);
                alert('Failed to load application details. Please try again.');
            }
        }
        
        // Hide application details modal
        function hideApplicationDetailsModal() {
            document.getElementById('applicationDetailsModal').classList.remove('show');
        }
        
        // Withdraw application
        async function withdrawApplication() {
            const applicationId = document.getElementById('applicationDetailsContent').dataset.applicationId;
            
            if (!applicationId) {
                alert('Application ID not found');
                return;
            }
            
            if (!confirm('Are you sure you want to withdraw this application?')) {
                return;
            }
            
            try {
                const application = await applicationDb.get(applicationId);
                if (!application) {
                    alert('Application not found');
                    return;
                }
                
                // Update application status
                application.status = 'withdrawn';
                application.updatedAt = new Date().toISOString();
                
                // Save to database
                await applicationDb.put(applicationId, application);
                
                // Record activity
                await recordActivity('application', `Withdrew application for job ${application.jobId}`);
                
                // Hide modal
                hideApplicationDetailsModal();
                
                // Show success message
                alert('Application withdrawn successfully');
                
                // Reload applications
                loadMyApplications();
                
            } catch (error) {
                console.error('Error withdrawing application:', error);
                alert('Failed to withdraw application. Please try again.');
            }
        }
        
        // Load online members
        async function loadOnlineMembers() {
            try {
                const allUsers = await userDb.all();
                
                // Filter out current user and banned users
                const onlineUsers = allUsers.filter(user => 
                    user.username !== currentUser.username && 
                    !user.isBanned &&
                    onlinePeers.includes(user.id) // This would need real online status checking
                );
                
                // Render online members
                const membersHtml = onlineUsers.length > 0 ? 
                    onlineUsers.map(user => renderOnlineMemberCard(user)).join('') :
                    '<p>No other members online at the moment.</p>';
                
                document.getElementById('onlineMembers').innerHTML = membersHtml;
                
                // Add event listeners
                onlineUsers.forEach(user => {
                    document.getElementById(`messageMember-${user.username}`).addEventListener('click', () => startChat(user.username));
                    document.getElementById(`askJobMember-${user.username}`).addEventListener('click', () => askAboutJobs(user.username));
                });
                
            } catch (error) {
                console.error('Error loading online members:', error);
                document.getElementById('onlineMembers').innerHTML = '<p>Error loading online members. Please try again.</p>';
            }
        }
        
        // Render online member card
        function renderOnlineMemberCard(user) {
            return `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;">
                    <div style="display: flex; align-items: center;">
                        <img src="${user.profilePicture || 'https://via.placeholder.com/40'}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
                        <div>
                            <div>${user.name}</div>
                            <div style="font-size: 0.8rem; color: #777;">${user.profession || 'No profession specified'}</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn btn-primary btn-sm" id="messageMember-${user.username}">
                            <i class="fas fa-envelope"></i>
                        </button>
                        <button class="btn btn-success btn-sm" id="askJobMember-${user.username}">
                            <i class="fas fa-briefcase"></i>
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Start chat with member
        function startChat(username) {
            chatWith = username;
            showChat();
            loadChatMessages();
        }
        
        // Ask about jobs from member
        function askAboutJobs(username) {
            startChat(username);
            document.getElementById('chatMessageInput').value = "Hi, do you know of any job opportunities available?";
        }
        
        // Show chat
        function showChat() {
            document.getElementById('chatContainer').classList.add('show');
            document.getElementById('chatTitle').textContent = `Chat with ${chatWith}`;
        }
        
        // Hide chat
        function hideChat() {
            document.getElementById('chatContainer').classList.remove('show');
            chatWith = null;
        }
        
        // Load chat messages
        async function loadChatMessages() {
            if (!chatWith) return;
            
            try {
                // Get messages between current user and chatWith
                const messagesSent = await messageDb.query('from', currentUser.username);
                const messagesReceived = await messageDb.query('to', currentUser.username);
                
                // Filter messages for this conversation
                const allMessages = [...messagesSent, ...messagesReceived].filter(msg => 
                    (msg.from === currentUser.username && msg.to === chatWith) || 
                    (msg.from === chatWith && msg.to === currentUser.username)
                );
                
                // Sort by timestamp
                allMessages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                // Render messages
                const messagesHtml = allMessages.map(msg => renderMessage(msg)).join('');
                document.getElementById('chatMessages').innerHTML = messagesHtml;
                
                // Show input container
                document.getElementById('messageInputContainer').style.display = 'flex';
                
                // Scroll to bottom
                document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
                
            } catch (error) {
                console.error('Error loading chat messages:', error);
                document.getElementById('chatMessages').innerHTML = '<p>Error loading messages. Please try again.</p>';
            }
        }
        
        // Render message
        function renderMessage(message) {
            const isSent = message.from === currentUser.username;
            const timestamp = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            return `
                <div class="message ${isSent ? 'sent' : 'received'}">
                    <div class="message-content">${message.content}</div>
                    <div class="message-time">${timestamp}</div>
                </div>
            `;
        }
        
        // Send chat message
        async function sendChatMessage() {
            if (!chatWith) return;
            
            const input = document.getElementById('chatMessageInput');
            const content = input.value.trim();
            
            if (!content) return;
            
            try {
                // Create message object
                const message = {
                    id: generateId(),
                    from: currentUser.username,
                    to: chatWith,
                    content,
                    timestamp: new Date().toISOString(),
                    read: false
                };
                
                // Save to database
                await messageDb.put(message.id, message);
                
                // Publish message to network
                if (node && node.pubsub) {
                    await node.pubsub.publish('skysoft-jobmarket-messages', new TextEncoder().encode(JSON.stringify(message)));
                }
                
                // Clear input
                input.value = '';
                
                // Reload messages
                loadChatMessages();
                
                // Record activity
                await recordActivity('message', `Sent message to ${chatWith}`);
                
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message. Please try again.');
            }
        }
        
        // Load message contacts
        async function loadMessageContacts() {
            try {
                // Get all messages involving current user
                const messagesSent = await messageDb.query('from', currentUser.username);
                const messagesReceived = await messageDb.query('to', currentUser.username);
                
                // Get unique usernames of contacts
                const contacts = new Set();
                
                messagesSent.forEach(msg => contacts.add(msg.to));
                messagesReceived.forEach(msg => contacts.add(msg.from));
                
                // Get user details for each contact
                const contactsWithDetails = await Promise.all(
                    Array.from(contacts).map(async username => {
                        const user = await userDb.get(username);
                        return user || { username, name: username };
                    })
                );
                
                // Render contacts
                const contactsHtml = contactsWithDetails.length > 0 ? 
                    contactsWithDetails.map(user => renderContact(user)).join('') :
                    '<p>No messages yet. Start a conversation with someone!</p>';
                
                document.getElementById('messageContacts').innerHTML = contactsHtml;
                
                // Add event listeners
                contactsWithDetails.forEach(user => {
                    document.getElementById(`contact-${user.username}`).addEventListener('click', () => {
                        chatWith = user.username;
                        loadChatMessages();
                    });
                });
                
            } catch (error) {
                console.error('Error loading message contacts:', error);
                document.getElementById('messageContacts').innerHTML = '<p>Error loading contacts. Please try again.</p>';
            }
        }
        
        // Render contact
        function renderContact(user) {
            return `
                <div style="display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; cursor: pointer;" id="contact-${user.username}">
                    <img src="${user.profilePicture || 'https://via.placeholder.com/40'}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
                    <div>
                        <div>${user.name}</div>
                        <div style="font-size: 0.8rem; color: #777;">${user.profession || 'No profession specified'}</div>
                    </div>
                </div>
            `;
        }
        
        // Load profile data
        async function loadProfileData() {
            if (!currentUser) return;
            
            // Fill form with current user data
            document.getElementById('profileName').value = currentUser.name;
            document.getElementById('profileUsername').value = currentUser.username;
            document.getElementById('profileEmail').value = currentUser.email;
            document.getElementById('profilePhone').value = currentUser.phone;
            document.getElementById('profileProfession').value = currentUser.profession || '';
            document.getElementById('profileJobTitle').value = currentUser.jobTitle || '';
            document.getElementById('profileWorkplace').value = currentUser.workplace || '';
            document.getElementById('profileLocation').value = currentUser.location || '';
            
            // Load profile picture if exists
            if (currentUser.profilePicture) {
                document.getElementById('profilePicture').src = currentUser.profilePicture;
            }
            
            // Load currency
            loadCurrencies('profileCurrency', currentUser.currency);
        }
        
        // Save profile
        async function saveProfile(e) {
            e.preventDefault();
            
            const name = document.getElementById('profileName').value.trim();
            const username = document.getElementById('profileUsername').value.trim().toLowerCase();
            const email = document.getElementById('profileEmail').value.trim().toLowerCase();
            const phone = document.getElementById('profilePhone').value.trim();
            const profession = document.getElementById('profileProfession').value.trim();
            const jobTitle = document.getElementById('profileJobTitle').value.trim();
            const workplace = document.getElementById('profileWorkplace').value.trim();
            const currency = document.getElementById('profileCurrency').value;
            
            // Validate inputs
            if (!name || !username || !email || !phone) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Check if username changed and is available
            if (username !== currentUser.username) {
                const available = await checkProfileUsernameAvailability(true);
                if (!available) {
                    alert('Username is not available');
                    return;
                }
            }
            
            try {
                // Update user object
                currentUser.name = name;
                currentUser.username = username;
                currentUser.email = email;
                currentUser.phone = phone;
                currentUser.profession = profession;
                currentUser.jobTitle = jobTitle;
                currentUser.workplace = workplace;
                currentUser.currency = currency;
                currentUser.updatedAt = new Date().toISOString();
                
                // Save to database
                await userDb.put(currentUser.username, currentUser);
                
                // Update local storage
                localStorage.setItem('loggedInUser', JSON.stringify(currentUser));
                
                // Update UI
                document.getElementById('userName').textContent = currentUser.username;
                document.getElementById('welcomeName').textContent = currentUser.username;
                
                // Record activity
                await recordActivity('profile', `Updated profile information`);
                
                // Show success message
                alert('Profile updated successfully');
                
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Failed to update profile. Please try again.');
            }
        }
        
        // Upload profile picture
        async function uploadProfilePicture(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                // Upload to IPFS
                const hash = await uploadFileToIPFS(file);
                
                // Update user object
                currentUser.profilePicture = `https://ipfs.io/ipfs/${hash}`;
                currentUser.updatedAt = new Date().toISOString();
                
                // Save to database
                await userDb.put(currentUser.username, currentUser);
                
                // Update local storage
                localStorage.setItem('loggedInUser', JSON.stringify(currentUser));
                
                // Update UI
                document.getElementById('profilePicture').src = currentUser.profilePicture;
                document.getElementById('userProfilePic').src = currentUser.profilePicture;
                
                // Record activity
                await recordActivity('profile', `Updated profile picture`);
                
                // Show success message
                alert('Profile picture updated successfully');
                
            } catch (error) {
                console.error('Error uploading profile picture:', error);
                alert('Failed to upload profile picture. Please try again.');
            }
        }
        
        // Change password
        async function changePassword(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value.trim();
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmNewPassword = document.getElementById('confirmNewPassword').value.trim();
            
            // Validate inputs
            if (!currentPassword || !newPassword || !confirmNewPassword) {
                alert('Please fill in all fields');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                alert('New passwords do not match');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }
            
            try {
                // Verify current password
                const hashedCurrentPassword = sha256(currentPassword);
                if (hashedCurrentPassword !== currentUser.password) {
                    alert('Current password is incorrect');
                    return;
                }
                
                // Hash new password
                const hashedNewPassword = sha256(newPassword);
                
                // Update user object
                currentUser.password = hashedNewPassword;
                currentUser.updatedAt = new Date().toISOString();
                
                // Save to database
                await userDb.put(currentUser.username, currentUser);
                
                // Update local storage
                localStorage.setItem('loggedInUser', JSON.stringify(currentUser));
                
                // Reset form
                document.getElementById('passwordForm').reset();
                
                // Record activity
                await recordActivity('security', `Changed password`);
                
                // Show success message
                alert('Password changed successfully');
                
            } catch (error) {
                console.error('Error changing password:', error);
                alert('Failed to change password. Please try again.');
            }
        }
        
        // Load job categories
        async function loadJobCategories() {
            try {
                const categories = await categoryDb.all();
                
                const select = document.getElementById('jobCategory');
                select.innerHTML = '<option value="">Select a category</option>';
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = category.name;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading job categories:', error);
            }
        }
        
        // Load currencies
        function loadCurrencies(selectId = 'jobCurrency', selectedCurrency = 'UGX') {
            const select = document.getElementById(selectId);
            select.innerHTML = '';
            
            currencies.forEach(currency => {
                const option = document.createElement('option');
                option.value = currency.code;
                option.textContent = `${currency.name} (${currency.symbol})`;
                option.selected = currency.code === selectedCurrency;
                select.appendChild(option);
            });
        }
        
        // Post job
        async function postJob(e) {
            e.preventDefault();
            
            const title = document.getElementById('jobTitle').value.trim();
            const company = document.getElementById('jobCompany').value.trim();
            const category = document.getElementById('jobCategory').value;
            const positions = document.getElementById('jobPositions').value;
            const description = document.getElementById('jobDescription').value.trim();
            const location = document.getElementById('jobLocation').value.trim();
            const currency = document.getElementById('jobCurrency').value;
            const salaryMin = document.getElementById('jobSalaryMin').value;
            const salaryMax = document.getElementById('jobSalaryMax').value;
            const salaryNotDisclosed = document.getElementById('jobSalaryNotDisclosed').checked;
            const deadline = document.getElementById('jobDeadline').value;
            const allowComments = document.getElementById('jobAllowComments').checked;
            const allowPrivateMessages = document.getElementById('jobAllowPrivateMessages').checked;
            const imageFile = document.getElementById('jobImage').files[0];
            
            // Validate inputs
            if (!title || !company || !category || !positions || !description || !location || !deadline) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (!salaryNotDisclosed && (!salaryMin || !salaryMax)) {
                alert('Please enter salary range or check "Not Disclosed"');
                return;
            }
            
            try {
                let imageHash = '';
                
                // Upload image if provided
                if (imageFile) {
                    imageHash = await uploadFileToIPFS(imageFile);
                }
                
                // Check if company has blue tick
                let companyBlueTick = false;
                const companies = await companyDb.query('name', company);
                if (companies.length > 0 && companies[0].blueTick) {
                    companyBlueTick = true;
                }
                
                // Create job object
                const job = {
                    id: generateId(),
                    title,
                    company,
                    blueTick: companyBlueTick,
                    category,
                    positions: parseInt(positions),
                    description,
                    location,
                    currency,
                    salaryMin: salaryNotDisclosed ? 0 : parseFloat(salaryMin),
                    salaryMax: salaryNotDisclosed ? 0 : parseFloat(salaryMax),
                    salaryNotDisclosed,
                    deadline: new Date(deadline).toISOString(),
                    image: imageHash,
                    allowComments,
                    allowPrivateMessages,
                    poster: currentUser.username,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // Save to database
                await jobDb.put(job.id, job);
                
                // Publish job to network
                if (node && node.pubsub) {
                    await node.pubsub.publish('skysoft-jobmarket-jobs', new TextEncoder().encode(JSON.stringify(job)));
                }
                
                // Reset form
                document.getElementById('postJobForm').reset();
                
                // Record activity
                await recordActivity('job', `Posted new job: ${title}`);
                
                // Show success message
                alert('Job posted successfully!');
                
                // Reload jobs
                loadRecentJobs();
                loadAllJobs();
                
            } catch (error) {
                console.error('Error posting job:', error);
                alert('Failed to post job. Please try again.');
            }
        }
        
        // Load my companies
        async function loadMyCompanies() {
            try {
                const companies = await companyDb.query('owner', currentUser.username);
                
                const companiesHtml = companies.length > 0 ? 
                    companies.map(company => renderCompanyCard(company)).join('') :
                    '<p>You have not registered any companies yet.</p>';
                
                document.getElementById('myCompaniesList').innerHTML = companiesHtml;
                
                // Add event listeners
                companies.forEach(company => {
                    document.getElementById(`editCompany-${company.id}`).addEventListener('click', () => editCompany(company.id));
                });
                
            } catch (error) {
                console.error('Error loading companies:', error);
                document.getElementById('myCompaniesList').innerHTML = '<p>Error loading companies. Please try again.</p>';
            }
        }
        
        // Render company card
        function renderCompanyCard(company) {
            return `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;">
                    <div style="display: flex; align-items: center;">
                        ${company.logo ? `<img src="https://ipfs.io/ipfs/${company.logo}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">` : ''}
                        <div>
                            <div>${company.name} ${company.blueTick ? '<i class="fas fa-check-circle blue-tick"></i>' : ''}</div>
                            <div style="font-size: 0.8rem; color: #777;">${company.industry || 'No industry specified'}</div>
                        </div>
                    </div>
                    <button class="btn btn-primary btn-sm" id="editCompany-${company.id}">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            `;
        }
        
        // Show company modal
        function showCompanyModal() {
            document.getElementById('companyForm').reset();
            document.getElementById('companyModal').classList.add('show');
        }
        
        // Hide company modal
        function hideCompanyModal() {
            document.getElementById('companyModal').classList.remove('show');
        }
        
        // Save company
        async function saveCompany() {
            const name = document.getElementById('companyName').value.trim();
            const industry = document.getElementById('companyIndustry').value.trim();
            const location = document.getElementById('companyLocation').value.trim();
            const website = document.getElementById('companyWebsite').value.trim();
            const description = document.getElementById('companyDescription').value.trim();
            const requestBlueTick = document.getElementById('requestBlueTick').checked;
            const logoFile = document.getElementById('companyLogo').files[0];
            
            // Validate inputs
            if (!name || !industry || !location || !description || !logoFile) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                // Upload logo to IPFS
                const logoHash = await uploadFileToIPFS(logoFile);
                
                // Create company object
                const company = {
                    id: generateId(),
                    name,
                    industry,
                    location,
                    website,
                    description,
                    logo: logoHash,
                    owner: currentUser.username,
                    blueTick: false,
                    blueTickRequested: requestBlueTick,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // Save to database
                await companyDb.put(company.id, company);
                
                // Record activity
                await recordActivity('company', `Registered new company: ${name}`);
                
                // Hide modal
                hideCompanyModal();
                
                // Show success message
                alert('Company registered successfully!');
                
                // Reload companies
                loadMyCompanies();
                
            } catch (error) {
                console.error('Error saving company:', error);
                alert('Failed to register company. Please try again.');
            }
        }
        
        // Edit company
        async function editCompany(companyId) {
            try {
                const company = await companyDb.get(companyId);
                if (!company) {
                    alert('Company not found');
                    return;
                }
                
                // Fill form
                document.getElementById('companyName').value = company.name;
                document.getElementById('companyIndustry').value = company.industry;
                document.getElementById('companyLocation').value = company.location;
                document.getElementById('companyWebsite').value = company.website;
                document.getElementById('companyDescription').value = company.description;
                document.getElementById('requestBlueTick').checked = company.blueTickRequested;
                
                // Show logo preview if exists
                if (company.logo) {
                    // TODO: Show logo preview
                }
                
                // Store company ID in a data attribute
                document.getElementById('companyForm').dataset.companyId = companyId;
                
                // Show modal
                document.getElementById('companyModal').classList.add('show');
                
            } catch (error) {
                console.error('Error editing company:', error);
                alert('Failed to edit company. Please try again.');
            }
        }
        
        // Load admin users
        async function loadAdminUsers() {
            try {
                const users = await userDb.all();
                
                // Sort by newest first
                users.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                // Render users
                const usersHtml = users.map(user => renderAdminUserRow(user)).join('');
                document.getElementById('adminUsersList').innerHTML = usersHtml;
                
                // Add event listeners
                users.forEach(user => {
                    document.getElementById(`banUser-${user.username}`).addEventListener('click', () => banUser(user.username));
                    document.getElementById(`makeAdmin-${user.username}`).addEventListener('click', () => makeAdmin(user.username));
                });
                
                // Add search functionality
                document.getElementById('adminUserSearch').addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const filteredUsers = users.filter(user => 
                        user.name.toLowerCase().includes(searchTerm) || 
                        user.username.toLowerCase().includes(searchTerm) ||
                        user.email.toLowerCase().includes(searchTerm) ||
                        user.phone.toLowerCase().includes(searchTerm)
                    );
                    
                    const filteredHtml = filteredUsers.map(user => renderAdminUserRow(user)).join('');
                    document.getElementById('adminUsersList').innerHTML = filteredHtml;
                    
                    // Add event listeners to filtered users
                    filteredUsers.forEach(user => {
                        document.getElementById(`banUser-${user.username}`).addEventListener('click', () => banUser(user.username));
                        document.getElementById(`makeAdmin-${user.username}`).addEventListener('click', () => makeAdmin(user.username));
                    });
                });
                
            } catch (error) {
                console.error('Error loading admin users:', error);
                document.getElementById('adminUsersList').innerHTML = '<tr><td colspan="6">Error loading users. Please try again.</td></tr>';
            }
        }
        
        // Render admin user row
        function renderAdminUserRow(user) {
            return `
                <tr>
                    <td style="padding: 10px;">${user.name}</td>
                    <td style="padding: 10px;">${user.username}</td>
                    <td style="padding: 10px;">${user.email}</td>
                    <td style="padding: 10px;">${user.phone}</td>
                    <td style="padding: 10px;">
                        ${user.isBanned ? '<span style="color: var(--danger-color);">Banned</span>' : 
                          user.isAdmin ? '<span style="color: var(--success-color);">Admin</span>' : 
                          '<span style="color: var(--primary-color);">Active</span>'}
                    </td>
                    <td style="padding: 10px;">
                        <button class="btn btn-danger btn-sm" id="banUser-${user.username}" ${user.isAdmin ? 'disabled' : ''}>
                            ${user.isBanned ? 'Unban' : 'Ban'}
                        </button>
                        <button class="btn btn-primary btn-sm" id="makeAdmin-${user.username}" ${user.isAdmin ? 'disabled' : ''}>
                            Make Admin
                        </button>
                    </td>
                </tr>
            `;
        }
        
        // Ban user
        async function banUser(username) {
            if (!username) {
                username = document.getElementById('viewReportContent').dataset.username;
            }
            
            if (!username) {
                alert('User not found');
                return;
            }
            
            if (!confirm(`Are you sure you want to ${currentUser.isBanned ? 'unban' : 'ban'} this user?`)) {
                return;
            }
            
            try {
                const user = await userDb.get(username);
                if (!user) {
                    alert('User not found');
                    return;
                }
                
                // Toggle ban status
                user.isBanned = !user.isBanned;
                user.updatedAt = new Date().toISOString();
                
                // Save to database
                await userDb.put(username, user);
                
                // Record activity
                await recordActivity('admin', `${user.isBanned ? 'Banned' : 'Unbanned'} user ${username}`);
                
                // Reload users
                loadAdminUsers();
                
                // Hide report modal if open
                hideViewReportModal();
                
                // Show success message
                alert(`User ${user.isBanned ? 'banned' : 'unbanned'} successfully`);
                
            } catch (error) {
                console.error('Error banning user:', error);
                alert('Failed to ban user. Please try again.');
            }
        }
        
        // Make admin
        async function makeAdmin(username) {
            if (!confirm('Are you sure you want to make this user an admin?')) {
                return;
            }
            
            try {
                const user = await userDb.get(username);
                if (!user) {
                    alert('User not found');
                    return;
                }
                
                // Make admin
                user.isAdmin = true;
                user.updatedAt = new Date().toISOString();
                
                // Save to database
                await userDb.put(username, user);
                
                // Record activity
                await recordActivity('admin', `Made user ${username} an admin`);
                
                // Reload users
                loadAdminUsers();
                
                // Show success message
                alert('User made admin successfully');
                
            } catch (error) {
                console.error('Error making user admin:', error);
                alert('Failed to make user admin. Please try again.');
            }
        }
        
        // Load admin settings
        async function loadAdminSettings() {
            try {
                let settings = await settingsDb.get('system');
                
                if (!settings) {
                    // Create default settings
                    settings = {
                        appName: 'Skysoft Job Market',
                        systemEmail: '',
                        inactivityTimeout: 30,
                        blueTickPosts: 100,
                        successor1: '',
                        successor2: ''
                    };
                    
                    await settingsDb.put('system', settings);
                }
                
                // Fill form
                document.getElementById('adminAppName').value = settings.appName;
                document.getElementById('adminSystemEmail').value = settings.systemEmail;
                document.getElementById('adminInactivityTimeout').value = settings.inactivityTimeout;
                document.getElementById('adminBlueTickPosts').value = settings.blueTickPosts;
                document.getElementById('adminSuccessor1').value = settings.successor1;
                document.getElementById('adminSuccessor2').value = settings.successor2;
                
                // Load categories
                const categories = await categoryDb.all();
                const categoriesHtml = categories.map(category => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #eee;">
                        <span>${category.name}</span>
                        <button class="btn btn-danger btn-sm" data-category="${category.name}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
                
                document.getElementById('adminCategoriesList').innerHTML = 
                    categoriesHtml || '<p>No categories added yet.</p>';
                
                // Add event listeners to delete buttons
                categories.forEach(category => {
                    document.querySelector(`button[data-category="${category.name}"]`).addEventListener('click', () => deleteCategory(category.name));
                });
                
            } catch (error) {
                console.error('Error loading admin settings:', error);
            }
        }
        
        // Save admin settings
        async function saveAdminSettings(e) {
            e.preventDefault();
            
            const appName = document.getElementById('adminAppName').value.trim();
            const systemEmail = document.getElementById('adminSystemEmail').value.trim();
            const inactivityTimeout = document.getElementById('adminInactivityTimeout').value;
            const blueTickPosts = document.getElementById('adminBlueTickPosts').value;
            const successor1 = document.getElementById('adminSuccessor1').value.trim();
            const successor2 = document.getElementById('adminSuccessor2').value.trim();
            
            // Validate inputs
            if (!appName || !systemEmail || !inactivityTimeout || !blueTickPosts) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                // Create settings object
                const settings = {
                    appName,
                    systemEmail,
                    inactivityTimeout: parseInt(inactivityTimeout),
                    blueTickPosts: parseInt(blueTickPosts),
                    successor1,
                    successor2,
                    updatedAt: new Date().toISOString()
                };
                
                // Save to database
                await settingsDb.put('system', settings);
                
                // Record activity
                await recordActivity('settings', `Updated system settings`);
                
                // Show success message
                alert('Settings saved successfully');
                
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Failed to save settings. Please try again.');
            }
        }
        
        // Add category
        async function addCategory() {
            const name = document.getElementById('adminNewCategory').value.trim();
            
            if (!name) {
                alert('Please enter a category name');
                return;
            }
            
            try {
                // Check if category already exists
                const existing = await categoryDb.get(name);
                if (existing) {
                    alert('Category already exists');
                    return;
                }
                
                // Create category object
                const category = {
                    name,
                    createdAt: new Date().toISOString()
                };
                
                // Save to database
                await categoryDb.put(name, category);
                
                // Clear input
                document.getElementById('adminNewCategory').value = '';
                
                // Record activity
                await recordActivity('category', `Added new category: ${name}`);
                
                // Reload categories
                loadAdminSettings();
                
                // Show success message
                alert('Category added successfully');
                
            } catch (error) {
                console.error('Error adding category:', error);
                alert('Failed to add category. Please try again.');
            }
        }
        
        // Delete category
        async function deleteCategory(name) {
            if (!confirm(`Are you sure you want to delete the category "${name}"?`)) {
                return;
            }
            
            try {
                // Delete from database
                await categoryDb.delete(name);
                
                // Record activity
                await recordActivity('category', `Deleted category: ${name}`);
                
                // Reload categories
                loadAdminSettings();
                
                // Show success message
                alert('Category deleted successfully');
                
            } catch (error) {
                console.error('Error deleting category:', error);
                alert('Failed to delete category. Please try again.');
            }
        }
        
        // Send broadcast message
        async function sendBroadcast(e) {
            e.preventDefault();
            
            const type = document.getElementById('broadcastType').value;
            const message = document.getElementById('broadcastMessageText').value.trim();
            
            if (!message) {
                alert('Please enter a message');
                return;
            }
            
            try {
                // Create broadcast object
                const broadcast = {
                    type,
                    message,
                    sender: currentUser.username,
                    timestamp: new Date().toISOString()
                };
                
                // Publish broadcast to network
                if (node && node.pubsub) {
                    await node.pubsub.publish('skysoft-jobmarket-broadcast', new TextEncoder().encode(JSON.stringify(broadcast)));
                }
                
                // Reset form
                document.getElementById('broadcastMessageText').value = '';
                
                // Record activity
                await recordActivity('broadcast', `Sent broadcast message`);
                
                // Show success message
                alert('Broadcast sent successfully');
                
            } catch (error) {
                console.error('Error sending broadcast:', error);
                alert('Failed to send broadcast. Please try again.');
            }
        }
        
        // Show broadcast message
        function showBroadcastMessage(message, type = 'info') {
            const broadcastEl = document.getElementById('broadcastMessage');
            broadcastEl.style.backgroundColor = 
                type === 'warning' ? 'var(--warning-color)' : 
                type === 'alert' ? 'var(--danger-color)' : 'var(--primary-color)';
            
            document.getElementById('broadcastText').textContent = message;
            broadcastEl.classList.add('show');
        }
        
        // Hide broadcast message
        function hideBroadcastMessage() {
            document.getElementById('broadcastMessage').classList.remove('show');
        }
        
        // Show report modal
        function showReportModal(jobId) {
            document.getElementById('reportForm').reset();
            document.getElementById('reportForm').dataset.jobId = jobId;
            document.getElementById('reportModal').classList.add('show');
        }
        
        // Hide report modal
        function hideReportModal() {
            document.getElementById('reportModal').classList.remove('show');
        }
        
        // Submit report
        async function submitReport() {
            const form = document.getElementById('reportForm');
            const jobId = form.dataset.jobId;
            
            const reason = document.getElementById('reportReason').value;
            const otherReason = document.getElementById('reportOther').value.trim();
            const details = document.getElementById('reportDetails').value.trim();
            const evidenceFiles = document.getElementById('reportEvidence').files;
            
            // Validate inputs
            if (!reason || !details) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (reason === 'other' && !otherReason) {
                alert('Please specify the reason');
                return;
            }
            
            try {
                // Upload evidence files to IPFS
                const evidenceHashes = [];
                for (let i = 0; i < evidenceFiles.length; i++) {
                    const hash = await uploadFileToIPFS(evidenceFiles[i]);
                    evidenceHashes.push(hash);
                }
                
                // Create report object
                const report = {
                    id: generateId(),
                    jobId,
                    reporter: currentUser.username,
                    reason: reason === 'other' ? otherReason : reason,
                    details,
                    evidence: evidenceHashes,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // Save to database
                await reportDb.put(report.id, report);
                
                // Record activity
                await recordActivity('report', `Reported job ${jobId}`);
                
                // Hide modal
                hideReportModal();
                
                // Show success message
                alert('Report submitted successfully. Thank you for your feedback.');
                
            } catch (error) {
                console.error('Error submitting report:', error);
                alert('Failed to submit report. Please try again.');
            }
        }
        
        // Show view report modal
        async function showViewReportModal(reportId) {
            try {
                const report = await reportDb.get(reportId);
                if (!report) {
                    alert('Report not found');
                    return;
                }
                
                const job = await jobDb.get(report.jobId);
                const reporter = await userDb.get(report.reporter);
                
                // Render report details
                document.getElementById('viewReportContent').innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h4>Report Details</h4>
                        <p><strong>Job Title:</strong> ${job?.title || 'Job not found'}</p>
                        <p><strong>Reported by:</strong> ${reporter?.name || report.reporter}</p>
                        <p><strong>Reason:</strong> ${report.reason}</p>
                        <p><strong>Date:</strong> ${new Date(report.createdAt).toLocaleString()}</p>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <h4>Details</h4>
                        <p>${report.details}</p>
                    </div>
                    ${report.evidence.length > 0 ? `
                    <div style="margin-bottom: 15px;">
                        <h4>Evidence</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            ${report.evidence.map(hash => `
                                <a href="https://ipfs.io/ipfs/${hash}" target="_blank" style="text-decoration: none;">
                                    <div style="width: 100px; height: 100px; background-color: #f5f5f5; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-file" style="font-size: 2rem; color: #777;"></i>
                                    </div>
                                </a>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                `;
                
                // Store job ID and reporter username in data attributes
                document.getElementById('viewReportContent').dataset.jobId = report.jobId;
                document.getElementById('viewReportContent').dataset.username = job?.poster;
                
                // Show modal
                document.getElementById('viewReportModal').classList.add('show');
                
            } catch (error) {
                console.error('Error showing report:', error);
                alert('Failed to load report. Please try again.');
            }
        }
        
        // Hide view report modal
        function hideViewReportModal() {
            document.getElementById('viewReportModal').classList.remove('show');
        }
        
        // Approve job
        async function approveJob() {
            const jobId = document.getElementById('viewReportContent').dataset.jobId;
            
            if (!jobId) {
                alert('Job not found');
                return;
            }
            
            try {
                const job = await jobDb.get(jobId);
                if (!job) {
                    alert('Job not found');
                    return;
                }
                
                // Add blue tick to this job only
                job.blueTick = true;
                job.updatedAt = new Date().toISOString();
                
                // Save to database
                await jobDb.put(jobId, job);
                
                // Update all reports for this job
                const reports = await reportDb.query('jobId', jobId);
                await Promise.all(reports.map(async report => {
                    report.status = 'resolved';
                    report.updatedAt = new Date().toISOString();
                    await reportDb.put(report.id, report);
                }));
                
                // Record activity
                await recordActivity('report', `Approved job ${jobId} after review`);
                
                // Hide modal
                hideViewReportModal();
                
                // Show success message
                alert('Job approved and marked with blue tick');
                
                // Reload jobs
                loadRecentJobs();
                loadAllJobs();
                
            } catch (error) {
                console.error('Error approving job:', error);
                alert('Failed to approve job. Please try again.');
            }
        }
        
        // Show notification modal
        async function showNotificationModal() {
            try {
                // Get notifications for current user
                const notifications = await activityDb.query('user', currentUser.username);
                
                // Sort by newest first
                notifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Render notifications
                const notificationsHtml = notifications.length > 0 ? 
                    notifications.map(notification => renderNotification(notification)).join('') :
                    '<p>No notifications yet.</p>';
                
                document.getElementById('notificationContent').innerHTML = notificationsHtml;
                
                // Update badge
                const unreadCount = notifications.filter(n => !n.read).length;
                document.getElementById('notificationBadge').style.display = unreadCount > 0 ? 'flex' : 'none';
                document.getElementById('notificationBadge').textContent = unreadCount;
                
                // Show modal
                document.getElementById('notificationModal').classList.add('show');
                
                // Mark all as read
                await Promise.all(notifications.map(async notification => {
                    if (!notification.read) {
                        notification.read = true;
                        await activityDb.put(notification.id, notification);
                    }
                }));
                
            } catch (error) {
                console.error('Error loading notifications:', error);
                document.getElementById('notificationContent').innerHTML = '<p>Error loading notifications. Please try again.</p>';
            }
        }
        
        // Hide notification modal
        function hideNotificationModal() {
            document.getElementById('notificationModal').classList.remove('show');
        }
        
        // Render notification
        function renderNotification(notification) {
            return `
                <div style="padding: 10px; border-bottom: 1px solid #eee; ${notification.read ? '' : 'background-color: #f5f9ff;'}">
                    <div style="font-weight: ${notification.read ? 'normal' : 'bold'};}">${notification.message}</div>
                    <div style="font-size: 0.8rem; color: #777;">${new Date(notification.timestamp).toLocaleString()}</div>
                </div>
            `;
        }
        
        // Record activity
        async function recordActivity(type, message) {
            try {
                const activity = {
                    id: generateId(),
                    type,
                    user: currentUser.username,
                    message,
                    timestamp: new Date().toISOString(),
                    read: false
                };
                
                await activityDb.put(activity.id, activity);
                
            } catch (error) {
                console.error('Error recording activity:', error);
            }
        }
        
        // Upload file to IPFS
        async function uploadFileToIPFS(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = async function() {
                    try {
                        const buffer = Buffer.from(reader.result);
                        const { cid } = await ipfs.add(buffer);
                        resolve(cid.toString());
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        // Start interview
        async function startInterview(applicationId) {
            try {
                const application = await applicationDb.get(applicationId);
                if (!application) {
                    alert('Application not found');
                    return;
                }
                
                const job = await jobDb.get(application.jobId);
                if (!job) {
                    alert('Job not found');
                    return;
                }
                
                // Store interview data
                interviewData = {
                    applicationId,
                    jobId: job.id,
                    applicant: application.applicant,
                    interviewer: currentUser.username
                };
                
                // Initialize WebRTC
                await initWebRTC();
                
                // Show interview room
                document.getElementById('interviewRoom').classList.add('show');
                document.getElementById('remoteVideoLabel').textContent = application.name;
                
            } catch (error) {
                console.error('Error starting interview:', error);
                alert('Failed to start interview. Please try again.');
            }
        }
        
        // Initialize WebRTC
        async function initWebRTC() {
            try {
                // Get local media stream
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = stream;
                
                // TODO: Implement WebRTC connection between peers
                // This would require a signaling server and more complex setup
                
            } catch (error) {
                console.error('Error initializing WebRTC:', error);
                alert('Failed to access camera/microphone. Please check permissions.');
            }
        }
        
        // End interview
        function endInterview() {
            // Stop all media streams
            if (document.getElementById('localVideo').srcObject) {
                document.getElementById('localVideo').srcObject.getTracks().forEach(track => track.stop());
            }
            
            if (document.getElementById('remoteVideo').srcObject) {
                document.getElementById('remoteVideo').srcObject.getTracks().forEach(track => track.stop());
            }
            
            // Hide interview room
            document.getElementById('interviewRoom').classList.remove('show');
            
            // Clear interview data
            interviewData = null;
        }
        
        // Toggle mute
        function toggleMute() {
            const button = document.getElementById('muteBtn');
            const icon = button.querySelector('i');
            
            if (document.getElementById('localVideo').srcObject) {
                const audioTracks = document.getElementById('localVideo').srcObject.getAudioTracks();
                if (audioTracks.length > 0) {
                    const enabled = audioTracks[0].enabled;
                    audioTracks[0].enabled = !enabled;
                    
                    icon.classList.toggle('fa-microphone');
                    icon.classList.toggle('fa-microphone-slash');
                }
            }
        }
        
        // Toggle video
        function toggleVideo() {
            const button = document.getElementById('videoBtn');
            const icon = button.querySelector('i');
            
            if (document.getElementById('localVideo').srcObject) {
                const videoTracks = document.getElementById('localVideo').srcObject.getVideoTracks();
                if (videoTracks.length > 0) {
                    const enabled = videoTracks[0].enabled;
                    videoTracks[0].enabled = !enabled;
                    
                    icon.classList.toggle('fa-video');
                    icon.classList.toggle('fa-video-slash');
                }
            }
        }
        
        // Start inactivity timer
        function startInactivityTimer() {
            let timeout;
            
            const resetTimer = () => {
                clearTimeout(timeout);
                
                // Get inactivity timeout from settings (default to 30 minutes)
                const inactivityTimeout = (settingsDb?.inactivityTimeout || 30) * 60 * 1000;
                
                timeout = setTimeout(() => {
                    if (currentUser) {
                        logout();
                    }
                }, inactivityTimeout);
            };
            
            // Reset timer on these events
            ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
                document.addEventListener(event, resetTimer);
            });
            
            resetTimer();
        }
        
        // Generate ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
    </script>
</body>
</html>
