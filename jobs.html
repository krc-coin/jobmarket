<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skysoft Job Market</title>
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --border-radius: 5px;
            --box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            box-shadow: var(--box-shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        
        .auth-buttons button {
            background-color: white;
            color: var(--primary-color);
            border: none;
            padding: 8px 15px;
            margin-left: 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .auth-buttons button:hover {
            background-color: var(--light-color);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--box-shadow);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: var(--primary-color);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--dark-color);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-block;
        }
        
        .btn:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
        }
        
        .btn-warning:hover {
            background-color: #d35400;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .sidebar {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--box-shadow);
            height: fit-content;
        }
        
        .sidebar-menu {
            list-style: none;
        }
        
        .sidebar-menu li {
            margin-bottom: 10px;
        }
        
        .sidebar-menu a {
            display: block;
            padding: 10px;
            color: var(--dark-color);
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: all 0.3s;
        }
        
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: var(--light-color);
            color: var(--primary-color);
        }
        
        .sidebar-menu i {
            margin-right: 10px;
        }
        
        .main-content {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
        }
        
        .section-title {
            margin-bottom: 20px;
            color: var(--primary-color);
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .job-card {
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .job-card:hover {
            box-shadow: var(--box-shadow);
        }
        
        .job-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .job-company {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .job-company.verified::after {
            content: "✓";
            color: var(--primary-color);
            margin-left: 5px;
        }
        
        .job-location, .job-deadline, .job-salary {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            color: #666;
        }
        
        .job-location i, .job-deadline i, .job-salary i {
            margin-right: 5px;
        }
        
        .job-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .job-actions .btn {
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
        }
        
        .user-info h3 {
            margin-bottom: 5px;
        }
        
        .user-info p {
            color: #666;
        }
        
        .tab-container {
            margin-top: 20px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .online-users {
            margin-top: 20px;
        }
        
        .user-badge {
            display: inline-block;
            background-color: var(--light-color);
            padding: 5px 10px;
            border-radius: 20px;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .user-badge.online::after {
            content: "•";
            color: var(--success-color);
            margin-left: 5px;
        }
        
        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 1000;
            display: none;
        }
        
        .chat-header {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .close-chat {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        .chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 15px;
        }
        
        .message {
            margin-bottom: 15px;
        }
        
        .message.sent {
            text-align: right;
        }
        
        .message-content {
            display: inline-block;
            padding: 10px 15px;
            border-radius: 20px;
            max-width: 80%;
        }
        
        .message.received .message-content {
            background-color: var(--light-color);
            border-top-left-radius: 5px;
        }
        
        .message.sent .message-content {
            background-color: var(--primary-color);
            color: white;
            border-top-right-radius: 5px;
        }
        
        .message-time {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        
        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
        }
        
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-right: 10px;
        }
        
        .alert {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .search-container {
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
        }
        
        .filter-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .filter-container select {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
        }
        
        .badge {
            display: inline-block;
            padding: 3px 7px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .badge-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .badge-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .badge-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .application-card {
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .application-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .application-status {
            font-weight: bold;
        }
        
        .status-pending {
            color: var(--warning-color);
        }
        
        .status-accepted {
            color: var(--success-color);
        }
        
        .status-rejected {
            color: var(--danger-color);
        }
        
        .application-actions {
            display: flex;
            gap: 10px;
        }
        
        .interview-container {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--light-color);
            border-radius: var(--border-radius);
        }
        
        .interview-container h4 {
            margin-bottom: 10px;
        }
        
        .video-container {
            width: 100%;
            height: 300px;
            background-color: var(--dark-color);
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .admin-panel {
            margin-top: 20px;
        }
        
        .admin-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .report-card {
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .report-reason {
            font-weight: bold;
        }
        
        .report-actions {
            display: flex;
            gap: 10px;
        }
        
        .blue-tick {
            color: var(--primary-color);
            margin-left: 5px;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
            
            .chat-container {
                width: 90%;
                right: 5%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo">Skysoft Job Market</div>
            <div class="auth-buttons">
                <button id="loginBtn">Login</button>
                <button id="signupBtn">Sign Up</button>
                <button id="profileBtn" style="display: none;">My Profile</button>
                <button id="logoutBtn" style="display: none;">Logout</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="welcome-section">
            <h1>Welcome to Skysoft Job Market</h1>
            <p>Find your dream job or the perfect candidate in our decentralized peer-to-peer job marketplace.</p>
            <div class="search-container">
                <input type="text" id="mainSearch" class="search-input" placeholder="Search for jobs...">
                <div class="filter-container">
                    <select id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                    <select id="locationFilter">
                        <option value="">All Locations</option>
                    </select>
                </div>
            </div>
            <button id="postJobBtn" class="btn">Post a Job</button>
        </div>

        <div id="dashboard" style="display: none;">
            <div class="dashboard">
                <div class="sidebar">
                    <div class="user-profile">
                        <img id="userAvatar" src="https://via.placeholder.com/80" alt="User Avatar" class="user-avatar">
                        <div class="user-info">
                            <h3 id="userName">User Name</h3>
                            <p id="userTitle">Job Seeker</p>
                            <p id="userLocation">Location</p>
                        </div>
                    </div>
                    <ul class="sidebar-menu">
                        <li><a href="#" class="active" data-tab="dashboard-tab"><i>📊</i> Dashboard</a></li>
                        <li><a href="#" data-tab="jobs-tab"><i>💼</i> My Jobs</a></li>
                        <li><a href="#" data-tab="applications-tab"><i>📝</i> My Applications</a></li>
                        <li><a href="#" data-tab="messages-tab"><i>✉️</i> Messages</a></li>
                        <li><a href="#" data-tab="network-tab"><i>🌐</i> Network</a></li>
                        <li><a href="#" data-tab="settings-tab"><i>⚙️</i> Settings</a></li>
                        <li id="adminMenuItem" style="display: none;"><a href="#" data-tab="admin-tab"><i>🛡️</i> Admin Panel</a></li>
                    </ul>
                </div>
                <div class="main-content">
                    <h2 class="section-title" id="sectionTitle">Dashboard</h2>
                    <div id="dashboard-tab" class="tab-content active">
                        <div class="alert alert-info">
                            Welcome back! <span id="dashboardUsername"></span>. Check out the latest jobs below.
                        </div>
                        <div class="search-container">
                            <input type="text" id="jobSearch" class="search-input" placeholder="Search jobs...">
                            <div class="filter-container">
                                <select id="jobCategoryFilter">
                                    <option value="">All Categories</option>
                                </select>
                                <select id="jobLocationFilter">
                                    <option value="">All Locations</option>
                                </select>
                            </div>
                        </div>
                        <div id="jobListings">
                            <!-- Job listings will be loaded here -->
                        </div>
                    </div>
                    <div id="jobs-tab" class="tab-content">
                        <div class="tabs">
                            <div class="tab active" data-subtab="posted-jobs">Posted Jobs</div>
                            <div class="tab" data-subtab="job-applicants">Applicants</div>
                        </div>
                        <div id="posted-jobs" class="subtab-content active">
                            <button id="newJobBtn" class="btn">Post New Job</button>
                            <div id="postedJobsList">
                                <!-- User's posted jobs will be loaded here -->
                            </div>
                        </div>
                        <div id="job-applicants" class="subtab-content">
                            <div id="applicantsList">
                                <!-- Job applicants will be loaded here -->
                            </div>
                        </div>
                    </div>
                    <div id="applications-tab" class="tab-content">
                        <div class="tabs">
                            <div class="tab active" data-subtab="active-applications">Active</div>
                            <div class="tab" data-subtab="accepted-applications">Accepted</div>
                            <div class="tab" data-subtab="rejected-applications">Rejected</div>
                        </div>
                        <div id="active-applications" class="subtab-content active">
                            <div id="activeApplications">
                                <!-- Active applications will be loaded here -->
                            </div>
                        </div>
                        <div id="accepted-applications" class="subtab-content">
                            <div id="acceptedApplications">
                                <!-- Accepted applications will be loaded here -->
                            </div>
                        </div>
                        <div id="rejected-applications" class="subtab-content">
                            <div id="rejectedApplications">
                                <!-- Rejected applications will be loaded here -->
                            </div>
                        </div>
                    </div>
                    <div id="messages-tab" class="tab-content">
                        <div id="messageList">
                            <!-- Messages will be loaded here -->
                        </div>
                    </div>
                    <div id="network-tab" class="tab-content">
                        <div class="online-users">
                            <h3>Online Users Near You</h3>
                            <div id="nearbyUsers">
                                <!-- Nearby online users will be loaded here -->
                            </div>
                        </div>
                        <div class="online-users">
                            <h3>All Online Users</h3>
                            <div id="allOnlineUsers">
                                <!-- All online users will be loaded here -->
                            </div>
                        </div>
                    </div>
                    <div id="settings-tab" class="tab-content">
                        <div class="user-profile">
                            <img id="settingsAvatar" src="https://via.placeholder.com/80" alt="User Avatar" class="user-avatar">
                            <div class="user-info">
                                <h3>Profile Settings</h3>
                                <button id="changeAvatarBtn" class="btn">Change Photo</button>
                            </div>
                        </div>
                        <form id="profileForm">
                            <div class="form-group">
                                <label for="settingsUsername">Username</label>
                                <input type="text" id="settingsUsername" required>
                            </div>
                            <div class="form-group">
                                <label for="settingsFullName">Full Name</label>
                                <input type="text" id="settingsFullName">
                            </div>
                            <div class="form-group">
                                <label for="settingsEmail">Email</label>
                                <input type="email" id="settingsEmail" required>
                            </div>
                            <div class="form-group">
                                <label for="settingsPhone">Phone Number</label>
                                <input type="tel" id="settingsPhone" required>
                            </div>
                            <div class="form-group">
                                <label for="settingsProfession">Profession</label>
                                <input type="text" id="settingsProfession">
                            </div>
                            <div class="form-group">
                                <label for="settingsJobTitle">Job Title</label>
                                <input type="text" id="settingsJobTitle">
                            </div>
                            <div class="form-group">
                                <label for="settingsCompany">Company</label>
                                <input type="text" id="settingsCompany">
                            </div>
                            <div class="form-group">
                                <label for="settingsCurrency">Currency</label>
                                <select id="settingsCurrency">
                                    <option value="UGX">UGX - Ugandan Shilling</option>
                                    <option value="USD">USD - US Dollar</option>
                                    <option value="EUR">EUR - Euro</option>
                                    <option value="GBP">GBP - British Pound</option>
                                    <option value="KES">KES - Kenyan Shilling</option>
                                    <option value="TZS">TZS - Tanzanian Shilling</option>
                                    <option value="ZAR">ZAR - South African Rand</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-block">Update Profile</button>
                        </form>
                        <div class="form-group" style="margin-top: 20px;">
                            <label for="currentPassword">Current Password</label>
                            <input type="password" id="currentPassword">
                        </div>
                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <input type="password" id="newPassword">
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirm New Password</label>
                            <input type="password" id="confirmPassword">
                        </div>
                        <button id="changePasswordBtn" class="btn btn-block">Change Password</button>
                    </div>
                    <div id="admin-tab" class="tab-content">
                        <div class="admin-panel">
                            <h3>Admin Dashboard</h3>
                            <div class="admin-actions">
                                <button id="broadcastMessageBtn" class="btn">Send Broadcast</button>
                                <button id="manageUsersBtn" class="btn">Manage Users</button>
                                <button id="manageJobsBtn" class="btn">Manage Jobs</button>
                                <button id="manageReportsBtn" class="btn">Manage Reports</button>
                                <button id="manageCategoriesBtn" class="btn">Manage Categories</button>
                            </div>
                            <div id="adminContent">
                                <!-- Admin content will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Login</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email or Phone</label>
                    <input type="text" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-block">Login</button>
            </form>
            <div style="text-align: center; margin-top: 15px;">
                <p>Or login with:</p>
                <div style="display: flex; justify-content: center; gap: 10px; margin-top: 10px;">
                    <button id="googleLoginBtn" class="btn" style="background-color: #DB4437;">Google</button>
                    <button id="facebookLoginBtn" class="btn" style="background-color: #4267B2;">Facebook</button>
                    <button id="whatsappLoginBtn" class="btn" style="background-color: #25D366;">WhatsApp</button>
                </div>
            </div>
            <p style="text-align: center; margin-top: 15px;">Don't have an account? <a href="#" id="showSignup">Sign up</a></p>
        </div>
    </div>

    <!-- Signup Modal -->
    <div id="signupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Sign Up</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="signupForm">
                <div class="form-group">
                    <label for="signupFullName">Full Name</label>
                    <input type="text" id="signupFullName" required>
                </div>
                <div class="form-group">
                    <label for="signupUsername">Username</label>
                    <input type="text" id="signupUsername" required>
                </div>
                <div class="form-group">
                    <label for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" required>
                </div>
                <div class="form-group">
                    <label for="signupPhone">Phone Number</label>
                    <input type="tel" id="signupPhone" required>
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" required>
                </div>
                <div class="form-group">
                    <label for="signupConfirmPassword">Confirm Password</label>
                    <input type="password" id="signupConfirmPassword" required>
                </div>
                <div class="form-group">
                    <label for="signupProfession">Profession</label>
                    <input type="text" id="signupProfession">
                </div>
                <div class="form-group">
                    <label for="signupJobTitle">Job Title</label>
                    <input type="text" id="signupJobTitle">
                </div>
                <button type="submit" class="btn btn-block">Sign Up</button>
            </form>
            <div style="text-align: center; margin-top: 15px;">
                <p>Or sign up with:</p>
                <div style="display: flex; justify-content: center; gap: 10px; margin-top: 10px;">
                    <button id="googleSignupBtn" class="btn" style="background-color: #DB4437;">Google</button>
                    <button id="facebookSignupBtn" class="btn" style="background-color: #4267B2;">Facebook</button>
                    <button id="whatsappSignupBtn" class="btn" style="background-color: #25D366;">WhatsApp</button>
                </div>
            </div>
            <p style="text-align: center; margin-top: 15px;">Already have an account? <a href="#" id="showLogin">Login</a></p>
        </div>
    </div>

    <!-- Post Job Modal -->
    <div id="postJobModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Post a Job</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="postJobForm">
                <div class="form-group">
                    <label for="jobTitle">Job Title*</label>
                    <input type="text" id="jobTitle" required>
                </div>
                <div class="form-group">
                    <label for="jobCompany">Company Name*</label>
                    <input type="text" id="jobCompany" required>
                </div>
                <div class="form-group">
                    <label for="jobCategory">Category*</label>
                    <select id="jobCategory" required>
                        <option value="">Select a category</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="jobPositions">Number of Positions*</label>
                    <input type="number" id="jobPositions" min="1" required>
                </div>
                <div class="form-group">
                    <label for="jobDeadline">Application Deadline*</label>
                    <input type="date" id="jobDeadline" required>
                </div>
                <div class="form-group">
                    <label for="jobLocation">Location*</label>
                    <input type="text" id="jobLocation" required>
                </div>
                <div class="form-group">
                    <label for="jobSalary">Salary Range</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="jobSalaryMin" placeholder="Minimum">
                        <input type="text" id="jobSalaryMax" placeholder="Maximum">
                        <select id="jobSalaryCurrency" style="width: 100px;">
                            <option value="UGX">UGX</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="jobSalaryDisclosed"> Salary Not Disclosed
                    </label>
                </div>
                <div class="form-group">
                    <label for="jobDescription">Job Description*</label>
                    <textarea id="jobDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label for="jobImage">Company/Job Image (Optional)</label>
                    <input type="file" id="jobImage" accept="image/*">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="jobAllowMessages"> Allow private messages about this job
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="jobAllowComments"> Allow comments on this job
                    </label>
                </div>
                <button type="submit" class="btn btn-block">Post Job</button>
            </form>
        </div>
    </div>

    <!-- Apply for Job Modal -->
    <div id="applyJobModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Apply for Job</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="applyJobForm">
                <input type="hidden" id="applyJobId">
                <div class="form-group">
                    <label for="applicantName">Full Name*</label>
                    <input type="text" id="applicantName" required>
                </div>
                <div class="form-group">
                    <label for="applicantEmail">Email*</label>
                    <input type="email" id="applicantEmail" required>
                </div>
                <div class="form-group">
                    <label for="applicantPhone">Phone*</label>
                    <input type="tel" id="applicantPhone" required>
                </div>
                <div class="form-group">
                    <label for="applicantGender">Gender*</label>
                    <select id="applicantGender" required>
                        <option value="">Select</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                        <option value="Prefer not to say">Prefer not to say</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="applicantAge">Age*</label>
                    <input type="number" id="applicantAge" min="18" required>
                </div>
                <div class="form-group">
                    <label for="applicantLocation">Current Location*</label>
                    <input type="text" id="applicantLocation" required>
                </div>
                <div class="form-group">
                    <label for="applicantExperience">Years of Experience*</label>
                    <input type="number" id="applicantExperience" min="0" required>
                </div>
                <div class="form-group">
                    <label for="applicantQualifications">Qualifications*</label>
                    <textarea id="applicantQualifications" required></textarea>
                </div>
                <div class="form-group">
                    <label for="applicantPhoto">Portrait Photo*</label>
                    <input type="file" id="applicantPhoto" accept="image/*" required>
                </div>
                <div class="form-group">
                    <label for="applicantCV">Upload CV*</label>
                    <input type="file" id="applicantCV" accept=".pdf,.doc,.docx" required>
                </div>
                <div class="form-group">
                    <label for="applicantCoverLetter">Cover Letter (Optional)</label>
                    <textarea id="applicantCoverLetter"></textarea>
                </div>
                <button type="submit" class="btn btn-block">Submit Application</button>
            </form>
        </div>
    </div>

    <!-- View Job Modal -->
    <div id="viewJobModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="viewJobTitle">Job Title</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="job-card">
                <div class="job-company" id="viewJobCompany">Company Name</div>
                <div class="job-location"><i>📍</i> <span id="viewJobLocation">Location</span></div>
                <div class="job-deadline"><i>⏰</i> Deadline: <span id="viewJobDeadline">Date</span></div>
                <div class="job-salary"><i>💰</i> Salary: <span id="viewJobSalary">Salary Range</span></div>
                <div class="job-description" id="viewJobDescription" style="margin-top: 15px;">
                    Job description will be here...
                </div>
                <div class="job-actions" style="margin-top: 15px;">
                    <button id="applyNowBtn" class="btn">Apply Now</button>
                    <button id="saveJobBtn" class="btn">Save Job</button>
                    <button id="reportJobBtn" class="btn btn-danger">Report</button>
                </div>
            </div>
            <div id="jobCommentsSection" style="margin-top: 20px; display: none;">
                <h3>Comments</h3>
                <div id="jobComments">
                    <!-- Comments will be loaded here -->
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <textarea id="newJobComment" placeholder="Add a comment..."></textarea>
                    <button id="postCommentBtn" class="btn" style="margin-top: 10px;">Post Comment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Job Modal -->
    <div id="reportJobModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Report Job</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="reportJobForm">
                <input type="hidden" id="reportJobId">
                <div class="form-group">
                    <label for="reportReason">Reason for Reporting*</label>
                    <select id="reportReason" required>
                        <option value="">Select a reason</option>
                        <option value="Fraudulent">Fraudulent Activity</option>
                        <option value="Scam">Scam/Asking for Money</option>
                        <option value="Discrimination">Discrimination</option>
                        <option value="Inappropriate">Inappropriate Content</option>
                        <option value="Fake">Fake Job</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reportDetails">Details*</label>
                    <textarea id="reportDetails" required></textarea>
                </div>
                <div class="form-group">
                    <label for="reportEvidence">Evidence (Screenshots, Audio, etc.)</label>
                    <input type="file" id="reportEvidence" multiple>
                </div>
                <button type="submit" class="btn btn-block btn-danger">Submit Report</button>
            </form>
        </div>
    </div>

    <!-- View Application Modal -->
    <div id="viewApplicationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Job Application</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="application-card">
                <div class="application-header">
                    <h3 id="applicationJobTitle">Job Title</h3>
                    <div class="application-status status-pending" id="applicationStatus">Pending</div>
                </div>
                <div class="user-profile">
                    <img id="applicationPhoto" src="https://via.placeholder.com/60" alt="Applicant Photo" style="width: 60px; height: 60px;">
                    <div class="user-info">
                        <h3 id="applicationName">Applicant Name</h3>
                        <p id="applicationLocation">Location</p>
                        <p id="applicationExperience">X years experience</p>
                    </div>
                </div>
                <div class="application-details" style="margin-top: 15px;">
                    <h4>Qualifications</h4>
                    <p id="applicationQualifications">Qualifications will be here...</p>
                    
                    <h4 style="margin-top: 15px;">Cover Letter</h4>
                    <p id="applicationCoverLetter">Cover letter will be here...</p>
                </div>
                <div class="application-actions" style="margin-top: 15px;">
                    <a href="#" id="viewApplicationCV" class="btn">View CV</a>
                    <button id="acceptApplicationBtn" class="btn btn-success">Accept</button>
                    <button id="rejectApplicationBtn" class="btn btn-danger">Reject</button>
                    <button id="messageApplicantBtn" class="btn">Message</button>
                </div>
            </div>
            <div id="interviewContainer" class="interview-container" style="display: none;">
                <h4>Interview Details</h4>
                <div class="form-group">
                    <label for="interviewDate">Interview Date*</label>
                    <input type="datetime-local" id="interviewDate">
                </div>
                <div class="form-group">
                    <label for="interviewType">Interview Type*</label>
                    <select id="interviewType">
                        <option value="In-person">In-person</option>
                        <option value="Online">Online</option>
                        <option value="Phone">Phone</option>
                    </select>
                </div>
                <div class="form-group" id="interviewLocationGroup">
                    <label for="interviewLocation">Location*</label>
                    <input type="text" id="interviewLocation">
                </div>
                <div class="form-group">
                    <label for="interviewNotes">Notes/Instructions</label>
                    <textarea id="interviewNotes"></textarea>
                </div>
                <button id="scheduleInterviewBtn" class="btn btn-block">Schedule Interview</button>
            </div>
        </div>
    </div>

    <!-- Interview Room Modal -->
    <div id="interviewRoomModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Interview Room</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="video-container">
                <video id="localVideo" autoplay muted></video>
                <video id="remoteVideo" autoplay></video>
            </div>
            <div class="video-controls">
                <button id="toggleVideoBtn" class="btn">Turn Off Video</button>
                <button id="toggleAudioBtn" class="btn">Mute Audio</button>
                <button id="endCallBtn" class="btn btn-danger">End Call</button>
            </div>
            <div class="chat-container" style="position: relative; width: 100%; margin-top: 15px;">
                <div class="chat-messages" id="interviewChat">
                    <!-- Chat messages will appear here -->
                </div>
                <div class="chat-input">
                    <input type="text" id="interviewMessage" placeholder="Type your message...">
                    <button id="sendInterviewMessageBtn" class="btn">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Broadcast Message Modal -->
    <div id="broadcastModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Send Broadcast Message</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="broadcastForm">
                <div class="form-group">
                    <label for="broadcastType">Message Type*</label>
                    <select id="broadcastType" required>
                        <option value="info">Information</option>
                        <option value="warning">Warning</option>
                        <option value="alert">Alert</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="broadcastSubject">Subject*</label>
                    <input type="text" id="broadcastSubject" required>
                </div>
                <div class="form-group">
                    <label for="broadcastMessage">Message*</label>
                    <textarea id="broadcastMessage" required></textarea>
                </div>
                <button type="submit" class="btn btn-block">Send Broadcast</button>
            </form>
        </div>
    </div>

    <!-- Chat Container -->
    <div id="chatContainer" class="chat-container">
        <div class="chat-header">
            <span id="chatWith">Chat</span>
            <button class="close-chat">&times;</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will appear here -->
        </div>
        <div class="chat-input">
            <input type="text" id="chatMessageInput" placeholder="Type your message...">
            <button id="sendMessageBtn" class="btn">Send</button>
        </div>
    </div>

    <script>
        // Initialize Firebase (for social logins)
        const firebaseConfig = {
            apiKey: "AIzaSyDummyKeyDummyKeyDummyKeyDummyKey",
            authDomain: "skysoft-job-market.firebaseapp.com",
            projectId: "skysoft-job-market",
            storageBucket: "skysoft-job-market.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:dummyappiddummyappiddummy"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Initialize WebTorrent
        const client = new WebTorrent();
        
        // Global variables
        let currentUser = null;
        let isAdmin = false;
        let db;
        let torrentId = 'skysoft-job-market-torrent-' + Math.random().toString(36).substring(2, 15);
        let torrent = null;
        let peers = {};
        let chatChannel = null;
        let dataChannel = null;
        let currentJobViewing = null;
        let currentApplicationViewing = null;
        let currentChatUser = null;
        let localStream = null;
        let peerConnection = null;
        
        // DOM Elements
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const profileBtn = document.getElementById('profileBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginModal = document.getElementById('loginModal');
        const signupModal = document.getElementById('signupModal');
        const postJobModal = document.getElementById('postJobModal');
        const applyJobModal = document.getElementById('applyJobModal');
        const viewJobModal = document.getElementById('viewJobModal');
        const reportJobModal = document.getElementById('reportJobModal');
        const viewApplicationModal = document.getElementById('viewApplicationModal');
        const interviewRoomModal = document.getElementById('interviewRoomModal');
        const broadcastModal = document.getElementById('broadcastModal');
        const chatContainer = document.getElementById('chatContainer');
        const closeChatBtn = document.querySelector('.close-chat');
        const chatMessageInput = document.getElementById('chatMessageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const chatMessages = document.getElementById('chatMessages');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const postJobForm = document.getElementById('postJobForm');
        const applyJobForm = document.getElementById('applyJobForm');
        const reportJobForm = document.getElementById('reportJobForm');
        const broadcastForm = document.getElementById('broadcastForm');
        const showSignup = document.getElementById('showSignup');
        const showLogin = document.getElementById('showLogin');
        const postJobBtn = document.getElementById('postJobBtn');
        const applyNowBtn = document.getElementById('applyNowBtn');
        const saveJobBtn = document.getElementById('saveJobBtn');
        const reportJobBtn = document.getElementById('reportJobBtn');
        const acceptApplicationBtn = document.getElementById('acceptApplicationBtn');
        const rejectApplicationBtn = document.getElementById('rejectApplicationBtn');
        const messageApplicantBtn = document.getElementById('messageApplicantBtn');
        const scheduleInterviewBtn = document.getElementById('scheduleInterviewBtn');
        const toggleVideoBtn = document.getElementById('toggleVideoBtn');
        const toggleAudioBtn = document.getElementById('toggleAudioBtn');
        const endCallBtn = document.getElementById('endCallBtn');
        const sendInterviewMessageBtn = document.getElementById('sendInterviewMessageBtn');
        const interviewMessage = document.getElementById('interviewMessage');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const facebookLoginBtn = document.getElementById('facebookLoginBtn');
        const whatsappLoginBtn = document.getElementById('whatsappLoginBtn');
        const googleSignupBtn = document.getElementById('googleSignupBtn');
        const facebookSignupBtn = document.getElementById('facebookSignupBtn');
        const whatsappSignupBtn = document.getElementById('whatsappSignupBtn');
        const broadcastMessageBtn = document.getElementById('broadcastMessageBtn');
        const manageUsersBtn = document.getElementById('manageUsersBtn');
        const manageJobsBtn = document.getElementById('manageJobsBtn');
        const manageReportsBtn = document.getElementById('manageReportsBtn');
        const manageCategoriesBtn = document.getElementById('manageCategoriesBtn');
        const dashboardUsername = document.getElementById('dashboardUsername');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const userTitle = document.getElementById('userTitle');
        const userLocation = document.getElementById('userLocation');
        const settingsAvatar = document.getElementById('settingsAvatar');
        const settingsUsername = document.getElementById('settingsUsername');
        const settingsFullName = document.getElementById('settingsFullName');
        const settingsEmail = document.getElementById('settingsEmail');
        const settingsPhone = document.getElementById('settingsPhone');
        const settingsProfession = document.getElementById('settingsProfession');
        const settingsJobTitle = document.getElementById('settingsJobTitle');
        const settingsCompany = document.getElementById('settingsCompany');
        const settingsCurrency = document.getElementById('settingsCurrency');
        const profileForm = document.getElementById('profileForm');
        const changeAvatarBtn = document.getElementById('changeAvatarBtn');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const currentPassword = document.getElementById('currentPassword');
        const newPassword = document.getElementById('newPassword');
        const confirmPassword = document.getElementById('confirmPassword');
        const jobListings = document.getElementById('jobListings');
        const postedJobsList = document.getElementById('postedJobsList');
        const applicantsList = document.getElementById('applicantsList');
        const activeApplications = document.getElementById('activeApplications');
        const acceptedApplications = document.getElementById('acceptedApplications');
        const rejectedApplications = document.getElementById('rejectedApplications');
        const nearbyUsers = document.getElementById('nearbyUsers');
        const allOnlineUsers = document.getElementById('allOnlineUsers');
        const adminMenuItem = document.getElementById('adminMenuItem');
        const welcomeSection = document.getElementById('welcomeSection');
        const dashboard = document.getElementById('dashboard');
        
        // Close modals when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
        
        // Close modals with close button
        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.closest('.modal').style.display = 'none';
            });
        });
        
        // Toggle between login and signup modals
        showSignup.addEventListener('click', (e) => {
            e.preventDefault();
            loginModal.style.display = 'none';
            signupModal.style.display = 'flex';
        });
        
        showLogin.addEventListener('click', (e) => {
            e.preventDefault();
            signupModal.style.display = 'none';
            loginModal.style.display = 'flex';
        });
        
        // Open login modal
        loginBtn.addEventListener('click', () => {
            loginModal.style.display = 'flex';
        });
        
        // Open signup modal
        signupBtn.addEventListener('click', () => {
            signupModal.style.display = 'flex';
        });
        
        // Open post job modal
        postJobBtn.addEventListener('click', () => {
            if (!currentUser) {
                alert('Please login to post a job');
                loginModal.style.display = 'flex';
                return;
            }
            postJobModal.style.display = 'flex';
        });
        
        // Initialize IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('SkysoftJobMarketDB', 1);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Create object stores
                    if (!db.objectStoreNames.contains('users')) {
                        const usersStore = db.createObjectStore('users', { keyPath: 'id' });
                        usersStore.createIndex('email', 'email', { unique: true });
                        usersStore.createIndex('phone', 'phone', { unique: true });
                    }
                    
                    if (!db.objectStoreNames.contains('jobs')) {
                        const jobsStore = db.createObjectStore('jobs', { keyPath: 'id' });
                        jobsStore.createIndex('employerId', 'employerId');
                        jobsStore.createIndex('deadline', 'deadline');
                        jobsStore.createIndex('location', 'location');
                        jobsStore.createIndex('category', 'category');
                    }
                    
                    if (!db.objectStoreNames.contains('applications')) {
                        const applicationsStore = db.createObjectStore('applications', { keyPath: 'id' });
                        applicationsStore.createIndex('jobId', 'jobId');
                        applicationsStore.createIndex('applicantId', 'applicantId');
                        applicationsStore.createIndex('status', 'status');
                    }
                    
                    if (!db.objectStoreNames.contains('messages')) {
                        const messagesStore = db.createObjectStore('messages', { keyPath: 'id' });
                        messagesStore.createIndex('senderId', 'senderId');
                        messagesStore.createIndex('receiverId', 'receiverId');
                        messagesStore.createIndex('timestamp', 'timestamp');
                    }
                    
                    if (!db.objectStoreNames.contains('reports')) {
                        const reportsStore = db.createObjectStore('reports', { keyPath: 'id' });
                        reportsStore.createIndex('jobId', 'jobId');
                        reportsStore.createIndex('reporterId', 'reporterId');
                        reportsStore.createIndex('status', 'status');
                    }
                    
                    if (!db.objectStoreNames.contains('categories')) {
                        const categoriesStore = db.createObjectStore('categories', { keyPath: 'id' });
                    }
                    
                    if (!db.objectStoreNames.contains('settings')) {
                        const settingsStore = db.createObjectStore('settings', { keyPath: 'key' });
                    }
                    
                    // Create the first admin user
                    const transaction = event.target.transaction;
                    const usersStore = transaction.objectStore('users');
                    
                    usersStore.count().onsuccess = (e) => {
                        const count = e.target.result;
                        if (count === 0) {
                            const adminUser = {
                                id: 'admin-' + generateId(),
                                username: 'admin',
                                email: 'admin@skysoft.com',
                                phone: '+256700000000',
                                password: hashPassword('admin123'),
                                isAdmin: true,
                                isSuperAdmin: true,
                                createdAt: new Date().toISOString(),
                                lastActive: new Date().toISOString()
                            };
                            usersStore.add(adminUser);
                        }
                    };
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                
                request.onerror = (event) => {
                    reject('Database error: ' + event.target.error);
                };
            });
        }
        
        // Generate unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }
        
        // Hash password
        function hashPassword(password) {
            return CryptoJS.SHA256(password).toString();
        }
        
        // Initialize WebTorrent and connect to peers
        function initTorrent() {
            torrent = client.add(torrentId, {
                announce: [
                    'wss://tracker.openwebtorrent.com',
                    'wss://tracker.btorrent.xyz',
                    'wss://tracker.files.fm:7073/announce'
                ]
            }, (torrent) => {
                console.log('Torrent ready');
                
                // Create a data channel for messaging
                torrent.createDataChannel('skysoft-chat');
                torrent.createDataChannel('skysoft-data');
                
                // Seed initial data
                updateTorrentData();
            });
            
            client.on('torrent', (torrent) => {
                console.log('New torrent added:', torrent.infoHash);
                
                torrent.on('wire', (wire, addr) => {
                    console.log('Connected to peer:', addr);
                    
                    wire.on('handshake', (infoHash, peerId) => {
                        // Store peer information
                        peers[peerId] = {
                            id: peerId,
                            lastSeen: Date.now()
                        };
                        
                        updateOnlineUsers();
                    });
                    
                    wire.on('close', () => {
                        console.log('Disconnected from peer:', addr);
                        delete peers[wire.peerId];
                        updateOnlineUsers();
                    });
                });
                
                // Handle incoming data
                torrent.files.forEach((file) => {
                    file.getBuffer((err, buffer) => {
                        if (err) return;
                        
                        try {
                            const data = JSON.parse(buffer.toString());
                            handleIncomingData(data);
                        } catch (e) {
                            console.error('Error parsing incoming data:', e);
                        }
                    });
                });
            });
        }
        
        // Update torrent data with current state
        function updateTorrentData() {
            if (!torrent) return;
            
            // Get current data from IndexedDB
            Promise.all([
                getAllFromStore('users'),
                getAllFromStore('jobs'),
                getAllFromStore('applications'),
                getAllFromStore('messages'),
                getAllFromStore('reports'),
                getAllFromStore('categories'),
                getAllFromStore('settings')
            ]).then(([users, jobs, applications, messages, reports, categories, settings]) => {
                const data = {
                    timestamp: Date.now(),
                    users,
                    jobs,
                    applications,
                    messages,
                    reports,
                    categories,
                    settings,
                    currentUser: currentUser ? currentUser.id : null
                };
                
                // Create a new Buffer with the data
                const buffer = Buffer.from(JSON.stringify(data));
                
                // Add the file to the torrent
                torrent.addFile('skysoft-data.json', buffer);
            });
        }
        
        // Handle incoming data from peers
        function handleIncomingData(data) {
            if (!data || !data.timestamp) return;
            
            // Check if this data is newer than what we have
            getSetting('lastSyncTimestamp').then((lastSync) => {
                if (lastSync && data.timestamp <= lastSync.value) return;
                
                // Process each type of data
                if (data.users) {
                    data.users.forEach((user) => {
                        addToStore('users', user).catch(() => {
                            updateInStore('users', user);
                        });
                    });
                }
                
                if (data.jobs) {
                    data.jobs.forEach((job) => {
                        addToStore('jobs', job).catch(() => {
                            updateInStore('jobs', job);
                        });
                    });
                }
                
                if (data.applications) {
                    data.applications.forEach((app) => {
                        addToStore('applications', app).catch(() => {
                            updateInStore('applications', app);
                        });
                    });
                }
                
                if (data.messages) {
                    data.messages.forEach((msg) => {
                        addToStore('messages', msg).catch(() => {
                            updateInStore('messages', msg);
                        });
                    });
                }
                
                if (data.reports) {
                    data.reports.forEach((report) => {
                        addToStore('reports', report).catch(() => {
                            updateInStore('reports', report);
                        });
                    });
                }
                
                if (data.categories) {
                    data.categories.forEach((category) => {
                        addToStore('categories', category).catch(() => {
                            updateInStore('categories', category);
                        });
                    });
                }
                
                if (data.settings) {
                    data.settings.forEach((setting) => {
                        addToStore('settings', setting).catch(() => {
                            updateInStore('settings', setting);
                        });
                    });
                }
                
                // Update last sync timestamp
                addToStore('settings', {
                    key: 'lastSyncTimestamp',
                    value: data.timestamp
                }).catch(() => {
                    updateInStore('settings', {
                        key: 'lastSyncTimestamp',
                        value: data.timestamp
                    });
                });
                
                // Update UI if needed
                if (currentUser) {
                    loadDashboard();
                }
            });
        }
        
        // IndexedDB helper functions
        function addToStore(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject();
            });
        }
        
        function updateInStore(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject();
            });
        }
        
        function getFromStore(storeName, key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(key);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        function getAllFromStore(storeName, index, value) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                let request;
                
                if (index && value !== undefined) {
                    const idx = store.index(index);
                    request = idx.getAll(value);
                } else if (index) {
                    const idx = store.index(index);
                    request = idx.getAll();
                } else {
                    request = store.getAll();
                }
                
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }
        
        function deleteFromStore(storeName, key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(key);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject();
            });
        }
        
        function getSetting(key) {
            return getFromStore('settings', key);
        }
        
        function setSetting(key, value) {
            return addToStore('settings', { key, value }).catch(() => {
                return updateInStore('settings', { key, value });
            });
        }
        
        // User authentication functions
        async function login(emailOrPhone, password) {
            try {
                // Try by email first
                let user = await getFromStore('users', emailOrPhone);
                
                // If not found by email, try by phone
                if (!user) {
                    const users = await getAllFromStore('users', 'phone', emailOrPhone);
                    user = users[0];
                }
                
                if (!user) {
                    throw new Error('User not found');
                }
                
                if (user.password !== hashPassword(password)) {
                    throw new Error('Invalid password');
                }
                
                // Update last active time
                user.lastActive = new Date().toISOString();
                await updateInStore('users', user);
                
                // Set current user
                currentUser = user;
                isAdmin = user.isAdmin || user.isSuperAdmin;
                
                // Update UI
                updateUIAfterLogin();
                
                // Initialize torrent with user-specific ID
                torrentId = `skysoft-job-market-${user.id}`;
                initTorrent();
                
                return user;
            } catch (error) {
                console.error('Login error:', error);
                throw error;
            }
        }
        
        async function signup(userData) {
            try {
                // Check if email or phone already exists
                const emailExists = await getFromStore('users', userData.email);
                if (emailExists) {
                    throw new Error('Email already registered');
                }
                
                const phoneExists = await getAllFromStore('users', 'phone', userData.phone);
                if (phoneExists.length > 0) {
                    throw new Error('Phone number already registered');
                }
                
                // Create new user
                const newUser = {
                    id: generateId(),
                    username: userData.username,
                    fullName: userData.fullName,
                    email: userData.email,
                    phone: userData.phone,
                    password: hashPassword(userData.password),
                    profession: userData.profession,
                    jobTitle: userData.jobTitle,
                    company: userData.company,
                    location: await detectLocation(),
                    currency: 'UGX', // Default currency
                    createdAt: new Date().toISOString(),
                    lastActive: new Date().toISOString(),
                    isAdmin: false,
                    isSuperAdmin: false,
                    isVerified: false,
                    blueTick: false
                };
                
                // Add to database
                await addToStore('users', newUser);
                
                // Set current user
                currentUser = newUser;
                isAdmin = false;
                
                // Update UI
                updateUIAfterLogin();
                
                // Initialize torrent with user-specific ID
                torrentId = `skysoft-job-market-${newUser.id}`;
                initTorrent();
                
                return newUser;
            } catch (error) {
                console.error('Signup error:', error);
                throw error;
            }
        }
        
        function logout() {
            currentUser = null;
            isAdmin = false;
            
            // Update UI
            welcomeSection.style.display = 'block';
            dashboard.style.display = 'none';
            profileBtn.style.display = 'none';
            logoutBtn.style.display = 'none';
            loginBtn.style.display = 'inline-block';
            signupBtn.style.display = 'inline-block';
            
            // Close all modals
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
            
            // Destroy torrent
            if (torrent) {
                client.remove(torrent);
                torrent = null;
            }
        }
        
        function updateUIAfterLogin() {
            welcomeSection.style.display = 'none';
            dashboard.style.display = 'block';
            profileBtn.style.display = 'inline-block';
            logoutBtn.style.display = 'inline-block';
            loginBtn.style.display = 'none';
            signupBtn.style.display = 'none';
            
            // Update user info in dashboard
            dashboardUsername.textContent = currentUser.username || currentUser.fullName;
            userName.textContent = currentUser.username || currentUser.fullName;
            userTitle.textContent = currentUser.jobTitle || 'Job Seeker';
            userLocation.textContent = currentUser.location || 'Unknown location';
            
            // Set avatar
            const avatar = currentUser.avatar || 'https://via.placeholder.com/80';
            userAvatar.src = avatar;
            settingsAvatar.src = avatar;
            
            // Update settings form
            settingsUsername.value = currentUser.username || '';
            settingsFullName.value = currentUser.fullName || '';
            settingsEmail.value = currentUser.email || '';
            settingsPhone.value = currentUser.phone || '';
            settingsProfession.value = currentUser.profession || '';
            settingsJobTitle.value = currentUser.jobTitle || '';
            settingsCompany.value = currentUser.company || '';
            settingsCurrency.value = currentUser.currency || 'UGX';
            
            // Show/hide admin menu item
            adminMenuItem.style.display = (currentUser.isAdmin || currentUser.isSuperAdmin) ? 'block' : 'none';
            
            // Load dashboard data
            loadDashboard();
        }
        
        // Load dashboard data
        function loadDashboard() {
            loadJobCategories();
            loadJobs();
            loadPostedJobs();
            loadApplications();
            loadMessages();
            updateOnlineUsers();
        }
        
        // Load job categories
        function loadJobCategories() {
            getAllFromStore('categories').then(categories => {
                const categorySelects = document.querySelectorAll('select[id$="Category"], #jobCategory');
                
                categorySelects.forEach(select => {
                    // Clear existing options except the first one
                    while (select.options.length > 1) {
                        select.remove(1);
                    }
                    
                    // Add categories
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        select.appendChild(option);
                    });
                });
            });
        }
        
        // Load jobs
        function loadJobs() {
            getAllFromStore('jobs').then(jobs => {
                // Filter out expired jobs
                const currentDate = new Date();
                jobs = jobs.filter(job => new Date(job.deadline) > currentDate);
                
                // Sort by location proximity (simplified)
                if (currentUser && currentUser.location) {
                    jobs.sort((a, b) => {
                        const aDistance = a.location === currentUser.location ? 0 : 1;
                        const bDistance = b.location === currentUser.location ? 0 : 1;
                        return aDistance - bDistance;
                    });
                }
                
                // Display jobs
                jobListings.innerHTML = '';
                jobs.forEach(job => {
                    const jobElement = createJobElement(job);
                    jobListings.appendChild(jobElement);
                });
            });
        }
        
        // Create job element
        function createJobElement(job) {
            const jobElement = document.createElement('div');
            jobElement.className = 'job-card';
            jobElement.dataset.jobId = job.id;
            
            const deadlineDate = new Date(job.deadline);
            const formattedDeadline = deadlineDate.toLocaleDateString();
            
            let salaryText = 'Not disclosed';
            if (!job.salaryDisclosed) {
                salaryText = `${job.salaryCurrency} ${job.salaryMin} - ${job.salaryMax}`;
            }
            
            jobElement.innerHTML = `
                <div class="job-title">${job.title}</div>
                <div class="job-company ${job.blueTick ? 'verified' : ''}">${job.company}</div>
                <div class="job-location"><i>📍</i> ${job.location}</div>
                <div class="job-deadline"><i>⏰</i> Deadline: ${formattedDeadline}</div>
                <div class="job-salary"><i>💰</i> Salary: ${salaryText}</div>
                <div class="job-description" style="margin-top: 10px;">${job.description.substring(0, 150)}...</div>
                <div class="job-actions" style="margin-top: 15px;">
                    <button class="btn view-job-btn">View Details</button>
                    <button class="btn apply-job-btn">Apply Now</button>
                </div>
            `;
            
            return jobElement;
        }
        
        // Load user's posted jobs
        function loadPostedJobs() {
            if (!currentUser) return;
            
            getAllFromStore('jobs', 'employerId', currentUser.id).then(jobs => {
                postedJobsList.innerHTML = '';
                jobs.forEach(job => {
                    const jobElement = createPostedJobElement(job);
                    postedJobsList.appendChild(jobElement);
                });
            });
        }
        
        // Create posted job element
        function createPostedJobElement(job) {
            const jobElement = document.createElement('div');
            jobElement.className = 'job-card';
            jobElement.dataset.jobId = job.id;
            
            const deadlineDate = new Date(job.deadline);
            const formattedDeadline = deadlineDate.toLocaleDateString();
            
            jobElement.innerHTML = `
                <div class="job-title">${job.title}</div>
                <div class="job-company">${job.company}</div>
                <div class="job-location"><i>📍</i> ${job.location}</div>
                <div class="job-deadline"><i>⏰</i> Deadline: ${formattedDeadline}</div>
                <div class="job-actions" style="margin-top: 15px;">
                    <button class="btn view-applicants-btn">View Applicants</button>
                    <button class="btn edit-job-btn">Edit</button>
                    <button class="btn btn-danger delete-job-btn">Delete</button>
                </div>
            `;
            
            return jobElement;
        }
        
        // Load job applicants
        function loadJobApplicants(jobId) {
            Promise.all([
                getAllFromStore('applications', 'jobId', jobId),
                getFromStore('jobs', jobId)
            ]).then(([applications, job]) => {
                applicantsList.innerHTML = '';
                
                if (applications.length === 0) {
                    applicantsList.innerHTML = '<p>No applicants yet.</p>';
                    return;
                }
                
                applications.forEach(application => {
                    getFromStore('users', application.applicantId).then(user => {
                        if (!user) return;
                        
                        const appElement = document.createElement('div');
                        appElement.className = 'application-card';
                        appElement.dataset.applicationId = application.id;
                        
                        let statusClass = 'status-pending';
                        if (application.status === 'accepted') statusClass = 'status-accepted';
                        if (application.status === 'rejected') statusClass = 'status-rejected';
                        
                        appElement.innerHTML = `
                            <div class="application-header">
                                <h3>${job.title}</h3>
                                <div class="application-status ${statusClass}">${application.status}</div>
                            </div>
                            <div class="user-profile">
                                <img src="${user.avatar || 'https://via.placeholder.com/60'}" alt="Applicant Photo" style="width: 60px; height: 60px;">
                                <div class="user-info">
                                    <h3>${user.fullName || user.username}</h3>
                                    <p>${user.location || 'Unknown location'}</p>
                                    <p>${application.experience} years experience</p>
                                </div>
                            </div>
                            <div class="application-actions" style="margin-top: 15px;">
                                <button class="btn view-application-btn">View Application</button>
                                <button class="btn message-applicant-btn">Message</button>
                            </div>
                        `;
                        
                        applicantsList.appendChild(appElement);
                    });
                });
            });
        }
        
        // Load user's applications
        function loadApplications() {
            if (!currentUser) return;
            
            getAllFromStore('applications', 'applicantId', currentUser.id).then(applications => {
                // Separate by status
                const activeApps = applications.filter(app => app.status === 'pending');
                const acceptedApps = applications.filter(app => app.status === 'accepted');
                const rejectedApps = applications.filter(app => app.status === 'rejected');
                
                // Display active applications
                activeApplications.innerHTML = '';
                if (activeApps.length === 0) {
                    activeApplications.innerHTML = '<p>No active applications.</p>';
                } else {
                    activeApps.forEach(application => {
                        getFromStore('jobs', application.jobId).then(job => {
                            if (!job) return;
                            
                            const appElement = createApplicationElement(application, job);
                            activeApplications.appendChild(appElement);
                        });
                    });
                }
                
                // Display accepted applications
                acceptedApplications.innerHTML = '';
                if (acceptedApps.length === 0) {
                    acceptedApplications.innerHTML = '<p>No accepted applications.</p>';
                } else {
                    acceptedApps.forEach(application => {
                        getFromStore('jobs', application.jobId).then(job => {
                            if (!job) return;
                            
                            const appElement = createApplicationElement(application, job);
                            acceptedApplications.appendChild(appElement);
                        });
                    });
                }
                
                // Display rejected applications
                rejectedApplications.innerHTML = '';
                if (rejectedApps.length === 0) {
                    rejectedApplications.innerHTML = '<p>No rejected applications.</p>';
                } else {
                    rejectedApps.forEach(application => {
                        getFromStore('jobs', application.jobId).then(job => {
                            if (!job) return;
                            
                            const appElement = createApplicationElement(application, job);
                            rejectedApplications.appendChild(appElement);
                        });
                    });
                }
            });
        }
        
        // Create application element
        function createApplicationElement(application, job) {
            const appElement = document.createElement('div');
            appElement.className = 'application-card';
            appElement.dataset.applicationId = application.id;
            
            let statusClass = 'status-pending';
            if (application.status === 'accepted') statusClass = 'status-accepted';
            if (application.status === 'rejected') statusClass = 'status-rejected';
            
            appElement.innerHTML = `
                <div class="application-header">
                    <h3>${job.title}</h3>
                    <div class="application-status ${statusClass}">${application.status}</div>
                </div>
                <div class="job-company">${job.company}</div>
                <div class="job-location"><i>📍</i> ${job.location}</div>
                <div class="job-deadline"><i>⏰</i> Deadline: ${new Date(job.deadline).toLocaleDateString()}</div>
                <div class="application-actions" style="margin-top: 15px;">
                    <button class="btn view-application-btn">View Application</button>
                    <button class="btn withdraw-application-btn">Withdraw</button>
                </div>
            `;
            
            return appElement;
        }
        
        // Load messages
        function loadMessages() {
            if (!currentUser) return;
            
            getAllFromStore('messages').then(messages => {
                // Filter messages for current user
                const userMessages = messages.filter(msg => 
                    msg.senderId === currentUser.id || msg.receiverId === currentUser.id
                );
                
                // Group by conversation
                const conversations = {};
                userMessages.forEach(msg => {
                    const otherUserId = msg.senderId === currentUser.id ? msg.receiverId : msg.senderId;
                    if (!conversations[otherUserId]) {
                        conversations[otherUserId] = {
                            userId: otherUserId,
                            lastMessage: msg,
                            unread: msg.receiverId === currentUser.id && !msg.read
                        };
                    } else {
                        if (new Date(msg.timestamp) > new Date(conversations[otherUserId].lastMessage.timestamp)) {
                            conversations[otherUserId].lastMessage = msg;
                            conversations[otherUserId].unread = msg.receiverId === currentUser.id && !msg.read;
                        }
                    }
                });
                
                // Display conversations
                messageList.innerHTML = '';
                Object.values(conversations).forEach(convo => {
                    getFromStore('users', convo.userId).then(user => {
                        if (!user) return;
                        
                        const messageElement = document.createElement('div');
                        messageElement.className = `message-card ${convo.unread ? 'unread' : ''}`;
                        messageElement.dataset.userId = user.id;
                        
                        const messageTime = new Date(convo.lastMessage.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        
                        messageElement.innerHTML = `
                            <img src="${user.avatar || 'https://via.placeholder.com/50'}" alt="User Avatar" style="width: 50px; height: 50px; border-radius: 50%;">
                            <div style="flex: 1; margin-left: 10px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <strong>${user.fullName || user.username}</strong>
                                    <span>${messageTime}</span>
                                </div>
                                <p>${convo.lastMessage.content.substring(0, 50)}...</p>
                            </div>
                        `;
                        
                        messageElement.addEventListener('click', () => {
                            openChat(user);
                        });
                        
                        messageList.appendChild(messageElement);
                    });
                });
            });
        }
        
        // Update online users list
        function updateOnlineUsers() {
            if (!currentUser) return;
            
            getAllFromStore('users').then(users => {
                // Filter out current user
                users = users.filter(user => user.id !== currentUser.id);
                
                // Mark online users
                const onlineUserIds = Object.keys(peers);
                users.forEach(user => {
                    user.isOnline = onlineUserIds.includes(user.id);
                });
                
                // Separate nearby and all online users
                const nearby = users.filter(user => user.isOnline && user.location === currentUser.location);
                const allOnline = users.filter(user => user.isOnline);
                
                // Display nearby users
                nearbyUsers.innerHTML = '';
                if (nearby.length === 0) {
                    nearbyUsers.innerHTML = '<p>No users online near you.</p>';
                } else {
                    nearby.forEach(user => {
                        const userElement = createUserBadge(user);
                        nearbyUsers.appendChild(userElement);
                    });
                }
                
                // Display all online users
                allOnlineUsers.innerHTML = '';
                if (allOnline.length === 0) {
                    allOnlineUsers.innerHTML = '<p>No other users online.</p>';
                } else {
                    allOnline.forEach(user => {
                        const userElement = createUserBadge(user);
                        allOnlineUsers.appendChild(userElement);
                    });
                }
            });
        }
        
        // Create user badge element
        function createUserBadge(user) {
            const userElement = document.createElement('div');
            userElement.className = 'user-badge';
            if (user.isOnline) userElement.classList.add('online');
            userElement.dataset.userId = user.id;
            
            userElement.innerHTML = `
                <img src="${user.avatar || 'https://via.placeholder.com/30'}" alt="User Avatar" style="width: 30px; height: 30px; border-radius: 50%;">
                ${user.fullName || user.username}
                ${user.blueTick ? '<span class="blue-tick">✓</span>' : ''}
            `;
            
            userElement.addEventListener('click', () => {
                openChat(user);
            });
            
            return userElement;
        }
        
        // Open chat with user
        function openChat(user) {
            currentChatUser = user;
            chatContainer.style.display = 'block';
            chatWith.textContent = user.fullName || user.username;
            
            // Load chat messages
            loadChatMessages(user.id);
        }
        
        // Load chat messages between current user and another user
        function loadChatMessages(otherUserId) {
            if (!currentUser) return;
            
            getAllFromStore('messages').then(messages => {
                const conversation = messages.filter(msg => 
                    (msg.senderId === currentUser.id && msg.receiverId === otherUserId) ||
                    (msg.senderId === otherUserId && msg.receiverId === currentUser.id)
                ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                // Display messages
                chatMessages.innerHTML = '';
                conversation.forEach(msg => {
                    const isSent = msg.senderId === currentUser.id;
                    const messageTime = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    const messageElement = document.createElement('div');
                    messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
                    
                    messageElement.innerHTML = `
                        <div class="message-content">${msg.content}</div>
                        <div class="message-time">${messageTime}</div>
                    `;
                    
                    chatMessages.appendChild(messageElement);
                });
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Mark messages as read
                conversation.forEach(msg => {
                    if (msg.receiverId === currentUser.id && !msg.read) {
                        msg.read = true;
                        updateInStore('messages', msg);
                    }
                });
            });
        }
        
        // Send message
        function sendMessage(receiverId, content) {
            if (!currentUser || !content.trim()) return;
            
            const message = {
                id: generateId(),
                senderId: currentUser.id,
                receiverId,
                content,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            addToStore('messages', message).then(() => {
                // Update UI
                loadChatMessages(receiverId);
                loadMessages();
                
                // Clear input
                chatMessageInput.value = '';
                
                // Broadcast update
                updateTorrentData();
            });
        }
        
        // Detect user location
        function detectLocation() {
            return new Promise((resolve) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            // In a real app, you would reverse geocode to get city/country
                            resolve(`Lat: ${position.coords.latitude}, Long: ${position.coords.longitude}`);
                        },
                        (error) => {
                            console.error('Geolocation error:', error);
                            resolve('Unknown location');
                        }
                    );
                } else {
                    resolve('Unknown location');
                }
            });
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize database
            try {
                await initDB();
                initTorrent();
                
                // Check if user is already logged in
                const lastUser = await getSetting('lastUser');
                if (lastUser) {
                    const user = await getFromStore('users', lastUser.value);
                    if (user) {
                        currentUser = user;
                        isAdmin = user.isAdmin || user.isSuperAdmin;
                        updateUIAfterLogin();
                    }
                }
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Failed to initialize application. Please refresh the page.');
            }
        });
        
        // Login form submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const emailOrPhone = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                await login(emailOrPhone, password);
                loginModal.style.display = 'none';
                
                // Save last user
                await setSetting('lastUser', currentUser.id);
            } catch (error) {
                alert(error.message);
            }
        });
        
        // Signup form submission
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userData = {
                username: document.getElementById('signupUsername').value,
                fullName: document.getElementById('signupFullName').value,
                email: document.getElementById('signupEmail').value,
                phone: document.getElementById('signupPhone').value,
                password: document.getElementById('signupPassword').value,
                profession: document.getElementById('signupProfession').value,
                jobTitle: document.getElementById('signupJobTitle').value,
                company: document.getElementById('signupCompany').value
            };
            
            if (userData.password !== document.getElementById('signupConfirmPassword').value) {
                alert('Passwords do not match');
                return;
            }
            
            try {
                await signup(userData);
                signupModal.style.display = 'none';
                
                // Save last user
                await setSetting('lastUser', currentUser.id);
            } catch (error) {
                alert(error.message);
            }
        });
        
        // Post job form submission
        postJobForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                alert('Please login to post a job');
                return;
            }
            
            const jobData = {
                id: generateId(),
                title: document.getElementById('jobTitle').value,
                company: document.getElementById('jobCompany').value,
                category: document.getElementById('jobCategory').value,
                positions: parseInt(document.getElementById('jobPositions').value),
                deadline: document.getElementById('jobDeadline').value,
                location: document.getElementById('jobLocation').value,
                salaryMin: document.getElementById('jobSalaryMin').value,
                salaryMax: document.getElementById('jobSalaryMax').value,
                salaryCurrency: document.getElementById('jobSalaryCurrency').value,
                salaryDisclosed: document.getElementById('jobSalaryDisclosed').checked,
                description: document.getElementById('jobDescription').value,
                allowMessages: document.getElementById('jobAllowMessages').checked,
                allowComments: document.getElementById('jobAllowComments').checked,
                employerId: currentUser.id,
                createdAt: new Date().toISOString(),
                blueTick: currentUser.blueTick || false
            };
            
            // Handle image upload
            const imageInput = document.getElementById('jobImage');
            if (imageInput.files.length > 0) {
                const file = imageInput.files[0];
                jobData.image = await readFileAsDataURL(file);
            }
            
            try {
                await addToStore('jobs', jobData);
                postJobModal.style.display = 'none';
                postJobForm.reset();
                
                // Update UI
                loadPostedJobs();
                loadJobs();
                
                // Broadcast update
                updateTorrentData();
                
                alert('Job posted successfully!');
            } catch (error) {
                console.error('Error posting job:', error);
                alert('Failed to post job. Please try again.');
            }
        });
        
        // Apply job form submission
        applyJobForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                alert('Please login to apply for a job');
                return;
            }
            
            const jobId = document.getElementById('applyJobId').value;
            const job = await getFromStore('jobs', jobId);
            if (!job) {
                alert('Job not found');
                return;
            }
            
            const applicationData = {
                id: generateId(),
                jobId,
                applicantId: currentUser.id,
                name: document.getElementById('applicantName').value,
                email: document.getElementById('applicantEmail').value,
                phone: document.getElementById('applicantPhone').value,
                gender: document.getElementById('applicantGender').value,
                age: parseInt(document.getElementById('applicantAge').value),
                location: document.getElementById('applicantLocation').value,
                experience: parseInt(document.getElementById('applicantExperience').value),
                qualifications: document.getElementById('applicantQualifications').value,
                coverLetter: document.getElementById('applicantCoverLetter').value,
                status: 'pending',
                appliedAt: new Date().toISOString()
            };
            
            // Handle file uploads
            const photoInput = document.getElementById('applicantPhoto');
            const cvInput = document.getElementById('applicantCV');
            
            if (photoInput.files.length > 0) {
                const file = photoInput.files[0];
                applicationData.photo = await readFileAsDataURL(file);
            }
            
            if (cvInput.files.length > 0) {
                const file = cvInput.files[0];
                applicationData.cv = await readFileAsDataURL(file);
            }
            
            try {
                await addToStore('applications', applicationData);
                applyJobModal.style.display = 'none';
                applyJobForm.reset();
                
                // Update UI
                loadApplications();
                
                // Broadcast update
                updateTorrentData();
                
                alert('Application submitted successfully!');
            } catch (error) {
                console.error('Error submitting application:', error);
                alert('Failed to submit application. Please try again.');
            }
        });
        
        // Report job form submission
        reportJobForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                alert('Please login to report a job');
                return;
            }
            
            const reportData = {
                id: generateId(),
                jobId: document.getElementById('reportJobId').value,
                reporterId: currentUser.id,
                reason: document.getElementById('reportReason').value,
                details: document.getElementById('reportDetails').value,
                status: 'pending',
                reportedAt: new Date().toISOString()
            };
            
            // Handle evidence upload
            const evidenceInput = document.getElementById('reportEvidence');
            if (evidenceInput.files.length > 0) {
                const files = Array.from(evidenceInput.files);
                reportData.evidence = await Promise.all(files.map(file => readFileAsDataURL(file)));
            }
            
            try {
                await addToStore('reports', reportData);
                reportJobModal.style.display = 'none';
                reportJobForm.reset();
                
                // Broadcast update
                updateTorrentData();
                
                alert('Report submitted successfully! Our team will review it shortly.');
            } catch (error) {
                console.error('Error submitting report:', error);
                alert('Failed to submit report. Please try again.');
            }
        });
        
        // Broadcast form submission
        broadcastForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser || !currentUser.isSuperAdmin) {
                alert('Only super admin can send broadcasts');
                return;
            }
            
            const broadcastData = {
                id: generateId(),
                type: document.getElementById('broadcastType').value,
                subject: document.getElementById('broadcastSubject').value,
                message: document.getElementById('broadcastMessage').value,
                sentBy: currentUser.id,
                sentAt: new Date().toISOString()
            };
            
            try {
                // In a real app, this would be sent to all peers
                alert(`Broadcast sent: ${broadcastData.subject}\n\n${broadcastData.message}`);
                broadcastModal.style.display = 'none';
                broadcastForm.reset();
            } catch (error) {
                console.error('Error sending broadcast:', error);
                alert('Failed to send broadcast. Please try again.');
            }
        });
        
        // Profile form submission
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                alert('Please login to update your profile');
                return;
            }
            
            const updatedUser = {
                ...currentUser,
                username: settingsUsername.value,
                fullName: settingsFullName.value,
                email: settingsEmail.value,
                phone: settingsPhone.value,
                profession: settingsProfession.value,
                jobTitle: settingsJobTitle.value,
                company: settingsCompany.value,
                currency: settingsCurrency.value
            };
            
            try {
                await updateInStore('users', updatedUser);
                currentUser = updatedUser;
                
                // Update UI
                updateUIAfterLogin();
                
                // Broadcast update
                updateTorrentData();
                
                alert('Profile updated successfully!');
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Failed to update profile. Please try again.');
            }
        });
        
        // Change password
        changePasswordBtn.addEventListener('click', async () => {
            if (!currentUser) {
                alert('Please login to change your password');
                return;
            }
            
            const currentPass = currentPassword.value;
            const newPass = newPassword.value;
            const confirmPass = confirmPassword.value;
            
            if (hashPassword(currentPass) !== currentUser.password) {
                alert('Current password is incorrect');
                return;
            }
            
            if (newPass !== confirmPass) {
                alert('New passwords do not match');
                return;
            }
            
            if (newPass.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }
            
            const updatedUser = {
                ...currentUser,
                password: hashPassword(newPass)
            };
            
            try {
                await updateInStore('users', updatedUser);
                currentUser = updatedUser;
                
                // Clear fields
                currentPassword.value = '';
                newPassword.value = '';
                confirmPassword.value = '';
                
                alert('Password changed successfully!');
            } catch (error) {
                console.error('Error changing password:', error);
                alert('Failed to change password. Please try again.');
            }
        });
        
        // Change avatar
        changeAvatarBtn.addEventListener('click', async () => {
            if (!currentUser) return;
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const dataUrl = await readFileAsDataURL(file);
                    
                    const updatedUser = {
                        ...currentUser,
                        avatar: dataUrl
                    };
                    
                    await updateInStore('users', updatedUser);
                    currentUser = updatedUser;
                    
                    // Update UI
                    userAvatar.src = dataUrl;
                    settingsAvatar.src = dataUrl;
                    
                    // Broadcast update
                    updateTorrentData();
                    
                    alert('Profile photo updated successfully!');
                } catch (error) {
                    console.error('Error updating profile photo:', error);
                    alert('Failed to update profile photo. Please try again.');
                }
            };
            
            input.click();
        });
        
        // Logout
        logoutBtn.addEventListener('click', () => {
            logout();
        });
        
        // Close chat
        closeChatBtn.addEventListener('click', () => {
            chatContainer.style.display = 'none';
            currentChatUser = null;
        });
        
        // Send message
        sendMessageBtn.addEventListener('click', () => {
            if (!currentChatUser) return;
            
            const message = chatMessageInput.value.trim();
            if (message) {
                sendMessage(currentChatUser.id, message);
            }
        });
        
        // Send message on Enter key
        chatMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && currentChatUser) {
                const message = chatMessageInput.value.trim();
                if (message) {
                    sendMessage(currentChatUser.id, message);
                }
            }
        });
        
        // View job details
        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('view-job-btn')) {
                const jobCard = e.target.closest('.job-card');
                const jobId = jobCard.dataset.jobId;
                
                const job = await getFromStore('jobs', jobId);
                if (!job) {
                    alert('Job not found');
                    return;
                }
                
                currentJobViewing = job;
                
                // Update view job modal
                document.getElementById('viewJobTitle').textContent = job.title;
                document.getElementById('viewJobCompany').textContent = job.company;
                document.getElementById('viewJobLocation').textContent = job.location;
                document.getElementById('viewJobDeadline').textContent = new Date(job.deadline).toLocaleDateString();
                
                let salaryText = 'Not disclosed';
                if (!job.salaryDisclosed) {
                    salaryText = `${job.salaryCurrency} ${job.salaryMin} - ${job.salaryMax}`;
                }
                document.getElementById('viewJobSalary').textContent = salaryText;
                
                document.getElementById('viewJobDescription').textContent = job.description;
                
                // Show/hide apply button based on whether user is the employer
                const applyNowBtn = document.getElementById('applyNowBtn');
                if (currentUser && currentUser.id === job.employerId) {
                    applyNowBtn.style.display = 'none';
                } else {
                    applyNowBtn.style.display = 'inline-block';
                }
                
                // Show comments section if enabled
                const commentsSection = document.getElementById('jobCommentsSection');
                if (job.allowComments) {
                    commentsSection.style.display = 'block';
                    // Load comments (not implemented in this demo)
                } else {
                    commentsSection.style.display = 'none';
                }
                
                viewJobModal.style.display = 'flex';
            }
            
            // Apply for job
            if (e.target.classList.contains('apply-job-btn') || e.target.id === 'applyNowBtn') {
                if (!currentUser) {
                    alert('Please login to apply for a job');
                    loginModal.style.display = 'flex';
                    return;
                }
                
                const jobCard = e.target.closest('.job-card');
                const jobId = jobCard ? jobCard.dataset.jobId : currentJobViewing.id;
                
                const job = await getFromStore('jobs', jobId);
                if (!job) {
                    alert('Job not found');
                    return;
                }
                
                // Check if user already applied
                const applications = await getAllFromStore('applications', 'jobId', jobId);
                const userApplication = applications.find(app => app.applicantId === currentUser.id);
                
                if (userApplication) {
                    alert('You have already applied for this job');
                    return;
                }
                
                // Set job ID in apply form
                document.getElementById('applyJobId').value = jobId;
                
                // Pre-fill some fields
                document.getElementById('applicantName').value = currentUser.fullName || '';
                document.getElementById('applicantEmail').value = currentUser.email || '';
                document.getElementById('applicantPhone').value = currentUser.phone || '';
                document.getElementById('applicantLocation').value = currentUser.location || '';
                
                applyJobModal.style.display = 'flex';
            }
            
            // Report job
            if (e.target.classList.contains('report-job-btn') || e.target.id === 'reportJobBtn') {
                if (!currentUser) {
                    alert('Please login to report a job');
                    loginModal.style.display = 'flex';
                    return;
                }
                
                const jobId = e.target.closest('.job-card')?.dataset.jobId || currentJobViewing.id;
                document.getElementById('reportJobId').value = jobId;
                reportJobModal.style.display = 'flex';
            }
            
            // View applicants
            if (e.target.classList.contains('view-applicants-btn')) {
                const jobCard = e.target.closest('.job-card');
                const jobId = jobCard.dataset.jobId;
                
                // Switch to applicants tab
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.subtab-content').forEach(content => content.classList.remove('active'));
                
                document.querySelector('.tab[data-subtab="job-applicants"]').classList.add('active');
                document.getElementById('job-applicants').classList.add('active');
                
                // Load applicants
                loadJobApplicants(jobId);
            }
            
            // View application
            if (e.target.classList.contains('view-application-btn')) {
                const appCard = e.target.closest('.application-card');
                const applicationId = appCard.dataset.applicationId;
                
                const application = await getFromStore('applications', applicationId);
                if (!application) {
                    alert('Application not found');
                    return;
                }
                
                const job = await getFromStore('jobs', application.jobId);
                if (!job) {
                    alert('Job not found');
                    return;
                }
                
                const applicant = await getFromStore('users', application.applicantId);
                if (!applicant) {
                    alert('Applicant not found');
                    return;
                }
                
                currentApplicationViewing = application;
                
                // Update view application modal
                document.getElementById('applicationJobTitle').textContent = job.title;
                
                let statusText = 'Pending';
                let statusClass = 'status-pending';
                if (application.status === 'accepted') {
                    statusText = 'Accepted';
                    statusClass = 'status-accepted';
                } else if (application.status === 'rejected') {
                    statusText = 'Rejected';
                    statusClass = 'status-rejected';
                }
                
                document.getElementById('applicationStatus').textContent = statusText;
                document.getElementById('applicationStatus').className = `application-status ${statusClass}`;
                
                document.getElementById('applicationName').textContent = applicant.fullName || applicant.username;
                document.getElementById('applicationLocation').textContent = applicant.location || 'Unknown location';
                document.getElementById('applicationExperience').textContent = `${application.experience} years experience`;
                document.getElementById('applicationQualifications').textContent = application.qualifications;
                document.getElementById('applicationCoverLetter').textContent = application.coverLetter || 'No cover letter provided';
                
                if (application.photo) {
                    document.getElementById('applicationPhoto').src = application.photo;
                }
                
                // Show/hide interview container based on status
                const interviewContainer = document.getElementById('interviewContainer');
                if (application.status === 'accepted' && !application.interviewScheduled) {
                    interviewContainer.style.display = 'block';
                } else {
                    interviewContainer.style.display = 'none';
                }
                
                // Show/hide action buttons based on user role
                const isEmployer = currentUser && currentUser.id === job.employerId;
                const isApplicant = currentUser && currentUser.id === application.applicantId;
                
                document.getElementById('acceptApplicationBtn').style.display = isEmployer ? 'inline-block' : 'none';
                document.getElementById('rejectApplicationBtn').style.display = isEmployer ? 'inline-block' : 'none';
                document.getElementById('messageApplicantBtn').style.display = 'inline-block';
                document.getElementById('viewApplicationCV').style.display = application.cv ? 'inline-block' : 'none';
                
                if (application.cv) {
                    document.getElementById('viewApplicationCV').onclick = () => {
                        window.open(application.cv, '_blank');
                    };
                }
                
                viewApplicationModal.style.display = 'flex';
            }
            
            // Accept application
            if (e.target.classList.contains('accept-application-btn') || e.target.id === 'acceptApplicationBtn') {
                if (!currentApplicationViewing) return;
                
                const updatedApplication = {
                    ...currentApplicationViewing,
                    status: 'accepted'
                };
                
                try {
                    await updateInStore('applications', updatedApplication);
                    currentApplicationViewing = updatedApplication;
                    
                    // Update UI
                    document.getElementById('applicationStatus').textContent = 'Accepted';
                    document.getElementById('applicationStatus').className = 'application-status status-accepted';
                    document.getElementById('interviewContainer').style.display = 'block';
                    
                    // Broadcast update
                    updateTorrentData();
                    
                    alert('Application accepted! Please schedule an interview.');
                } catch (error) {
                    console.error('Error accepting application:', error);
                    alert('Failed to accept application. Please try again.');
                }
            }
            
            // Reject application
            if (e.target.classList.contains('reject-application-btn') || e.target.id === 'rejectApplicationBtn') {
                if (!currentApplicationViewing) return;
                
                const updatedApplication = {
                    ...currentApplicationViewing,
                    status: 'rejected'
                };
                
                try {
                    await updateInStore('applications', updatedApplication);
                    currentApplicationViewing = updatedApplication;
                    
                    // Update UI
                    document.getElementById('applicationStatus').textContent = 'Rejected';
                    document.getElementById('applicationStatus').className = 'application-status status-rejected';
                    document.getElementById('interviewContainer').style.display = 'none';
                    
                    // Broadcast update
                    updateTorrentData();
                    
                    alert('Application rejected.');
                } catch (error) {
                    console.error('Error rejecting application:', error);
                    alert('Failed to reject application. Please try again.');
                }
            }
            
            // Withdraw application
            if (e.target.classList.contains('withdraw-application-btn')) {
                if (!confirm('Are you sure you want to withdraw this application?')) return;
                
                const appCard = e.target.closest('.application-card');
                const applicationId = appCard.dataset.applicationId;
                
                try {
                    await deleteFromStore('applications', applicationId);
                    
                    // Update UI
                    appCard.remove();
                    
                    // Broadcast update
                    updateTorrentData();
                    
                    alert('Application withdrawn successfully.');
                } catch (error) {
                    console.error('Error withdrawing application:', error);
                    alert('Failed to withdraw application. Please try again.');
                }
            }
            
            // Schedule interview
            if (e.target.id === 'scheduleInterviewBtn') {
                if (!currentApplicationViewing) return;
                
                const interviewType = document.getElementById('interviewType').value;
                const interviewDate = document.getElementById('interviewDate').value;
                const interviewLocation = document.getElementById('interviewLocation').value;
                const interviewNotes = document.getElementById('interviewNotes').value;
                
                if (!interviewDate) {
                    alert('Please select an interview date');
                    return;
                }
                
                if (interviewType === 'In-person' && !interviewLocation) {
                    alert('Please enter an interview location');
                    return;
                }
                
                const updatedApplication = {
                    ...currentApplicationViewing,
                    interviewScheduled: true,
                    interviewType,
                    interviewDate,
                    interviewLocation,
                    interviewNotes
                };
                
                try {
                    await updateInStore('applications', updatedApplication);
                    currentApplicationViewing = updatedApplication;
                    
                    // Update UI
                    document.getElementById('interviewContainer').style.display = 'none';
                    
                    // Broadcast update
                    updateTorrentData();
                    
                    alert('Interview scheduled successfully!');
                } catch (error) {
                    console.error('Error scheduling interview:', error);
                    alert('Failed to schedule interview. Please try again.');
                }
            }
            
            // Start interview
            if (e.target.classList.contains('start-interview-btn')) {
                if (!currentApplicationViewing) return;
                
                // In a real app, this would set up WebRTC connection
                alert('Starting interview room...');
                interviewRoomModal.style.display = 'flex';
                
                // Initialize video chat
                initVideoChat();
            }
            
            // End call
            if (e.target.id === 'endCallBtn') {
                endVideoChat();
                interviewRoomModal.style.display = 'none';
            }
            
            // Toggle video
            if (e.target.id === 'toggleVideoBtn') {
                if (!localStream) return;
                
                const videoTracks = localStream.getVideoTracks();
                if (videoTracks.length > 0) {
                    const isEnabled = videoTracks[0].enabled;
                    videoTracks[0].enabled = !isEnabled;
                    e.target.textContent = isEnabled ? 'Turn On Video' : 'Turn Off Video';
                }
            }
            
            // Toggle audio
            if (e.target.id === 'toggleAudioBtn') {
                if (!localStream) return;
                
                const audioTracks = localStream.getAudioTracks();
                if (audioTracks.length > 0) {
                    const isEnabled = audioTracks[0].enabled;
                    audioTracks[0].enabled = !isEnabled;
                    e.target.textContent = isEnabled ? 'Unmute Audio' : 'Mute Audio';
                }
            }
            
            // Send interview message
            if (e.target.id === 'sendInterviewMessageBtn') {
                const message = interviewMessage.value.trim();
                if (message) {
                    // In a real app, this would send via WebRTC data channel
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message sent';
                    messageElement.innerHTML = `
                        <div class="message-content">${message}</div>
                        <div class="message-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                    `;
                    document.getElementById('interviewChat').appendChild(messageElement);
                    interviewMessage.value = '';
                }
            }
            
            // Tab navigation
            if (e.target.hasAttribute('data-tab')) {
                const tabId = e.target.getAttribute('data-tab');
                
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Show selected tab content
                document.getElementById(tabId).classList.add('active');
                
                // Update active tab in sidebar
                document.querySelectorAll('.sidebar-menu a').forEach(link => {
                    link.classList.remove('active');
                });
                
                e.target.classList.add('active');
            }
            
            // Sub-tab navigation
            if (e.target.hasAttribute('data-subtab')) {
                const subtabId = e.target.getAttribute('data-subtab');
                
                // Hide all sub-tab contents
                document.querySelectorAll('.subtab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Show selected sub-tab content
                document.getElementById(subtabId).classList.add('active');
                
                // Update active sub-tab
                document.querySelectorAll('.tabs .tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                e.target.classList.add('active');
            }
            
            // Admin actions
            if (e.target.id === 'broadcastMessageBtn') {
                if (!currentUser || !currentUser.isSuperAdmin) {
                    alert('Only super admin can send broadcasts');
                    return;
                }
                
                broadcastModal.style.display = 'flex';
            }
            
            if (e.target.id === 'manageUsersBtn') {
                if (!currentUser || !currentUser.isAdmin) {
                    alert('Only admin can manage users');
                    return;
                }
                
                // Load users
                getAllFromStore('users').then(users => {
                    let html = '<h3>Manage Users</h3><table style="width: 100%; border-collapse: collapse;">';
                    html += '<tr><th>Username</th><th>Email</th><th>Role</th><th>Actions</th></tr>';
                    
                    users.forEach(user => {
                        if (user.id === currentUser.id) return; // Skip current user
                        
                        let role = 'User';
                        if (user.isSuperAdmin) role = 'Super Admin';
                        else if (user.isAdmin) role = 'Admin';
                        
                        html += `
                            <tr>
                                <td>${user.username}</td>
                                <td>${user.email}</td>
                                <td>${role}</td>
                                <td>
                                    <button class="btn btn-warning" data-user-id="${user.id}" data-action="toggle-admin">${user.isAdmin ? 'Remove Admin' : 'Make Admin'}</button>
                                    <button class="btn btn-danger" data-user-id="${user.id}" data-action="ban">Ban User</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</table>';
                    document.getElementById('adminContent').innerHTML = html;
                });
            }
            
            if (e.target.id === 'manageJobsBtn') {
                if (!currentUser || !currentUser.isAdmin) {
                    alert('Only admin can manage jobs');
                    return;
                }
                
                // Load jobs
                getAllFromStore('jobs').then(jobs => {
                    let html = '<h3>Manage Jobs</h3><table style="width: 100%; border-collapse: collapse;">';
                    html += '<tr><th>Title</th><th>Company</th><th>Location</th><th>Actions</th></tr>';
                    
                    jobs.forEach(job => {
                        html += `
                            <tr>
                                <td>${job.title}</td>
                                <td>${job.company}</td>
                                <td>${job.location}</td>
                                <td>
                                    <button class="btn btn-danger" data-job-id="${job.id}" data-action="delete-job">Delete Job</button>
                                    <button class="btn" data-job-id="${job.id}" data-action="toggle-blue-tick">${job.blueTick ? 'Remove Blue Tick' : 'Add Blue Tick'}</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</table>';
                    document.getElementById('adminContent').innerHTML = html;
                });
            }
            
            if (e.target.id === 'manageReportsBtn') {
                if (!currentUser || !currentUser.isAdmin) {
                    alert('Only admin can manage reports');
                    return;
                }
                
                // Load reports
                Promise.all([
                    getAllFromStore('reports'),
                    getAllFromStore('jobs'),
                    getAllFromStore('users')
                ]).then(([reports, jobs, users]) => {
                    let html = '<h3>Manage Reports</h3><table style="width: 100%; border-collapse: collapse;">';
                    html += '<tr><th>Job</th><th>Reporter</th><th>Reason</th><th>Status</th><th>Actions</th></tr>';
                    
                    reports.forEach(report => {
                        const job = jobs.find(j => j.id === report.jobId);
                        const reporter = users.find(u => u.id === report.reporterId);
                        
                        if (!job || !reporter) return;
                        
                        html += `
                            <tr>
                                <td>${job.title}</td>
                                <td>${reporter.username}</td>
                                <td>${report.reason}</td>
                                <td>${report.status}</td>
                                <td>
                                    <button class="btn btn-success" data-report-id="${report.id}" data-action="approve-report">Approve</button>
                                    <button class="btn btn-danger" data-report-id="${report.id}" data-action="reject-report">Reject</button>
                                    <button class="btn" data-report-id="${report.id}" data-action="view-report">View</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</table>';
                    document.getElementById('adminContent').innerHTML = html;
                });
            }
            
            if (e.target.id === 'manageCategoriesBtn') {
                if (!currentUser || !currentUser.isAdmin) {
                    alert('Only admin can manage categories');
                    return;
                }
                
                // Load categories
                getAllFromStore('categories').then(categories => {
                    let html = '<h3>Manage Job Categories</h3>';
                    html += '<div style="display: flex; margin-bottom: 20px;">';
                    html += '<input type="text" id="newCategoryName" placeholder="New category name" style="flex: 1; margin-right: 10px;">';
                    html += '<button id="addCategoryBtn" class="btn">Add Category</button>';
                    html += '</div>';
                    
                    html += '<ul style="list-style: none; padding: 0;">';
                    categories.forEach(category => {
                        html += `
                            <li style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">
                                <span>${category.name}</span>
                                <button class="btn btn-danger" data-category-id="${category.id}">Delete</button>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    
                    document.getElementById('adminContent').innerHTML = html;
                    
                    // Add category button
                    document.getElementById('addCategoryBtn').addEventListener('click', async () => {
                        const name = document.getElementById('newCategoryName').value.trim();
                        if (!name) return;
                        
                        const category = {
                            id: generateId(),
                            name
                        };
                        
                        try {
                            await addToStore('categories', category);
                            document.getElementById('newCategoryName').value = '';
                            
                            // Reload categories
                            manageCategoriesBtn.click();
                            loadJobCategories();
                            
                            // Broadcast update
                            updateTorrentData();
                        } catch (error) {
                            console.error('Error adding category:', error);
                            alert('Failed to add category. Please try again.');
                        }
                    });
                    
                    // Delete category buttons
                    document.querySelectorAll('[data-category-id]').forEach(btn => {
                        btn.addEventListener('click', async () => {
                            const categoryId = btn.getAttribute('data-category-id');
                            
                            if (!confirm('Are you sure you want to delete this category?')) return;
                            
                            try {
                                await deleteFromStore('categories', categoryId);
                                
                                // Reload categories
                                manageCategoriesBtn.click();
                                loadJobCategories();
                                
                                // Broadcast update
                                updateTorrentData();
                            } catch (error) {
                                console.error('Error deleting category:', error);
                                alert('Failed to delete category. Please try again.');
                            }
                        });
                    });
                });
            }
            
            // Admin action handlers
            if (e.target.hasAttribute('data-action')) {
                const action = e.target.getAttribute('data-action');
                const userId = e.target.getAttribute('data-user-id');
                const jobId = e.target.getAttribute('data-job-id');
                const reportId = e.target.getAttribute('data-report-id');
                
                switch (action) {
                    case 'toggle-admin':
                        if (!userId) return;
                        
                        getFromStore('users', userId).then(user => {
                            if (!user) return;
                            
                            // Super admin can't be modified
                            if (user.isSuperAdmin) {
                                alert('Cannot modify super admin privileges');
                                return;
                            }
                            
                            const updatedUser = {
                                ...user,
                                isAdmin: !user.isAdmin
                            };
                            
                            updateInStore('users', updatedUser).then(() => {
                                // Reload user management
                                manageUsersBtn.click();
                                
                                // Broadcast update
                                updateTorrentData();
                            });
                        });
                        break;
                        
                    case 'ban':
                        if (!userId) return;
                        
                        if (!confirm('Are you sure you want to ban this user?')) return;
                        
                        getFromStore('users', userId).then(user => {
                            if (!user) return;
                            
                            // Super admin can't be banned
                            if (user.isSuperAdmin) {
                                alert('Cannot ban super admin');
                                return;
                            }
                            
                            const updatedUser = {
                                ...user,
                                isBanned: true,
                                bannedUntil: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString() // 1 year ban
                            };
                            
                            updateInStore('users', updatedUser).then(() => {
                                // Reload user management
                                manageUsersBtn.click();
                                
                                // Broadcast update
                                updateTorrentData();
                                
                                alert('User banned for 1 year');
                            });
                        });
                        break;
                        
                    case 'delete-job':
                        if (!jobId) return;
                        
                        if (!confirm('Are you sure you want to delete this job?')) return;
                        
                        deleteFromStore('jobs', jobId).then(() => {
                            // Also delete related applications
                            return getAllFromStore('applications', 'jobId', jobId).then(applications => {
                                return Promise.all(applications.map(app => deleteFromStore('applications', app.id)));
                            });
                        }).then(() => {
                            // Reload job management
                            manageJobsBtn.click();
                            loadJobs();
                            loadPostedJobs();
                            
                            // Broadcast update
                            updateTorrentData();
                            
                            alert('Job deleted successfully');
                        });
                        break;
                        
                    case 'toggle-blue-tick':
                        if (!jobId) return;
                        
                        getFromStore('jobs', jobId).then(job => {
                            if (!job) return;
                            
                            const updatedJob = {
                                ...job,
                                blueTick: !job.blueTick
                            };
                            
                            updateInStore('jobs', updatedJob).then(() => {
                                // Reload job management
                                manageJobsBtn.click();
                                loadJobs();
                                loadPostedJobs();
                                
                                // Broadcast update
                                updateTorrentData();
                            });
                        });
                        break;
                        
                    case 'approve-report':
                        if (!reportId) return;
                        
                        getFromStore('reports', reportId).then(report => {
                            if (!report) return;
                            
                            const updatedReport = {
                                ...report,
                                status: 'approved',
                                reviewedBy: currentUser.id,
                                reviewedAt: new Date().toISOString()
                            };
                            
                            // Also mark the job as hidden
                            return updateInStore('reports', updatedReport).then(() => {
                                return getFromStore('jobs', report.jobId);
                            }).then(job => {
                                if (!job) return;
                                
                                const updatedJob = {
                                    ...job,
                                    isHidden: true
                                };
                                
                                return updateInStore('jobs', updatedJob);
                            });
                        }).then(() => {
                            // Reload report management
                            manageReportsBtn.click();
                            loadJobs();
                            loadPostedJobs();
                            
                            // Broadcast update
                            updateTorrentData();
                            
                            alert('Report approved and job hidden');
                        });
                        break;
                        
                    case 'reject-report':
                        if (!reportId) return;
                        
                        getFromStore('reports', reportId).then(report => {
                            if (!report) return;
                            
                            const updatedReport = {
                                ...report,
                                status: 'rejected',
                                reviewedBy: currentUser.id,
                                reviewedAt: new Date().toISOString()
                            };
                            
                            return updateInStore('reports', updatedReport);
                        }).then(() => {
                            // Reload report management
                            manageReportsBtn.click();
                            
                            // Broadcast update
                            updateTorrentData();
                            
                            alert('Report rejected');
                        });
                        break;
                        
                    case 'view-report':
                        if (!reportId) return;
                        
                        getFromStore('reports', reportId).then(report => {
                            if (!report) return;
                            
                            let html = `<h3>Report Details</h3>`;
                            html += `<p><strong>Reason:</strong> ${report.reason}</p>`;
                            html += `<p><strong>Details:</strong> ${report.details}</p>`;
                            
                            if (report.evidence && report.evidence.length > 0) {
                                html += `<h4>Evidence:</h4>`;
                                report.evidence.forEach((evidence, index) => {
                                    if (evidence.startsWith('data:image')) {
                                        html += `<img src="${evidence}" style="max-width: 100%; margin-bottom: 10px;">`;
                                    } else if (evidence.startsWith('data:audio')) {
                                        html += `<audio controls src="${evidence}" style="margin-bottom: 10px;"></audio>`;
                                    } else {
                                        html += `<a href="${evidence}" target="_blank">Evidence ${index + 1}</a><br>`;
                                    }
                                });
                            }
                            
                            document.getElementById('adminContent').innerHTML = html;
                        });
                        break;
                }
            }
        });
        
        // Helper function to read file as data URL
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // Initialize video chat
        async function initVideoChat() {
            try {
                // Get user media
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                
                // In a real app, you would set up WebRTC connection here
                // This is a simplified version for demonstration
                
                // Set up buttons
                toggleVideoBtn.textContent = 'Turn Off Video';
                toggleAudioBtn.textContent = 'Mute Audio';
            } catch (error) {
                console.error('Error initializing video chat:', error);
                alert('Could not access camera/microphone. Please check permissions.');
            }
        }
        
        // End video chat
        function endVideoChat() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (remoteVideo.srcObject) {
                remoteVideo.srcObject.getTracks().forEach(track => track.stop());
                remoteVideo.srcObject = null;
            }
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
        }
        
        // Social login handlers (simplified for demo)
        googleLoginBtn.addEventListener('click', () => {
            alert('Google login would be implemented here');
        });
        
        facebookLoginBtn.addEventListener('click', () => {
            alert('Facebook login would be implemented here');
        });
        
        whatsappLoginBtn.addEventListener('click', () => {
            alert('WhatsApp login would be implemented here');
        });
        
        googleSignupBtn.addEventListener('click', () => {
            alert('Google signup would be implemented here');
        });
        
        facebookSignupBtn.addEventListener('click', () => {
            alert('Facebook signup would be implemented here');
        });
        
        whatsappSignupBtn.addEventListener('click', () => {
            alert('WhatsApp signup would be implemented here');
        });
    </script>
</body>
</html>
