<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skysoft Job Market</title>
    <script src="https://cdn.jsdelivr.net/npm/ipfs/dist/index.min.js"></script>
    <script src="https://bundle.run/dat-sdk@1.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --border-radius: 5px;
            --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar styles */
        .sidebar {
            width: 250px;
            background-color: var(--dark-color);
            color: white;
            padding: 20px 0;
            transition: var(--transition);
            height: 100vh;
            position: fixed;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h2 {
            margin-bottom: 10px;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
        }

        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .menu-item i {
            margin-right: 10px;
        }

        .menu-item.active {
            background-color: var(--primary-color);
        }

        /* Main content styles */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
            transition: var(--transition);
        }

        /* Top bar styles */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: white;
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            border-radius: var(--border-radius);
        }

        .user-profile {
            display: flex;
            align-items: center;
            position: relative;
        }

        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }

        .profile-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background-color: white;
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            width: 200px;
            z-index: 100;
            display: none;
        }

        .profile-dropdown.show {
            display: block;
        }

        .dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: var(--transition);
        }

        .dropdown-item:hover {
            background-color: var(--light-color);
        }

        /* Notification styles */
        .notification-bell {
            position: relative;
            margin-right: 20px;
            cursor: pointer;
        }

        .notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Card styles */
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Job card styles */
        .job-card {
            margin-bottom: 15px;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            padding: 15px;
            transition: var(--transition);
        }

        .job-card:hover {
            box-shadow: var(--box-shadow);
        }

        .job-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .job-company {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .job-location {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .job-description {
            margin-bottom: 15px;
            font-size: 0.95rem;
        }

        .job-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 15px;
        }

        .job-actions {
            display: flex;
            justify-content: space-between;
        }

        /* Button styles */
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* Form styles */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            box-shadow: var(--box-shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        /* Login/Signup page styles */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--light-color);
        }

        .auth-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            width: 100%;
            max-width: 400px;
        }

        .auth-title {
            text-align: center;
            margin-bottom: 20px;
            color: var(--dark-color);
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }

        .auth-switch a {
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: none;
        }

        /* Badge styles */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .badge-success {
            background-color: var(--success-color);
            color: white;
        }

        .badge-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .badge-danger {
            background-color: var(--danger-color);
            color: white;
        }

        /* Blue tick styles */
        .blue-tick {
            display: inline-block;
            width: 16px;
            height: 16px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 16px;
            font-size: 10px;
            margin-left: 5px;
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
                overflow: hidden;
            }
            
            .sidebar-header h2, .menu-item span {
                display: none;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            .menu-item {
                justify-content: center;
            }
        }

        @media (max-width: 576px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .container {
                flex-direction: column;
            }
        }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Broadcast message */
        .broadcast-message {
            background-color: var(--warning-color);
            color: white;
            padding: 10px 20px;
            text-align: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1001;
        }

        /* Online status */
        .online-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success-color);
            margin-right: 5px;
        }

        .offline-status {
            background-color: #ccc;
        }

        /* Chat styles */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
        }

        .chat-header {
            padding: 10px 15px;
            background-color: var(--primary-color);
            color: white;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 15px;
            max-width: 70%;
        }

        .message.received {
            align-self: flex-start;
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 0 var(--border-radius) var(--border-radius) var(--border-radius);
        }

        .message.sent {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: white;
            padding: 10px;
            border-radius: var(--border-radius) 0 var(--border-radius) var(--border-radius);
        }

        .message-time {
            font-size: 0.75rem;
            color: #666;
            margin-top: 5px;
        }

        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius) 0 0 var(--border-radius);
            outline: none;
        }

        .chat-input button {
            padding: 10px 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            cursor: pointer;
        }

        /* Interview room styles */
        .video-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .video-box {
            flex: 1;
            min-width: 300px;
            height: 225px;
            background-color: #333;
            border-radius: var(--border-radius);
            position: relative;
        }

        .video-box video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--border-radius);
        }

        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px 10px;
            border-radius: var(--border-radius);
        }

        /* File upload styles */
        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: block;
            padding: 10px;
            border: 1px dashed #ddd;
            border-radius: var(--border-radius);
            text-align: center;
            cursor: pointer;
        }

        .file-upload-label:hover {
            border-color: var(--primary-color);
        }

        /* Application status styles */
        .status-pending {
            color: var(--warning-color);
        }

        .status-accepted {
            color: var(--success-color);
        }

        .status-rejected {
            color: var(--danger-color);
        }

        /* Location detection */
        .location-detection {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .location-icon {
            margin-right: 5px;
            color: var(--primary-color);
        }

        /* Job application form */
        .application-form .form-group {
            margin-bottom: 20px;
        }

        /* Admin controls */
        .admin-controls {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        .admin-section {
            margin-bottom: 30px;
        }

        .admin-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }

        /* Report styles */
        .report-reason {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
        }

        /* Blue tick request */
        .blue-tick-request {
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
        }

        /* Responsive tables */
        .responsive-table {
            width: 100%;
            border-collapse: collapse;
        }

        .responsive-table th, .responsive-table td {
            padding: 10px;
            border: 1px solid #eee;
            text-align: left;
        }

        .responsive-table th {
            background-color: #f8f9fa;
        }

        /* Tab navigation */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Auth Modal (shown when not logged in) -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="authModalTitle">Login</h2>
                <button class="modal-close" id="closeAuthModal">&times;</button>
            </div>
            <div id="loginForm">
                <div class="form-group">
                    <label for="loginUsername" class="form-label">Username or Phone Number</label>
                    <input type="text" id="loginUsername" class="form-control" placeholder="Enter username or phone">
                </div>
                <div class="form-group">
                    <label for="loginPassword" class="form-label">Password</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="Enter password">
                </div>
                <button id="loginBtn" class="btn btn-primary">Login</button>
                <div class="auth-switch">
                    Don't have an account? <a id="switchToSignup">Sign up</a>
                </div>
            </div>
            <div id="signupForm" style="display: none;">
                <div class="form-group">
                    <label for="signupName" class="form-label">Full Name</label>
                    <input type="text" id="signupName" class="form-control" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label for="signupUsername" class="form-label">Username (unique)</label>
                    <input type="text" id="signupUsername" class="form-control" placeholder="Choose a username">
                </div>
                <div class="form-group">
                    <label for="signupEmail" class="form-label">Email</label>
                    <input type="email" id="signupEmail" class="form-control" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="signupPhone" class="form-label">Phone Number</label>
                    <input type="tel" id="signupPhone" class="form-control" placeholder="Enter phone number">
                </div>
                <div class="form-group">
                    <label for="signupPassword" class="form-label">Password</label>
                    <input type="password" id="signupPassword" class="form-control" placeholder="Create password">
                </div>
                <div class="form-group">
                    <label for="signupConfirmPassword" class="form-label">Confirm Password</label>
                    <input type="password" id="signupConfirmPassword" class="form-control" placeholder="Confirm password">
                </div>
                <div class="form-group">
                    <label for="signupProfession" class="form-label">Profession</label>
                    <input type="text" id="signupProfession" class="form-control" placeholder="Your profession">
                </div>
                <div class="form-group">
                    <label for="signupJobTitle" class="form-label">Job Title</label>
                    <input type="text" id="signupJobTitle" class="form-control" placeholder="Your current job title">
                </div>
                <div class="form-group">
                    <label class="form-label">Profile Picture</label>
                    <div class="file-upload">
                        <label for="signupProfilePic" class="file-upload-label">
                            Click to upload profile picture
                        </label>
                        <input type="file" id="signupProfilePic" accept="image/*">
                    </div>
                </div>
                <button id="signupBtn" class="btn btn-primary">Sign Up</button>
                <div class="auth-switch">
                    Already have an account? <a id="switchToLogin">Login</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Container (shown when logged in) -->
    <div id="appContainer" style="display: none;">
        <div class="container">
            <!-- Sidebar Navigation -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2>Skysoft Job Market</h2>
                    <div class="location-detection">
                        <span class="location-icon">📍</span>
                        <span id="currentLocation">Detecting location...</span>
                    </div>
                </div>
                <div class="sidebar-menu">
                    <div class="menu-item active" data-section="dashboard">
                        <i>📊</i>
                        <span>Dashboard</span>
                    </div>
                    <div class="menu-item" data-section="jobs">
                        <i>💼</i>
                        <span>Job Listings</span>
                    </div>
                    <div class="menu-item" data-section="postJob">
                        <i>📝</i>
                        <span>Post a Job</span>
                    </div>
                    <div class="menu-item" data-section="myApplications">
                        <i>📋</i>
                        <span>My Applications</span>
                    </div>
                    <div class="menu-item" data-section="myJobs">
                        <i>🏢</i>
                        <span>My Job Posts</span>
                    </div>
                    <div class="menu-item" data-section="messages">
                        <i>💬</i>
                        <span>Messages</span>
                    </div>
                    <div class="menu-item" data-section="network">
                        <i>🌐</i>
                        <span>Network Peers</span>
                    </div>
                    <div id="adminMenuItem" class="menu-item" data-section="admin" style="display: none;">
                        <i>🛡️</i>
                        <span>Admin Panel</span>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="main-content">
                <!-- Top Bar -->
                <div class="top-bar">
                    <div id="breadcrumb">
                        <span>Dashboard</span>
                    </div>
                    <div class="user-actions">
                        <div class="notification-bell">
                            <span>🔔</span>
                            <span class="notification-count">0</span>
                        </div>
                        <div class="user-profile">
                            <img id="userProfilePic" src="" alt="Profile" class="profile-pic">
                            <span id="userDisplayName"></span>
                            <div class="profile-dropdown">
                                <div class="dropdown-item" id="editProfileBtn">Edit Profile</div>
                                <div class="dropdown-item" id="myCompaniesBtn">My Companies</div>
                                <div class="dropdown-item" id="settingsBtn">Settings</div>
                                <div class="dropdown-item" id="logoutBtn">Logout</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Broadcast Message -->
                <div id="broadcastMessage" class="broadcast-message" style="display: none;"></div>

                <!-- Dashboard Content -->
                <div id="dashboardSection" class="content-section">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Welcome, <span id="welcomeUserName"></span></h3>
                        </div>
                        <div class="card-body">
                            <p>Welcome to Skysoft Job Market. Find your dream job or the perfect candidate today!</p>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Jobs Near You</h3>
                        </div>
                        <div class="card-body" id="nearbyJobs">
                            <!-- Nearby jobs will be loaded here -->
                            <p>Loading jobs near you...</p>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Recent Activity</h3>
                        </div>
                        <div class="card-body" id="recentActivity">
                            <!-- Recent activity will be loaded here -->
                            <p>Loading recent activity...</p>
                        </div>
                    </div>
                </div>

                <!-- Job Listings Section -->
                <div id="jobsSection" class="content-section" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Browse Jobs</h3>
                            <div>
                                <input type="text" id="jobSearch" class="form-control" placeholder="Search jobs...">
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="tabs">
                                <div class="tab active" data-tab="allJobs">All Jobs</div>
                                <div class="tab" data-tab="verifiedJobs">Verified</div>
                                <div class="tab" data-tab="nearbyJobsTab">Near Me</div>
                            </div>
                            <div id="allJobs" class="tab-content active">
                                <div id="jobListings">
                                    <!-- Job listings will be loaded here -->
                                    <p>Loading job listings...</p>
                                </div>
                            </div>
                            <div id="verifiedJobs" class="tab-content">
                                <div id="verifiedJobListings">
                                    <!-- Verified job listings will be loaded here -->
                                    <p>Loading verified job listings...</p>
                                </div>
                            </div>
                            <div id="nearbyJobsTab" class="tab-content">
                                <div id="nearbyJobListings">
                                    <!-- Nearby job listings will be loaded here -->
                                    <p>Loading nearby job listings...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Post Job Section -->
                <div id="postJobSection" class="content-section" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Post a New Job</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="jobTitle" class="form-label">Job Title</label>
                                <input type="text" id="jobTitle" class="form-control" placeholder="Enter job title">
                            </div>
                            <div class="form-group">
                                <label for="jobCompany" class="form-label">Company</label>
                                <select id="jobCompany" class="form-control">
                                    <option value="">Select a company</option>
                                    <!-- Companies will be loaded here -->
                                </select>
                                <small>Or <a id="addNewCompanyLink">add a new company</a></small>
                            </div>
                            <div class="form-group">
                                <label for="jobCategory" class="form-label">Category</label>
                                <select id="jobCategory" class="form-control">
                                    <option value="">Select a category</option>
                                    <!-- Categories will be loaded here -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="jobPositions" class="form-label">Number of Positions</label>
                                <input type="number" id="jobPositions" class="form-control" placeholder="Enter number of positions" min="1">
                            </div>
                            <div class="form-group">
                                <label for="jobDeadline" class="form-label">Application Deadline</label>
                                <input type="date" id="jobDeadline" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="jobLocation" class="form-label">Location</label>
                                <input type="text" id="jobLocation" class="form-control" placeholder="Enter job location">
                            </div>
                            <div class="form-group">
                                <label for="jobSalary" class="form-label">Salary Range</label>
                                <div style="display: flex; gap: 10px;">
                                    <select id="jobCurrency" class="form-control" style="flex: 1;">
                                        <!-- Currencies will be loaded here -->
                                    </select>
                                    <input type="text" id="jobMinSalary" class="form-control" placeholder="Min" style="flex: 1;">
                                    <input type="text" id="jobMaxSalary" class="form-control" placeholder="Max" style="flex: 1;">
                                </div>
                                <div style="margin-top: 5px;">
                                    <input type="checkbox" id="jobSalaryNotDisclosed">
                                    <label for="jobSalaryNotDisclosed">Salary not disclosed</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="jobDescription" class="form-label">Job Description</label>
                                <textarea id="jobDescription" class="form-control" rows="5" placeholder="Enter job description"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Job Image (Optional)</label>
                                <div class="file-upload">
                                    <label for="jobImage" class="file-upload-label">
                                        Click to upload job image
                                    </label>
                                    <input type="file" id="jobImage" accept="image/*">
                                </div>
                            </div>
                            <div class="form-group">
                                <div>
                                    <input type="checkbox" id="allowComments">
                                    <label for="allowComments">Allow comments and reactions</label>
                                </div>
                                <div>
                                    <input type="checkbox" id="allowPrivateMessages">
                                    <label for="allowPrivateMessages">Allow private messages from applicants</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div style="background-color: #f8f9fa; padding: 10px; border-radius: var(--border-radius);">
                                    <input type="checkbox" id="jobFreeToApply" checked disabled>
                                    <label for="jobFreeToApply">This job is free to apply! No one should ask for money. If asked for money report the job immediately.</label>
                                </div>
                            </div>
                            <button id="postJobBtn" class="btn btn-primary">Post Job</button>
                        </div>
                    </div>
                </div>

                <!-- My Applications Section -->
                <div id="myApplicationsSection" class="content-section" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">My Job Applications</h3>
                        </div>
                        <div class="card-body">
                            <div class="tabs">
                                <div class="tab active" data-tab="allApplications">All</div>
                                <div class="tab" data-tab="pendingApplications">Pending</div>
                                <div class="tab" data-tab="acceptedApplications">Accepted</div>
                                <div class="tab" data-tab="rejectedApplications">Rejected</div>
                            </div>
                            <div id="allApplications" class="tab-content active">
                                <div id="applicationList">
                                    <!-- Applications will be loaded here -->
                                    <p>Loading your applications...</p>
                                </div>
                            </div>
                            <div id="pendingApplications" class="tab-content">
                                <div id="pendingApplicationList">
                                    <!-- Pending applications will be loaded here -->
                                    <p>Loading pending applications...</p>
                                </div>
                            </div>
                            <div id="acceptedApplications" class="tab-content">
                                <div id="acceptedApplicationList">
                                    <!-- Accepted applications will be loaded here -->
                                    <p>Loading accepted applications...</p>
                                </div>
                            </div>
                            <div id="rejectedApplications" class="tab-content">
                                <div id="rejectedApplicationList">
                                    <!-- Rejected applications will be loaded here -->
                                    <p>Loading rejected applications...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- My Job Posts Section -->
                <div id="myJobsSection" class="content-section" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">My Job Posts</h3>
                        </div>
                        <div class="card-body">
                            <div id="myJobPosts">
                                <!-- User's job posts will be loaded here -->
                                <p>Loading your job posts...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages Section -->
                <div id="messagesSection" class="content-section" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Messages</h3>
                        </div>
                        <div class="card-body">
                            <div style="display: flex; height: 500px;">
                                <div style="width: 30%; border-right: 1px solid #eee; padding-right: 10px; overflow-y: auto;">
                                    <div class="form-group">
                                        <input type="text" id="messageSearch" class="form-control" placeholder="Search contacts...">
                                    </div>
                                    <div id="messageContacts">
                                        <!-- Message contacts will be loaded here -->
                                        <p>Loading contacts...</p>
                                    </div>
                                </div>
                                <div style="flex: 1; padding-left: 10px; display: flex; flex-direction: column;">
                                    <div id="selectedContact" style="padding: 10px; border-bottom: 1px solid #eee; display: none;">
                                        <h4 id="contactName"></h4>
                                    </div>
                                    <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 10px;">
                                        <!-- Chat messages will be loaded here -->
                                        <p style="text-align: center; margin-top: 50%; color: #666;">Select a contact to start chatting</p>
                                    </div>
                                    <div id="chatInputContainer" style="padding: 10px; border-top: 1px solid #eee; display: none;">
                                        <div class="chat-input">
                                            <input type="text" id="chatMessageInput" placeholder="Type your message...">
                                            <button id="sendMessageBtn">Send</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Network Peers Section -->
                <div id="networkSection" class="content-section" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Network Peers</h3>
                        </div>
                        <div class="card-body">
                            <div class="tabs">
                                <div class="tab active" data-tab="onlinePeers">Online</div>
                                <div class="tab" data-tab="nearbyPeers">Near Me</div>
                                <div class="tab" data-tab="allPeers">All Peers</div>
                            </div>
                            <div id="onlinePeers" class="tab-content active">
                                <div id="onlinePeersList">
                                    <!-- Online peers will be loaded here -->
                                    <p>Loading online peers...</p>
                                </div>
                            </div>
                            <div id="nearbyPeers" class="tab-content">
                                <div id="nearbyPeersList">
                                    <!-- Nearby peers will be loaded here -->
                                    <p>Loading nearby peers...</p>
                                </div>
                            </div>
                            <div id="allPeers" class="tab-content">
                                <div id="allPeersList">
                                    <!-- All peers will be loaded here -->
                                    <p>Loading all peers...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin Panel Section -->
                <div id="adminSection" class="content-section" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Admin Panel</h3>
                        </div>
                        <div class="card-body">
                            <div class="admin-controls">
                                <h4>Broadcast Message</h4>
                                <div class="form-group">
                                    <textarea id="broadcastMessageInput" class="form-control" placeholder="Enter message to broadcast to all users"></textarea>
                                </div>
                                <button id="sendBroadcastBtn" class="btn btn-primary">Send Broadcast</button>
                            </div>

                            <div class="admin-section">
                                <h4 class="admin-section-title">User Management</h4>
                                <div class="form-group">
                                    <input type="text" id="adminUserSearch" class="form-control" placeholder="Search users...">
                                </div>
                                <div id="adminUsersList">
                                    <!-- Users will be loaded here -->
                                    <p>Loading users...</p>
                                </div>
                            </div>

                            <div class="admin-section">
                                <h4 class="admin-section-title">Job Reports</h4>
                                <div id="jobReportsList">
                                    <!-- Job reports will be loaded here -->
                                    <p>Loading job reports...</p>
                                </div>
                            </div>

                            <div class="admin-section">
                                <h4 class="admin-section-title">Blue Tick Requests</h4>
                                <div id="blueTickRequests">
                                    <!-- Blue tick requests will be loaded here -->
                                    <p>Loading blue tick requests...</p>
                                </div>
                            </div>

                            <div class="admin-section">
                                <h4 class="admin-section-title">Admin Settings</h4>
                                <div class="form-group">
                                    <label for="inactivityTimeout" class="form-label">Auto-logout after inactivity (minutes)</label>
                                    <input type="number" id="inactivityTimeout" class="form-control" value="30" min="1">
                                </div>
                                <div class="form-group">
                                    <label for="adminEmail" class="form-label">Admin Email for Verification</label>
                                    <input type="email" id="adminEmail" class="form-control" placeholder="Enter admin email">
                                </div>
                                <div class="form-group">
                                    <label for="successorEmail" class="form-label">Successor Email (if inactive for 6 months)</label>
                                    <input type="email" id="successorEmail" class="form-control" placeholder="Enter successor email">
                                </div>
                                <div class="form-group">
                                    <label for="successorPhone" class="form-label">Successor Phone (if inactive for 6 months)</label>
                                    <input type="tel" id="successorPhone" class="form-control" placeholder="Enter successor phone">
                                </div>
                                <button id="saveAdminSettingsBtn" class="btn btn-primary">Save Settings</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Profile</h2>
                <button class="modal-close" id="closeEditProfileModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editName" class="form-label">Full Name</label>
                    <input type="text" id="editName" class="form-control">
                </div>
                <div class="form-group">
                    <label for="editUsername" class="form-label">Username</label>
                    <input type="text" id="editUsername" class="form-control">
                </div>
                <div class="form-group">
                    <label for="editEmail" class="form-label">Email</label>
                    <input type="email" id="editEmail" class="form-control">
                </div>
                <div class="form-group">
                    <label for="editPhone" class="form-label">Phone Number</label>
                    <input type="tel" id="editPhone" class="form-control">
                </div>
                <div class="form-group">
                    <label for="editProfession" class="form-label">Profession</label>
                    <input type="text" id="editProfession" class="form-control">
                </div>
                <div class="form-group">
                    <label for="editJobTitle" class="form-label">Job Title</label>
                    <input type="text" id="editJobTitle" class="form-control">
                </div>
                <div class="form-group">
                    <label for="editCompany" class="form-label">Company</label>
                    <input type="text" id="editCompany" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Profile Picture</label>
                    <div class="file-upload">
                        <label for="editProfilePic" class="file-upload-label">
                            Click to change profile picture
                        </label>
                        <input type="file" id="editProfilePic" accept="image/*">
                    </div>
                </div>
                <button id="saveProfileBtn" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add Company Modal -->
    <div id="addCompanyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Company</h2>
                <button class="modal-close" id="closeAddCompanyModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="companyName" class="form-label">Company Name</label>
                    <input type="text" id="companyName" class="form-control" placeholder="Enter company name">
                </div>
                <div class="form-group">
                    <label for="companyDescription" class="form-label">Description</label>
                    <textarea id="companyDescription" class="form-control" rows="3" placeholder="Enter company description"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Company Logo</label>
                    <div class="file-upload">
                        <label for="companyLogo" class="file-upload-label">
                            Click to upload company logo
                        </label>
                        <input type="file" id="companyLogo" accept="image/*">
                    </div>
                </div>
                <div class="form-group">
                    <label for="companyWebsite" class="form-label">Website (optional)</label>
                    <input type="url" id="companyWebsite" class="form-control" placeholder="Enter company website">
                </div>
                <div class="form-group">
                    <input type="checkbox" id="requestBlueTick">
                    <label for="requestBlueTick">Request blue tick verification for this company</label>
                </div>
                <button id="saveCompanyBtn" class="btn btn-primary">Save Company</button>
            </div>
        </div>
    </div>

    <!-- View Job Modal -->
    <div id="viewJobModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="viewJobTitle"></h2>
                <button class="modal-close" id="closeViewJobModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="jobDetails">
                    <!-- Job details will be loaded here -->
                </div>
                <div id="jobActions" style="margin-top: 20px;">
                    <!-- Job actions will be loaded here -->
                </div>
                <div id="jobComments" style="margin-top: 20px; display: none;">
                    <h4>Comments</h4>
                    <div id="commentsList">
                        <!-- Comments will be loaded here -->
                    </div>
                    <div id="addComment" style="margin-top: 10px;">
                        <textarea id="commentInput" class="form-control" placeholder="Add a comment..." rows="2"></textarea>
                        <button id="postCommentBtn" class="btn btn-primary" style="margin-top: 5px;">Post Comment</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Apply for Job Modal -->
    <div id="applyJobModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Apply for Job</h2>
                <button class="modal-close" id="closeApplyJobModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="application-form">
                    <div class="form-group">
                        <label for="applicantName" class="form-label">Full Name</label>
                        <input type="text" id="applicantName" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="applicantEmail" class="form-label">Email</label>
                        <input type="email" id="applicantEmail" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="applicantPhone" class="form-label">Phone Number</label>
                        <input type="tel" id="applicantPhone" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="applicantAge" class="form-label">Age</label>
                        <input type="number" id="applicantAge" class="form-control" min="18" max="99">
                    </div>
                    <div class="form-group">
                        <label for="applicantGender" class="form-label">Gender</label>
                        <select id="applicantGender" class="form-control">
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                            <option value="prefer-not-to-say">Prefer not to say</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="applicantExperience" class="form-label">Years of Experience</label>
                        <input type="number" id="applicantExperience" class="form-control" min="0" max="50">
                    </div>
                    <div class="form-group">
                        <label for="applicantQualifications" class="form-label">Qualifications</label>
                        <textarea id="applicantQualifications" class="form-control" rows="3" placeholder="List your qualifications"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">CV/Resume</label>
                        <div class="file-upload">
                            <label for="applicantCv" class="file-upload-label">
                                Click to upload CV/Resume
                            </label>
                            <input type="file" id="applicantCv" accept=".pdf,.doc,.docx">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Portrait Photo</label>
                        <div class="file-upload">
                            <label for="applicantPhoto" class="file-upload-label">
                                Click to upload portrait photo
                            </label>
                            <input type="file" id="applicantPhoto" accept="image/*">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="applicantCoverLetter" class="form-label">Cover Letter (optional)</label>
                        <textarea id="applicantCoverLetter" class="form-control" rows="5" placeholder="Write your cover letter"></textarea>
                    </div>
                    <button id="submitApplicationBtn" class="btn btn-primary">Submit Application</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Application Modal -->
    <div id="viewApplicationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Job Application</h2>
                <button class="modal-close" id="closeViewApplicationModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="applicationDetails">
                    <!-- Application details will be loaded here -->
                </div>
                <div id="applicationActions" style="margin-top: 20px;">
                    <!-- Application actions will be loaded here -->
                </div>
                <div id="interviewSection" style="margin-top: 20px; display: none;">
                    <h4>Interview Details</h4>
                    <div id="interviewDetails">
                        <!-- Interview details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Interview Modal -->
    <div id="scheduleInterviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Schedule Interview</h2>
                <button class="modal-close" id="closeScheduleInterviewModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="interviewDate" class="form-label">Date</label>
                    <input type="date" id="interviewDate" class="form-control">
                </div>
                <div class="form-group">
                    <label for="interviewTime" class="form-label">Time</label>
                    <input type="time" id="interviewTime" class="form-control">
                </div>
                <div class="form-group">
                    <label for="interviewType" class="form-label">Interview Type</label>
                    <select id="interviewType" class="form-control">
                        <option value="online">Online</option>
                        <option value="in-person">In-Person</option>
                        <option value="phone">Phone</option>
                    </select>
                </div>
                <div class="form-group" id="interviewLocationGroup" style="display: none;">
                    <label for="interviewLocation" class="form-label">Location</label>
                    <input type="text" id="interviewLocation" class="form-control" placeholder="Enter interview location">
                </div>
                <div class="form-group">
                    <label for="interviewNotes" class="form-label">Additional Notes</label>
                    <textarea id="interviewNotes" class="form-control" rows="3" placeholder="Enter any additional notes for the applicant"></textarea>
                </div>
                <button id="scheduleInterviewBtn" class="btn btn-primary">Schedule Interview</button>
            </div>
        </div>
    </div>

    <!-- Interview Room Modal -->
    <div id="interviewRoomModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Interview Room</h2>
                <button class="modal-close" id="closeInterviewRoomModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="video-container">
                    <div class="video-box">
                        <video id="localVideo" autoplay muted></video>
                        <div class="video-label">You</div>
                    </div>
                    <div class="video-box">
                        <video id="remoteVideo" autoplay></video>
                        <div class="video-label" id="remoteParticipantName"></div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button id="toggleAudioBtn" class="btn btn-outline">Mute Audio</button>
                    <button id="toggleVideoBtn" class="btn btn-outline">Turn Off Video</button>
                    <button id="endInterviewBtn" class="btn btn-danger">End Interview</button>
                </div>
                <div style="margin-top: 20px;">
                    <h4>Chat</h4>
                    <div class="chat-container">
                        <div class="chat-messages" id="interviewChatMessages">
                            <!-- Interview chat messages will be loaded here -->
                        </div>
                        <div class="chat-input">
                            <input type="text" id="interviewChatInput" placeholder="Type your message...">
                            <button id="sendInterviewChatBtn">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Job Modal -->
    <div id="reportJobModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Report Job</h2>
                <button class="modal-close" id="closeReportJobModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="reportReason" class="form-label">Reason for Reporting</label>
                    <select id="reportReason" class="form-control">
                        <option value="fraud">Fraud or Scam</option>
                        <option value="discrimination">Discrimination</option>
                        <option value="misleading">Misleading Information</option>
                        <option value="illegal">Illegal Activity</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reportDetails" class="form-label">Details</label>
                    <textarea id="reportDetails" class="form-control" rows="3" placeholder="Please provide details about your report"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Evidence (Screenshots, Audio, etc.)</label>
                    <div class="file-upload">
                        <label for="reportEvidence" class="file-upload-label">
                            Click to upload evidence files
                        </label>
                        <input type="file" id="reportEvidence" multiple>
                    </div>
                </div>
                <button id="submitReportBtn" class="btn btn-danger">Submit Report</button>
            </div>
        </div>
    </div>

    <!-- View Report Modal -->
    <div id="viewReportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Job Report</h2>
                <button class="modal-close" id="closeViewReportModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="reportDetailsContent">
                    <!-- Report details will be loaded here -->
                </div>
                <div id="reportActions" style="margin-top: 20px;">
                    <!-- Report actions will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="modal-close" id="closeSettingsModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="settingsCurrency" class="form-label">Default Currency</label>
                    <select id="settingsCurrency" class="form-control">
                        <!-- Currencies will be loaded here -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="settingsNotifications" class="form-label">Notifications</label>
                    <div>
                        <input type="checkbox" id="settingsJobAlerts" checked>
                        <label for="settingsJobAlerts">Job alerts</label>
                    </div>
                    <div>
                        <input type="checkbox" id="settingsApplicationUpdates" checked>
                        <label for="settingsApplicationUpdates">Application updates</label>
                    </div>
                    <div>
                        <input type="checkbox" id="settingsMessages" checked>
                        <label for="settingsMessages">Messages</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="settingsLocation" class="form-label">Location Sharing</label>
                    <div>
                        <input type="checkbox" id="settingsShareLocation" checked>
                        <label for="settingsShareLocation">Share my location for better job matching</label>
                    </div>
                </div>
                <button id="saveSettingsBtn" class="btn btn-primary">Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let ipfs;
        let dat;
        let peer;
        let db;
        let currentUser = null;
        let isSuperAdmin = false;
        let inactivityTimer;
        let peerConnections = {};
        let dataChannel;
        let currentLocation = null;
        let currencies = [
            { code: 'UGX', name: 'Ugandan Shilling', symbol: 'USh' },
            { code: 'USD', name: 'US Dollar', symbol: '$' },
            { code: 'EUR', name: 'Euro', symbol: '€' },
            { code: 'GBP', name: 'British Pound', symbol: '£' },
            { code: 'KES', name: 'Kenyan Shilling', symbol: 'KSh' },
            { code: 'TZS', name: 'Tanzanian Shilling', symbol: 'TSh' },
            { code: 'RWF', name: 'Rwandan Franc', symbol: 'RF' },
            { code: 'ZAR', name: 'South African Rand', symbol: 'R' }
        ];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if user is logged in
            await initializeDatabases();
            checkAuthState();
            
            // Initialize event listeners
            setupEventListeners();
            
            // Initialize P2P network
            initializeNetwork();
            
            // Initialize location detection
            detectLocation();
            
            // Setup inactivity timer
            setupInactivityTimer();
            
            // Load currencies
            loadCurrencies();
        });

        // Initialize IndexedDB databases
        async function initializeDatabases() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('SkysoftJobMarketDB', 1);
                
                request.onupgradeneeded = function(event) {
                    const db = event.target.result;
                    
                    // Create users store
                    if (!db.objectStoreNames.contains('users')) {
                        const usersStore = db.createObjectStore('users', { keyPath: 'id', autoIncrement: true });
                        usersStore.createIndex('username', 'username', { unique: true });
                        usersStore.createIndex('email', 'email', { unique: true });
                        usersStore.createIndex('phone', 'phone', { unique: true });
                    }
                    
                    // Create jobs store
                    if (!db.objectStoreNames.contains('jobs')) {
                        const jobsStore = db.createObjectStore('jobs', { keyPath: 'id', autoIncrement: true });
                        jobsStore.createIndex('posterId', 'posterId');
                        jobsStore.createIndex('deadline', 'deadline');
                        jobsStore.createIndex('location', 'location');
                        jobsStore.createIndex('category', 'category');
                    }
                    
                    // Create applications store
                    if (!db.objectStoreNames.contains('applications')) {
                        const appsStore = db.createObjectStore('applications', { keyPath: 'id', autoIncrement: true });
                        appsStore.createIndex('jobId', 'jobId');
                        appsStore.createIndex('applicantId', 'applicantId');
                        appsStore.createIndex('status', 'status');
                    }
                    
                    // Create messages store
                    if (!db.objectStoreNames.contains('messages')) {
                        const msgsStore = db.createObjectStore('messages', { keyPath: 'id', autoIncrement: true });
                        msgsStore.createIndex('senderId', 'senderId');
                        msgsStore.createIndex('receiverId', 'receiverId');
                        msgsStore.createIndex('timestamp', 'timestamp');
                    }
                    
                    // Create companies store
                    if (!db.objectStoreNames.contains('companies')) {
                        const companiesStore = db.createObjectStore('companies', { keyPath: 'id', autoIncrement: true });
                        companiesStore.createIndex('ownerId', 'ownerId');
                        companiesStore.createIndex('name', 'name', { unique: true });
                    }
                    
                    // Create reports store
                    if (!db.objectStoreNames.contains('reports')) {
                        const reportsStore = db.createObjectStore('reports', { keyPath: 'id', autoIncrement: true });
                        reportsStore.createIndex('jobId', 'jobId');
                        reportsStore.createIndex('reporterId', 'reporterId');
                        reportsStore.createIndex('status', 'status');
                    }
                    
                    // Create notifications store
                    if (!db.objectStoreNames.contains('notifications')) {
                        const notifsStore = db.createObjectStore('notifications', { keyPath: 'id', autoIncrement: true });
                        notifsStore.createIndex('userId', 'userId');
                        notifsStore.createIndex('read', 'read');
                    }
                    
                    // Create activity store
                    if (!db.objectStoreNames.contains('activity')) {
                        const activityStore = db.createObjectStore('activity', { keyPath: 'id', autoIncrement: true });
                        activityStore.createIndex('userId', 'userId');
                        activityStore.createIndex('timestamp', 'timestamp');
                    }
                    
                    // Create settings store
                    if (!db.objectStoreNames.contains('settings')) {
                        const settingsStore = db.createObjectStore('settings', { keyPath: 'id' });
                    }
                    
                    // Create peer connections store
                    if (!db.objectStoreNames.contains('peers')) {
                        const peersStore = db.createObjectStore('peers', { keyPath: 'peerId' });
                        peersStore.createIndex('lastSeen', 'lastSeen');
                    }
                };
                
                request.onsuccess = function(event) {
                    db = event.target.result;
                    resolve(db);
                };
                
                request.onerror = function(event) {
                    console.error('Database error:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Check authentication state
        async function checkAuthState() {
            const user = await getCurrentUser();
            if (user) {
                currentUser = user;
                isSuperAdmin = user.isSuperAdmin || false;
                showApp();
                loadDashboard();
            } else {
                showAuthModal();
            }
        }

        // Show authentication modal
        function showAuthModal() {
            document.getElementById('authModal').classList.add('show');
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
        }

        // Hide authentication modal
        function hideAuthModal() {
            document.getElementById('authModal').classList.remove('show');
        }

        // Show main application
        function showApp() {
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('userProfilePic').src = currentUser.profilePic || 'default-profile.png';
            document.getElementById('userDisplayName').textContent = currentUser.username || currentUser.name;
            document.getElementById('welcomeUserName').textContent = currentUser.name;
            
            if (isSuperAdmin) {
                document.getElementById('adminMenuItem').style.display = 'block';
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Auth modal
            document.getElementById('switchToSignup').addEventListener('click', () => {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('signupForm').style.display = 'block';
                document.getElementById('authModalTitle').textContent = 'Sign Up';
            });
            
            document.getElementById('switchToLogin').addEventListener('click', () => {
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('signupForm').style.display = 'none';
                document.getElementById('authModalTitle').textContent = 'Login';
            });
            
            document.getElementById('closeAuthModal').addEventListener('click', hideAuthModal);
            
            // Login button
            document.getElementById('loginBtn').addEventListener('click', loginUser);
            
            // Signup button
            document.getElementById('signupBtn').addEventListener('click', signupUser);
            
            // Sidebar menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    const section = item.getAttribute('data-section');
                    showSection(section);
                });
            });
            
            // User profile dropdown
            document.querySelector('.user-profile').addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelector('.profile-dropdown').classList.toggle('show');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', () => {
                document.querySelector('.profile-dropdown').classList.remove('show');
            });
            
            // Edit profile
            document.getElementById('editProfileBtn').addEventListener('click', showEditProfileModal);
            document.getElementById('closeEditProfileModal').addEventListener('click', () => {
                document.getElementById('editProfileModal').classList.remove('show');
            });
            document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', logoutUser);
            
            // Post job
            document.getElementById('postJobBtn').addEventListener('click', postJob);
            document.getElementById('addNewCompanyLink').addEventListener('click', showAddCompanyModal);
            document.getElementById('closeAddCompanyModal').addEventListener('click', () => {
                document.getElementById('addCompanyModal').classList.remove('show');
            });
            document.getElementById('saveCompanyBtn').addEventListener('click', saveCompany);
            
            // Job search
            document.getElementById('jobSearch').addEventListener('input', searchJobs);
            
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    const tabContainer = tab.closest('.tabs').parentElement;
                    
                    // Update active tab
                    tabContainer.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Update active content
                    tabContainer.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tabContainer.querySelector(`#${tabId}`).classList.add('active');
                    
                    // Load content if needed
                    if (tabId === 'allJobs') loadAllJobs();
                    if (tabId === 'verifiedJobs') loadVerifiedJobs();
                    if (tabId === 'nearbyJobsTab') loadNearbyJobs();
                    if (tabId === 'allApplications') loadAllApplications();
                    if (tabId === 'pendingApplications') loadPendingApplications();
                    if (tabId === 'acceptedApplications') loadAcceptedApplications();
                    if (tabId === 'rejectedApplications') loadRejectedApplications();
                    if (tabId === 'onlinePeers') loadOnlinePeers();
                    if (tabId === 'nearbyPeers') loadNearbyPeers();
                    if (tabId === 'allPeers') loadAllPeers();
                });
            });
            
            // Admin controls
            document.getElementById('sendBroadcastBtn').addEventListener('click', sendBroadcastMessage);
            document.getElementById('saveAdminSettingsBtn').addEventListener('click', saveAdminSettings);
            
            // Settings
            document.getElementById('settingsBtn').addEventListener('click', showSettingsModal);
            document.getElementById('closeSettingsModal').addEventListener('click', () => {
                document.getElementById('settingsModal').classList.remove('show');
            });
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            
            // Interview type change
            document.getElementById('interviewType').addEventListener('change', (e) => {
                document.getElementById('interviewLocationGroup').style.display = 
                    e.target.value === 'in-person' ? 'block' : 'none';
            });
            
            // Schedule interview
            document.getElementById('scheduleInterviewBtn').addEventListener('click', scheduleInterview);
            
            // Report job
            document.getElementById('submitReportBtn').addEventListener('click', submitReport);
        }

        // Initialize P2P network
        async function initializeNetwork() {
            try {
                // Initialize IPFS
                ipfs = await Ipfs.create({ repo: 'skysoft-job-market' });
                console.log('IPFS initialized');
                
                // Initialize DAT
                const { Hypercore, Hyperdrive, close } = await DatSdk();
                dat = { Hypercore, Hyperdrive, close };
                console.log('DAT SDK initialized');
                
                // Initialize PeerJS
                peer = new Peer();
                
                peer.on('open', (id) => {
                    console.log('PeerJS connected with ID:', id);
                    // Store peer ID in database
                    storePeerId(id);
                });
                
                peer.on('connection', (conn) => {
                    console.log('Peer connected:', conn.peer);
                    setupDataConnection(conn);
                });
                
                peer.on('error', (err) => {
                    console.error('PeerJS error:', err);
                });
                
                // Connect to known peers
                connectToKnownPeers();
            } catch (err) {
                console.error('Network initialization error:', err);
            }
        }

        // Store peer ID in database
        function storePeerId(peerId) {
            const transaction = db.transaction(['peers'], 'readwrite');
            const store = transaction.objectStore('peers');
            
            const peerData = {
                peerId: peerId,
                userId: currentUser?.id || null,
                lastSeen: new Date().toISOString(),
                location: currentLocation
            };
            
            store.put(peerData);
        }

        // Connect to known peers
        async function connectToKnownPeers() {
            const peers = await getAllPeers();
            peers.forEach(peerData => {
                if (peerData.peerId !== peer.id) {
                    const conn = peer.connect(peerData.peerId);
                    setupDataConnection(conn);
                }
            });
        }

        // Setup data connection
        function setupDataConnection(conn) {
            conn.on('open', () => {
                console.log('Connected to peer:', conn.peer);
                peerConnections[conn.peer] = conn;
                
                // Set up data channel
                conn.on('data', (data) => {
                    handlePeerData(conn.peer, data);
                });
                
                // Send initial sync request
                if (currentUser) {
                    conn.send({
                        type: 'sync_request',
                        userId: currentUser.id,
                        peerId: peer.id,
                        timestamp: Date.now()
                    });
                }
            });
            
            conn.on('error', (err) => {
                console.error('Connection error:', err);
                delete peerConnections[conn.peer];
            });
            
            conn.on('close', () => {
                console.log('Connection closed:', conn.peer);
                delete peerConnections[conn.peer];
            });
        }

        // Handle incoming peer data
        function handlePeerData(peerId, data) {
            console.log('Data received from peer:', peerId, data);
            
            switch (data.type) {
                case 'sync_request':
                    handleSyncRequest(peerId, data);
                    break;
                case 'sync_response':
                    handleSyncResponse(data);
                    break;
                case 'job_post':
                    handleNewJob(data.job);
                    break;
                case 'job_update':
                    handleJobUpdate(data.job);
                    break;
                case 'job_delete':
                    handleJobDelete(data.jobId);
                    break;
                case 'application':
                    handleNewApplication(data.application);
                    break;
                case 'application_update':
                    handleApplicationUpdate(data.application);
                    break;
                case 'message':
                    handleNewMessage(data.message);
                    break;
                case 'broadcast':
                    handleBroadcastMessage(data.message);
                    break;
                case 'report':
                    handleNewReport(data.report);
                    break;
                case 'user_update':
                    handleUserUpdate(data.user);
                    break;
                case 'user_ban':
                    handleUserBan(data.userId, data.duration);
                    break;
                default:
                    console.log('Unknown message type:', data.type);
            }
        }

        // Handle sync request
        function handleSyncRequest(peerId, data) {
            if (!currentUser || !isSuperAdmin) return;
            
            // Get all data to sync
            Promise.all([
                getAllUsers(),
                getAllJobs(),
                getAllApplications(),
                getAllMessages(),
                getAllCompanies(),
                getAllReports()
            ]).then(([users, jobs, applications, messages, companies, reports]) => {
                const conn = peerConnections[peerId];
                if (conn) {
                    conn.send({
                        type: 'sync_response',
                        users,
                        jobs,
                        applications,
                        messages,
                        companies,
                        reports,
                        timestamp: Date.now()
                    });
                }
            });
        }

        // Handle sync response
        function handleSyncResponse(data) {
            // Store received data
            Promise.all([
                storeMultipleItems('users', data.users),
                storeMultipleItems('jobs', data.jobs),
                storeMultipleItems('applications', data.applications),
                storeMultipleItems('messages', data.messages),
                storeMultipleItems('companies', data.companies),
                storeMultipleItems('reports', data.reports)
            ]).then(() => {
                console.log('Data synchronized successfully');
                // Refresh UI
                if (document.getElementById('jobsSection').style.display !== 'none') {
                    loadAllJobs();
                }
            });
        }

        // Store multiple items in IndexedDB
        function storeMultipleItems(storeName, items) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                
                // Clear existing data
                const clearRequest = store.clear();
                
                clearRequest.onsuccess = () => {
                    // Add new items
                    let count = 0;
                    items.forEach(item => {
                        const request = store.put(item);
                        request.onsuccess = () => {
                            count++;
                            if (count === items.length) {
                                resolve();
                            }
                        };
                        request.onerror = (e) => {
                            console.error(`Error storing item in ${storeName}:`, e.target.error);
                            reject(e.target.error);
                        };
                    });
                    
                    if (items.length === 0) {
                        resolve();
                    }
                };
                
                clearRequest.onerror = (e) => {
                    console.error(`Error clearing ${storeName}:`, e.target.error);
                    reject(e.target.error);
                };
            });
        }

        // Detect user location
        function detectLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            timestamp: position.timestamp
                        };
                        document.getElementById('currentLocation').textContent = 
                            `Lat: ${currentLocation.lat.toFixed(4)}, Lng: ${currentLocation.lng.toFixed(4)}`;
                        
                        // Update user location in database
                        if (currentUser) {
                            updateUserLocation(currentUser.id, currentLocation);
                        }
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        document.getElementById('currentLocation').textContent = 'Location not available';
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                document.getElementById('currentLocation').textContent = 'Geolocation not supported';
            }
        }

        // Update user location in database
        function updateUserLocation(userId, location) {
            const transaction = db.transaction(['users'], 'readwrite');
            const store = transaction.objectStore('users');
            
            const request = store.get(userId);
            request.onsuccess = () => {
                const user = request.result;
                if (user) {
                    user.location = location;
                    store.put(user);
                }
            };
        }

        // Setup inactivity timer
        function setupInactivityTimer() {
            // Reset timer on any user activity
            document.addEventListener('mousemove', resetInactivityTimer);
            document.addEventListener('keypress', resetInactivityTimer);
            document.addEventListener('click', resetInactivityTimer);
            document.addEventListener('scroll', resetInactivityTimer);
            
            resetInactivityTimer();
        }

        // Reset inactivity timer
        function resetInactivityTimer() {
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
            }
            
            // Get timeout duration from settings or use default (30 minutes)
            const timeoutMinutes = 30; // Default, can be fetched from settings
            inactivityTimer = setTimeout(() => {
                if (currentUser) {
                    logoutUser();
                    alert('You have been logged out due to inactivity.');
                }
            }, timeoutMinutes * 60 * 1000);
        }

        // Load currencies
        function loadCurrencies() {
            const currencySelects = document.querySelectorAll('select[id$="Currency"]');
            
            currencySelects.forEach(select => {
                // Clear existing options
                select.innerHTML = '';
                
                // Add new options
                currencies.forEach(currency => {
                    const option = document.createElement('option');
                    option.value = currency.code;
                    option.textContent = `${currency.code} - ${currency.name} (${currency.symbol})`;
                    select.appendChild(option);
                });
                
                // Set default currency based on location or user preference
                const defaultCurrency = 'UGX'; // Default to UGX, can be detected from location
                select.value = defaultCurrency;
            });
        }

        // Show section
        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.style.display = 'none';
            });
            
            document.getElementById(`${section}Section`).style.display = 'block';
            document.getElementById('breadcrumb').innerHTML = `<span>${section.charAt(0).toUpperCase() + section.slice(1)}</span>`;
            
            // Load section data
            switch (section) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'jobs':
                    loadAllJobs();
                    break;
                case 'postJob':
                    loadPostJobForm();
                    break;
                case 'myApplications':
                    loadAllApplications();
                    break;
                case 'myJobs':
                    loadMyJobs();
                    break;
                case 'messages':
                    loadMessageContacts();
                    break;
                case 'network':
                    loadOnlinePeers();
                    break;
                case 'admin':
                    if (isSuperAdmin) {
                        loadAdminPanel();
                    }
                    break;
            }
        }

        // Load dashboard
        function loadDashboard() {
            loadNearbyJobs();
            loadRecentActivity();
        }

        // Load nearby jobs
        function loadNearbyJobs() {
            if (!currentLocation) {
                document.getElementById('nearbyJobs').innerHTML = '<p>Location not available to show nearby jobs.</p>';
                return;
            }
            
            getAllJobs().then(jobs => {
                // Filter jobs by location (simplified - would use real distance calculation in production)
                const nearbyJobs = jobs.filter(job => 
                    job.location && 
                    job.deadline > new Date().toISOString()
                ).slice(0, 5);
                
                displayJobs(nearbyJobs, 'nearbyJobs');
            });
        }

        // Load recent activity
        function loadRecentActivity() {
            getActivityForUser(currentUser.id, 5).then(activities => {
                const activityHtml = activities.map(activity => `
                    <div style="padding: 10px; border-bottom: 1px solid #eee;">
                        <p>${activity.description}</p>
                        <small>${new Date(activity.timestamp).toLocaleString()}</small>
                    </div>
                `).join('');
                
                document.getElementById('recentActivity').innerHTML = 
                    activityHtml || '<p>No recent activity.</p>';
            });
        }

        // Load all jobs
        function loadAllJobs() {
            getAllJobs().then(jobs => {
                const activeJobs = jobs.filter(job => job.deadline > new Date().toISOString());
                displayJobs(activeJobs, 'jobListings');
            });
        }

        // Load verified jobs
        function loadVerifiedJobs() {
            getAllJobs().then(jobs => {
                const verifiedJobs = jobs.filter(job => 
                    job.deadline > new Date().toISOString() && 
                    job.isVerified
                );
                displayJobs(verifiedJobs, 'verifiedJobListings');
            });
        }

        // Display jobs
        function displayJobs(jobs, containerId) {
            if (jobs.length === 0) {
                document.getElementById(containerId).innerHTML = '<p>No jobs found.</p>';
                return;
            }
            
            const jobsHtml = jobs.map(job => `
                <div class="job-card" data-job-id="${job.id}">
                    <h4 class="job-title">${job.title} ${job.isVerified ? '<span class="blue-tick">✓</span>' : ''}</h4>
                    <p class="job-company">${job.companyName}</p>
                    <p class="job-location">📍 ${job.location}</p>
                    <p class="job-description">${job.description.substring(0, 150)}...</p>
                    <div class="job-meta">
                        <span>${job.category}</span>
                        <span>Deadline: ${new Date(job.deadline).toLocaleDateString()}</span>
                    </div>
                    <div class="job-actions">
                        <button class="btn btn-outline view-job-btn">View Details</button>
                        <button class="btn btn-danger report-job-btn">Report</button>
                    </div>
                </div>
            `).join('');
            
            document.getElementById(containerId).innerHTML = jobsHtml;
            
            // Add event listeners to job buttons
            document.querySelectorAll('.view-job-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const jobId = e.target.closest('.job-card').getAttribute('data-job-id');
                    viewJob(jobId);
                });
            });
            
            document.querySelectorAll('.report-job-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const jobId = e.target.closest('.job-card').getAttribute('data-job-id');
                    showReportJobModal(jobId);
                });
            });
        }

        // View job details
        function viewJob(jobId) {
            getJob(jobId).then(job => {
                if (!job) {
                    alert('Job not found');
                    return;
                }
                
                document.getElementById('viewJobTitle').textContent = job.title;
                
                // Display job details
                let jobHtml = `
                    <div>
                        <p><strong>Company:</strong> ${job.companyName}</p>
                        <p><strong>Location:</strong> ${job.location}</p>
                        <p><strong>Category:</strong> ${job.category}</p>
                        <p><strong>Positions:</strong> ${job.positions}</p>
                        <p><strong>Deadline:</strong> ${new Date(job.deadline).toLocaleDateString()}</p>
                        <p><strong>Salary:</strong> ${job.salaryNotDisclosed ? 'Not disclosed' : 
                            `${job.currency} ${job.minSalary} - ${job.maxSalary}`}</p>
                        <p><strong>Description:</strong></p>
                        <p>${job.description}</p>
                    </div>
                `;
                
                if (job.image) {
                    jobHtml = `<img src="${job.image}" style="max-width: 100%; margin-bottom: 15px;">` + jobHtml;
                }
                
                document.getElementById('jobDetails').innerHTML = jobHtml;
                
                // Display job actions
                let actionsHtml = '';
                
                if (job.posterId === currentUser.id || isSuperAdmin) {
                    actionsHtml += `<button class="btn btn-danger" id="deleteJobBtn">Delete Job</button> `;
                    actionsHtml += `<button class="btn btn-primary" id="viewApplicationsBtn">View Applications</button>`;
                    
                    document.getElementById('jobActions').innerHTML = actionsHtml;
                    
                    document.getElementById('deleteJobBtn').addEventListener('click', () => {
                        if (confirm('Are you sure you want to delete this job?')) {
                            deleteJob(jobId);
                        }
                    });
                    
                    document.getElementById('viewApplicationsBtn').addEventListener('click', () => {
                        viewJobApplications(jobId);
                    });
                } else {
                    actionsHtml += `<button class="btn btn-primary" id="applyJobBtn">Apply Now</button>`;
                    
                    document.getElementById('jobActions').innerHTML = actionsHtml;
                    
                    document.getElementById('applyJobBtn').addEventListener('click', () => {
                        showApplyJobModal(jobId);
                    });
                }
                
                // Show comments if allowed
                if (job.allowComments) {
                    document.getElementById('jobComments').style.display = 'block';
                    loadJobComments(jobId);
                } else {
                    document.getElementById('jobComments').style.display = 'none';
                }
                
                // Show the modal
                document.getElementById('viewJobModal').classList.add('show');
            });
        }

        // Load job comments
        function loadJobComments(jobId) {
            // In a real app, this would fetch comments from the database
            document.getElementById('commentsList').innerHTML = '<p>No comments yet.</p>';
            
            // Add event listener to post comment button
            document.getElementById('postCommentBtn').addEventListener('click', () => {
                const commentText = document.getElementById('commentInput').value.trim();
                if (commentText) {
                    postJobComment(jobId, commentText);
                }
            });
        }

        // Post job comment
        function postJobComment(jobId, commentText) {
            // In a real app, this would store the comment in the database
            const comment = {
                id: Date.now(),
                jobId,
                userId: currentUser.id,
                username: currentUser.username || currentUser.name,
                text: commentText,
                timestamp: new Date().toISOString()
            };
            
            // Broadcast comment to peers
            broadcastData({
                type: 'job_comment',
                comment
            });
            
            // Add comment to UI
            const commentHtml = `
                <div style="margin-bottom: 10px; padding: 10px; background-color: #f8f9fa; border-radius: var(--border-radius);">
                    <p><strong>${comment.username}</strong></p>
                    <p>${comment.text}</p>
                    <small>${new Date(comment.timestamp).toLocaleString()}</small>
                </div>
            `;
            
            document.getElementById('commentsList').insertAdjacentHTML('afterbegin', commentHtml);
            document.getElementById('commentInput').value = '';
        }

        // Show apply job modal
        function showApplyJobModal(jobId) {
            document.getElementById('applicantName').value = currentUser.name;
            document.getElementById('applicantEmail').value = currentUser.email;
            document.getElementById('applicantPhone').value = currentUser.phone;
            
            document.getElementById('applyJobModal').classList.add('show');
            
            // Add event listener to submit button
            document.getElementById('submitApplicationBtn').addEventListener('click', () => {
                submitJobApplication(jobId);
            });
        }

        // Submit job application
        function submitJobApplication(jobId) {
            const age = document.getElementById('applicantAge').value;
            const gender = document.getElementById('applicantGender').value;
            const experience = document.getElementById('applicantExperience').value;
            const qualifications = document.getElementById('applicantQualifications').value;
            const coverLetter = document.getElementById('applicantCoverLetter').value;
            
            // Get files (simplified - in real app would upload to IPFS)
            const cvFile = document.getElementById('applicantCv').files[0];
            const photoFile = document.getElementById('applicantPhoto').files[0];
            
            if (!age || !experience || !qualifications || !cvFile || !photoFile) {
                alert('Please fill all required fields');
                return;
            }
            
            const application = {
                jobId,
                applicantId: currentUser.id,
                age,
                gender,
                experience,
                qualifications,
                coverLetter,
                cv: cvFile ? cvFile.name : null,
                photo: photoFile ? photoFile.name : null,
                status: 'pending',
                timestamp: new Date().toISOString()
            };
            
            // Store application in database
            addApplication(application).then(() => {
                // Broadcast application to peers
                broadcastData({
                    type: 'application',
                    application
                });
                
                // Notify job poster
                createNotification(
                    application.jobId, 
                    'New application received', 
                    `${currentUser.name} applied for your job posting`
                );
                
                // Add activity log
                addActivity(
                    currentUser.id,
                    `Applied for job: ${application.jobId}`,
                    'application'
                );
                
                alert('Application submitted successfully!');
                document.getElementById('applyJobModal').classList.remove('show');
                
                // Refresh applications list if on that page
                if (document.getElementById('myApplicationsSection').style.display !== 'none') {
                    loadAllApplications();
                }
            });
        }

        // View job applications
        function viewJobApplications(jobId) {
            getApplicationsForJob(jobId).then(applications => {
                let applicationsHtml = '';
                
                if (applications.length === 0) {
                    applicationsHtml = '<p>No applications yet.</p>';
                } else {
                    applications.forEach(app => {
                        applicationsHtml += `
                            <div class="job-card" data-application-id="${app.id}">
                                <h4>${app.applicantName || 'Applicant'}</h4>
                                <p>Age: ${app.age} | Experience: ${app.experience} years</p>
                                <p>Status: <span class="status-${app.status}">${app.status}</span></p>
                                <div class="job-actions">
                                    <button class="btn btn-outline view-application-btn">View Application</button>
                                    ${app.status === 'pending' ? 
                                        `<button class="btn btn-success accept-application-btn">Accept</button>
                                         <button class="btn btn-danger reject-application-btn">Reject</button>` : ''}
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('viewApplicationModal').querySelector('.modal-title').textContent = 'Job Applications';
                document.getElementById('applicationDetails').innerHTML = applicationsHtml;
                
                // Add event listeners to application buttons
                document.querySelectorAll('.view-application-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const appId = e.target.closest('.job-card').getAttribute('data-application-id');
                        viewApplication(appId);
                    });
                });
                
                document.querySelectorAll('.accept-application-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const appId = e.target.closest('.job-card').getAttribute('data-application-id');
                        updateApplicationStatus(appId, 'accepted');
                    });
                });
                
                document.querySelectorAll('.reject-application-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const appId = e.target.closest('.job-card').getAttribute('data-application-id');
                        updateApplicationStatus(appId, 'rejected');
                    });
                });
                
                // Show the modal
                document.getElementById('viewApplicationModal').classList.add('show');
            });
        }

        // View application details
        function viewApplication(applicationId) {
            getApplication(applicationId).then(application => {
                if (!application) {
                    alert('Application not found');
                    return;
                }
                
                document.getElementById('viewApplicationModal').querySelector('.modal-title').textContent = 'Application Details';
                
                let appHtml = `
                    <div>
                        <p><strong>Name:</strong> ${application.applicantName}</p>
                        <p><strong>Email:</strong> ${application.applicantEmail}</p>
                        <p><strong>Phone:</strong> ${application.applicantPhone}</p>
                        <p><strong>Age:</strong> ${application.age}</p>
                        <p><strong>Gender:</strong> ${application.gender}</p>
                        <p><strong>Experience:</strong> ${application.experience} years</p>
                        <p><strong>Qualifications:</strong></p>
                        <p>${application.qualifications}</p>
                        <p><strong>Cover Letter:</strong></p>
                        <p>${application.coverLetter || 'Not provided'}</p>
                        <p><strong>CV:</strong> ${application.cv ? '<a href="#" class="download-cv">Download</a>' : 'Not provided'}</p>
                        <p><strong>Photo:</strong> ${application.photo ? '<a href="#" class="view-photo">View</a>' : 'Not provided'}</p>
                        <p><strong>Status:</strong> <span class="status-${application.status}">${application.status}</span></p>
                        <p><strong>Applied on:</strong> ${new Date(application.timestamp).toLocaleString()}</p>
                    </div>
                `;
                
                document.getElementById('applicationDetails').innerHTML = appHtml;
                
                // Add actions based on status
                let actionsHtml = '';
                
                if (application.status === 'accepted' && !application.interviewScheduled) {
                    actionsHtml += `<button class="btn btn-primary" id="scheduleInterviewBtn">Schedule Interview</button>`;
                }
                
                if (application.status === 'accepted' && application.interviewScheduled) {
                    actionsHtml += `<button class="btn btn-primary" id="startInterviewBtn">Start Interview</button>`;
                }
                
                if (application.applicantId === currentUser.id) {
                    actionsHtml += `<button class="btn btn-danger" id="withdrawApplicationBtn">Withdraw Application</button>`;
                }
                
                document.getElementById('applicationActions').innerHTML = actionsHtml;
                
                // Add event listeners to action buttons
                if (document.getElementById('scheduleInterviewBtn')) {
                    document.getElementById('scheduleInterviewBtn').addEventListener('click', () => {
                        showScheduleInterviewModal(applicationId);
                    });
                }
                
                if (document.getElementById('startInterviewBtn')) {
                    document.getElementById('startInterviewBtn').addEventListener('click', () => {
                        startInterview(applicationId);
                    });
                }
                
                if (document.getElementById('withdrawApplicationBtn')) {
                    document.getElementById('withdrawApplicationBtn').addEventListener('click', () => {
                        if (confirm('Are you sure you want to withdraw this application?')) {
                            updateApplicationStatus(applicationId, 'withdrawn');
                        }
                    });
                }
                
                // Add event listeners to download/view links
                document.querySelectorAll('.download-cv').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        // In real app, would download the file from IPFS
                        alert('CV download would start here');
                    });
                });
                
                document.querySelectorAll('.view-photo').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        // In real app, would show the photo
                        alert('Photo would be displayed here');
                    });
                });
                
                // Show interview section if scheduled
                if (application.interviewScheduled) {
                    document.getElementById('interviewSection').style.display = 'block';
                    
                    let interviewHtml = `
                        <p><strong>Date:</strong> ${new Date(application.interviewDate).toLocaleDateString()}</p>
                        <p><strong>Time:</strong> ${application.interviewTime}</p>
                        <p><strong>Type:</strong> ${application.interviewType}</p>
                        ${application.interviewLocation ? `<p><strong>Location:</strong> ${application.interviewLocation}</p>` : ''}
                        <p><strong>Notes:</strong> ${application.interviewNotes || 'None'}</p>
                    `;
                    
                    document.getElementById('interviewDetails').innerHTML = interviewHtml;
                } else {
                    document.getElementById('interviewSection').style.display = 'none';
                }
            });
        }

        // Update application status
        function updateApplicationStatus(applicationId, status) {
            getApplication(applicationId).then(application => {
                if (!application) {
                    alert('Application not found');
                    return;
                }
                
                application.status = status;
                application.updatedAt = new Date().toISOString();
                
                updateApplication(application).then(() => {
                    // Broadcast update to peers
                    broadcastData({
                        type: 'application_update',
                        application
                    });
                    
                    // Notify applicant
                    createNotification(
                        application.applicantId,
                        'Application status updated',
                        `Your application status has been updated to ${status}`
                    );
                    
                    // Add activity log
                    addActivity(
                        currentUser.id,
                        `Updated application ${applicationId} to ${status}`,
                        'application'
                    );
                    
                    // Refresh view
                    viewJobApplications(application.jobId);
                });
            });
        }

        // Show schedule interview modal
        function showScheduleInterviewModal(applicationId) {
            document.getElementById('scheduleInterviewModal').classList.add('show');
            
            // Add event listener to schedule button
            document.getElementById('scheduleInterviewBtn').addEventListener('click', () => {
                scheduleInterview(applicationId);
            });
        }

        // Schedule interview
        function scheduleInterview(applicationId) {
            const date = document.getElementById('interviewDate').value;
            const time = document.getElementById('interviewTime').value;
            const type = document.getElementById('interviewType').value;
            const location = type === 'in-person' ? document.getElementById('interviewLocation').value : null;
            const notes = document.getElementById('interviewNotes').value;
            
            if (!date || !time || !type) {
                alert('Please fill all required fields');
                return;
            }
            
            getApplication(applicationId).then(application => {
                if (!application) {
                    alert('Application not found');
                    return;
                }
                
                application.interviewScheduled = true;
                application.interviewDate = date;
                application.interviewTime = time;
                application.interviewType = type;
                application.interviewLocation = location;
                application.interviewNotes = notes;
                
                updateApplication(application).then(() => {
                    // Broadcast update to peers
                    broadcastData({
                        type: 'application_update',
                        application
                    });
                    
                    // Notify applicant
                    createNotification(
                        application.applicantId,
                        'Interview scheduled',
                        `An interview has been scheduled for your application`
                    );
                    
                    // Add activity log
                    addActivity(
                        currentUser.id,
                        `Scheduled interview for application ${applicationId}`,
                        'interview'
                    );
                    
                    alert('Interview scheduled successfully!');
                    document.getElementById('scheduleInterviewModal').classList.remove('show');
                    
                    // Refresh application view
                    viewApplication(applicationId);
                });
            });
        }

        // Start interview
        function startInterview(applicationId) {
            getApplication(applicationId).then(application => {
                if (!application) {
                    alert('Application not found');
                    return;
                }
                
                // In a real app, this would set up WebRTC video chat
                document.getElementById('interviewRoomModal').classList.add('show');
                document.getElementById('remoteParticipantName').textContent = application.applicantName;
                
                // Set up event listeners for interview room buttons
                document.getElementById('toggleAudioBtn').addEventListener('click', toggleAudio);
                document.getElementById('toggleVideoBtn').addEventListener('click', toggleVideo);
                document.getElementById('endInterviewBtn').addEventListener('click', endInterview);
                document.getElementById('sendInterviewChatBtn').addEventListener('click', sendInterviewChat);
                
                // Start video streams (simplified - in real app would use WebRTC)
                navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                    .then(stream => {
                        document.getElementById('localVideo').srcObject = stream;
                        // In real app, would connect to remote peer
                    })
                    .catch(err => {
                        console.error('Error accessing media devices:', err);
                    });
            });
        }

        // Toggle audio in interview
        function toggleAudio() {
            const btn = document.getElementById('toggleAudioBtn');
            const localStream = document.getElementById('localVideo').srcObject;
            
            if (localStream) {
                const audioTracks = localStream.getAudioTracks();
                if (audioTracks.length > 0) {
                    const enabled = audioTracks[0].enabled;
                    audioTracks[0].enabled = !enabled;
                    btn.textContent = enabled ? 'Unmute Audio' : 'Mute Audio';
                }
            }
        }

        // Toggle video in interview
        function toggleVideo() {
            const btn = document.getElementById('toggleVideoBtn');
            const localStream = document.getElementById('localVideo').srcObject;
            
            if (localStream) {
                const videoTracks = localStream.getVideoTracks();
                if (videoTracks.length > 0) {
                    const enabled = videoTracks[0].enabled;
                    videoTracks[0].enabled = !enabled;
                    btn.textContent = enabled ? 'Turn On Video' : 'Turn Off Video';
                }
            }
        }

        // End interview
        function endInterview() {
            const localStream = document.getElementById('localVideo').srcObject;
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            document.getElementById('interviewRoomModal').classList.remove('show');
        }

        // Send interview chat message
        function sendInterviewChat() {
            const input = document.getElementById('interviewChatInput');
            const message = input.value.trim();
            
            if (message) {
                const messageHtml = `
                    <div class="message sent">
                        <p>${message}</p>
                        <p class="message-time">${new Date().toLocaleTimeString()}</p>
                    </div>
                `;
                
                document.getElementById('interviewChatMessages').insertAdjacentHTML('beforeend', messageHtml);
                input.value = '';
                
                // Scroll to bottom
                document.getElementById('interviewChatMessages').scrollTop = 
                    document.getElementById('interviewChatMessages').scrollHeight;
                
                // In real app, would send message to remote peer
            }
        }

        // Show report job modal
        function showReportJobModal(jobId) {
            document.getElementById('reportJobModal').classList.add('show');
            
            // Add event listener to submit button
            document.getElementById('submitReportBtn').addEventListener('click', () => {
                submitReport(jobId);
            });
        }

        // Submit report
        function submitReport(jobId) {
            const reason = document.getElementById('reportReason').value;
            const details = document.getElementById('reportDetails').value;
            const evidence = document.getElementById('reportEvidence').files;
            
            if (!details) {
                alert('Please provide details about your report');
                return;
            }
            
            const report = {
                jobId,
                reporterId: currentUser.id,
                reason,
                details,
                evidence: Array.from(evidence).map(file => file.name), // In real app would store files
                status: 'pending',
                timestamp: new Date().toISOString()
            };
            
            addReport(report).then(() => {
                // Broadcast report to peers
                broadcastData({
                    type: 'report',
                    report
                });
                
                // Notify admin
                if (isSuperAdmin) {
                    createNotification(
                        currentUser.id,
                        'New job report',
                        `A job has been reported by ${currentUser.name}`
                    );
                } else {
                    // Find super admin to notify
                    getSuperAdmin().then(admin => {
                        if (admin) {
                            createNotification(
                                admin.id,
                                'New job report',
                                `A job has been reported by ${currentUser.name}`
                            );
                        }
                    });
                }
                
                // Add activity log
                addActivity(
                    currentUser.id,
                    `Reported job: ${jobId}`,
                    'report'
                );
                
                alert('Report submitted successfully!');
                document.getElementById('reportJobModal').classList.remove('show');
            });
        }

        // View report
        function viewReport(reportId) {
            getReport(reportId).then(report => {
                if (!report) {
                    alert('Report not found');
                    return;
                }
                
                document.getElementById('viewReportModal').querySelector('.modal-title').textContent = 'Job Report';
                
                let reportHtml = `
                    <div>
                        <p><strong>Reported by:</strong> ${report.reporterName || 'Unknown'}</p>
                        <p><strong>Reason:</strong> ${report.reason}</p>
                        <p><strong>Details:</strong></p>
                        <p>${report.details}</p>
                        <p><strong>Evidence:</strong> ${report.evidence.length > 0 ? 
                            report.evidence.map(e => `<a href="#">${e}</a>`).join(', ') : 'None'}</p>
                        <p><strong>Status:</strong> ${report.status}</p>
                        <p><strong>Reported on:</strong> ${new Date(report.timestamp).toLocaleString()}</p>
                    </div>
                `;
                
                document.getElementById('reportDetailsContent').innerHTML = reportHtml;
                
                // Add actions for admin
                let actionsHtml = '';
                
                if (isSuperAdmin && report.status === 'pending') {
                    actionsHtml += `
                        <button class="btn btn-success" id="approveReportBtn">Approve Report</button>
                        <button class="btn btn-danger" id="rejectReportBtn">Reject Report</button>
                    `;
                }
                
                document.getElementById('reportActions').innerHTML = actionsHtml;
                
                // Add event listeners to action buttons
                if (document.getElementById('approveReportBtn')) {
                    document.getElementById('approveReportBtn').addEventListener('click', () => {
                        updateReportStatus(reportId, 'approved');
                    });
                }
                
                if (document.getElementById('rejectReportBtn')) {
                    document.getElementById('rejectReportBtn').addEventListener('click', () => {
                        updateReportStatus(reportId, 'rejected');
                    });
                }
                
                // Show the modal
                document.getElementById('viewReportModal').classList.add('show');
            });
        }

        // Update report status
        function updateReportStatus(reportId, status) {
            getReport(reportId).then(report => {
                if (!report) {
                    alert('Report not found');
                    return;
                }
                
                report.status = status;
                report.updatedAt = new Date().toISOString();
                
                updateReport(report).then(() => {
                    // Broadcast update to peers
                    broadcastData({
                        type: 'report_update',
                        report
                    });
                    
                    // Notify reporter
                    createNotification(
                        report.reporterId,
                        'Report status updated',
                        `Your report status has been updated to ${status}`
                    );
                    
                    // Add activity log
                    addActivity(
                        currentUser.id,
                        `Updated report ${reportId} to ${status}`,
                        'report'
                    );
                    
                    // If approved, take action on the job
                    if (status === 'approved') {
                        handleReportApproval(report);
                    }
                    
                    // Refresh view
                    viewReport(reportId);
                });
            });
        }

        // Handle report approval
        function handleReportApproval(report) {
            getJob(report.jobId).then(job => {
                if (!job) return;
                
                // Mark job as reported
                job.isReported = true;
                job.reportReason = report.reason;
                
                updateJob(job).then(() => {
                    // Broadcast update to peers
                    broadcastData({
                        type: 'job_update',
                        job
                    });
                    
                    // Notify job poster
                    createNotification(
                        job.posterId,
                        'Your job has been reported',
                        `Your job "${job.title}" has been reported for ${report.reason}`
                    );
                });
            });
        }

        // Load post job form
        function loadPostJobForm() {
            // Load user's companies
            getUserCompanies(currentUser.id).then(companies => {
                const companySelect = document.getElementById('jobCompany');
                companySelect.innerHTML = '<option value="">Select a company</option>';
                
                companies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.id;
                    option.textContent = company.name;
                    companySelect.appendChild(option);
                });
            });
            
            // Load job categories
            getJobCategories().then(categories => {
                const categorySelect = document.getElementById('jobCategory');
                categorySelect.innerHTML = '<option value="">Select a category</option>';
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            });
            
            // Set default deadline to 30 days from now
            const deadline = new Date();
            deadline.setDate(deadline.getDate() + 30);
            document.getElementById('jobDeadline').valueAsDate = deadline;
            
            // Set default location to user's current location
            if (currentLocation) {
                document.getElementById('jobLocation').value = `Lat: ${currentLocation.lat.toFixed(4)}, Lng: ${currentLocation.lng.toFixed(4)}`;
            }
        }

        // Post a new job
        function postJob() {
            const title = document.getElementById('jobTitle').value;
            const companyId = document.getElementById('jobCompany').value;
            const category = document.getElementById('jobCategory').value;
            const positions = document.getElementById('jobPositions').value;
            const deadline = document.getElementById('jobDeadline').value;
            const location = document.getElementById('jobLocation').value;
            const description = document.getElementById('jobDescription').value;
            const allowComments = document.getElementById('allowComments').checked;
            const allowPrivateMessages = document.getElementById('allowPrivateMessages').checked;
            const salaryNotDisclosed = document.getElementById('jobSalaryNotDisclosed').checked;
            const currency = salaryNotDisclosed ? null : document.getElementById('jobCurrency').value;
            const minSalary = salaryNotDisclosed ? null : document.getElementById('jobMinSalary').value;
            const maxSalary = salaryNotDisclosed ? null : document.getElementById('jobMaxSalary').value;
            const imageFile = document.getElementById('jobImage').files[0];
            
            if (!title || !companyId || !category || !positions || !deadline || !location || !description) {
                alert('Please fill all required fields');
                return;
            }
            
            // Get company name
            getCompany(companyId).then(company => {
                if (!company) {
                    alert('Company not found');
                    return;
                }
                
                const job = {
                    title,
                    companyId,
                    companyName: company.name,
                    category,
                    positions: parseInt(positions),
                    deadline,
                    location,
                    description,
                    allowComments,
                    allowPrivateMessages,
                    salaryNotDisclosed,
                    currency,
                    minSalary: minSalary ? parseFloat(minSalary) : null,
                    maxSalary: maxSalary ? parseFloat(maxSalary) : null,
                    posterId: currentUser.id,
                    posterName: currentUser.name,
                    isVerified: company.isVerified || false,
                    isReported: false,
                    timestamp: new Date().toISOString(),
                    image: imageFile ? imageFile.name : null // In real app would store image on IPFS
                };
                
                addJob(job).then(() => {
                    // Broadcast job to peers
                    broadcastData({
                        type: 'job_post',
                        job
                    });
                    
                    // Add activity log
                    addActivity(
                        currentUser.id,
                        `Posted new job: ${title}`,
                        'job'
                    );
                    
                    alert('Job posted successfully!');
                    
                    // Reset form
                    document.getElementById('jobTitle').value = '';
                    document.getElementById('jobDescription').value = '';
                    // ... reset other fields
                    
                    // Refresh jobs list if on that page
                    if (document.getElementById('jobsSection').style.display !== 'none') {
                        loadAllJobs();
                    }
                });
            });
        }

        // Load my jobs
        function loadMyJobs() {
            getJobsByUser(currentUser.id).then(jobs => {
                let jobsHtml = '';
                
                if (jobs.length === 0) {
                    jobsHtml = '<p>You have not posted any jobs yet.</p>';
                } else {
                    jobs.forEach(job => {
                        jobsHtml += `
                            <div class="job-card" data-job-id="${job.id}">
                                <h4 class="job-title">${job.title} ${job.isVerified ? '<span class="blue-tick">✓</span>' : ''}</h4>
                                <p class="job-company">${job.companyName}</p>
                                <p class="job-location">📍 ${job.location}</p>
                                <p class="job-description">${job.description.substring(0, 150)}...</p>
                                <div class="job-meta">
                                    <span>${job.category}</span>
                                    <span>Deadline: ${new Date(job.deadline).toLocaleDateString()}</span>
                                </div>
                                <div class="job-actions">
                                    <button class="btn btn-outline view-job-btn">View Details</button>
                                    <button class="btn btn-primary view-applications-btn">View Applications</button>
                                    <button class="btn btn-danger delete-job-btn">Delete</button>
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('myJobPosts').innerHTML = jobsHtml;
                
                // Add event listeners to job buttons
                document.querySelectorAll('.view-job-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const jobId = e.target.closest('.job-card').getAttribute('data-job-id');
                        viewJob(jobId);
                    });
                });
                
                document.querySelectorAll('.view-applications-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const jobId = e.target.closest('.job-card').getAttribute('data-job-id');
                        viewJobApplications(jobId);
                    });
                });
                
                document.querySelectorAll('.delete-job-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const jobId = e.target.closest('.job-card').getAttribute('data-job-id');
                        if (confirm('Are you sure you want to delete this job?')) {
                            deleteJob(jobId);
                        }
                    });
                });
            });
        }

        // Delete job
        function deleteJob(jobId) {
            removeJob(jobId).then(() => {
                // Broadcast deletion to peers
                broadcastData({
                    type: 'job_delete',
                    jobId
                });
                
                // Add activity log
                addActivity(
                    currentUser.id,
                    `Deleted job: ${jobId}`,
                    'job'
                );
                
                // Refresh jobs list
                if (document.getElementById('jobsSection').style.display !== 'none') {
                    loadAllJobs();
                }
                
                if (document.getElementById('myJobsSection').style.display !== 'none') {
                    loadMyJobs();
                }
            });
        }

        // Load all applications
        function loadAllApplications() {
            getApplicationsByUser(currentUser.id).then(applications => {
                displayApplications(applications, 'applicationList');
            });
        }

        // Load pending applications
        function loadPendingApplications() {
            getApplicationsByUser(currentUser.id, 'pending').then(applications => {
                displayApplications(applications, 'pendingApplicationList');
            });
        }

        // Load accepted applications
        function loadAcceptedApplications() {
            getApplicationsByUser(currentUser.id, 'accepted').then(applications => {
                displayApplications(applications, 'acceptedApplicationList');
            });
        }

        // Load rejected applications
        function loadRejectedApplications() {
            getApplicationsByUser(currentUser.id, 'rejected').then(applications => {
                displayApplications(applications, 'rejectedApplicationList');
            });
        }

        // Display applications
        function displayApplications(applications, containerId) {
            if (applications.length === 0) {
                document.getElementById(containerId).innerHTML = '<p>No applications found.</p>';
                return;
            }
            
            const appsHtml = applications.map(app => {
                return `
                    <div class="job-card" data-application-id="${app.id}">
                        <h4>${app.jobTitle || 'Job Application'}</h4>
                        <p>Company: ${app.companyName}</p>
                        <p>Status: <span class="status-${app.status}">${app.status}</span></p>
                        <p>Applied on: ${new Date(app.timestamp).toLocaleDateString()}</p>
                        <div class="job-actions">
                            <button class="btn btn-outline view-application-btn">View Details</button>
                            ${app.status === 'pending' ? 
                                `<button class="btn btn-danger withdraw-application-btn">Withdraw</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById(containerId).innerHTML = appsHtml;
            
            // Add event listeners to application buttons
            document.querySelectorAll('.view-application-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const appId = e.target.closest('.job-card').getAttribute('data-application-id');
                    viewApplication(appId);
                });
            });
            
            document.querySelectorAll('.withdraw-application-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const appId = e.target.closest('.job-card').getAttribute('data-application-id');
                    if (confirm('Are you sure you want to withdraw this application?')) {
                        updateApplicationStatus(appId, 'withdrawn');
                    }
                });
            });
        }

        // Load message contacts
        function loadMessageContacts() {
            getMessageContacts(currentUser.id).then(contacts => {
                let contactsHtml = '';
                
                if (contacts.length === 0) {
                    contactsHtml = '<p>No contacts yet.</p>';
                } else {
                    contacts.forEach(contact => {
                        contactsHtml += `
                            <div class="contact" data-contact-id="${contact.id}" style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer;">
                                <div style="display: flex; align-items: center;">
                                    <img src="${contact.profilePic || 'default-profile.png'}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
                                    <div>
                                        <p><strong>${contact.name}</strong></p>
                                        <p style="font-size: 0.8rem; color: #666;">${contact.lastMessage ? contact.lastMessage.substring(0, 30) + '...' : 'No messages yet'}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('messageContacts').innerHTML = contactsHtml;
                
                // Add event listeners to contacts
                document.querySelectorAll('.contact').forEach(contact => {
                    contact.addEventListener('click', (e) => {
                        const contactId = contact.getAttribute('data-contact-id');
                        startChat(contactId);
                    });
                });
            });
        }

        // Start chat with contact
        function startChat(contactId) {
            getUser(contactId).then(contact => {
                if (!contact) {
                    alert('Contact not found');
                    return;
                }
                
                // Show contact info
                document.getElementById('selectedContact').style.display = 'block';
                document.getElementById('contactName').textContent = contact.name;
                
                // Show chat input
                document.getElementById('chatInputContainer').style.display = 'block';
                
                // Load messages
                getMessagesBetweenUsers(currentUser.id, contactId).then(messages => {
                    let messagesHtml = '';
                    
                    if (messages.length === 0) {
                        messagesHtml = '<p style="text-align: center; color: #666;">No messages yet. Start the conversation!</p>';
                    } else {
                        messages.forEach(msg => {
                            const isSender = msg.senderId === currentUser.id;
                            messagesHtml += `
                                <div class="message ${isSender ? 'sent' : 'received'}">
                                    <p>${msg.text}</p>
                                    <p class="message-time">${new Date(msg.timestamp).toLocaleString()}</p>
                                </div>
                            `;
                        });
                    }
                    
                    document.getElementById('chatMessages').innerHTML = messagesHtml;
                    
                    // Scroll to bottom
                    document.getElementById('chatMessages').scrollTop = 
                        document.getElementById('chatMessages').scrollHeight;
                });
                
                // Set up send message handler
                document.getElementById('sendMessageBtn').addEventListener('click', () => {
                    const input = document.getElementById('chatMessageInput');
                    const text = input.value.trim();
                    
                    if (text) {
                        sendMessage(contactId, text);
                        input.value = '';
                    }
                });
            });
        }

        // Send message
        function sendMessage(receiverId, text) {
            const message = {
                senderId: currentUser.id,
                receiverId,
                text,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            addMessage(message).then(() => {
                // Broadcast message to peers
                broadcastData({
                    type: 'message',
                    message
                });
                
                // Add to chat UI
                const messageHtml = `
                    <div class="message sent">
                        <p>${text}</p>
                        <p class="message-time">${new Date().toLocaleTimeString()}</p>
                    </div>
                `;
                
                document.getElementById('chatMessages').insertAdjacentHTML('beforeend', messageHtml);
                
                // Scroll to bottom
                document.getElementById('chatMessages').scrollTop = 
                    document.getElementById('chatMessages').scrollHeight;
                
                // Add activity log
                addActivity(
                    currentUser.id,
                    `Sent message to ${receiverId}`,
                    'message'
                );
            });
        }

        // Load online peers
        function loadOnlinePeers() {
            getOnlinePeers().then(peers => {
                displayPeers(peers, 'onlinePeersList');
            });
        }

        // Load nearby peers
        function loadNearbyPeers() {
            if (!currentLocation) {
                document.getElementById('nearbyPeersList').innerHTML = '<p>Location not available to show nearby peers.</p>';
                return;
            }
            
            getNearbyPeers(currentLocation).then(peers => {
                displayPeers(peers, 'nearbyPeersList');
            });
        }

        // Load all peers
        function loadAllPeers() {
            getAllPeers().then(peers => {
                displayPeers(peers, 'allPeersList');
            });
        }

        // Display peers
        function displayPeers(peers, containerId) {
            if (peers.length === 0) {
                document.getElementById(containerId).innerHTML = '<p>No peers found.</p>';
                return;
            }
            
            const peersHtml = peers.map(peer => {
                // Skip current user
                if (peer.userId === currentUser.id) return '';
                
                return `
                    <div class="peer" data-peer-id="${peer.peerId}" style="padding: 10px; border-bottom: 1px solid #eee;">
                        <div style="display: flex; align-items: center;">
                            <span class="online-status"></span>
                            <div>
                                <p><strong>${peer.userName || 'Unknown user'}</strong></p>
                                <p style="font-size: 0.8rem; color: #666;">
                                    ${peer.location ? `Location: ${peer.location.lat.toFixed(2)}, ${peer.location.lng.toFixed(2)}` : 'Location unknown'}
                                </p>
                            </div>
                            <div style="margin-left: auto;">
                                <button class="btn btn-outline message-peer-btn">Message</button>
                                ${peer.profession ? `<button class="btn btn-outline ask-for-work-btn">Ask for Work</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById(containerId).innerHTML = peersHtml;
            
            // Add event listeners to peer buttons
            document.querySelectorAll('.message-peer-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const peerId = e.target.closest('.peer').getAttribute('data-peer-id');
                    // In real app, would start chat with peer
                    alert(`Would start chat with peer ${peerId}`);
                });
            });
            
            document.querySelectorAll('.ask-for-work-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const peerId = e.target.closest('.peer').getAttribute('data-peer-id');
                    // In real app, would ask peer for work opportunities
                    alert(`Would ask peer ${peerId} for work opportunities`);
                });
            });
        }

        // Load admin panel
        function loadAdminPanel() {
            if (!isSuperAdmin) return;
            
            // Load users
            getAllUsers().then(users => {
                let usersHtml = '';
                
                if (users.length === 0) {
                    usersHtml = '<p>No users found.</p>';
                } else {
                    usersHtml = `
                        <table class="responsive-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(user => `
                                    <tr data-user-id="${user.id}">
                                        <td>${user.name}</td>
                                        <td>${user.email}</td>
                                        <td>${user.phone}</td>
                                        <td>
                                            ${user.isBanned ? '<span class="badge badge-danger">Banned</span>' : 
                                              user.isVerified ? '<span class="badge badge-success">Verified</span>' : 
                                              '<span class="badge badge-warning">Normal</span>'}
                                        </td>
                                        <td>
                                            ${user.isBanned ? 
                                                `<button class="btn btn-success unban-user-btn">Unban</button>` : 
                                                `<button class="btn btn-danger ban-user-btn">Ban</button>`}
                                            ${!user.isVerified ? 
                                                `<button class="btn btn-primary verify-user-btn">Verify</button>` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
                
                document.getElementById('adminUsersList').innerHTML = usersHtml;
                
                // Add event listeners to user actions
                document.querySelectorAll('.ban-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.closest('tr').getAttribute('data-user-id');
                        banUser(userId);
                    });
                });
                
                document.querySelectorAll('.unban-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.closest('tr').getAttribute('data-user-id');
                        unbanUser(userId);
                    });
                });
                
                document.querySelectorAll('.verify-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.closest('tr').getAttribute('data-user-id');
                        verifyUser(userId);
                    });
                });
            });
            
            // Load job reports
            getAllReports().then(reports => {
                let reportsHtml = '';
                
                if (reports.length === 0) {
                    reportsHtml = '<p>No reports found.</p>';
                } else {
                    reportsHtml = reports.map(report => `
                        <div class="report" data-report-id="${report.id}" style="margin-bottom: 15px; padding: 10px; border: 1px solid #eee; border-radius: var(--border-radius);">
                            <p><strong>Reported by:</strong> ${report.reporterName}</p>
                            <p><strong>Job:</strong> ${report.jobTitle}</p>
                            <p><strong>Reason:</strong> ${report.reason}</p>
                            <div class="report-reason">
                                <p><strong>Details:</strong></p>
                                <p>${report.details}</p>
                            </div>
                            <p><strong>Status:</strong> ${report.status}</p>
                            <div style="margin-top: 10px;">
                                <button class="btn btn-outline view-report-btn">View Details</button>
                                ${report.status === 'pending' ? 
                                    `<button class="btn btn-success approve-report-btn">Approve</button>
                                     <button class="btn btn-danger reject-report-btn">Reject</button>` : ''}
                            </div>
                        </div>
                    `).join('');
                }
                
                document.getElementById('jobReportsList').innerHTML = reportsHtml;
                
                // Add event listeners to report buttons
                document.querySelectorAll('.view-report-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const reportId = e.target.closest('.report').getAttribute('data-report-id');
                        viewReport(reportId);
                    });
                });
                
                document.querySelectorAll('.approve-report-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const reportId = e.target.closest('.report').getAttribute('data-report-id');
                        updateReportStatus(reportId, 'approved');
                    });
                });
                
                document.querySelectorAll('.reject-report-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const reportId = e.target.closest('.report').getAttribute('data-report-id');
                        updateReportStatus(reportId, 'rejected');
                    });
                });
            });
            
            // Load blue tick requests
            getBlueTickRequests().then(requests => {
                let requestsHtml = '';
                
                if (requests.length === 0) {
                    requestsHtml = '<p>No blue tick requests found.</p>';
                } else {
                    requestsHtml = requests.map(req => `
                        <div class="blue-tick-request" data-request-id="${req.id}">
                            <p><strong>Requested by:</strong> ${req.userName}</p>
                            <p><strong>For:</strong> ${req.companyName}</p>
                            <p><strong>Reason:</strong> ${req.reason}</p>
                            <div style="margin-top: 10px;">
                                <button class="btn btn-success approve-blue-tick-btn">Approve</button>
                                <button class="btn btn-danger reject-blue-tick-btn">Reject</button>
                            </div>
                        </div>
                    `).join('');
                }
                
                document.getElementById('blueTickRequests').innerHTML = requestsHtml;
                
                // Add event listeners to request buttons
                document.querySelectorAll('.approve-blue-tick-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const requestId = e.target.closest('.blue-tick-request').getAttribute('data-request-id');
                        approveBlueTickRequest(requestId);
                    });
                });
                
                document.querySelectorAll('.reject-blue-tick-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const requestId = e.target.closest('.blue-tick-request').getAttribute('data-request-id');
                        rejectBlueTickRequest(requestId);
                    });
                });
            });
            
            // Load admin settings
            getAdminSettings().then(settings => {
                if (settings) {
                    document.getElementById('inactivityTimeout').value = settings.inactivityTimeout || 30;
                    document.getElementById('adminEmail').value = settings.adminEmail || '';
                    document.getElementById('successorEmail').value = settings.successorEmail || '';
                    document.getElementById('successorPhone').value = settings.successorPhone || '';
                }
            });
        }

        // Ban user
        function banUser(userId, durationMonths = 12) {
            if (!isSuperAdmin) return;
            
            getUser(userId).then(user => {
                if (!user) {
                    alert('User not found');
                    return;
                }
                
                user.isBanned = true;
                user.banDuration = durationMonths;
                user.banStartDate = new Date().toISOString();
                
                updateUser(user).then(() => {
                    // Broadcast user update to peers
                    broadcastData({
                        type: 'user_ban',
                        userId: user.id,
                        duration: durationMonths
                    });
                    
                    // Notify user
                    createNotification(
                        user.id,
                        'Account banned',
                        `Your account has been banned for ${durationMonths} months. Contact admin for more information.`
                    );
                    
                    // Add activity log
                    addActivity(
                        currentUser.id,
                        `Banned user: ${user.name}`,
                        'admin'
                    );
                    
                    // Refresh admin panel
                    loadAdminPanel();
                });
            });
        }

        // Unban user
        function unbanUser(userId) {
            if (!isSuperAdmin) return;
            
            getUser(userId).then(user => {
                if (!user) {
                    alert('User not found');
                    return;
                }
                
                user.isBanned = false;
                user.banDuration = null;
                user.banStartDate = null;
                
                updateUser(user).then(() => {
                    // Broadcast user update to peers
                    broadcastData({
                        type: 'user_update',
                        user
                    });
                    
                    // Notify user
                    createNotification(
                        user.id,
                        'Account unbanned',
                        'Your account has been unbanned. You can now access all features.'
                    );
                    
                    // Add activity log
                    addActivity(
                        currentUser.id,
                        `Unbanned user: ${user.name}`,
                        'admin'
                    );
                    
                    // Refresh admin panel
                    loadAdminPanel();
                });
            });
        }

        // Verify user (give blue tick)
        function verifyUser(userId) {
            if (!isSuperAdmin) return;
            
            getUser(userId).then(user => {
                if (!user) {
                    alert('User not found');
                    return;
                }
                
                user.isVerified = true;
                
                updateUser(user).then(() => {
                    // Broadcast user update to peers
                    broadcastData({
                        type: 'user_update',
                        user
                    });
                    
                    // Notify user
                    createNotification(
                        user.id,
                        'Account verified',
                        'Your account has been verified by admin. You now have a blue tick.'
                    );
                    
                    // Add activity log
                    addActivity(
                        currentUser.id,
                        `Verified user: ${user.name}`,
                        'admin'
                    );
                    
                    // Refresh admin panel
                    loadAdminPanel();
                });
            });
        }

        // Approve blue tick request
        function approveBlueTickRequest(requestId) {
            if (!isSuperAdmin) return;
            
            getBlueTickRequest(requestId).then(request => {
                if (!request) {
                    alert('Request not found');
                    return;
                }
                
                getCompany(request.companyId).then(company => {
                    if (!company) {
                        alert('Company not found');
                        return;
                    }
                    
                    company.isVerified = true;
                    
                    updateCompany(company).then(() => {
                        // Broadcast company update to peers
                        broadcastData({
                            type: 'company_update',
                            company
                        });
                        
                        // Notify user
                        createNotification(
                            request.userId,
                            'Blue tick approved',
                            `Your request for a blue tick for ${company.name} has been approved.`
                        );
                        
                        // Delete the request
                        deleteBlueTickRequest(requestId).then(() => {
                            // Add activity log
                            addActivity(
                                currentUser.id,
                                `Approved blue tick for ${company.name}`,
                                'admin'
                            );
                            
                            // Refresh admin panel
                            loadAdminPanel();
                        });
                    });
                });
            });
        }

        // Reject blue tick request
        function rejectBlueTickRequest(requestId) {
            if (!isSuperAdmin) return;
            
            getBlueTickRequest(requestId).then(request => {
                if (!request) {
                    alert('Request not found');
                    return;
                }
                
                // Delete the request
                deleteBlueTickRequest(requestId).then(() => {
                    // Notify user
                    createNotification(
                        request.userId,
                        'Blue tick request rejected',
                        `Your request for a blue tick has been rejected. Contact admin for more information.`
                    );
                    
                    // Add activity log
                    addActivity(
                        currentUser.id,
                        `Rejected blue tick request`,
                        'admin'
                    );
                    
                    // Refresh admin panel
                    loadAdminPanel();
                });
            });
        }

        // Save admin settings
        function saveAdminSettings() {
            if (!isSuperAdmin) return;
            
            const settings = {
                id: 'admin_settings',
                inactivityTimeout: parseInt(document.getElementById('inactivityTimeout').value) || 30,
                adminEmail: document.getElementById('adminEmail').value,
                successorEmail: document.getElementById('successorEmail').value,
                successorPhone: document.getElementById('successorPhone').value,
                updatedAt: new Date().toISOString()
            };
            
            saveSettings(settings).then(() => {
                alert('Settings saved successfully');
                
                // Add activity log
                addActivity(
                    currentUser.id,
                    'Updated admin settings',
                    'admin'
                );
            });
        }

        // Show settings modal
        function showSettingsModal() {
            getSettings(currentUser.id).then(settings => {
                if (settings) {
                    document.getElementById('settingsCurrency').value = settings.currency || 'UGX';
                    document.getElementById('settingsJobAlerts').checked = settings.notifications.jobAlerts !== false;
                    document.getElementById('settingsApplicationUpdates').checked = settings.notifications.applicationUpdates !== false;
                    document.getElementById('settingsMessages').checked = settings.notifications.messages !== false;
                    document.getElementById('settingsShareLocation').checked = settings.shareLocation !== false;
                }
                
                document.getElementById('settingsModal').classList.add('show');
            });
        }

        // Save settings
        function saveSettings() {
            const settings = {
                id: currentUser.id,
                currency: document.getElementById('settingsCurrency').value,
                notifications: {
                    jobAlerts: document.getElementById('settingsJobAlerts').checked,
                    applicationUpdates: document.getElementById('settingsApplicationUpdates').checked,
                    messages: document.getElementById('settingsMessages').checked
                },
                shareLocation: document.getElementById('settingsShareLocation').checked,
                updatedAt: new Date().toISOString()
            };
            
            saveUserSettings(settings).then(() => {
                alert('Settings saved successfully');
                document.getElementById('settingsModal').classList.remove('show');
                
                // Add activity log
                addActivity(
                    currentUser.id,
                    'Updated settings',
                    'settings'
                );
            });
        }

        // Show edit profile modal
        function showEditProfileModal() {
            document.getElementById('editName').value = currentUser.name;
            document.getElementById('editUsername').value = currentUser.username;
            document.getElementById('editEmail').value = currentUser.email;
            document.getElementById('editPhone').value = currentUser.phone;
            document.getElementById('editProfession').value = currentUser.profession;
            document.getElementById('editJobTitle').value = currentUser.jobTitle;
            document.getElementById('editCompany').value = currentUser.company;
            
            document.getElementById('editProfileModal').classList.add('show');
        }

        // Save profile
        function saveProfile() {
            const name = document.getElementById('editName').value;
            const username = document.getElementById('editUsername').value;
            const email = document.getElementById('editEmail').value;
            const phone = document.getElementById('editPhone').value;
            const profession = document.getElementById('editProfession').value;
            const jobTitle = document.getElementById('editJobTitle').value;
            const company = document.getElementById('editCompany').value;
            const profilePicFile = document.getElementById('editProfilePic').files[0];
            
            if (!name || !username || !email || !phone) {
                alert('Please fill all required fields');
                return;
            }
            
            // Check if username is available
            checkUsernameAvailable(username, currentUser.id).then(available => {
                if (!available) {
                    alert('Username is already taken');
                    return;
                }
                
                // Update user
                currentUser.name = name;
                currentUser.username = username;
                currentUser.email = email;
                currentUser.phone = phone;
                currentUser.profession = profession;
                currentUser.jobTitle = jobTitle;
                currentUser.company = company;
                
                if (profilePicFile) {
                    currentUser.profilePic = profilePicFile.name; // In real app would store on IPFS
                }
                
                updateUser(currentUser).then(() => {
                    // Broadcast user update to peers
                    broadcastData({
                        type: 'user_update',
                        user: currentUser
                    });
                    
                    // Update UI
                    document.getElementById('userDisplayName').textContent = currentUser.username || currentUser.name;
                    document.getElementById('welcomeUserName').textContent = currentUser.name;
                    
                    if (profilePicFile) {
                        document.getElementById('userProfilePic').src = URL.createObjectURL(profilePicFile);
                    }
                    
                    alert('Profile updated successfully');
                    document.getElementById('editProfileModal').classList.remove('show');
                    
                    // Add activity log
                    addActivity(
                        currentUser.id,
                        'Updated profile',
                        'profile'
                    );
                });
            });
        }

        // Show add company modal
        function showAddCompanyModal() {
            document.getElementById('addCompanyModal').classList.add('show');
        }

        // Save company
        function saveCompany() {
            const name = document.getElementById('companyName').value;
            const description = document.getElementById('companyDescription').value;
            const website = document.getElementById('companyWebsite').value;
            const logoFile = document.getElementById('companyLogo').files[0];
            const requestBlueTick = document.getElementById('requestBlueTick').checked;
            
            if (!name || !description) {
                alert('Please fill all required fields');
                return;
            }
            
            // Check if company name is available
            checkCompanyNameAvailable(name).then(available => {
                if (!available) {
                    alert('Company name is already taken');
                    return;
                }
                
                const company = {
                    name,
                    description,
                    website,
                    ownerId: currentUser.id,
                    ownerName: currentUser.name,
                    isVerified: false,
                    logo: logoFile ? logoFile.name : null, // In real app would store on IPFS
                    timestamp: new Date().toISOString()
                };
                
                addCompany(company).then(() => {
                    // Broadcast company to peers
                    broadcastData({
                        type: 'company',
                        company
                    });
                    
                    // If requested blue tick, create request
                    if (requestBlueTick) {
                        const request = {
                            companyId: company.id,
                            companyName: company.name,
                            userId: currentUser.id,
                            userName: currentUser.name,
                            reason: 'Requested by company owner',
                            status: 'pending',
                            timestamp: new Date().toISOString()
                        };
                        
                        addBlueTickRequest(request).then(() => {
                            // Broadcast request to peers
                            broadcastData({
                                type: 'blue_tick_request',
                                request
                            });
                            
                            // Notify admin
                            getSuperAdmin().then(admin => {
                                if (admin) {
                                    createNotification(
                                        admin.id,
                                        'New blue tick request',
                                        `${currentUser.name} has requested a blue tick for ${company.name}`
                                    );
                                }
                            });
                        });
                    }
                    
                    alert('Company saved successfully');
                    document.getElementById('addCompanyModal').classList.remove('show');
                    
                    // Refresh company select in post job form
                    loadPostJobForm();
                    
                    // Add activity log
                    addActivity(
                        currentUser.id,
                        `Added company: ${name}`,
                        'company'
                    );
                });
            });
        }

        // Send broadcast message
        function sendBroadcastMessage() {
            if (!isSuperAdmin) return;
            
            const messageText = document.getElementById('broadcastMessageInput').value.trim();
            
            if (!messageText) {
                alert('Please enter a message');
                return;
            }
            
            const message = {
                id: Date.now().toString(),
                text: messageText,
                senderId: currentUser.id,
                senderName: currentUser.name,
                timestamp: new Date().toISOString(),
                isBroadcast: true
            };
            
            // Broadcast message to all peers
            broadcastData({
                type: 'broadcast',
                message
            });
            
            // Store message in database
            addMessage(message).then(() => {
                document.getElementById('broadcastMessageInput').value = '';
                alert('Broadcast message sent to all users');
                
                // Add activity log
                addActivity(
                    currentUser.id,
                    'Sent broadcast message',
                    'admin'
                );
            });
        }

        // Handle broadcast message
        function handleBroadcastMessage(message) {
            // Show broadcast message at top of screen
            const broadcastEl = document.getElementById('broadcastMessage');
            broadcastEl.textContent = `📢 Broadcast from ${message.senderName}: ${message.text}`;
            broadcastEl.style.display = 'block';
            
            // Hide after 10 seconds
            setTimeout(() => {
                broadcastEl.style.display = 'none';
            }, 10000);
            
            // Add to notifications
            createNotification(
                currentUser.id,
                'Broadcast message',
                message.text
            );
        }

        // Broadcast data to all peers
        function broadcastData(data) {
            Object.values(peerConnections).forEach(conn => {
                try {
                    conn.send(data);
                } catch (err) {
                    console.error('Error sending data to peer:', conn.peer, err);
                }
            });
        }

        // Login user
        function loginUser() {
            const usernameOrPhone = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!usernameOrPhone || !password) {
                alert('Please fill all fields');
                return;
            }
            
            // Hash password
            hashPassword(password).then(hashedPassword => {
                // Find user by username or phone
                findUser(usernameOrPhone).then(user => {
                    if (!user) {
                        alert('User not found');
                        return;
                    }
                    
                    // Verify password
                    if (user.password !== hashedPassword) {
                        alert('Invalid password');
                        return;
                    }
                    
                    // Check if user is banned
                    if (user.isBanned) {
                        const banDate = new Date(user.banStartDate);
                        const unbanDate = new Date(banDate.setMonth(banDate.getMonth() + user.banDuration));
                        
                        if (new Date() < unbanDate) {
                            alert(`Your account is banned until ${unbanDate.toLocaleDateString()}. Contact admin for more information.`);
                            return;
                        } else {
                            // Unban user if ban period has passed
                            user.isBanned = false;
                            user.banDuration = null;
                            user.banStartDate = null;
                            
                            updateUser(user).then(() => {
                                broadcastData({
                                    type: 'user_update',
                                    user
                                });
                            });
                        }
                    }
                    
                    // Set current user
                    currentUser = user;
                    isSuperAdmin = user.isSuperAdmin || false;
                    
                    // Hide auth modal and show app
                    hideAuthModal();
                    showApp();
                    
                    // Add activity log
                    addActivity(
                        user.id,
                        'Logged in',
                        'auth'
                    );
                });
            });
        }

        // Signup user
        function signupUser() {
            const name = document.getElementById('signupName').value.trim();
            const username = document.getElementById('signupUsername').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const phone = document.getElementById('signupPhone').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const profession = document.getElementById('signupProfession').value.trim();
            const jobTitle = document.getElementById('signupJobTitle').value.trim();
            const profilePicFile = document.getElementById('signupProfilePic').files[0];
            
            if (!name || !username || !email || !phone || !password || !confirmPassword) {
                alert('Please fill all required fields');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            // Check if username is available
            checkUsernameAvailable(username).then(available => {
                if (!available) {
                    alert('Username is already taken');
                    return;
                }
                
                // Check if email is available
                checkEmailAvailable(email).then(available => {
                    if (!available) {
                        alert('Email is already registered');
                        return;
                    }
                    
                    // Check if phone is available
                    checkPhoneAvailable(phone).then(available => {
                        if (!available) {
                            alert('Phone number is already registered');
                            return;
                        }
                        
                        // Hash password
                        hashPassword(password).then(hashedPassword => {
                            // Create user object
                            const user = {
                                name,
                                username,
                                email,
                                phone,
                                password: hashedPassword,
                                profession,
                                jobTitle,
                                profilePic: profilePicFile ? profilePicFile.name : null, // In real app would store on IPFS
                                isSuperAdmin: false, // First user becomes super admin
                                isVerified: false,
                                isBanned: false,
                                location: currentLocation,
                                createdAt: new Date().toISOString()
                            };
                            
                            // Check if this is the first user (super admin)
                            countUsers().then(count => {
                                if (count === 0) {
                                    user.isSuperAdmin = true;
                                    user.isVerified = true;
                                }
                                
                                // Add user to database
                                addUser(user).then(() => {
                                    // Broadcast user to peers
                                    broadcastData({
                                        type: 'user',
                                        user
                                    });
                                    
                                    // Set current user
                                    currentUser = user;
                                    isSuperAdmin = user.isSuperAdmin;
                                    
                                    // Hide auth modal and show app
                                    hideAuthModal();
                                    showApp();
                                    
                                    // Add activity log
                                    addActivity(
                                        user.id,
                                        'Account created',
                                        'auth'
                                    );
                                    
                                    // If first user, show admin panel
                                    if (isSuperAdmin) {
                                        document.getElementById('adminMenuItem').style.display = 'block';
                                        showSection('admin');
                                    }
                                });
                            });
                        });
                    });
                });
            });
        }

        // Logout user
        function logoutUser() {
            // Add activity log
            addActivity(
                currentUser.id,
                'Logged out',
                'auth'
            );
            
            // Clear current user
            currentUser = null;
            isSuperAdmin = false;
            
            // Show auth modal and hide app
            showAuthModal();
            document.getElementById('appContainer').style.display = 'none';
        }

        // Hash password using SHA-256
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // Database operations
        function getCurrentUser() {
            return new Promise((resolve) => {
                // In a real app, would get from IndexedDB or session
                // For demo, we'll use localStorage
                const user = JSON.parse(localStorage.getItem('currentUser'));
                resolve(user);
            });
        }

        function addUser(user) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['users'], 'readwrite');
                const store = transaction.objectStore('users');
                
                const request = store.add(user);
                
                request.onsuccess = () => {
                    // For demo, also store in localStorage
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    resolve(user);
                };
                
                request.onerror = (e) => {
                    reject(e.target.error);
                };
            });
        }

        function updateUser(user) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['users'], 'readwrite');
                const store = transaction.objectStore('users');
                
                const request = store.put(user);
                
                request.onsuccess = () => {
                    // Update current user if it's the same user
                    if (currentUser && currentUser.id === user.id) {
                        currentUser = user;
                        localStorage.setItem('currentUser', JSON.stringify(user));
                    }
                    resolve(user);
                };
                
                request.onerror = (e) => {
                    reject(e.target.error);
                };
            });
        }

        function getUser(userId) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['users'], 'readonly');
                const store = transaction.objectStore('users');
                
                const request = store.get(userId);
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    resolve(null);
                };
            });
        }

        function findUser(usernameOrPhone) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['users'], 'readonly');
                const store = transaction.objectStore('users');
                
                // Try by username
                const usernameIndex = store.index('username');
                const usernameRequest = usernameIndex.get(usernameOrPhone);
                
                usernameRequest.onsuccess = () => {
                    if (usernameRequest.result) {
                        resolve(usernameRequest.result);
                    } else {
                        // Try by phone
                        const phoneIndex = store.index('phone');
                        const phoneRequest = phoneIndex.get(usernameOrPhone);
                        
                        phoneRequest.onsuccess = () => {
                            resolve(phoneRequest.result);
                        };
                        
                        phoneRequest.onerror = () => {
                            resolve(null);
                        };
                    }
                };
                
                usernameRequest.onerror = () => {
                    resolve(null);
                };
            });
        }

        function checkUsernameAvailable(username, excludeUserId = null) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['users'], 'readonly');
                const store = transaction.objectStore('users');
                const index = store.index('username');
                
                const request = index.get(username);
                
                request.onsuccess = () => {
                    if (!request.result) {
                        resolve(true);
                    } else if (excludeUserId && request.result.id === excludeUserId) {
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                };
                
                request.onerror = () => {
                    resolve(false);
                };
            });
        }

        function checkEmailAvailable(email, excludeUserId = null) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['users'], 'readonly');
                const store = transaction.objectStore('users');
                const index = store.index('email');
                
                const request = index.get(email);
                
                request.onsuccess = () => {
                    if (!request.result) {
                        resolve(true);
                    } else if (excludeUserId && request.result.id === excludeUserId) {
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                };
                
                request.onerror = () => {
                    resolve(false);
                };
            });
        }

        function checkPhoneAvailable(phone, excludeUserId = null) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['users'], 'readonly');
                const store = transaction.objectStore('users');
                const index = store.index('phone');
                
                const request = index.get(phone);
                
                request.onsuccess = () => {
                    if (!request.result) {
                        resolve(true);
                    } else if (excludeUserId && request.result.id === excludeUserId) {
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                };
                
                request.onerror = () => {
                    resolve(false);
                };
            });
        }

        function countUsers() {
            return new Promise((resolve) => {
                const transaction = db.transaction(['users'], 'readonly');
                const store = transaction.objectStore('users');
                
                const request = store.count();
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    resolve(0);
                };
            });
        }

        function getAllUsers() {
            return new Promise((resolve) => {
                const transaction = db.transaction(['users'], 'readonly');
                const store = transaction.objectStore('users');
                
                const request = store.getAll();
                
                request.onsuccess = () => {
                    resolve(request.result || []);
                };
                
                request.onerror = () => {
                    resolve([]);
                };
            });
        }

        function getSuperAdmin() {
            return new Promise((resolve) => {
                const transaction = db.transaction(['users'], 'readonly');
                const store = transaction.objectStore('users');
                
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const users = request.result || [];
                    const admin = users.find(u => u.isSuperAdmin);
                    resolve(admin || null);
                };
                
                request.onerror = () => {
                    resolve(null);
                };
            });
        }

        function addJob(job) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['jobs'], 'readwrite');
                const store = transaction.objectStore('jobs');
                
                const request = store.add(job);
                
                request.onsuccess = () => {
                    resolve(job);
                };
                
                request.onerror = (e) => {
                    reject(e.target.error);
                };
            });
        }

        function updateJob(job) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['jobs'], 'readwrite');
                const store = transaction.objectStore('jobs');
                
                const request = store.put(job);
                
                request.onsuccess = () => {
                    resolve(job);
                };
                
                request.onerror = (e) => {
                    reject(e.target.error);
                };
            });
        }

        function getJob(jobId) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['jobs'], 'readonly');
                const store = transaction.objectStore('jobs');
                
                const request = store.get(jobId);
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    resolve(null);
                };
            });
        }

        function getAllJobs() {
            return new Promise((resolve) => {
                const transaction = db.transaction(['jobs'], 'readonly');
                const store = transaction.objectStore('jobs');
                
                const request = store.getAll();
                
                request.onsuccess = () => {
                    resolve(request.result || []);
                };
                
                request.onerror = () => {
                    resolve([]);
                };
            });
        }

        function getJobsByUser(userId) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['jobs'], 'readonly');
                const store = transaction.objectStore('jobs');
                const index = store.index('posterId');
                
                const request = index.getAll(userId);
                
                request.onsuccess = () => {
                    resolve(request.result || []);
                };
                
                request.onerror = () => {
                    resolve([]);
                };
            });
        }

        function removeJob(jobId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['jobs'], 'readwrite');
                const store = transaction.objectStore('jobs');
                
                const request = store.delete(jobId);
                
                request.onsuccess = () => {
                    resolve();
                };
                
                request.onerror = (e) => {
                    reject(e.target.error);
                };
            });
        }

        function addApplication(application) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['applications'], 'readwrite');
                const store = transaction.objectStore('applications');
                
                const request = store.add(application);
                
                request.onsuccess = () => {
                    resolve(application);
                };
                
                request.onerror = (e) => {
                    reject(e.target.error);
                };
            });
        }

        function updateApplication(application) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['applications'], 'readwrite');
                const store = transaction.objectStore('applications');
                
                const request = store.put(application);
                
                request.onsuccess = () => {
                    resolve(application);
                };
                
                request.onerror = (e) => {
                    reject(e.target.error);
                };
            });
        }

        function getApplication(applicationId) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['applications'], 'readonly');
                const store = transaction.objectStore('applications');
                
                const request = store.get(applicationId);
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    resolve(null);
                };
            });
        }

        function getApplicationsForJob(jobId) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['applications'], 'readonly');
                const store = transaction.objectStore('applications');
                const index = store.index('jobId');
                
                const request = index.getAll(jobId);
                
                request.onsuccess = () => {
                    const applications = request.result || [];
                    
                    // Get applicant details for each application
                    Promise.all(applications.map(app => {
                        return getUser(app.applicantId).then(user => {
                            return {
                                ...app,
                                applicantName: user?.name,
                                applicantEmail: user?.email,
                                applicantPhone: user?.phone,
                                applicantProfilePic: user?.profilePic
                            };
                        });
                    })).then(applicationsWithDetails => {
                        resolve(applicationsWithDetails);
                    });
                };
                
                request.onerror = () => {
                    resolve([]);
                };
            });
        }

        function getApplicationsByUser(userId, status = null) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['applications'], 'readonly');
                const store = transaction.objectStore('applications');
                const index = store.index('applicantId');
                
                const request = index.getAll(userId);
                
                request.onsuccess = () => {
                    let applications = request.result || [];
                    
                    if (status) {
                        applications = applications.filter(app => app.status === status);
                    }
                    
                    // Get job details for each application
                    Promise.all(applications.map(app => {
                        return getJob(app.jobId).then(job => {
                            return {
                                ...app,
                                jobTitle: job?.title,
                                companyName: job?.companyName,
                                jobLocation: job?.location
                            };
                        });
                    })).then(applicationsWithDetails => {
                        resolve(applicationsWithDetails);
                    });
                };
                
                request.onerror = () => {
                    resolve([]);
                };
            });
        }

        function addMessage(message) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['messages'], 'readwrite');
                const store = transaction.objectStore('messages');
                
                const request = store.add(message);
                
                request.onsuccess = () => {
                    resolve(message);
                };
                
                request.onerror = (e) => {
                    reject(e.target.error);
                };
            });
        }

        function getMessagesBetweenUsers(user1Id, user2Id) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['messages'], 'readonly');
                const store = transaction.objectStore('messages');
                
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const messages = request.result || [];
                    const filtered = messages.filter(msg => 
                        (msg.senderId === user1Id && msg.receiverId === user2Id) ||
                        (msg.senderId === user2Id && msg.receiverId === user1Id)
                    ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    resolve(filtered);
                };
                
                request.onerror = () => {
                    resolve([]);
                };
            });
        }

        function getMessageContacts(userId) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['messages'], 'readonly');
                const store = transaction.objectStore('messages');
                
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const messages = request.result || [];
                    const contactIds = new Set();
                    
                    // Get all unique contacts
                    messages.forEach(msg => {
                        if (msg.senderId === userId) {
                            contactIds.add(msg.receiverId);
                        } else if (msg.receiverId === userId) {
                            contactIds.add(msg.senderId);
                        }
                    });
                    
                    // Get contact details
                    Promise.all(Array.from(contactIds).map(contactId => {
                        return getUser(contactId).then(user => {
                            if (!user) return null;
                            
                            // Get last message with this contact
                            const contactMessages = messages.filter(msg => 
                                (msg.senderId === userId && msg.receiverId === contactId) ||
                                (msg.senderId === contactId && msg.receiverId === userId)
                            ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                            
                            return {
                                id: contactId,
                                name: user.name,
                                profilePic: user.profilePic,
                                lastMessage: contactMessages[0]?.text
                            };
                        });
                    })).then(contacts => {
                        resolve(contacts.filter(c => c !== null));
                    });
                };
                
                request.onerror = () => {
                    resolve([]);
                };
            });
        }

        function addCompany(company) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['companies'], 'readwrite');
                const store = transaction.objectStore('companies');
                
                const request = store.add(company);
                
                request.onsuccess = () => {
                    resolve(company);
                };
                
                request.onerror = (e) => {
                    reject(e.target.error);
                };
            });
        }

        function updateCompany(company) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['companies'], 'readwrite');
                const store = transaction.objectStore('companies');
                
                const request = store.put(company);
                
                request.onsuccess = () => {
                    resolve(company);
                };
                
                request.onerror = (e) => {
                    reject(e.target.error);
                };
            });
        }

        function getCompany(companyId) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['companies'], 'readonly');
                const store = transaction.objectStore('companies');
                
                const request = store.get(companyId);
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    resolve(null);
                };
            });
        }

        function getUserCompanies(userId) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['companies'], 'readonly');
                const store = transaction.objectStore('companies');
                const index = store.index('ownerId');
                
                const request = index.getAll(userId);
                
                request.onsuccess = () => {
                    resolve(request.result || []);
                };
                
                request.onerror = () => {
                    resolve([]);
                };
            });
        }

        function checkCompanyNameAvailable(name, excludeCompanyId = null) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['companies'], 'readonly');
                const store = transaction.objectStore('companies');
                const index = store.index('name');
                
                const request = index.get(name);
                
                request.onsuccess = () => {
                    if (!request.result) {
                        resolve(true);
                    } else if (excludeCompanyId && request.result.id === excludeCompanyId) {
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                };
                
                request.onerror = () => {
                    resolve(false);
                };
            });
        }

        function addReport(report) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['reports'], 'readwrite');
                const store = transaction.objectStore('reports');
                
                const request = store.add(report);
                
                request.onsuccess = () => {
                    // Get reporter and job details
                    Promise.all([
                        getUser(report.reporterId),
                        getJob(report.jobId)
                    ]).then(([reporter, job]) => {
                        const reportWithDetails = {
                            ...report,
                            reporterName: reporter?.name,
                            jobTitle: job?.title
                        };
                        resolve(reportWithDetails);
                    });
                };
                
                request.onerror = (e) => {
                    reject(e.target.error);
                };
            });
        }

        function updateReport(report) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['reports'], 'readwrite');
                const store = transaction.objectStore('reports');
                
                const request = store.put(report);
                
                request.onsuccess = () => {
                    resolve(report);
                };
                
                request.onerror = (e) => {
                    reject(e.target.error);
                };
            });
        }

        function getReport(reportId) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['reports'], 'readonly');
                const store = transaction.objectStore('reports');
                
                const request = store.get(reportId);
                
                request.onsuccess = () => {
                    const report = request.result;
                    if (!report) {
                        resolve(null);
                        return;
                    }
                    
                    // Get reporter and job details
                    Promise.all([
                        getUser(report.reporterId),
                        getJob(report.jobId)
                    ]).then(([reporter, job]) => {
                        const reportWithDetails = {
                            ...report,
                            reporterName: reporter?.name,
                            jobTitle: job?.title
                        };
                        resolve(reportWithDetails);
                    });
                };
                
                request.onerror = () => {
                    resolve(null);
                };
            });
        }

        function getAllReports() {
            return new Promise((resolve) => {
                const transaction = db.transaction(['reports'], 'readonly');
                const store = transaction.objectStore('reports');
                
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const reports = request.result || [];
                    
                    // Get reporter and job details for each report
                    Promise.all(reports.map(report => {
                        return Promise.all([
                            getUser(report.reporterId),
                            getJob(report.jobId)
                        ]).then(([reporter, job]) => {
                            return {
                                ...report,
                                reporterName: reporter?.name,
                                jobTitle: job?.title
                            };
                        });
                    })).then(reportsWithDetails => {
                        resolve(reportsWithDetails);
                    });
                };
                
                request.onerror = () => {
                    resolve([]);
                };
            });
        }

        function addNotification(notification) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['notifications'], 'readwrite');
                const store = transaction.objectStore('notifications');
                
                const request = store.add(notification);
                
                request.onsuccess = () => {
                    resolve(notification);
                };
                
                request.onerror = (e) => {
                    reject(e.target.error);
                };
            });
        }

        function getNotificationsForUser(userId) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['notifications'], 'readonly');
                const store = transaction.objectStore('notifications');
                const index = store.index('userId');
                
                const request = index.getAll(userId);
                
                request.onsuccess = () => {
                    resolve(request.result || []);
                };
                
                request.onerror = () => {
                    resolve([]);
                };
            });
        }

        function createNotification(userId, title, message) {
            const notification = {
                userId,
                title,
                message,
                read: false,
                timestamp: new Date().toISOString()
            };
            
            addNotification(notification).then(() => {
                // Update notification count in UI
                updateNotificationCount(userId);
                
                // Broadcast notification to peer if online
                if (peerConnections[userId]) {
                    peerConnections[userId].send({
                        type: 'notification',
                        notification
                    });
                }
            });
        }

        function updateNotificationCount(userId) {
            if (currentUser && currentUser.id === userId) {
                getNotificationsForUser(userId).then(notifications => {
                    const unreadCount = notifications.filter(n => !n.read).length;
                    document.querySelector('.notification-count').textContent = unreadCount;
                });
            }
        }

        function addActivity(userId, description, type) {
            const activity = {
                userId,
                description,
                type,
                timestamp: new Date().toISOString()
            };
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['activity'], 'readwrite');
                const store = transaction.objectStore('activity');
                
                const request = store.add(activity);
                
                request.onsuccess = () => {
                    resolve(activity);
                };
                
                request.onerror = (e) => {
                    reject(e.target.error);
                };
            });
        }

        function getActivityForUser(userId, limit = 10) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['activity'], 'readonly');
                const store = transaction.objectStore('activity');
                const index = store.index('userId');
                
                const request = index.getAll(userId);
                
                request.onsuccess = () => {
                    const activities = request.result || [];
                    activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    resolve(activities.slice(0, limit));
                };
                
                request.onerror = () => {
                    resolve([]);
                };
            });
        }

        function saveSettings(settings) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['settings'], 'readwrite');
                const store = transaction.objectStore('settings');
                
                const request = store.put(settings);
                
                request.onsuccess = () => {
                    resolve(settings);
                };
                
                request.onerror = (e) => {
                    reject(e.target.error);
                };
            });
        }

        function getSettings(userId) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['settings'], 'readonly');
                const store = transaction.objectStore('settings');
                
                const request = store.get(userId);
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    resolve(null);
                };
            });
        }

        function getAdminSettings() {
            return new Promise((resolve) => {
                const transaction = db.transaction(['settings'], 'readonly');
                const store = transaction.objectStore('settings');
                
                const request = store.get('admin_settings');
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    resolve(null);
                };
            });
        }

        function saveUserSettings(settings) {
            return saveSettings(settings);
        }

        function addPeer(peerData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['peers'], 'readwrite');
                const store = transaction.objectStore('peers');
                
                const request = store.put(peerData);
                
                request.onsuccess = () => {
                    resolve(peerData);
                };
                
                request.onerror = (e) => {
                    reject(e.target.error);
                };
            });
        }

        function getPeer(peerId) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['peers'], 'readonly');
                const store = transaction.objectStore('peers');
                
                const request = store.get(peerId);
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    resolve(null);
                };
            });
        }

        function getAllPeers() {
            return new Promise((resolve) => {
                const transaction = db.transaction(['peers'], 'readonly');
                const store = transaction.objectStore('peers');
                
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const peers = request.result || [];
                    
                    // Get user details for each peer
                    Promise.all(peers.map(peer => {
                        return getUser(peer.userId).then(user => {
                            return {
                                ...peer,
                                userName: user?.name,
                                profession: user?.profession,
                                profilePic: user?.profilePic
                            };
                        });
                    })).then(peersWithDetails => {
                        resolve(peersWithDetails);
                    });
                };
                
                request.onerror = () => {
                    resolve([]);
                };
            });
        }

        function getOnlinePeers() {
            return getAllPeers().then(peers => {
                // In a real app, would check which peers are actually online
                // For demo, we'll assume all peers are online
                return peers;
            });
        }

        function getNearbyPeers(location, maxDistance = 50) {
            return getAllPeers().then(peers => {
                // In a real app, would calculate distance from current location
                // For demo, we'll just return all peers
                return peers;
            });
        }

        function addBlueTickRequest(request) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['blue_tick_requests'], 'readwrite');
                const store = transaction.objectStore('blue_tick_requests');
                
                const request = store.add(request);
                
                request.onsuccess = () => {
                    resolve(request);
                };
                
                request.onerror = (e) => {
                    reject(e.target.error);
                };
            });
        }

        function getBlueTickRequest(requestId) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['blue_tick_requests'], 'readonly');
                const store = transaction.objectStore('blue_tick_requests');
                
                const request = store.get(requestId);
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    resolve(null);
                };
            });
        }

        function getBlueTickRequests() {
            return new Promise((resolve) => {
                const transaction = db.transaction(['blue_tick_requests'], 'readonly');
                const store = transaction.objectStore('blue_tick_requests');
                
                const request = store.getAll();
                
                request.onsuccess = () => {
                    resolve(request.result || []);
                };
                
                request.onerror = () => {
                    resolve([]);
                };
            });
        }

        function deleteBlueTickRequest(requestId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['blue_tick_requests'], 'readwrite');
                const store = transaction.objectStore('blue_tick_requests');
                
                const request = store.delete(requestId);
                
                request.onsuccess = () => {
                    resolve();
                };
                
                request.onerror = (e) => {
                    reject(e.target.error);
                };
            });
        }

        // Handle new job from peer
        function handleNewJob(job) {
            addJob(job).then(() => {
                // Refresh jobs list if on that page
                if (document.getElementById('jobsSection').style.display !== 'none') {
                    loadAllJobs();
                }
                
                // Show notification
                if (currentUser && job.posterId !== currentUser.id) {
                    createNotification(
                        currentUser.id,
                        'New job posted',
                        `A new job "${job.title}" has been posted by ${job.posterName}`
                    );
                }
            });
        }

        // Handle job update from peer
        function handleJobUpdate(job) {
            updateJob(job).then(() => {
                // Refresh jobs list if on that page
                if (document.getElementById('jobsSection').style.display !== 'none') {
                    loadAllJobs();
                }
                
                // Refresh my jobs if on that page
                if (document.getElementById('myJobsSection').style.display !== 'none') {
                    loadMyJobs();
                }
            });
        }

        // Handle job deletion from peer
        function handleJobDelete(jobId) {
            removeJob(jobId).then(() => {
                // Refresh jobs list if on that page
                if (document.getElementById('jobsSection').style.display !== 'none') {
                    loadAllJobs();
                }
                
                // Refresh my jobs if on that page
                if (document.getElementById('myJobsSection').style.display !== 'none') {
                    loadMyJobs();
                }
            });
        }

        // Handle new application from peer
        function handleNewApplication(application) {
            addApplication(application).then(() => {
                // Refresh applications if on that page
                if (document.getElementById('myApplicationsSection').style.display !== 'none') {
                    loadAllApplications();
                }
                
                // Notify job poster if it's their job
                if (currentUser) {
                    getJob(application.jobId).then(job => {
                        if (job && job.posterId === currentUser.id) {
                            createNotification(
                                currentUser.id,
                                'New application received',
                                `A new application has been received for your job "${job.title}"`
                            );
                            
                            // Refresh job applications if viewing them
                            if (document.getElementById('viewJobModal').classList.contains('show')) {
                                const jobId = document.getElementById('viewJobModal').querySelector('.job-card')?.getAttribute('data-job-id');
                                if (jobId === application.jobId) {
                                    viewJobApplications(jobId);
                                }
                            }
                        }
                    });
                }
            });
        }

        // Handle application update from peer
        function handleApplicationUpdate(application) {
            updateApplication(application).then(() => {
                // Refresh applications if on that page
                if (document.getElementById('myApplicationsSection').style.display !== 'none') {
                    loadAllApplications();
                }
                
                // Notify applicant if status changed
                if (currentUser && application.applicantId === currentUser.id) {
                    createNotification(
                        currentUser.id,
                        'Application status updated',
                        `Your application status has been updated to ${application.status}`
                    );
                }
            });
        }

        // Handle new message from peer
        function handleNewMessage(message) {
            addMessage(message).then(() => {
                // If chatting with this peer, show the message
                if (document.getElementById('messagesSection').style.display !== 'none' && 
                    (message.senderId === currentUser.id || message.receiverId === currentUser.id)) {
                    const contactId = message.senderId === currentUser.id ? message.receiverId : message.senderId;
                    const selectedContact = document.querySelector('.contact[data-contact-id="${contactId}"]');
                    
                    if (selectedContact) {
                        const messageHtml = `
                            <div class="message ${message.senderId === currentUser.id ? 'sent' : 'received'}">
                                <p>${message.text}</p>
                                <p class="message-time">${new Date(message.timestamp).toLocaleTimeString()}</p>
                            </div>
                        `;
                        
                        document.getElementById('chatMessages').insertAdjacentHTML('beforeend', messageHtml);
                        
                        // Scroll to bottom
                        document.getElementById('chatMessages').scrollTop = 
                            document.getElementById('chatMessages').scrollHeight;
                    }
                }
                
                // Update notification count
                if (currentUser && message.receiverId === currentUser.id) {
                    updateNotificationCount(currentUser.id);
                }
            });
        }

        // Handle broadcast message from peer
        function handleBroadcastMessage(message) {
            // Show broadcast message
            const broadcastEl = document.getElementById('broadcastMessage');
            broadcastEl.textContent = `📢 Broadcast from ${message.senderName}: ${message.text}`;
            broadcastEl.style.display = 'block';
            
            // Hide after 10 seconds
            setTimeout(() => {
                broadcastEl.style.display = 'none';
            }, 10000);
            
            // Add to notifications
            if (currentUser) {
                createNotification(
                    currentUser.id,
                    'Broadcast message',
                    message.text
                );
            }
        }

        // Handle new report from peer
        function handleNewReport(report) {
            addReport(report).then(() => {
                // If admin and on reports page, refresh
                if (isSuperAdmin && document.getElementById('adminSection').style.display !== 'none') {
                    loadAdminPanel();
                }
            });
        }

        // Handle user update from peer
        function handleUserUpdate(user) {
            updateUser(user).then(() => {
                // If updated user is current user, refresh
                if (currentUser && user.id === currentUser.id) {
                    currentUser = user;
                    document.getElementById('userDisplayName').textContent = user.username || user.name;
                    document.getElementById('welcomeUserName').textContent = user.name;
                }
            });
        }

        // Handle user ban from peer
        function handleUserBan(userId, duration) {
            getUser(userId).then(user => {
                if (!user) return;
                
                user.isBanned = true;
                user.banDuration = duration;
                user.banStartDate = new Date().toISOString();
                
                updateUser(user).then(() => {
                    // If banned user is current user, log them out
                    if (currentUser && user.id === currentUser.id) {
                        const banDate = new Date(user.banStartDate);
                        const unbanDate = new Date(banDate.setMonth(banDate.getMonth() + user.banDuration));
                        
                        alert(`Your account has been banned until ${unbanDate.toLocaleDateString()}. Contact admin for more information.`);
                        logoutUser();
                    }
                });
            });
        }

        // Search jobs
        function searchJobs() {
            const query = document.getElementById('jobSearch').value.toLowerCase();
            
            if (!query) {
                loadAllJobs();
                return;
            }
            
            getAllJobs().then(jobs => {
                const filtered = jobs.filter(job => 
                    job.title.toLowerCase().includes(query) ||
                    job.description.toLowerCase().includes(query) ||
                    job.companyName.toLowerCase().includes(query) ||
                    job.location.toLowerCase().includes(query) ||
                    job.category.toLowerCase().includes(query)
                );
                
                displayJobs(filtered, 'jobListings');
            });
        }

        // Search users (admin)
        function searchUsers() {
            const query = document.getElementById('adminUserSearch').value.toLowerCase();
            
            if (!query) {
                loadAdminPanel();
                return;
            }
            
            getAllUsers().then(users => {
                const filtered = users.filter(user => 
                    user.name.toLowerCase().includes(query) ||
                    user.email.toLowerCase().includes(query) ||
                    user.phone.toLowerCase().includes(query) ||
                    (user.username && user.username.toLowerCase().includes(query))
                );
                
                let usersHtml = '';
                
                if (filtered.length === 0) {
                    usersHtml = '<p>No users found.</p>';
                } else {
                    usersHtml = `
                        <table class="responsive-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filtered.map(user => `
                                    <tr data-user-id="${user.id}">
                                        <td>${user.name}</td>
                                        <td>${user.email}</td>
                                        <td>${user.phone}</td>
                                        <td>
                                            ${user.isBanned ? '<span class="badge badge-danger">Banned</span>' : 
                                              user.isVerified ? '<span class="badge badge-success">Verified</span>' : 
                                              '<span class="badge badge-warning">Normal</span>'}
                                        </td>
                                        <td>
                                            ${user.isBanned ? 
                                                `<button class="btn btn-success unban-user-btn">Unban</button>` : 
                                                `<button class="btn btn-danger ban-user-btn">Ban</button>`}
                                            ${!user.isVerified ? 
                                                `<button class="btn btn-primary verify-user-btn">Verify</button>` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
                
                document.getElementById('adminUsersList').innerHTML = usersHtml;
                
                // Add event listeners to user actions
                document.querySelectorAll('.ban-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.closest('tr').getAttribute('data-user-id');
                        banUser(userId);
                    });
                });
                
                document.querySelectorAll('.unban-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.closest('tr').getAttribute('data-user-id');
                        unbanUser(userId);
                    });
                });
                
                document.querySelectorAll('.verify-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.closest('tr').getAttribute('data-user-id');
                        verifyUser(userId);
                    });
                });
            });
        }

        // Get job categories (hardcoded for demo)
        function getJobCategories() {
            return Promise.resolve([
                { id: 'it', name: 'Information Technology' },
                { id: 'finance', name: 'Finance' },
                { id: 'healthcare', name: 'Healthcare' },
                { id: 'education', name: 'Education' },
                { id: 'construction', name: 'Construction' },
                { id: 'retail', name: 'Retail' },
                { id: 'hospitality', name: 'Hospitality' },
                { id: 'manufacturing', name: 'Manufacturing' },
                { id: 'transportation', name: 'Transportation' },
                { id: 'other', name: 'Other' }
            ]);
        }
    </script>
</body>
</html>
