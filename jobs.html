<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skysoft Job Market</title>
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@1.8.0/webtorrent.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb@7.0.2/build/iife/index-min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --gray-color: #95a5a6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
        }

        .logo span {
            color: var(--light-color);
        }

        nav ul {
            display: flex;
            list-style: none;
        }

        nav ul li {
            margin-left: 20px;
        }

        nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        nav ul li a:hover {
            color: var(--light-color);
        }

        .auth-buttons button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .auth-buttons button:hover {
            background-color: var(--dark-color);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-secondary {
            background-color: var(--gray-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .dashboard {
            display: none;
            margin-top: 30px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .welcome-message {
            font-size: 20px;
            font-weight: 500;
        }

        .user-profile {
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }

        .user-info h3 {
            margin-bottom: 5px;
        }

        .user-info p {
            color: var(--gray-color);
            font-size: 14px;
        }

        .dashboard-content {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
        }

        .sidebar {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 15px;
        }

        .sidebar-menu li a {
            color: var(--dark-color);
            text-decoration: none;
            font-weight: 500;
            display: flex;
            align-items: center;
        }

        .sidebar-menu li a i {
            margin-right: 10px;
            font-size: 18px;
        }

        .sidebar-menu li a:hover {
            color: var(--primary-color);
        }

        .main-content {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .job-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .job-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .job-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-5px);
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .job-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-color);
        }

        .job-company {
            color: var(--primary-color);
            font-weight: 500;
            margin-bottom: 5px;
        }

        .verified-badge {
            color: var(--primary-color);
            margin-left: 5px;
        }

        .job-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .job-meta-item {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: var(--gray-color);
        }

        .job-meta-item i {
            margin-right: 5px;
        }

        .job-description {
            margin-bottom: 15px;
            color: #555;
        }

        .job-actions {
            display: flex;
            justify-content: space-between;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 14px;
        }

        .online-users {
            margin-top: 30px;
        }

        .online-users-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .user-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            width: calc(33.333% - 10px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }

        .user-avatar-sm {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }

        .user-info-sm h4 {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .user-info-sm p {
            font-size: 12px;
            color: var(--gray-color);
        }

        .online-dot {
            width: 10px;
            height: 10px;
            background-color: var(--success-color);
            border-radius: 50%;
            margin-left: auto;
        }

        .chat-container {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            height: 500px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            flex-direction: column;
        }

        .chat-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-weight: 500;
        }

        .close-chat {
            cursor: pointer;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 15px;
        }

        .message-sender {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .message-content {
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 8px;
            display: inline-block;
            max-width: 80%;
        }

        .message-time {
            font-size: 12px;
            color: var(--gray-color);
            margin-top: 5px;
        }

        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }

        .interview-room {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .interview-container {
            background-color: white;
            width: 90%;
            max-width: 1000px;
            height: 80%;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }

        .interview-header {
            background-color: var(--dark-color);
            color: white;
            padding: 15px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .interview-title {
            font-weight: 500;
        }

        .close-interview {
            cursor: pointer;
        }

        .video-container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 15px;
        }

        .video-box {
            background-color: #333;
            border-radius: 4px;
            position: relative;
        }

        .video-box video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
        }

        .interview-controls {
            display: flex;
            justify-content: center;
            padding: 15px;
            border-top: 1px solid #eee;
            gap: 15px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background-color: var(--secondary-color);
        }

        .end-call {
            background-color: var(--danger-color);
        }

        .end-call:hover {
            background-color: #c0392b;
        }

        .admin-panel {
            display: none;
        }

        .admin-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .admin-section-title {
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }

        .admin-table th,
        .admin-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .admin-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .admin-table tr:hover {
            background-color: #f8f9fa;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background-color: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-banned {
            background-color: #f8d7da;
            color: #721c24;
        }

        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .report-modal textarea {
            min-height: 150px;
        }

        .file-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: var(--primary-color);
        }

        .file-upload input {
            display: none;
        }

        .file-upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .file-upload-label i {
            font-size: 40px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .file-name {
            margin-top: 10px;
            font-size: 14px;
            color: var(--gray-color);
        }

        @media (max-width: 768px) {
            .dashboard-content {
                grid-template-columns: 1fr;
            }

            .user-card {
                width: calc(50% - 10px);
            }

            .video-container {
                grid-template-columns: 1fr;
            }

            .chat-container {
                width: 90%;
                right: 5%;
            }
        }

        @media (max-width: 480px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            nav ul {
                margin-top: 15px;
                width: 100%;
                justify-content: space-between;
            }

            nav ul li {
                margin-left: 0;
            }

            .auth-buttons {
                margin-top: 15px;
                width: 100%;
                display: flex;
                justify-content: space-between;
            }

            .job-list {
                grid-template-columns: 1fr;
            }

            .user-card {
                width: 100%;
            }

            .modal-content {
                width: 95%;
                padding: 20px 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo">Skysoft <span>Job Market</span></div>
            <nav>
                <ul>
                    <li><a href="#" id="home-link">Home</a></li>
                    <li><a href="#" id="jobs-link">Jobs</a></li>
                    <li><a href="#" id="network-link">Network</a></li>
                    <li><a href="#" id="messages-link">Messages</a></li>
                </ul>
            </nav>
            <div class="auth-buttons">
                <button id="login-btn">Login</button>
                <button id="signup-btn">Sign Up</button>
                <button id="logout-btn" style="display: none;">Logout</button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Login Modal -->
        <div class="modal" id="login-modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2>Login to Your Account</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-identifier">Username, Email or Phone</label>
                        <input type="text" id="login-identifier" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="remember-me"> Remember me
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary close-login">Cancel</button>
                        <button type="submit" class="btn btn-primary">Login</button>
                    </div>
                    <p style="text-align: center; margin-top: 15px;">
                        <a href="#" id="forgot-password">Forgot Password?</a>
                    </p>
                    <p style="text-align: center; margin-top: 10px;">
                        Don't have an account? <a href="#" id="show-signup">Sign Up</a>
                    </p>
                </form>
            </div>
        </div>

        <!-- Signup Modal -->
        <div class="modal" id="signup-modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2>Create Your Account</h2>
                <form id="signup-form">
                    <div class="form-group">
                        <label for="signup-fullname">Full Name</label>
                        <input type="text" id="signup-fullname" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-username">Username</label>
                        <input type="text" id="signup-username" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-email">Email</label>
                        <input type="email" id="signup-email" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-phone">Phone Number</label>
                        <input type="tel" id="signup-phone" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-password">Password</label>
                        <input type="password" id="signup-password" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-confirm-password">Confirm Password</label>
                        <input type="password" id="signup-confirm-password" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-profession">Profession</label>
                        <input type="text" id="signup-profession" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-job-title">Job Title</label>
                        <input type="text" id="signup-job-title">
                    </div>
                    <div class="form-group">
                        <label for="signup-workplace">Place of Work</label>
                        <input type="text" id="signup-workplace">
                    </div>
                    <div class="form-group">
                        <label for="signup-avatar">Profile Picture</label>
                        <div class="file-upload" id="avatar-upload">
                            <input type="file" id="signup-avatar" accept="image/*">
                            <label for="signup-avatar" class="file-upload-label">
                                <i>üì∑</i>
                                <span>Click to upload profile picture</span>
                                <div class="file-name" id="avatar-file-name">No file selected</div>
                            </label>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary close-signup">Cancel</button>
                        <button type="submit" class="btn btn-primary">Sign Up</button>
                    </div>
                    <p style="text-align: center; margin-top: 15px;">
                        Already have an account? <a href="#" id="show-login">Login</a>
                    </p>
                </form>
            </div>
        </div>

        <!-- Forgot Password Modal -->
        <div class="modal" id="forgot-password-modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2>Reset Password</h2>
                <form id="forgot-password-form">
                    <div class="form-group">
                        <label for="reset-email">Email or Phone Number</label>
                        <input type="text" id="reset-email" required>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary close-forgot">Cancel</button>
                        <button type="submit" class="btn btn-primary">Reset Password</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Job Post Modal -->
        <div class="modal" id="job-post-modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2>Post a Job</h2>
                <form id="job-post-form">
                    <div class="form-group">
                        <label for="job-title">Job Title</label>
                        <input type="text" id="job-title" required>
                    </div>
                    <div class="form-group">
                        <label for="job-company">Company Name</label>
                        <input type="text" id="job-company" required>
                    </div>
                    <div class="form-group">
                        <label for="job-category">Category</label>
                        <select id="job-category" required>
                            <option value="">Select a category</option>
                            <!-- Categories will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="job-positions">Number of Positions</label>
                        <input type="number" id="job-positions" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="job-deadline">Application Deadline</label>
                        <input type="date" id="job-deadline" required>
                    </div>
                    <div class="form-group">
                        <label for="job-location">Location</label>
                        <input type="text" id="job-location" required>
                    </div>
                    <div class="form-group">
                        <label for="job-salary">Salary Range (optional)</label>
                        <input type="text" id="job-salary">
                    </div>
                    <div class="form-group">
                        <label for="job-description">Job Description</label>
                        <textarea id="job-description" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="job-image">Job Image (optional)</label>
                        <div class="file-upload" id="job-image-upload">
                            <input type="file" id="job-image" accept="image/*">
                            <label for="job-image" class="file-upload-label">
                                <i>üñºÔ∏è</i>
                                <span>Click to upload job image</span>
                                <div class="file-name" id="job-image-file-name">No file selected</div>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="allow-comments"> Allow comments on this job post
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="allow-private-messages"> Allow private messages from applicants
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary close-job-post">Cancel</button>
                        <button type="submit" class="btn btn-primary">Post Job</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Apply for Job Modal -->
        <div class="modal" id="apply-job-modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2>Apply for Job</h2>
                <form id="apply-job-form">
                    <input type="hidden" id="apply-job-id">
                    <div class="form-group">
                        <label for="applicant-name">Full Name</label>
                        <input type="text" id="applicant-name" required>
                    </div>
                    <div class="form-group">
                        <label for="applicant-email">Email</label>
                        <input type="email" id="applicant-email" required>
                    </div>
                    <div class="form-group">
                        <label for="applicant-phone">Phone Number</label>
                        <input type="tel" id="applicant-phone" required>
                    </div>
                    <div class="form-group">
                        <label for="applicant-age">Age</label>
                        <input type="number" id="applicant-age" min="18" required>
                    </div>
                    <div class="form-group">
                        <label for="applicant-gender">Gender</label>
                        <select id="applicant-gender" required>
                            <option value="">Select gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                            <option value="prefer-not-to-say">Prefer not to say</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="applicant-location">Current Location</label>
                        <input type="text" id="applicant-location" required>
                    </div>
                    <div class="form-group">
                        <label for="applicant-experience">Years of Experience</label>
                        <input type="number" id="applicant-experience" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="applicant-qualifications">Qualifications</label>
                        <textarea id="applicant-qualifications" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="applicant-portrait">Portrait Photo</label>
                        <div class="file-upload" id="portrait-upload">
                            <input type="file" id="applicant-portrait" accept="image/*" required>
                            <label for="applicant-portrait" class="file-upload-label">
                                <i>üì∑</i>
                                <span>Click to upload portrait photo</span>
                                <div class="file-name" id="portrait-file-name">No file selected</div>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="applicant-cv">Upload CV (PDF)</label>
                        <div class="file-upload" id="cv-upload">
                            <input type="file" id="applicant-cv" accept=".pdf" required>
                            <label for="applicant-cv" class="file-upload-label">
                                <i>üìÑ</i>
                                <span>Click to upload CV</span>
                                <div class="file-name" id="cv-file-name">No file selected</div>
                            </label>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary close-apply">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit Application</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Report Job Modal -->
        <div class="modal" id="report-job-modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2>Report Job Post</h2>
                <form id="report-job-form">
                    <input type="hidden" id="report-job-id">
                    <div class="form-group">
                        <label for="report-reason">Reason for Reporting</label>
                        <select id="report-reason" required>
                            <option value="">Select a reason</option>
                            <option value="fraud">Fraudulent Activity</option>
                            <option value="spam">Spam or Misleading</option>
                            <option value="discrimination">Discrimination</option>
                            <option value="illegal">Illegal Content</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="report-details">Additional Details</label>
                        <textarea id="report-details" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="report-evidence">Upload Evidence (Screenshots, Audio)</label>
                        <div class="file-upload" id="evidence-upload">
                            <input type="file" id="report-evidence" accept="image/*,audio/*" multiple>
                            <label for="report-evidence" class="file-upload-label">
                                <i>üìé</i>
                                <span>Click to upload evidence</span>
                                <div class="file-name" id="evidence-file-name">No files selected</div>
                            </label>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary close-report">Cancel</button>
                        <button type="submit" class="btn btn-danger">Submit Report</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Admin Panel Modal -->
        <div class="modal" id="admin-modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2>Admin Panel</h2>
                <div class="admin-panel" id="admin-panel-content">
                    <div class="admin-section">
                        <h3 class="admin-section-title">System Overview</h3>
                        <div class="admin-stats">
                            <p>Total Users: <span id="total-users">0</span></p>
                            <p>Active Users: <span id="active-users">0</span></p>
                            <p>Banned Users: <span id="banned-users">0</span></p>
                            <p>Total Jobs: <span id="total-jobs">0</span></p>
                            <p>Active Jobs: <span id="active-jobs">0</span></p>
                            <p>Pending Reports: <span id="pending-reports">0</span></p>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3 class="admin-section-title">User Management</h3>
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <!-- Users will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <div class="admin-section">
                        <h3 class="admin-section-title">Job Reports</h3>
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Job Title</th>
                                    <th>Report Reason</th>
                                    <th>Reported By</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reports-table-body">
                                <!-- Reports will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <div class="admin-section">
                        <h3 class="admin-section-title">System Settings</h3>
                        <form id="admin-settings-form">
                            <div class="form-group">
                                <label for="app-title">App Title</label>
                                <input type="text" id="app-title" value="Skysoft Job Market">
                            </div>
                            <div class="form-group">
                                <label for="admin-whatsapp">Admin WhatsApp Number</label>
                                <input type="tel" id="admin-whatsapp">
                            </div>
                            <div class="form-group">
                                <label for="default-currency">Default Currency</label>
                                <select id="default-currency">
                                    <option value="UGX">UGX - Ugandan Shilling</option>
                                    <option value="USD">USD - US Dollar</option>
                                    <option value="EUR">EUR - Euro</option>
                                    <option value="GBP">GBP - British Pound</option>
                                    <option value="KES">KES - Kenyan Shilling</option>
                                    <option value="TZS">TZS - Tanzanian Shilling</option>
                                    <option value="ZAR">ZAR - South African Rand</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="blue-tick-threshold">Blue Tick Threshold (number of posts)</label>
                                <input type="number" id="blue-tick-threshold" value="100" min="1">
                            </div>
                            <div class="form-group">
                                <label for="backup-admin">Backup Admin (Email or Phone)</label>
                                <input type="text" id="backup-admin">
                            </div>
                            <div class="form-group">
                                <label for="broadcast-message">Broadcast Message</label>
                                <textarea id="broadcast-message"></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary close-admin">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Settings</button>
                                <button type="button" class="btn btn-success" id="send-broadcast">Send Broadcast</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Job Details Modal -->
        <div class="modal" id="job-details-modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <div id="job-details-content">
                    <!-- Job details will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Application Details Modal -->
        <div class="modal" id="application-details-modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <div id="application-details-content">
                    <!-- Application details will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Interview Schedule Modal -->
        <div class="modal" id="interview-modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2>Schedule Interview</h2>
                <form id="interview-form">
                    <input type="hidden" id="interview-application-id">
                    <div class="form-group">
                        <label for="interview-date">Interview Date</label>
                        <input type="date" id="interview-date" required>
                    </div>
                    <div class="form-group">
                        <label for="interview-time">Interview Time</label>
                        <input type="time" id="interview-time" required>
                    </div>
                    <div class="form-group">
                        <label for="interview-type">Interview Type</label>
                        <select id="interview-type" required>
                            <option value="">Select interview type</option>
                            <option value="online">Online (Video Call)</option>
                            <option value="in-person">In-Person</option>
                        </select>
                    </div>
                    <div class="form-group" id="interview-location-group">
                        <label for="interview-location">Interview Location</label>
                        <input type="text" id="interview-location">
                    </div>
                    <div class="form-group">
                        <label for="interview-notes">Additional Notes</label>
                        <textarea id="interview-notes"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary close-interview">Cancel</button>
                        <button type="submit" class="btn btn-primary">Schedule Interview</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="dashboard" id="dashboard">
            <div class="dashboard-header">
                <h1 class="welcome-message">Welcome, <span id="user-greeting">User</span></h1>
                <div class="user-profile">
                    <img src="" alt="Profile Picture" class="user-avatar" id="user-avatar">
                    <div class="user-info">
                        <h3 id="user-fullname">Full Name</h3>
                        <p id="user-profession">Profession</p>
                    </div>
                </div>
            </div>

            <div class="dashboard-content">
                <div class="sidebar">
                    <ul class="sidebar-menu">
                        <li><a href="#" id="dashboard-link"><i>üè†</i> Dashboard</a></li>
                        <li><a href="#" id="my-jobs-link"><i>üíº</i> My Jobs</a></li>
                        <li><a href="#" id="my-applications-link"><i>üìù</i> My Applications</a></li>
                        <li><a href="#" id="post-job-link"><i>‚ûï</i> Post a Job</a></li>
                        <li><a href="#" id="network-link-side"><i>üë•</i> Network</a></li>
                        <li><a href="#" id="messages-link-side"><i>üí¨</i> Messages</a></li>
                        <li><a href="#" id="settings-link"><i>‚öôÔ∏è</i> Settings</a></li>
                        <li id="admin-link-li" style="display: none;"><a href="#" id="admin-link"><i>üëë</i> Admin Panel</a></li>
                    </ul>
                </div>

                <div class="main-content">
                    <div id="home-content">
                        <h2 class="section-title">Recent Job Listings</h2>
                        <div class="job-list" id="recent-jobs">
                            <!-- Recent jobs will be populated by JavaScript -->
                        </div>

                        <div class="online-users">
                            <h2 class="section-title">People Online Near You</h2>
                            <div class="online-users-list" id="online-users-list">
                                <!-- Online users will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <div id="jobs-content" style="display: none;">
                        <div class="dashboard-header">
                            <h2 class="section-title">All Job Listings</h2>
                            <div class="search-box">
                                <input type="text" id="job-search" placeholder="Search jobs...">
                                <button class="btn btn-primary" id="search-btn">Search</button>
                            </div>
                        </div>
                        <div class="job-list" id="all-jobs">
                            <!-- All jobs will be populated by JavaScript -->
                        </div>
                    </div>

                    <div id="my-jobs-content" style="display: none;">
                        <h2 class="section-title">My Job Posts</h2>
                        <div class="job-list" id="my-jobs">
                            <!-- User's jobs will be populated by JavaScript -->
                        </div>
                    </div>

                    <div id="my-applications-content" style="display: none;">
                        <h2 class="section-title">My Applications</h2>
                        <div class="job-list" id="my-applications">
                            <!-- User's applications will be populated by JavaScript -->
                        </div>
                    </div>

                    <div id="network-content" style="display: none;">
                        <h2 class="section-title">Network</h2>
                        <div class="online-users-list" id="network-users">
                            <!-- Network users will be populated by JavaScript -->
                        </div>
                    </div>

                    <div id="settings-content" style="display: none;">
                        <h2 class="section-title">Settings</h2>
                        <form id="profile-form">
                            <div class="form-group">
                                <label for="profile-username">Username</label>
                                <input type="text" id="profile-username" required>
                            </div>
                            <div class="form-group">
                                <label for="profile-fullname">Full Name</label>
                                <input type="text" id="profile-fullname" required>
                            </div>
                            <div class="form-group">
                                <label for="profile-email">Email</label>
                                <input type="email" id="profile-email" required>
                            </div>
                            <div class="form-group">
                                <label for="profile-phone">Phone Number</label>
                                <input type="tel" id="profile-phone" required>
                            </div>
                            <div class="form-group">
                                <label for="profile-profession">Profession</label>
                                <input type="text" id="profile-profession" required>
                            </div>
                            <div class="form-group">
                                <label for="profile-job-title">Job Title</label>
                                <input type="text" id="profile-job-title">
                            </div>
                            <div class="form-group">
                                <label for="profile-workplace">Place of Work</label>
                                <input type="text" id="profile-workplace">
                            </div>
                            <div class="form-group">
                                <label for="profile-currency">Preferred Currency</label>
                                <select id="profile-currency">
                                    <option value="UGX">UGX - Ugandan Shilling</option>
                                    <option value="USD">USD - US Dollar</option>
                                    <option value="EUR">EUR - Euro</option>
                                    <option value="GBP">GBP - British Pound</option>
                                    <option value="KES">KES - Kenyan Shilling</option>
                                    <option value="TZS">TZS - Tanzanian Shilling</option>
                                    <option value="ZAR">ZAR - South African Rand</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="profile-avatar">Profile Picture</label>
                                <div class="file-upload" id="profile-avatar-upload">
                                    <input type="file" id="profile-avatar" accept="image/*">
                                    <label for="profile-avatar" class="file-upload-label">
                                        <i>üì∑</i>
                                        <span>Click to upload profile picture</span>
                                        <div class="file-name" id="profile-avatar-file-name">No file selected</div>
                                    </label>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary cancel-profile">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </div>
                        </form>

                        <div class="change-password" style="margin-top: 30px;">
                            <h3 class="section-title">Change Password</h3>
                            <form id="password-form">
                                <div class="form-group">
                                    <label for="current-password">Current Password</label>
                                    <input type="password" id="current-password" required>
                                </div>
                                <div class="form-group">
                                    <label for="new-password">New Password</label>
                                    <input type="password" id="new-password" required>
                                </div>
                                <div class="form-group">
                                    <label for="confirm-password">Confirm New Password</label>
                                    <input type="password" id="confirm-password" required>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary cancel-password">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Change Password</button>
                                </div>
                            </form>
                        </div>

                        <div class="company-registration" style="margin-top: 30px; display: none;" id="company-registration">
                            <h3 class="section-title">Register Your Company</h3>
                            <form id="company-form">
                                <div class="form-group">
                                    <label for="company-name">Company Name</label>
                                    <input type="text" id="company-name" required>
                                </div>
                                <div class="form-group">
                                    <label for="company-description">Company Description</label>
                                    <textarea id="company-description" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="company-logo">Company Logo</label>
                                    <div class="file-upload" id="company-logo-upload">
                                        <input type="file" id="company-logo" accept="image/*">
                                        <label for="company-logo" class="file-upload-label">
                                            <i>üè¢</i>
                                            <span>Click to upload company logo</span>
                                            <div class="file-name" id="company-logo-file-name">No file selected</div>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary cancel-company">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Register Company</button>
                                    <button type="button" class="btn btn-success" id="request-blue-tick" style="display: none;">Request Blue Tick</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Container -->
        <div class="chat-container" id="chat-container">
            <div class="chat-header">
                <div class="chat-title" id="chat-title">Chat</div>
                <div class="close-chat" id="close-chat">√ó</div>
            </div>
            <div class="chat-messages" id="chat-messages">
                <!-- Chat messages will be populated by JavaScript -->
            </div>
            <div class="chat-input">
                <input type="text" id="chat-input" placeholder="Type your message...">
                <button class="btn btn-primary" id="send-message">Send</button>
            </div>
        </div>

        <!-- Interview Room -->
        <div class="interview-room" id="interview-room">
            <div class="interview-container">
                <div class="interview-header">
                    <div class="interview-title">Interview Room</div>
                    <div class="close-interview" id="close-interview">√ó</div>
                </div>
                <div class="video-container">
                    <div class="video-box">
                        <video id="local-video" autoplay muted></video>
                        <div class="video-label" id="local-video-label">You</div>
                    </div>
                    <div class="video-box">
                        <video id="remote-video" autoplay></video>
                        <div class="video-label" id="remote-video-label">Interviewer</div>
                    </div>
                </div>
                <div class="interview-controls">
                    <button class="control-btn" id="mute-audio">üîá</button>
                    <button class="control-btn" id="mute-video">üì∑</button>
                    <button class="control-btn end-call" id="end-call">üìû</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let isAdmin = false;
        let db;
        let peer;
        let torrentClient;
        let activeChat = null;
        let peerConnections = {};
        let dataChannel;
        let localStream;
        let currentInterview = null;

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize IndexedDB
            await initDB();
            
            // Initialize WebTorrent
            initTorrentClient();
            
            // Initialize PeerJS
            initPeerJS();
            
            // Check if user is logged in
            checkAuth();
            
            // Setup event listeners
            setupEventListeners();
            
            // Request location permission
            requestLocation();
            
            // Load job categories
            loadCategories();
            
            // Load currency settings
            loadCurrencySettings();
        });

        // Initialize IndexedDB
        async function initDB() {
            db = await idb.openDB('skysoft-job-market', 1, {
                upgrade(db) {
                    // Create object stores
                    if (!db.objectStoreNames.contains('users')) {
                        db.createObjectStore('users', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('jobs')) {
                        db.createObjectStore('jobs', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('applications')) {
                        db.createObjectStore('applications', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('reports')) {
                        db.createObjectStore('reports', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('messages')) {
                        db.createObjectStore('messages', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('interviews')) {
                        db.createObjectStore('interviews', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('companies')) {
                        db.createObjectStore('companies', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('categories')) {
                        db.createObjectStore('categories', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('activity')) {
                        db.createObjectStore('activity', { keyPath: 'id' });
                    }
                }
            });
            
            // Check if we need to create the first admin
            const tx = db.transaction('users', 'readonly');
            const store = tx.objectStore('users');
            const count = await store.count();
            
            if (count === 0) {
                // Create default categories
                const defaultCategories = [
                    { id: '1', name: 'Information Technology' },
                    { id: '2', name: 'Healthcare' },
                    { id: '3', name: 'Finance' },
                    { id: '4', name: 'Education' },
                    { id: '5', name: 'Engineering' },
                    { id: '6', name: 'Marketing' },
                    { id: '7', name: 'Sales' },
                    { id: '8', name: 'Customer Service' },
                    { id: '9', name: 'Human Resources' },
                    { id: '10', name: 'Other' }
                ];
                
                const tx = db.transaction('categories', 'readwrite');
                const store = tx.objectStore('categories');
                for (const category of defaultCategories) {
                    await store.put(category);
                }
                await tx.done;
                
                // Create default settings
                const defaultSettings = [
                    { id: 'app-title', value: 'Skysoft Job Market' },
                    { id: 'default-currency', value: 'UGX' },
                    { id: 'blue-tick-threshold', value: 100 },
                    { id: 'admin-whatsapp', value: '' }
                ];
                
                const tx2 = db.transaction('settings', 'readwrite');
                const store2 = tx2.objectStore('settings');
                for (const setting of defaultSettings) {
                    await store2.put(setting);
                }
                await tx2.done;
            }
        }

        // Initialize WebTorrent client
        function initTorrentClient() {
            torrentClient = new WebTorrent();
            
            torrentClient.on('error', (err) => {
                console.error('WebTorrent error:', err);
            });
            
            torrentClient.on('warning', (err) => {
                console.warn('WebTorrent warning:', err);
            });
        }

        // Initialize PeerJS
        function initPeerJS() {
            // Generate a random peer ID if no user is logged in
            const peerId = currentUser ? `user-${currentUser.id}` : `guest-${Math.random().toString(36).substr(2, 9)}`;
            
            peer = new Peer(peerId, {
                host: '0.peerjs.com',
                port: 443,
                secure: true,
                debug: 3
            });
            
            peer.on('open', (id) => {
                console.log('PeerJS connected with ID:', id);
                if (currentUser) {
                    updateUserOnlineStatus(true);
                }
            });
            
            peer.on('connection', (conn) => {
                console.log('Peer connected:', conn.peer);
                setupDataConnection(conn);
            });
            
            peer.on('disconnected', () => {
                console.log('Peer disconnected');
                if (currentUser) {
                    updateUserOnlineStatus(false);
                }
                // Try to reconnect
                setTimeout(() => peer.reconnect(), 5000);
            });
            
            peer.on('close', () => {
                console.log('Peer connection closed');
                if (currentUser) {
                    updateUserOnlineStatus(false);
                }
            });
            
            peer.on('error', (err) => {
                console.error('PeerJS error:', err);
            });
            
            // Handle incoming calls for video chat
            peer.on('call', (call) => {
                // Only accept calls if we're expecting an interview
                if (currentInterview && currentInterview.interviewerId === call.peer) {
                    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                        .then((stream) => {
                            localStream = stream;
                            document.getElementById('local-video').srcObject = stream;
                            call.answer(stream);
                            
                            call.on('stream', (remoteStream) => {
                                document.getElementById('remote-video').srcObject = remoteStream;
                                document.getElementById('interview-room').style.display = 'flex';
                                document.getElementById('remote-video-label').textContent = currentInterview.interviewerName;
                            });
                            
                            call.on('close', () => {
                                endInterview();
                            });
                        })
                        .catch((err) => {
                            console.error('Error getting local stream:', err);
                            showAlert('Error accessing camera/microphone. Please check permissions.', 'danger');
                        });
                } else {
                    call.close();
                }
            });
        }

        // Setup data connection for peer-to-peer messaging
        function setupDataConnection(conn) {
            conn.on('open', () => {
                console.log('Data connection opened with:', conn.peer);
                peerConnections[conn.peer] = conn;
                
                // Handle incoming messages
                conn.on('data', (data) => {
                    handleIncomingData(data, conn.peer);
                });
                
                conn.on('close', () => {
                    console.log('Data connection closed with:', conn.peer);
                    delete peerConnections[conn.peer];
                });
                
                conn.on('error', (err) => {
                    console.error('Data connection error:', err);
                    delete peerConnections[conn.peer];
                });
            });
        }

        // Handle incoming data from peers
        function handleIncomingData(data, peerId) {
            console.log('Received data from peer:', peerId, data);
            
            switch (data.type) {
                case 'message':
                    if (activeChat === peerId) {
                        displayMessage(data.message, peerId, false);
                    } else {
                        // Show notification for new message
                        showAlert(`New message from ${data.senderName}`, 'info');
                    }
                    break;
                    
                case 'job':
                    // Add or update job in local DB
                    addOrUpdateJob(data.job);
                    break;
                    
                case 'application':
                    // Add or update application in local DB
                    addOrUpdateApplication(data.application);
                    break;
                    
                case 'user':
                    // Add or update user in local DB
                    addOrUpdateUser(data.user);
                    break;
                    
                case 'sync-request':
                    // Respond to sync request with our data
                    if (currentUser && currentUser.isAdmin) {
                        syncDataWithPeer(peerId);
                    }
                    break;
                    
                default:
                    console.warn('Unknown data type:', data.type);
            }
        }

        // Sync data with a newly connected peer
        async function syncDataWithPeer(peerId) {
            if (!peerConnections[peerId]) return;
            
            // Get all data from local DB
            const users = await getAllUsers();
            const jobs = await getAllJobs();
            const applications = await getAllApplications();
            
            // Send users
            for (const user of users) {
                peerConnections[peerId].send({
                    type: 'user',
                    user: user
                });
            }
            
            // Send jobs
            for (const job of jobs) {
                peerConnections[peerId].send({
                    type: 'job',
                    job: job
                });
            }
            
            // Send applications
            for (const application of applications) {
                peerConnections[peerId].send({
                    type: 'application',
                    application: application
                });
            }
        }

        // Check if user is authenticated
        async function checkAuth() {
            const userId = localStorage.getItem('currentUser');
            if (userId) {
                const user = await getUserById(userId);
                if (user) {
                    currentUser = user;
                    isAdmin = user.isAdmin || false;
                    showDashboard();
                    
                    // Update online status
                    updateUserOnlineStatus(true);
                    
                    // Request sync from admin
                    if (!isAdmin) {
                        requestSyncFromAdmin();
                    }
                    
                    return;
                }
            }
            
            // Show login modal if not authenticated
            showModal('login-modal');
        }

        // Request data sync from admin
        async function requestSyncFromAdmin() {
            // Find admin user
            const admin = await findAdminUser();
            if (!admin || !admin.peerId) return;
            
            // Connect to admin
            if (peerConnections[admin.peerId]) {
                peerConnections[admin.peerId].send({ type: 'sync-request' });
            } else {
                const conn = peer.connect(admin.peerId);
                setupDataConnection(conn);
                
                conn.on('open', () => {
                    conn.send({ type: 'sync-request' });
                });
            }
        }

        // Find admin user in the database
        async function findAdminUser() {
            const tx = db.transaction('users', 'readonly');
            const store = tx.objectStore('users');
            const index = store.index('isAdmin');
            const admin = await index.get(IDBKeyRange.only(true));
            return admin;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Auth buttons
            document.getElementById('login-btn').addEventListener('click', () => showModal('login-modal'));
            document.getElementById('signup-btn').addEventListener('click', () => showModal('signup-modal'));
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('show-signup').addEventListener('click', (e) => {
                e.preventDefault();
                hideModal('login-modal');
                showModal('signup-modal');
            });
            document.getElementById('show-login').addEventListener('click', (e) => {
                e.preventDefault();
                hideModal('signup-modal');
                showModal('login-modal');
            });
            document.getElementById('forgot-password').addEventListener('click', (e) => {
                e.preventDefault();
                hideModal('login-modal');
                showModal('forgot-password-modal');
            });
            
            // Close buttons
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    const modal = btn.closest('.modal');
                    hideModal(modal.id);
                });
            });
            
            document.querySelector('.close-login').addEventListener('click', () => hideModal('login-modal'));
            document.querySelector('.close-signup').addEventListener('click', () => hideModal('signup-modal'));
            document.querySelector('.close-forgot').addEventListener('click', () => hideModal('forgot-password-modal'));
            document.querySelector('.close-job-post').addEventListener('click', () => hideModal('job-post-modal'));
            document.querySelector('.close-apply').addEventListener('click', () => hideModal('apply-job-modal'));
            document.querySelector('.close-report').addEventListener('click', () => hideModal('report-job-modal'));
            document.querySelector('.close-admin').addEventListener('click', () => hideModal('admin-modal'));
            document.querySelector('.close-interview').addEventListener('click', () => hideModal('interview-modal'));
            
            // Forms
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('signup-form').addEventListener('submit', handleSignup);
            document.getElementById('forgot-password-form').addEventListener('submit', handleForgotPassword);
            document.getElementById('job-post-form').addEventListener('submit', handleJobPost);
            document.getElementById('apply-job-form').addEventListener('submit', handleJobApplication);
            document.getElementById('report-job-form').addEventListener('submit', handleJobReport);
            document.getElementById('profile-form').addEventListener('submit', handleProfileUpdate);
            document.getElementById('password-form').addEventListener('submit', handlePasswordChange);
            document.getElementById('company-form').addEventListener('submit', handleCompanyRegistration);
            document.getElementById('admin-settings-form').addEventListener('submit', handleAdminSettings);
            
            // Navigation
            document.getElementById('home-link').addEventListener('click', (e) => {
                e.preventDefault();
                showDashboard();
            });
            document.getElementById('jobs-link').addEventListener('click', (e) => {
                e.preventDefault();
                showJobsPage();
            });
            document.getElementById('network-link').addEventListener('click', (e) => {
                e.preventDefault();
                showNetworkPage();
            });
            document.getElementById('messages-link').addEventListener('click', (e) => {
                e.preventDefault();
                showMessagesPage();
            });
            
            // Sidebar navigation
            document.getElementById('dashboard-link').addEventListener('click', (e) => {
                e.preventDefault();
                showDashboard();
            });
            document.getElementById('my-jobs-link').addEventListener('click', (e) => {
                e.preventDefault();
                showMyJobsPage();
            });
            document.getElementById('my-applications-link').addEventListener('click', (e) => {
                e.preventDefault();
                showMyApplicationsPage();
            });
            document.getElementById('post-job-link').addEventListener('click', (e) => {
                e.preventDefault();
                showJobPostModal();
            });
            document.getElementById('network-link-side').addEventListener('click', (e) => {
                e.preventDefault();
                showNetworkPage();
            });
            document.getElementById('messages-link-side').addEventListener('click', (e) => {
                e.preventDefault();
                showMessagesPage();
            });
            document.getElementById('settings-link').addEventListener('click', (e) => {
                e.preventDefault();
                showSettingsPage();
            });
            document.getElementById('admin-link').addEventListener('click', (e) => {
                e.preventDefault();
                showAdminPanel();
            });
            
            // File uploads
            document.getElementById('signup-avatar').addEventListener('change', handleFileUpload);
            document.getElementById('job-image').addEventListener('change', handleFileUpload);
            document.getElementById('applicant-portrait').addEventListener('change', handleFileUpload);
            document.getElementById('applicant-cv').addEventListener('change', handleFileUpload);
            document.getElementById('report-evidence').addEventListener('change', handleFileUpload);
            document.getElementById('profile-avatar').addEventListener('change', handleFileUpload);
            document.getElementById('company-logo').addEventListener('change', handleFileUpload);
            
            // Chat
            document.getElementById('close-chat').addEventListener('click', closeChat);
            document.getElementById('send-message').addEventListener('click', sendMessage);
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Interview
            document.getElementById('interview-type').addEventListener('change', (e) => {
                document.getElementById('interview-location-group').style.display = 
                    e.target.value === 'in-person' ? 'block' : 'none';
            });
            
            document.getElementById('interview-form').addEventListener('submit', scheduleInterview);
            document.getElementById('close-interview').addEventListener('click', endInterview);
            document.getElementById('mute-audio').addEventListener('click', toggleAudio);
            document.getElementById('mute-video').addEventListener('click', toggleVideo);
            document.getElementById('end-call').addEventListener('click', endInterview);
            
            // Admin
            document.getElementById('send-broadcast').addEventListener('click', sendBroadcastMessage);
            
            // Search
            document.getElementById('search-btn').addEventListener('click', searchJobs);
            document.getElementById('job-search').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchJobs();
                }
            });
            
            // Request blue tick
            document.getElementById('request-blue-tick').addEventListener('click', requestBlueTick);
        }

        // Handle file uploads
        function handleFileUpload(e) {
            const input = e.target;
            const fileName = input.files.length > 0 ? 
                (input.files.length > 1 ? `${input.files.length} files selected` : input.files[0].name) : 
                'No file selected';
            
            // Update the file name display
            const fileNameElement = document.getElementById(`${input.id}-file-name`);
            if (fileNameElement) {
                fileNameElement.textContent = fileName;
            }
        }

        // Show modal
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        // Hide modal
        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Show alert message
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(alert, container.firstChild);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Handle login
        async function handleLogin(e) {
            e.preventDefault();
            
            const identifier = document.getElementById('login-identifier').value;
            const password = document.getElementById('login-password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            
            // Find user by email, phone or username
            const user = await findUserByIdentifier(identifier);
            
            if (!user) {
                showAlert('User not found. Please check your credentials or sign up.', 'danger');
                return;
            }
            
            // Verify password
            const passwordMatch = await verifyPassword(password, user.password);
            if (!passwordMatch) {
                showAlert('Invalid password. Please try again.', 'danger');
                return;
            }
            
            // Check if user is banned
            if (user.isBanned) {
                const banUntil = new Date(user.banUntil);
                const now = new Date();
                
                if (banUntil > now) {
                    showAlert(`Your account is banned until ${banUntil.toLocaleDateString()}. Please contact support.`, 'danger');
                    return;
                } else {
                    // Unban user if ban period has expired
                    user.isBanned = false;
                    user.banUntil = null;
                    await updateUser(user);
                }
            }
            
            // Login successful
            currentUser = user;
            isAdmin = user.isAdmin || false;
            
            if (rememberMe) {
                localStorage.setItem('currentUser', user.id);
            } else {
                sessionStorage.setItem('currentUser', user.id);
            }
            
            // Update online status
            updateUserOnlineStatus(true);
            
            // Update peer ID
            if (peer) {
                user.peerId = peer.id;
                await updateUser(user);
            }
            
            // Show dashboard
            showDashboard();
            
            // Hide login modal
            hideModal('login-modal');
            
            // Request sync from admin if not admin
            if (!isAdmin) {
                requestSyncFromAdmin();
            }
            
            // Check if username is set
            if (!user.username) {
                showAlert('Please set your username in your profile settings.', 'warning');
            }
            
            // Check if user has company registration
            const company = await getUserCompany(user.id);
            if (!company && user.jobPosts && user.jobPosts.length >= 5) {
                document.getElementById('company-registration').style.display = 'block';
            }
            
            showAlert('Login successful!', 'success');
        }

        // Find user by email, phone or username
        async function findUserByIdentifier(identifier) {
            const tx = db.transaction('users', 'readonly');
            const store = tx.objectStore('users');
            
            // Try by email
            let user = await store.get(identifier);
            if (user) return user;
            
            // Try by phone
            const phoneIndex = store.index('phone');
            user = await phoneIndex.get(identifier);
            if (user) return user;
            
            // Try by username
            const usernameIndex = store.index('username');
            user = await usernameIndex.get(identifier);
            return user;
        }

        // Verify password
        async function verifyPassword(password, hash) {
            // In a real app, we would use a proper password hashing library
            // For this demo, we'll use a simple hash
            const hashedPassword = CryptoJS.SHA256(password).toString();
            return hashedPassword === hash;
        }

        // Handle signup
        async function handleSignup(e) {
            e.preventDefault();
            
            const fullname = document.getElementById('signup-fullname').value;
            const username = document.getElementById('signup-username').value;
            const email = document.getElementById('signup-email').value;
            const phone = document.getElementById('signup-phone').value;
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm-password').value;
            const profession = document.getElementById('signup-profession').value;
            const jobTitle = document.getElementById('signup-job-title').value;
            const workplace = document.getElementById('signup-workplace').value;
            const avatarFile = document.getElementById('signup-avatar').files[0];
            
            // Validate inputs
            if (password !== confirmPassword) {
                showAlert('Passwords do not match.', 'danger');
                return;
            }
            
            if (username.length < 3) {
                showAlert('Username must be at least 3 characters.', 'danger');
                return;
            }
            
            // Check if username or email already exists
            const usernameExists = await checkUsernameExists(username);
            if (usernameExists) {
                showAlert('Username already taken. Please choose another.', 'danger');
                return;
            }
            
            const emailExists = await checkEmailExists(email);
            if (emailExists) {
                showAlert('Email already registered. Please use another email or login.', 'danger');
                return;
            }
            
            const phoneExists = await checkPhoneExists(phone);
            if (phoneExists) {
                showAlert('Phone number already registered. Please use another phone or login.', 'danger');
                return;
            }
            
            // Hash password
            const hashedPassword = CryptoJS.SHA256(password).toString();
            
            // Get location
            let location = 'Unknown';
            try {
                const position = await getCurrentPosition();
                location = `${position.coords.latitude}, ${position.coords.longitude}`;
            } catch (err) {
                console.error('Error getting location:', err);
            }
            
            // Process avatar image
            let avatarUrl = '';
            if (avatarFile) {
                avatarUrl = await readFileAsDataURL(avatarFile);
            }
            
            // Create user object
            const user = {
                id: email, // Using email as ID
                username: username,
                fullname: fullname,
                email: email,
                phone: phone,
                password: hashedPassword,
                profession: profession,
                jobTitle: jobTitle,
                workplace: workplace,
                avatar: avatarUrl,
                location: location,
                peerId: peer ? peer.id : '',
                isOnline: true,
                isAdmin: false,
                isBanned: false,
                banUntil: null,
                jobPosts: [],
                applications: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Check if this is the first user (make admin)
            const tx = db.transaction('users', 'readonly');
            const store = tx.objectStore('users');
            const count = await store.count();
            
            if (count === 0) {
                user.isAdmin = true;
                isAdmin = true;
            }
            
            // Save user to database
            await addUser(user);
            
            // Set as current user
            currentUser = user;
            localStorage.setItem('currentUser', user.id);
            
            // Update peer ID
            if (peer) {
                user.peerId = peer.id;
                await updateUser(user);
            }
            
            // Show dashboard
            showDashboard();
            
            // Hide signup modal
            hideModal('signup-modal');
            
            showAlert('Account created successfully!', 'success');
            
            // If this is the first user (admin), initialize the network
            if (user.isAdmin) {
                initializeNetwork();
            }
        }

        // Check if username exists
        async function checkUsernameExists(username) {
            const tx = db.transaction('users', 'readonly');
            const store = tx.objectStore('users');
            const index = store.index('username');
            const user = await index.get(username);
            return !!user;
        }

        // Check if email exists
        async function checkEmailExists(email) {
            const tx = db.transaction('users', 'readonly');
            const store = tx.objectStore('users');
            const user = await store.get(email);
            return !!user;
        }

        // Check if phone exists
        async function checkPhoneExists(phone) {
            const tx = db.transaction('users', 'readonly');
            const store = tx.objectStore('users');
            const index = store.index('phone');
            const user = await index.get(phone);
            return !!user;
        }

        // Read file as data URL
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Handle forgot password
        async function handleForgotPassword(e) {
            e.preventDefault();
            
            const identifier = document.getElementById('reset-email').value;
            
            // Find user by email or phone
            const user = await findUserByIdentifier(identifier);
            
            if (!user) {
                showAlert('No account found with that email or phone number.', 'danger');
                return;
            }
            
            // In a real app, we would send a password reset link to the user's email or phone
            // For this demo, we'll just show a message
            showAlert(`Password reset instructions have been sent to ${user.email}.`, 'success');
            hideModal('forgot-password-modal');
        }

        // Logout user
        async function logout() {
            if (currentUser) {
                // Update online status
                await updateUserOnlineStatus(false);
                
                // Clear current user
                currentUser = null;
                isAdmin = false;
                localStorage.removeItem('currentUser');
                sessionStorage.removeItem('currentUser');
            }
            
            // Hide dashboard
            document.getElementById('dashboard').style.display = 'none';
            
            // Show login modal
            showModal('login-modal');
            
            // Close any active chat
            closeChat();
            
            // End any active interview
            endInterview();
        }

        // Update user online status
        async function updateUserOnlineStatus(isOnline) {
            if (!currentUser) return;
            
            currentUser.isOnline = isOnline;
            currentUser.lastSeen = new Date().toISOString();
            await updateUser(currentUser);
            
            // Broadcast status update to peers
            broadcastUserUpdate(currentUser);
        }

        // Broadcast user update to all connected peers
        function broadcastUserUpdate(user) {
            for (const peerId in peerConnections) {
                peerConnections[peerId].send({
                    type: 'user',
                    user: user
                });
            }
        }

        // Show dashboard
        async function showDashboard() {
            if (!currentUser) return;
            
            // Update UI
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('login-btn').style.display = 'none';
            document.getElementById('signup-btn').style.display = 'none';
            document.getElementById('logout-btn').style.display = 'inline-block';
            
            // Show admin link if user is admin
            document.getElementById('admin-link-li').style.display = isAdmin ? 'block' : 'none';
            
            // Update user greeting
            document.getElementById('user-greeting').textContent = currentUser.username || currentUser.fullname;
            document.getElementById('user-fullname').textContent = currentUser.fullname;
            document.getElementById('user-profession').textContent = currentUser.profession;
            
            if (currentUser.avatar) {
                document.getElementById('user-avatar').src = currentUser.avatar;
            }
            
            // Show home content
            document.getElementById('home-content').style.display = 'block';
            document.getElementById('jobs-content').style.display = 'none';
            document.getElementById('my-jobs-content').style.display = 'none';
            document.getElementById('my-applications-content').style.display = 'none';
            document.getElementById('network-content').style.display = 'none';
            document.getElementById('settings-content').style.display = 'none';
            
            // Load recent jobs
            await loadRecentJobs();
            
            // Load online users
            await loadOnlineUsers();
        }

        // Show jobs page
        async function showJobsPage() {
            if (!currentUser) return;
            
            // Update UI
            document.getElementById('home-content').style.display = 'none';
            document.getElementById('jobs-content').style.display = 'block';
            document.getElementById('my-jobs-content').style.display = 'none';
            document.getElementById('my-applications-content').style.display = 'none';
            document.getElementById('network-content').style.display = 'none';
            document.getElementById('settings-content').style.display = 'none';
            
            // Load all jobs
            await loadAllJobs();
        }

        // Show my jobs page
        async function showMyJobsPage() {
            if (!currentUser) return;
            
            // Update UI
            document.getElementById('home-content').style.display = 'none';
            document.getElementById('jobs-content').style.display = 'none';
            document.getElementById('my-jobs-content').style.display = 'block';
            document.getElementById('my-applications-content').style.display = 'none';
            document.getElementById('network-content').style.display = 'none';
            document.getElementById('settings-content').style.display = 'none';
            
            // Load user's jobs
            await loadUserJobs();
        }

        // Show my applications page
        async function showMyApplicationsPage() {
            if (!currentUser) return;
            
            // Update UI
            document.getElementById('home-content').style.display = 'none';
            document.getElementById('jobs-content').style.display = 'none';
            document.getElementById('my-jobs-content').style.display = 'none';
            document.getElementById('my-applications-content').style.display = 'block';
            document.getElementById('network-content').style.display = 'none';
            document.getElementById('settings-content').style.display = 'none';
            
            // Load user's applications
            await loadUserApplications();
        }

        // Show network page
        async function showNetworkPage() {
            if (!currentUser) return;
            
            // Update UI
            document.getElementById('home-content').style.display = 'none';
            document.getElementById('jobs-content').style.display = 'none';
            document.getElementById('my-jobs-content').style.display = 'none';
            document.getElementById('my-applications-content').style.display = 'none';
            document.getElementById('network-content').style.display = 'block';
            document.getElementById('settings-content').style.display = 'none';
            
            // Load network users
            await loadNetworkUsers();
        }

        // Show messages page
        function showMessagesPage() {
            if (!currentUser) return;
            
            // Update UI
            document.getElementById('home-content').style.display = 'none';
            document.getElementById('jobs-content').style.display = 'none';
            document.getElementById('my-jobs-content').style.display = 'none';
            document.getElementById('my-applications-content').style.display = 'none';
            document.getElementById('network-content').style.display = 'none';
            document.getElementById('settings-content').style.display = 'none';
            
            // For this demo, we'll just show the chat container
            document.getElementById('chat-container').style.display = 'flex';
        }

        // Show settings page
        async function showSettingsPage() {
            if (!currentUser) return;
            
            // Update UI
            document.getElementById('home-content').style.display = 'none';
            document.getElementById('jobs-content').style.display = 'none';
            document.getElementById('my-jobs-content').style.display = 'none';
            document.getElementById('my-applications-content').style.display = 'none';
            document.getElementById('network-content').style.display = 'none';
            document.getElementById('settings-content').style.display = 'block';
            
            // Populate form with user data
            document.getElementById('profile-username').value = currentUser.username || '';
            document.getElementById('profile-fullname').value = currentUser.fullname || '';
            document.getElementById('profile-email').value = currentUser.email || '';
            document.getElementById('profile-phone').value = currentUser.phone || '';
            document.getElementById('profile-profession').value = currentUser.profession || '';
            document.getElementById('profile-job-title').value = currentUser.jobTitle || '';
            document.getElementById('profile-workplace').value = currentUser.workplace || '';
            
            // Set currency
            const currency = await getSetting('default-currency');
            document.getElementById('profile-currency').value = currency || 'UGX';
            
            // Check if user has company registration
            const company = await getUserCompany(currentUser.id);
            if (company) {
                document.getElementById('company-name').value = company.name || '';
                document.getElementById('company-description').value = company.description || '';
                document.getElementById('request-blue-tick').style.display = company.hasBlueTick ? 'none' : 'block';
            }
            
            document.getElementById('company-registration').style.display = company ? 'none' : 'block';
        }

        // Show admin panel
        async function showAdminPanel() {
            if (!currentUser || !isAdmin) return;
            
            showModal('admin-modal');
            
            // Load admin data
            await loadAdminData();
        }

        // Load admin data
        async function loadAdminData() {
            // Get counts
            const usersCount = await getUsersCount();
            const activeUsersCount = await getActiveUsersCount();
            const bannedUsersCount = await getBannedUsersCount();
            const jobsCount = await getJobsCount();
            const activeJobsCount = await getActiveJobsCount();
            const pendingReportsCount = await getPendingReportsCount();
            
            // Update counts
            document.getElementById('total-users').textContent = usersCount;
            document.getElementById('active-users').textContent = activeUsersCount;
            document.getElementById('banned-users').textContent = bannedUsersCount;
            document.getElementById('total-jobs').textContent = jobsCount;
            document.getElementById('active-jobs').textContent = activeJobsCount;
            document.getElementById('pending-reports').textContent = pendingReportsCount;
            
            // Load users
            await loadUsersTable();
            
            // Load reports
            await loadReportsTable();
            
            // Load settings
            await loadAdminSettings();
        }

        // Load users table
        async function loadUsersTable() {
            const users = await getAllUsers();
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            
            for (const user of users) {
                const tr = document.createElement('tr');
                
                const statusClass = user.isBanned ? 'status-banned' : 
                                  user.isOnline ? 'status-active' : 'status-inactive';
                const statusText = user.isBanned ? 'Banned' : 
                                  user.isOnline ? 'Online' : 'Offline';
                
                tr.innerHTML = `
                    <td>${user.username || user.fullname}</td>
                    <td>${user.email}</td>
                    <td>${user.phone}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="btn btn-sm ${user.isBanned ? 'btn-success' : 'btn-danger'}" 
                                data-user-id="${user.id}" 
                                data-action="${user.isBanned ? 'unban' : 'ban'}">
                            ${user.isBanned ? 'Unban' : 'Ban'}
                        </button>
                        ${user.isAdmin ? '' : 
                            `<button class="btn btn-sm btn-primary" 
                                     data-user-id="${user.id}" 
                                     data-action="make-admin">
                                Make Admin
                            </button>`}
                    </td>
                `;
                
                tbody.appendChild(tr);
            }
            
            // Add event listeners to buttons
            document.querySelectorAll('[data-action="ban"], [data-action="unban"]').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const userId = e.target.getAttribute('data-user-id');
                    const action = e.target.getAttribute('data-action');
                    await handleBanUser(userId, action === 'ban');
                });
            });
            
            document.querySelectorAll('[data-action="make-admin"]').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const userId = e.target.getAttribute('data-user-id');
                    await handleMakeAdmin(userId);
                });
            });
        }

        // Load reports table
        async function loadReportsTable() {
            const reports = await getAllReports();
            const tbody = document.getElementById('reports-table-body');
            tbody.innerHTML = '';
            
            for (const report of reports) {
                if (report.status === 'resolved') continue;
                
                const job = await getJobById(report.jobId);
                const reporter = await getUserById(report.reporterId);
                
                tr.innerHTML = `
                    <td>${job ? job.title : 'Job not found'}</td>
                    <td>${report.reason}</td>
                    <td>${reporter ? reporter.username || reporter.fullname : 'Unknown'}</td>
                    <td><span class="status-${report.status === 'pending' ? 'warning' : 'danger'}">${report.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" 
                                data-report-id="${report.id}" 
                                data-action="review">
                            Review
                        </button>
                        <button class="btn btn-sm btn-danger" 
                                data-report-id="${report.id}" 
                                data-action="dismiss">
                            Dismiss
                        </button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            }
            
            // Add event listeners to buttons
            document.querySelectorAll('[data-action="review"], [data-action="dismiss"]').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const reportId = e.target.getAttribute('data-report-id');
                    const action = e.target.getAttribute('data-action');
                    await handleReportAction(reportId, action);
                });
            });
        }

        // Load admin settings
        async function loadAdminSettings() {
            const appTitle = await getSetting('app-title');
            const adminWhatsapp = await getSetting('admin-whatsapp');
            const defaultCurrency = await getSetting('default-currency');
            const blueTickThreshold = await getSetting('blue-tick-threshold');
            const backupAdmin = await getSetting('backup-admin');
            
            document.getElementById('app-title').value = appTitle || 'Skysoft Job Market';
            document.getElementById('admin-whatsapp').value = adminWhatsapp || '';
            document.getElementById('default-currency').value = defaultCurrency || 'UGX';
            document.getElementById('blue-tick-threshold').value = blueTickThreshold || 100;
            document.getElementById('backup-admin').value = backupAdmin || '';
        }

        // Handle ban/unban user
        async function handleBanUser(userId, ban) {
            if (!isAdmin) return;
            
            const user = await getUserById(userId);
            if (!user) return;
            
            if (ban) {
                const banUntil = new Date();
                banUntil.setFullYear(banUntil.getFullYear() + 1); // Ban for 1 year
                user.isBanned = true;
                user.banUntil = banUntil.toISOString();
                
                showAlert(`User ${user.username || user.fullname} has been banned for 1 year.`, 'success');
            } else {
                user.isBanned = false;
                user.banUntil = null;
                showAlert(`User ${user.username || user.fullname} has been unbanned.`, 'success');
            }
            
            await updateUser(user);
            await loadUsersTable();
            
            // Broadcast user update
            broadcastUserUpdate(user);
            
            // If banned user is current user, log them out
            if (currentUser && currentUser.id === userId && ban) {
                logout();
            }
        }

        // Handle make admin
        async function handleMakeAdmin(userId) {
            if (!isAdmin) return;
            
            const user = await getUserById(userId);
            if (!user) return;
            
            user.isAdmin = true;
            await updateUser(user);
            
            showAlert(`User ${user.username || user.fullname} is now an admin.`, 'success');
            await loadUsersTable();
            
            // Broadcast user update
            broadcastUserUpdate(user);
        }

        // Handle report action
        async function handleReportAction(reportId, action) {
            if (!isAdmin) return;
            
            const report = await getReportById(reportId);
            if (!report) return;
            
            const job = await getJobById(report.jobId);
            if (!job) return;
            
            if (action === 'review') {
                // Mark job as under review (hidden from others)
                job.isUnderReview = true;
                await updateJob(job);
                
                // Update report status
                report.status = 'under_review';
                await updateReport(report);
                
                showAlert('Job has been marked for review and hidden from other users.', 'success');
            } else if (action === 'dismiss') {
                // Dismiss the report
                report.status = 'dismissed';
                await updateReport(report);
                
                showAlert('Report has been dismissed.', 'success');
            }
            
            // Reload reports table
            await loadReportsTable();
            
            // Broadcast job update
            broadcastJobUpdate(job);
        }

        // Handle admin settings
        async function handleAdminSettings(e) {
            e.preventDefault();
            
            if (!isAdmin) return;
            
            const appTitle = document.getElementById('app-title').value;
            const adminWhatsapp = document.getElementById('admin-whatsapp').value;
            const defaultCurrency = document.getElementById('default-currency').value;
            const blueTickThreshold = document.getElementById('blue-tick-threshold').value;
            const backupAdmin = document.getElementById('backup-admin').value;
            
            // Save settings
            await setSetting('app-title', appTitle);
            await setSetting('admin-whatsapp', adminWhatsapp);
            await setSetting('default-currency', defaultCurrency);
            await setSetting('blue-tick-threshold', blueTickThreshold);
            await setSetting('backup-admin', backupAdmin);
            
            // Update app title
            document.title = appTitle;
            document.querySelector('.logo').firstChild.textContent = appTitle.split(' ')[0];
            document.querySelector('.logo span').textContent = appTitle.split(' ').slice(1).join(' ');
            
            showAlert('Settings saved successfully!', 'success');
        }

        // Send broadcast message
        async function sendBroadcastMessage() {
            if (!isAdmin) return;
            
            const message = document.getElementById('broadcast-message').value;
            if (!message) {
                showAlert('Please enter a message to broadcast.', 'danger');
                return;
            }
            
            // Get all users
            const users = await getAllUsers();
            
            // Create notification for each user
            for (const user of users) {
                if (user.id === currentUser.id) continue;
                
                const notification = {
                    id: `notification-${Date.now()}-${user.id}`,
                    userId: user.id,
                    type: 'broadcast',
                    message: message,
                    isRead: false,
                    createdAt: new Date().toISOString()
                };
                
                await addNotification(notification);
            }
            
            // Clear message
            document.getElementById('broadcast-message').value = '';
            
            showAlert('Broadcast message sent to all users!', 'success');
        }

        // Show job post modal
        function showJobPostModal() {
            if (!currentUser) return;
            
            // Reset form
            document.getElementById('job-post-form').reset();
            document.getElementById('job-image-file-name').textContent = 'No file selected';
            
            showModal('job-post-modal');
        }

        // Handle job post
        async function handleJobPost(e) {
            e.preventDefault();
            
            if (!currentUser) return;
            
            const title = document.getElementById('job-title').value;
            const company = document.getElementById('job-company').value;
            const category = document.getElementById('job-category').value;
            const positions = document.getElementById('job-positions').value;
            const deadline = document.getElementById('job-deadline').value;
            const location = document.getElementById('job-location').value;
            const salary = document.getElementById('job-salary').value;
            const description = document.getElementById('job-description').value;
            const allowComments = document.getElementById('allow-comments').checked;
            const allowPrivateMessages = document.getElementById('allow-private-messages').checked;
            const imageFile = document.getElementById('job-image').files[0];
            
            // Validate inputs
            if (!title || !company || !category || !positions || !deadline || !location || !description) {
                showAlert('Please fill in all required fields.', 'danger');
                return;
            }
            
            // Process image
            let imageUrl = '';
            if (imageFile) {
                imageUrl = await readFileAsDataURL(imageFile);
            }
            
            // Create job object
            const job = {
                id: `job-${Date.now()}-${currentUser.id}`,
                title: title,
                company: company,
                category: category,
                positions: parseInt(positions),
                deadline: deadline,
                location: location,
                salary: salary,
                description: description,
                image: imageUrl,
                allowComments: allowComments,
                allowPrivateMessages: allowPrivateMessages,
                posterId: currentUser.id,
                posterName: currentUser.fullname,
                posterUsername: currentUser.username,
                isActive: true,
                isUnderReview: false,
                hasBlueTick: false,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Check if poster has a company with blue tick
            const posterCompany = await getUserCompany(currentUser.id);
            if (posterCompany && posterCompany.hasBlueTick) {
                job.hasBlueTick = true;
            }
            
            // Save job to database
            await addJob(job);
            
            // Add job to user's job posts
            currentUser.jobPosts = currentUser.jobPosts || [];
            currentUser.jobPosts.push(job.id);
            await updateUser(currentUser);
            
            // Broadcast job to all peers
            broadcastJobUpdate(job);
            
            // Hide modal
            hideModal('job-post-modal');
            
            showAlert('Job posted successfully!', 'success');
            
            // Reload jobs
            await loadRecentJobs();
            await loadAllJobs();
            await loadUserJobs();
        }

        // Broadcast job update to all connected peers
        function broadcastJobUpdate(job) {
            for (const peerId in peerConnections) {
                peerConnections[peerId].send({
                    type: 'job',
                    job: job
                });
            }
        }

        // Show apply job modal
        async function showApplyJobModal(jobId) {
            if (!currentUser) {
                showModal('login-modal');
                return;
            }
            
            const job = await getJobById(jobId);
            if (!job) return;
            
            // Set job ID
            document.getElementById('apply-job-id').value = jobId;
            
            // Pre-fill form with user data
            document.getElementById('applicant-name').value = currentUser.fullname || '';
            document.getElementById('applicant-email').value = currentUser.email || '';
            document.getElementById('applicant-phone').value = currentUser.phone || '';
            document.getElementById('applicant-location').value = currentUser.location || '';
            document.getElementById('applicant-profession').value = currentUser.profession || '';
            
            // Reset other fields
            document.getElementById('applicant-age').value = '';
            document.getElementById('applicant-gender').selectedIndex = 0;
            document.getElementById('applicant-experience').value = '';
            document.getElementById('applicant-qualifications').value = '';
            document.getElementById('portrait-file-name').textContent = 'No file selected';
            document.getElementById('cv-file-name').textContent = 'No file selected';
            
            showModal('apply-job-modal');
        }

        // Handle job application
        async function handleJobApplication(e) {
            e.preventDefault();
            
            if (!currentUser) return;
            
            const jobId = document.getElementById('apply-job-id').value;
            const name = document.getElementById('applicant-name').value;
            const email = document.getElementById('applicant-email').value;
            const phone = document.getElementById('applicant-phone').value;
            const age = document.getElementById('applicant-age').value;
            const gender = document.getElementById('applicant-gender').value;
            const location = document.getElementById('applicant-location').value;
            const experience = document.getElementById('applicant-experience').value;
            const qualifications = document.getElementById('applicant-qualifications').value;
            const portraitFile = document.getElementById('applicant-portrait').files[0];
            const cvFile = document.getElementById('applicant-cv').files[0];
            
            // Validate inputs
            if (!name || !email || !phone || !age || !gender || !location || !experience || !qualifications || !portraitFile || !cvFile) {
                showAlert('Please fill in all required fields.', 'danger');
                return;
            }
            
            // Process files
            const portraitUrl = await readFileAsDataURL(portraitFile);
            const cvUrl = await readFileAsDataURL(cvFile);
            
            // Create application object
            const application = {
                id: `application-${Date.now()}-${currentUser.id}`,
                jobId: jobId,
                applicantId: currentUser.id,
                applicantName: name,
                applicantEmail: email,
                applicantPhone: phone,
                applicantAge: parseInt(age),
                applicantGender: gender,
                applicantLocation: location,
                applicantExperience: parseInt(experience),
                applicantQualifications: qualifications,
                applicantPortrait: portraitUrl,
                applicantCV: cvUrl,
                status: 'pending',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Save application to database
            await addApplication(application);
            
            // Add application to user's applications
            currentUser.applications = currentUser.applications || [];
            currentUser.applications.push(application.id);
            await updateUser(currentUser);
            
            // Get job and add application to it
            const job = await getJobById(jobId);
            if (job) {
                job.applications = job.applications || [];
                job.applications.push(application.id);
                await updateJob(job);
                
                // Broadcast job update
                broadcastJobUpdate(job);
            }
            
            // Broadcast application to job poster
            const jobPoster = await getUserById(job.posterId);
            if (jobPoster && jobPoster.peerId && peerConnections[jobPoster.peerId]) {
                peerConnections[jobPoster.peerId].send({
                    type: 'application',
                    application: application
                });
            }
            
            // Hide modal
            hideModal('apply-job-modal');
            
            showAlert('Application submitted successfully!', 'success');
            
            // Reload applications
            await loadUserApplications();
        }

        // Show report job modal
        function showReportJobModal(jobId) {
            if (!currentUser) {
                showModal('login-modal');
                return;
            }
            
            // Set job ID
            document.getElementById('report-job-id').value = jobId;
            
            // Reset form
            document.getElementById('report-job-form').reset();
            document.getElementById('evidence-file-name').textContent = 'No files selected';
            
            showModal('report-job-modal');
        }

        // Handle job report
        async function handleJobReport(e) {
            e.preventDefault();
            
            if (!currentUser) return;
            
            const jobId = document.getElementById('report-job-id').value;
            const reason = document.getElementById('report-reason').value;
            const details = document.getElementById('report-details').value;
            const evidenceFiles = document.getElementById('report-evidence').files;
            
            // Validate inputs
            if (!reason || !details) {
                showAlert('Please fill in all required fields.', 'danger');
                return;
            }
            
            // Process evidence files
            let evidenceUrls = [];
            if (evidenceFiles.length > 0) {
                for (let i = 0; i < evidenceFiles.length; i++) {
                    const url = await readFileAsDataURL(evidenceFiles[i]);
                    evidenceUrls.push(url);
                }
            }
            
            // Create report object
            const report = {
                id: `report-${Date.now()}-${currentUser.id}`,
                jobId: jobId,
                reporterId: currentUser.id,
                reason: reason,
                details: details,
                evidence: evidenceUrls,
                status: 'pending',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Save report to database
            await addReport(report);
            
            // Get job and add report to it
            const job = await getJobById(jobId);
            if (job) {
                job.reports = job.reports || [];
                job.reports.push(report.id);
                await updateJob(job);
                
                // Broadcast job update
                broadcastJobUpdate(job);
            }
            
            // Notify admin
            const admin = await findAdminUser();
            if (admin && admin.peerId && peerConnections[admin.peerId]) {
                peerConnections[admin.peerId].send({
                    type: 'report',
                    report: report
                });
            }
            
            // Hide modal
            hideModal('report-job-modal');
            
            showAlert('Report submitted successfully! Admin will review it shortly.', 'success');
        }

        // Handle profile update
        async function handleProfileUpdate(e) {
            e.preventDefault();
            
            if (!currentUser) return;
            
            const username = document.getElementById('profile-username').value;
            const fullname = document.getElementById('profile-fullname').value;
            const email = document.getElementById('profile-email').value;
            const phone = document.getElementById('profile-phone').value;
            const profession = document.getElementById('profile-profession').value;
            const jobTitle = document.getElementById('profile-job-title').value;
            const workplace = document.getElementById('profile-workplace').value;
            const avatarFile = document.getElementById('profile-avatar').files[0];
            const currency = document.getElementById('profile-currency').value;
            
            // Validate inputs
            if (!username || !fullname || !email || !phone || !profession) {
                showAlert('Please fill in all required fields.', 'danger');
                return;
            }
            
            // Check if username is available (if changed)
            if (username !== currentUser.username) {
                const usernameExists = await checkUsernameExists(username);
                if (usernameExists) {
                    showAlert('Username already taken. Please choose another.', 'danger');
                    return;
                }
            }
            
            // Process avatar image
            let avatarUrl = currentUser.avatar;
            if (avatarFile) {
                avatarUrl = await readFileAsDataURL(avatarFile);
            }
            
            // Update user object
            currentUser.username = username;
            currentUser.fullname = fullname;
            currentUser.email = email;
            currentUser.phone = phone;
            currentUser.profession = profession;
            currentUser.jobTitle = jobTitle;
            currentUser.workplace = workplace;
            currentUser.avatar = avatarUrl;
            currentUser.updatedAt = new Date().toISOString();
            
            // Save user to database
            await updateUser(currentUser);
            
            // Save currency preference
            await setSetting('user-currency', currency);
            
            // Update UI
            document.getElementById('user-greeting').textContent = username || fullname;
            document.getElementById('user-fullname').textContent = fullname;
            document.getElementById('user-profession').textContent = profession;
            
            if (avatarUrl) {
                document.getElementById('user-avatar').src = avatarUrl;
            }
            
            // Broadcast user update
            broadcastUserUpdate(currentUser);
            
            showAlert('Profile updated successfully!', 'success');
        }

        // Handle password change
        async function handlePasswordChange(e) {
            e.preventDefault();
            
            if (!currentUser) return;
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            // Validate inputs
            if (!currentPassword || !newPassword || !confirmPassword) {
                showAlert('Please fill in all fields.', 'danger');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showAlert('New passwords do not match.', 'danger');
                return;
            }
            
            // Verify current password
            const passwordMatch = await verifyPassword(currentPassword, currentUser.password);
            if (!passwordMatch) {
                showAlert('Current password is incorrect.', 'danger');
                return;
            }
            
            // Hash new password
            const hashedPassword = CryptoJS.SHA256(newPassword).toString();
            
            // Update password
            currentUser.password = hashedPassword;
            currentUser.updatedAt = new Date().toISOString();
            await updateUser(currentUser);
            
            // Reset form
            document.getElementById('password-form').reset();
            
            showAlert('Password changed successfully!', 'success');
        }

        // Handle company registration
        async function handleCompanyRegistration(e) {
            e.preventDefault();
            
            if (!currentUser) return;
            
            const name = document.getElementById('company-name').value;
            const description = document.getElementById('company-description').value;
            const logoFile = document.getElementById('company-logo').files[0];
            
            // Validate inputs
            if (!name || !description) {
                showAlert('Please fill in all required fields.', 'danger');
                return;
            }
            
            // Process logo
            let logoUrl = '';
            if (logoFile) {
                logoUrl = await readFileAsDataURL(logoFile);
            }
            
            // Create company object
            const company = {
                id: `company-${Date.now()}-${currentUser.id}`,
                ownerId: currentUser.id,
                name: name,
                description: description,
                logo: logoUrl,
                hasBlueTick: false,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Save company to database
            await addCompany(company);
            
            // Hide registration form
            document.getElementById('company-registration').style.display = 'none';
            
            // Show blue tick request button if user has enough job posts
            if (currentUser.jobPosts && currentUser.jobPosts.length >= 5) {
                document.getElementById('request-blue-tick').style.display = 'block';
            }
            
            showAlert('Company registered successfully!', 'success');
        }

        // Request blue tick for company
        async function requestBlueTick() {
            if (!currentUser) return;
            
            const company = await getUserCompany(currentUser.id);
            if (!company) return;
            
            // Create notification for admin
            const notification = {
                id: `blue-tick-request-${Date.now()}-${currentUser.id}`,
                userId: currentUser.id,
                type: 'blue-tick-request',
                message: `${currentUser.username || currentUser.fullname} is requesting a blue tick for their company ${company.name}`,
                isRead: false,
                createdAt: new Date().toISOString()
            };
            
            await addNotification(notification);
            
            // Notify admin
            const admin = await findAdminUser();
            if (admin && admin.peerId && peerConnections[admin.peerId]) {
                peerConnections[admin.peerId].send({
                    type: 'notification',
                    notification: notification
                });
            }
            
            document.getElementById('request-blue-tick').style.display = 'none';
            showAlert('Blue tick request sent to admin for approval.', 'success');
        }

        // Load recent jobs
        async function loadRecentJobs() {
            const jobs = await getAllJobs();
            const now = new Date();
            
            // Filter active jobs (not expired and not under review)
            const activeJobs = jobs.filter(job => {
                const deadline = new Date(job.deadline);
                return deadline > now && !job.isUnderReview;
            });
            
            // Sort by proximity to current location
            if (currentUser && currentUser.location && currentUser.location !== 'Unknown') {
                try {
                    const [lat, lon] = currentUser.location.split(',').map(coord => parseFloat(coord.trim()));
                    
                    activeJobs.sort((a, b) => {
                        const aLoc = a.location;
                        const bLoc = b.location;
                        
                        if (aLoc === bLoc) return 0;
                        if (aLoc === 'Unknown') return 1;
                        if (bLoc === 'Unknown') return -1;
                        
                        try {
                            const [aLat, aLon] = aLoc.split(',').map(coord => parseFloat(coord.trim()));
                            const [bLat, bLon] = bLoc.split(',').map(coord => parseFloat(coord.trim()));
                            
                            const aDist = getDistance(lat, lon, aLat, aLon);
                            const bDist = getDistance(lat, lon, bLat, bLon);
                            
                            return aDist - bDist;
                        } catch (err) {
                            console.error('Error calculating distance:', err);
                            return 0;
                        }
                    });
                } catch (err) {
                    console.error('Error parsing user location:', err);
                }
            }
            
            // Display jobs
            const container = document.getElementById('recent-jobs');
            container.innerHTML = '';
            
            for (const job of activeJobs.slice(0, 6)) { // Show only 6 most recent
                const jobElement = createJobElement(job);
                container.appendChild(jobElement);
            }
            
            // Show "View All" button if there are more jobs
            if (activeJobs.length > 6) {
                const viewAllBtn = document.createElement('button');
                viewAllBtn.className = 'btn btn-primary';
                viewAllBtn.textContent = 'View All Jobs';
                viewAllBtn.style.marginTop = '20px';
                viewAllBtn.addEventListener('click', showJobsPage);
                container.appendChild(viewAllBtn);
            }
        }

        // Load all jobs
        async function loadAllJobs() {
            const jobs = await getAllJobs();
            const now = new Date();
            
            // Filter active jobs (not expired and not under review)
            const activeJobs = jobs.filter(job => {
                const deadline = new Date(job.deadline);
                return deadline > now && !job.isUnderReview;
            });
            
            // Display jobs
            const container = document.getElementById('all-jobs');
            container.innerHTML = '';
            
            if (activeJobs.length === 0) {
                container.innerHTML = '<p>No active job listings found.</p>';
                return;
            }
            
            for (const job of activeJobs) {
                const jobElement = createJobElement(job);
                container.appendChild(jobElement);
            }
        }

        // Load user's jobs
        async function loadUserJobs() {
            if (!currentUser) return;
            
            const jobs = await getAllJobs();
            const userJobs = jobs.filter(job => job.posterId === currentUser.id);
            
            // Display jobs
            const container = document.getElementById('my-jobs');
            container.innerHTML = '';
            
            if (userJobs.length === 0) {
                container.innerHTML = '<p>You have not posted any jobs yet.</p>';
                return;
            }
            
            for (const job of userJobs) {
                const jobElement = createJobElement(job, true);
                container.appendChild(jobElement);
            }
        }

        // Load user's applications
        async function loadUserApplications() {
            if (!currentUser) return;
            
            const applications = await getAllApplications();
            const userApplications = applications.filter(app => app.applicantId === currentUser.id);
            
            // Get jobs for these applications
            const jobs = await getAllJobs();
            const applicationsWithJobs = userApplications.map(app => {
                const job = jobs.find(j => j.id === app.jobId);
                return { ...app, job };
            }).filter(app => app.job); // Filter out applications for deleted jobs
            
            // Display applications
            const container = document.getElementById('my-applications');
            container.innerHTML = '';
            
            if (applicationsWithJobs.length === 0) {
                container.innerHTML = '<p>You have not applied to any jobs yet.</p>';
                return;
            }
            
            for (const app of applicationsWithJobs) {
                const appElement = createApplicationElement(app);
                container.appendChild(appElement);
            }
        }

        // Load online users
        async function loadOnlineUsers() {
            const users = await getAllUsers();
            const onlineUsers = users.filter(user => user.isOnline && user.id !== currentUser.id);
            
            // Sort by proximity to current location
            if (currentUser && currentUser.location && currentUser.location !== 'Unknown') {
                try {
                    const [lat, lon] = currentUser.location.split(',').map(coord => parseFloat(coord.trim()));
                    
                    onlineUsers.sort((a, b) => {
                        const aLoc = a.location;
                        const bLoc = b.location;
                        
                        if (aLoc === bLoc) return 0;
                        if (aLoc === 'Unknown') return 1;
                        if (bLoc === 'Unknown') return -1;
                        
                        try {
                            const [aLat, aLon] = aLoc.split(',').map(coord => parseFloat(coord.trim()));
                            const [bLat, bLon] = bLoc.split(',').map(coord => parseFloat(coord.trim()));
                            
                            const aDist = getDistance(lat, lon, aLat, aLon);
                            const bDist = getDistance(lat, lon, bLat, bLon);
                            
                            return aDist - bDist;
                        } catch (err) {
                            console.error('Error calculating distance:', err);
                            return 0;
                        }
                    });
                } catch (err) {
                    console.error('Error parsing user location:', err);
                }
            }
            
            // Display online users
            const container = document.getElementById('online-users-list');
            container.innerHTML = '';
            
            if (onlineUsers.length === 0) {
                container.innerHTML = '<p>No other users online at the moment.</p>';
                return;
            }
            
            for (const user of onlineUsers.slice(0, 6)) { // Show only 6 nearest
                const userElement = createUserElement(user);
                container.appendChild(userElement);
            }
            
            // Show "View All" button if there are more users
            if (onlineUsers.length > 6) {
                const viewAllBtn = document.createElement('button');
                viewAllBtn.className = 'btn btn-primary';
                viewAllBtn.textContent = 'View All Online Users';
                viewAllBtn.style.marginTop = '20px';
                viewAllBtn.addEventListener('click', showNetworkPage);
                container.appendChild(viewAllBtn);
            }
        }

        // Load network users
        async function loadNetworkUsers() {
            const users = await getAllUsers();
            const otherUsers = users.filter(user => user.id !== currentUser.id);
            
            // Display users
            const container = document.getElementById('network-users');
            container.innerHTML = '';
            
            if (otherUsers.length === 0) {
                container.innerHTML = '<p>No other users in the network yet.</p>';
                return;
            }
            
            for (const user of otherUsers) {
                const userElement = createUserElement(user);
                container.appendChild(userElement);
            }
        }

        // Load job categories
        async function loadCategories() {
            const categories = await getAllCategories();
            const select = document.getElementById('job-category');
            
            // Clear existing options except the first one
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Add categories to select
            for (const category of categories) {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            }
        }

        // Load currency settings
        async function loadCurrencySettings() {
            const currency = await getSetting('default-currency');
            if (currency) {
                document.getElementById('default-currency').value = currency;
            }
        }

        // Create job element for display
        function createJobElement(job, isOwner = false) {
            const now = new Date();
            const deadline = new Date(job.deadline);
            const daysLeft = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
            
            const jobElement = document.createElement('div');
            jobElement.className = 'job-card';
            
            let actionsHtml = '';
            if (isOwner) {
                // Owner actions
                actionsHtml = `
                    <button class="btn btn-sm btn-primary view-applications" data-job-id="${job.id}">
                        View Applications (${job.applications ? job.applications.length : 0})
                    </button>
                    <button class="btn btn-sm btn-danger delete-job" data-job-id="${job.id}">
                        Delete
                    </button>
                `;
            } else {
                // Non-owner actions
                actionsHtml = `
                    <button class="btn btn-sm btn-primary apply-job" data-job-id="${job.id}">
                        Apply Now
                    </button>
                    <button class="btn btn-sm btn-secondary report-job" data-job-id="${job.id}">
                        Report
                    </button>
                `;
            }
            
            jobElement.innerHTML = `
                <div class="job-header">
                    <h3 class="job-title">${job.title}</h3>
                    ${job.hasBlueTick ? '<span class="verified-badge">‚úì</span>' : ''}
                </div>
                <p class="job-company">${job.company} ${job.hasBlueTick ? '<span class="verified-badge">‚úì</span>' : ''}</p>
                <div class="job-meta">
                    <span class="job-meta-item"><i>üìç</i> ${job.location}</span>
                    <span class="job-meta-item"><i>üïí</i> ${daysLeft > 0 ? `${daysLeft} days left` : 'Expired'}</span>
                    ${job.salary ? `<span class="job-meta-item"><i>üí∞</i> ${job.salary}</span>` : ''}
                    <span class="job-meta-item"><i>üë•</i> ${job.positions} position(s)</span>
                </div>
                <p class="job-description">${job.description.length > 150 ? job.description.substring(0, 150) + '...' : job.description}</p>
                <div class="job-actions">
                    ${actionsHtml}
                    <button class="btn btn-sm btn-secondary view-details" data-job-id="${job.id}">
                        View Details
                    </button>
                </div>
            `;
            
            // Add event listeners to buttons
            jobElement.querySelector('.view-details').addEventListener('click', () => showJobDetails(job.id));
            
            if (isOwner) {
                jobElement.querySelector('.view-applications').addEventListener('click', () => showJobApplications(job.id));
                jobElement.querySelector('.delete-job').addEventListener('click', () => deleteJob(job.id));
            } else {
                jobElement.querySelector('.apply-job').addEventListener('click', () => showApplyJobModal(job.id));
                jobElement.querySelector('.report-job').addEventListener('click', () => showReportJobModal(job.id));
            }
            
            return jobElement;
        }

        // Create application element for display
        function createApplicationElement(application) {
            const appElement = document.createElement('div');
            appElement.className = 'job-card';
            
            let statusBadge = '';
            switch (application.status) {
                case 'pending':
                    statusBadge = '<span class="status-badge status-warning">Pending</span>';
                    break;
                case 'accepted':
                    statusBadge = '<span class="status-badge status-success">Accepted</span>';
                    break;
                case 'rejected':
                    statusBadge = '<span class="status-badge status-danger">Rejected</span>';
                    break;
                case 'interview':
                    statusBadge = '<span class="status-badge status-info">Interview Scheduled</span>';
                    break;
                default:
                    statusBadge = '<span class="status-badge">Unknown</span>';
            }
            
            appElement.innerHTML = `
                <div class="job-header">
                    <h3 class="job-title">${application.job.title}</h3>
                    ${application.job.hasBlueTick ? '<span class="verified-badge">‚úì</span>' : ''}
                </div>
                <p class="job-company">${application.job.company} ${application.job.hasBlueTick ? '<span class="verified-badge">‚úì</span>' : ''}</p>
                <div class="job-meta">
                    <span class="job-meta-item"><i>üìç</i> ${application.job.location}</span>
                    <span class="job-meta-item"><i>üïí</i> Applied on ${new Date(application.createdAt).toLocaleDateString()}</span>
                    <span class="job-meta-item">${statusBadge}</span>
                </div>
                <div class="job-actions">
                    <button class="btn btn-sm btn-primary view-application" data-application-id="${application.id}">
                        View Application
                    </button>
                    ${application.status === 'pending' ? 
                        `<button class="btn btn-sm btn-danger withdraw-application" data-application-id="${application.id}">
                            Withdraw
                        </button>` : ''}
                    ${application.status === 'interview' ? 
                        `<button class="btn btn-sm btn-success view-interview" data-application-id="${application.id}">
                            Interview Details
                        </button>` : ''}
                </div>
            `;
            
            // Add event listeners to buttons
            appElement.querySelector('.view-application').addEventListener('click', () => showApplicationDetails(application.id));
            
            if (application.status === 'pending') {
                appElement.querySelector('.withdraw-application').addEventListener('click', () => withdrawApplication(application.id));
            }
            
            if (application.status === 'interview') {
                appElement.querySelector('.view-interview').addEventListener('click', () => showInterviewDetails(application.id));
            }
            
            return appElement;
        }

        // Create user element for display
        function createUserElement(user) {
            const userElement = document.createElement('div');
            userElement.className = 'user-card';
            
            userElement.innerHTML = `
                <img src="${user.avatar || 'https://via.placeholder.com/40'}" alt="User Avatar" class="user-avatar-sm">
                <div class="user-info-sm">
                    <h4>${user.username || user.fullname} ${user.isAdmin ? 'üëë' : ''}</h4>
                    <p>${user.profession || 'No profession specified'}</p>
                </div>
                ${user.isOnline ? '<div class="online-dot"></div>' : ''}
            `;
            
            // Add click event to open chat
            userElement.addEventListener('click', () => openChat(user.id));
            
            return userElement;
        }

        // Show job details
        async function showJobDetails(jobId) {
            const job = await getJobById(jobId);
            if (!job) return;
            
            const now = new Date();
            const deadline = new Date(job.deadline);
            const daysLeft = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
            const isOwner = currentUser && job.posterId === currentUser.id;
            
            let detailsHtml = `
                <h2>${job.title}</h2>
                <p class="job-company">${job.company} ${job.hasBlueTick ? '<span class="verified-badge">‚úì</span>' : ''}</p>
                <div class="job-meta">
                    <span class="job-meta-item"><i>üìç</i> ${job.location}</span>
                    <span class="job-meta-item"><i>üïí</i> ${daysLeft > 0 ? `${daysLeft} days left` : 'Expired'}</span>
                    ${job.salary ? `<span class="job-meta-item"><i>üí∞</i> ${job.salary}</span>` : ''}
                    <span class="job-meta-item"><i>üë•</i> ${job.positions} position(s)</span>
                    <span class="job-meta-item"><i>üìÖ</i> Posted on ${new Date(job.createdAt).toLocaleDateString()}</span>
                </div>
                ${job.image ? `<img src="${job.image}" alt="Job Image" style="max-width: 100%; margin: 15px 0; border-radius: 8px;">` : ''}
                <h3>Job Description</h3>
                <p>${job.description}</p>
            `;
            
            if (isOwner) {
                detailsHtml += `
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary view-applications" data-job-id="${job.id}" style="margin-right: 10px;">
                            View Applications (${job.applications ? job.applications.length : 0})
                        </button>
                        <button class="btn btn-danger delete-job" data-job-id="${job.id}">
                            Delete Job
                        </button>
                    </div>
                `;
            } else if (currentUser) {
                detailsHtml += `
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary apply-job" data-job-id="${job.id}" style="margin-right: 10px;">
                            Apply Now
                        </button>
                        <button class="btn btn-secondary report-job" data-job-id="${job.id}">
                            Report Job
                        </button>
                    </div>
                `;
            }
            
            document.getElementById('job-details-content').innerHTML = detailsHtml;
            
            // Add event listeners to buttons
            if (isOwner) {
                document.querySelector('.view-applications').addEventListener('click', () => showJobApplications(job.id));
                document.querySelector('.delete-job').addEventListener('click', () => deleteJob(job.id));
            } else if (currentUser) {
                document.querySelector('.apply-job').addEventListener('click', () => showApplyJobModal(job.id));
                document.querySelector('.report-job').addEventListener('click', () => showReportJobModal(job.id));
            }
            
            showModal('job-details-modal');
        }

        // Show job applications
        async function showJobApplications(jobId) {
            const job = await getJobById(jobId);
            if (!job || !job.applications || job.applications.length === 0) {
                showAlert('No applications found for this job.', 'info');
                return;
            }
            
            const applications = await getAllApplications();
            const jobApplications = applications.filter(app => job.applications.includes(app.id));
            
            let applicationsHtml = `
                <h2>Applications for ${job.title}</h2>
                <p>Total applications: ${jobApplications.length}</p>
                <div class="applications-list" style="margin-top: 20px;">
            `;
            
            for (const app of jobApplications) {
                let statusBadge = '';
                switch (app.status) {
                    case 'pending':
                        statusBadge = '<span class="status-badge status-warning">Pending</span>';
                        break;
                    case 'accepted':
                        statusBadge = '<span class="status-badge status-success">Accepted</span>';
                        break;
                    case 'rejected':
                        statusBadge = '<span class="status-badge status-danger">Rejected</span>';
                        break;
                    case 'interview':
                        statusBadge = '<span class="status-badge status-info">Interview Scheduled</span>';
                        break;
                    default:
                        statusBadge = '<span class="status-badge">Unknown</span>';
                }
                
                applicationsHtml += `
                    <div class="application-item" style="border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3>${app.applicantName}</h3>
                            ${statusBadge}
                        </div>
                        <p>Email: ${app.applicantEmail}</p>
                        <p>Phone: ${app.applicantPhone}</p>
                        <p>Experience: ${app.applicantExperience} years</p>
                        <div style="margin-top: 10px; display: flex; gap: 10px;">
                            <button class="btn btn-sm btn-primary view-application" data-application-id="${app.id}">
                                View Application
                            </button>
                            ${app.status === 'pending' ? `
                                <button class="btn btn-sm btn-success accept-application" data-application-id="${app.id}">
                                    Accept
                                </button>
                                <button class="btn btn-sm btn-danger reject-application" data-application-id="${app.id}">
                                    Reject
                                </button>
                            ` : ''}
                            ${app.status === 'accepted' ? `
                                <button class="btn btn-sm btn-info schedule-interview" data-application-id="${app.id}">
                                    Schedule Interview
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            applicationsHtml += `</div>`;
            
            document.getElementById('job-details-content').innerHTML = applicationsHtml;
            
            // Add event listeners to buttons
            document.querySelectorAll('.view-application').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const applicationId = e.target.getAttribute('data-application-id');
                    showApplicationDetails(applicationId);
                });
            });
            
            document.querySelectorAll('.accept-application').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const applicationId = e.target.getAttribute('data-application-id');
                    await updateApplicationStatus(applicationId, 'accepted');
                    showJobApplications(jobId);
                });
            });
            
            document.querySelectorAll('.reject-application').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const applicationId = e.target.getAttribute('data-application-id');
                    await updateApplicationStatus(applicationId, 'rejected');
                    showJobApplications(jobId);
                });
            });
            
            document.querySelectorAll('.schedule-interview').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const applicationId = e.target.getAttribute('data-application-id');
                    showInterviewModal(applicationId);
                });
            });
            
            showModal('job-details-modal');
        }

        // Show application details
        async function showApplicationDetails(applicationId) {
            const application = await getApplicationById(applicationId);
            if (!application) return;
            
            const job = await getJobById(application.jobId);
            
            let detailsHtml = `
                <h2>Application Details</h2>
                ${job ? `<p>For position: <strong>${job.title}</strong> at <strong>${job.company}</strong></p>` : ''}
                <div style="display: flex; gap: 20px; margin-top: 20px;">
                    <div style="flex: 1;">
                        <img src="${application.applicantPortrait || 'https://via.placeholder.com/150'}" 
                             alt="Applicant Portrait" 
                             style="width: 150px; height: 150px; object-fit: cover; border-radius: 8px;">
                    </div>
                    <div style="flex: 2;">
                        <h3>${application.applicantName}</h3>
                        <p><strong>Email:</strong> ${application.applicantEmail}</p>
                        <p><strong>Phone:</strong> ${application.applicantPhone}</p>
                        <p><strong>Age:</strong> ${application.applicantAge}</p>
                        <p><strong>Gender:</strong> ${application.applicantGender}</p>
                        <p><strong>Location:</strong> ${application.applicantLocation}</p>
                        <p><strong>Experience:</strong> ${application.applicantExperience} years</p>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <h3>Qualifications</h3>
                    <p>${application.applicantQualifications}</p>
                </div>
                <div style="margin-top: 20px;">
                    <a href="${application.applicantCV}" 
                       class="btn btn-primary" 
                       target="_blank" 
                       download="CV_${application.applicantName.replace(/\s+/g, '_')}.pdf">
                        Download CV
                    </a>
                </div>
            `;
            
            document.getElementById('application-details-content').innerHTML = detailsHtml;
            showModal('application-details-modal');
        }

        // Show interview modal
        async function showInterviewModal(applicationId) {
            const application = await getApplicationById(applicationId);
            if (!application) return;
            
            // Set application ID
            document.getElementById('interview-application-id').value = applicationId;
            
            // Reset form
            document.getElementById('interview-form').reset();
            document.getElementById('interview-location-group').style.display = 'none';
            
            showModal('interview-modal');
        }

        // Schedule interview
        async function scheduleInterview(e) {
            e.preventDefault();
            
            const applicationId = document.getElementById('interview-application-id').value;
            const date = document.getElementById('interview-date').value;
            const time = document.getElementById('interview-time').value;
            const type = document.getElementById('interview-type').value;
            const location = document.getElementById('interview-location').value;
            const notes = document.getElementById('interview-notes').value;
            
            // Validate inputs
            if (!date || !time || !type) {
                showAlert('Please fill in all required fields.', 'danger');
                return;
            }
            
            if (type === 'in-person' && !location) {
                showAlert('Please specify interview location for in-person interviews.', 'danger');
                return;
            }
            
            // Update application status
            await updateApplicationStatus(applicationId, 'interview');
            
            // Create interview record
            const application = await getApplicationById(applicationId);
            const job = await getJobById(application.jobId);
            
            const interview = {
                id: `interview-${Date.now()}-${applicationId}`,
                applicationId: applicationId,
                jobId: application.jobId,
                applicantId: application.applicantId,
                interviewerId: currentUser.id,
                date: date,
                time: time,
                type: type,
                location: location,
                notes: notes,
                status: 'scheduled',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            await addInterview(interview);
            
            // Notify applicant
            const applicant = await getUserById(application.applicantId);
            if (applicant && applicant.peerId && peerConnections[applicant.peerId]) {
                peerConnections[applicant.peerId].send({
                    type: 'interview',
                    interview: interview,
                    job: job
                });
            }
            
            // Hide modal
            hideModal('interview-modal');
            
            showAlert('Interview scheduled successfully!', 'success');
            
            // Reload applications
            await loadUserApplications();
        }

        // Show interview details
        async function showInterviewDetails(applicationId) {
            const interview = await getInterviewByApplicationId(applicationId);
            if (!interview) return;
            
            const application = await getApplicationById(applicationId);
            const job = await getJobById(application.jobId);
            const interviewer = await getUserById(interview.interviewerId);
            
            let detailsHtml = `
                <h2>Interview Details</h2>
                ${job ? `<p>For position: <strong>${job.title}</strong> at <strong>${job.company}</strong></p>` : ''}
                <div style="margin-top: 20px;">
                    <p><strong>Date:</strong> ${new Date(interview.date).toLocaleDateString()}</p>
                    <p><strong>Time:</strong> ${interview.time}</p>
                    <p><strong>Type:</strong> ${interview.type === 'online' ? 'Online (Video Call)' : 'In-Person'}</p>
                    ${interview.type === 'in-person' ? `<p><strong>Location:</strong> ${interview.location}</p>` : ''}
                    ${interview.notes ? `<p><strong>Notes:</strong> ${interview.notes}</p>` : ''}
                    <p><strong>Status:</strong> ${interview.status}</p>
                    ${interviewer ? `<p><strong>Interviewer:</strong> ${interviewer.fullname}</p>` : ''}
                </div>
            `;
            
            if (interview.type === 'online' && interview.status === 'scheduled') {
                const interviewDate = new Date(`${interview.date}T${interview.time}`);
                const now = new Date();
                
                if (now >= interviewDate) {
                    detailsHtml += `
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary join-interview" data-interview-id="${interview.id}">
                                Join Interview
                            </button>
                        </div>
                    `;
                } else {
                    const timeLeft = interviewDate - now;
                    const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
                    const minutesLeft = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    
                    detailsHtml += `
                        <div style="margin-top: 20px;">
                            <p>Interview will start in ${hoursLeft > 0 ? `${hoursLeft} hours and ` : ''}${minutesLeft} minutes.</p>
                        </div>
                    `;
                }
            }
            
            document.getElementById('application-details-content').innerHTML = detailsHtml;
            
            // Add event listener to join button
            if (document.querySelector('.join-interview')) {
                document.querySelector('.join-interview').addEventListener('click', () => joinInterview(interview.id));
            }
            
            showModal('application-details-modal');
        }

        // Join interview
        async function joinInterview(interviewId) {
            const interview = await getInterviewById(interviewId);
            if (!interview) return;
            
            const interviewer = await getUserById(interview.interviewerId);
            if (!interviewer || !interviewer.peerId) {
                showAlert('Interviewer is not available at the moment.', 'danger');
                return;
            }
            
            // Store current interview
            currentInterview = {
                id: interview.id,
                interviewerId: interviewer.peerId,
                interviewerName: interviewer.fullname
            };
            
            // Get local media stream
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('local-video').srcObject = localStream;
                
                // Call interviewer
                const call = peer.call(interviewer.peerId, localStream);
                
                call.on('stream', (remoteStream) => {
                    document.getElementById('remote-video').srcObject = remoteStream;
                    document.getElementById('interview-room').style.display = 'flex';
                    document.getElementById('remote-video-label').textContent = interviewer.fullname;
                });
                
                call.on('close', () => {
                    endInterview();
                });
                
                // Store call reference
                currentInterview.call = call;
            } catch (err) {
                console.error('Error accessing media devices:', err);
                showAlert('Error accessing camera/microphone. Please check permissions.', 'danger');
            }
        }

        // End interview
        function endInterview() {
            if (currentInterview && currentInterview.call) {
                currentInterview.call.close();
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            document.getElementById('interview-room').style.display = 'none';
            document.getElementById('local-video').srcObject = null;
            document.getElementById('remote-video').srcObject = null;
            currentInterview = null;
        }

        // Toggle audio mute
        function toggleAudio() {
            if (!localStream) return;
            
            const audioTracks = localStream.getAudioTracks();
            if (audioTracks.length === 0) return;
            
            const isMuted = !audioTracks[0].enabled;
            audioTracks[0].enabled = isMuted;
            
            document.getElementById('mute-audio').textContent = isMuted ? 'üîá' : 'üîä';
        }

        // Toggle video mute
        function toggleVideo() {
            if (!localStream) return;
            
            const videoTracks = localStream.getVideoTracks();
            if (videoTracks.length === 0) return;
            
            const isMuted = !videoTracks[0].enabled;
            videoTracks[0].enabled = isMuted;
            
            document.getElementById('mute-video').textContent = isMuted ? 'üì∑' : 'üìπ';
        }

        // Update application status
        async function updateApplicationStatus(applicationId, status) {
            const application = await getApplicationById(applicationId);
            if (!application) return;
            
            application.status = status;
            application.updatedAt = new Date().toISOString();
            await updateApplication(application);
            
            // Notify applicant if status changed
            if (application.applicantId !== currentUser.id) {
                const applicant = await getUserById(application.applicantId);
                if (applicant && applicant.peerId && peerConnections[applicant.peerId]) {
                    peerConnections[applicant.peerId].send({
                        type: 'application',
                        application: application
                    });
                }
            }
            
            return application;
        }

        // Withdraw application
        async function withdrawApplication(applicationId) {
            const application = await getApplicationById(applicationId);
            if (!application) return;
            
            // Update application status
            application.status = 'withdrawn';
            application.updatedAt = new Date().toISOString();
            await updateApplication(application);
            
            // Notify job poster
            const job = await getJobById(application.jobId);
            if (job) {
                const poster = await getUserById(job.posterId);
                if (poster && poster.peerId && peerConnections[poster.peerId]) {
                    peerConnections[poster.peerId].send({
                        type: 'application',
                        application: application
                    });
                }
            }
            
            showAlert('Application withdrawn successfully!', 'success');
            
            // Reload applications
            await loadUserApplications();
        }

        // Delete job
        async function deleteJob(jobId) {
            if (!confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
                return;
            }
            
            const job = await getJobById(jobId);
            if (!job) return;
            
            // Remove job from database
            await deleteJobById(jobId);
            
            // Remove job from user's job posts
            if (currentUser && currentUser.jobPosts) {
                currentUser.jobPosts = currentUser.jobPosts.filter(id => id !== jobId);
                await updateUser(currentUser);
            }
            
            // Broadcast job deletion
            for (const peerId in peerConnections) {
                peerConnections[peerId].send({
                    type: 'job-deleted',
                    jobId: jobId
                });
            }
            
            showAlert('Job deleted successfully!', 'success');
            
            // Reload jobs
            await loadRecentJobs();
            await loadAllJobs();
            await loadUserJobs();
            
            // Close modal if open
            hideModal('job-details-modal');
        }

        // Open chat with user
        async function openChat(userId) {
            if (!currentUser) return;
            
            const user = await getUserById(userId);
            if (!user) return;
            
            // Set active chat
            activeChat = user.id;
            
            // Update chat UI
            document.getElementById('chat-title').textContent = `Chat with ${user.username || user.fullname}`;
            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('chat-input').value = '';
            document.getElementById('chat-container').style.display = 'flex';
            
            // Load chat history
            await loadChatMessages(userId);
            
            // Connect to user if not already connected
            if (!peerConnections[user.peerId] && user.peerId && user.peerId !== peer.id) {
                const conn = peer.connect(user.peerId);
                setupDataConnection(conn);
            }
        }

        // Close chat
        function closeChat() {
            activeChat = null;
            document.getElementById('chat-container').style.display = 'none';
        }

        // Load chat messages
        async function loadChatMessages(userId) {
            const messages = await getMessagesBetweenUsers(currentUser.id, userId);
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';
            
            for (const message of messages) {
                displayMessage(message, message.senderId === currentUser.id ? currentUser.id : userId, message.senderId === currentUser.id);
            }
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Display message in chat
        function displayMessage(message, userId, isSender) {
            const messagesContainer = document.getElementById('chat-messages');
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isSender ? 'message-sent' : 'message-received'}`;
            
            messageElement.innerHTML = `
                <div class="message-sender">${isSender ? 'You' : (message.senderName || 'User')}</div>
                <div class="message-content">${message.content}</div>
                <div class="message-time">${new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
            `;
            
            messagesContainer.appendChild(messageElement);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Send message
        async function sendMessage() {
            if (!activeChat || !currentUser) return;
            
            const input = document.getElementById('chat-input');
            const content = input.value.trim();
            
            if (!content) return;
            
            // Create message object
            const message = {
                id: `message-${Date.now()}-${currentUser.id}-${activeChat}`,
                senderId: currentUser.id,
                senderName: currentUser.username || currentUser.fullname,
                receiverId: activeChat,
                content: content,
                timestamp: new Date().toISOString(),
                isRead: false
            };
            
            // Save message to database
            await addMessage(message);
            
            // Display message
            displayMessage(message, currentUser.id, true);
            
            // Clear input
            input.value = '';
            
            // Send message to recipient if connected
            const recipient = await getUserById(activeChat);
            if (recipient && recipient.peerId && peerConnections[recipient.peerId]) {
                peerConnections[recipient.peerId].send({
                    type: 'message',
                    message: message,
                    senderName: currentUser.username || currentUser.fullname
                });
            }
        }

        // Search jobs
        async function searchJobs() {
            const query = document.getElementById('job-search').value.toLowerCase();
            if (!query) {
                await loadAllJobs();
                return;
            }
            
            const jobs = await getAllJobs();
            const now = new Date();
            
            // Filter jobs by search query
            const filteredJobs = jobs.filter(job => {
                const deadline = new Date(job.deadline);
                const matchesQuery = job.title.toLowerCase().includes(query) || 
                                    job.company.toLowerCase().includes(query) || 
                                    job.description.toLowerCase().includes(query) || 
                                    job.location.toLowerCase().includes(query);
                
                return matchesQuery && deadline > now && !job.isUnderReview;
            });
            
            // Display filtered jobs
            const container = document.getElementById('all-jobs');
            container.innerHTML = '';
            
            if (filteredJobs.length === 0) {
                container.innerHTML = '<p>No jobs found matching your search.</p>';
                return;
            }
            
            for (const job of filteredJobs) {
                const jobElement = createJobElement(job);
                container.appendChild(jobElement);
            }
        }

        // Initialize network (for first admin)
        async function initializeNetwork() {
            if (!isAdmin) return;
            
            // Get all data from local DB
            const users = await getAllUsers();
            const jobs = await getAllJobs();
            const applications = await getAllApplications();
            
            // Share data with connected peers
            for (const peerId in peerConnections) {
                // Send users
                for (const user of users) {
                    peerConnections[peerId].send({
                        type: 'user',
                        user: user
                    });
                }
                
                // Send jobs
                for (const job of jobs) {
                    peerConnections[peerId].send({
                        type: 'job',
                        job: job
                    });
                }
                
                // Send applications
                for (const application of applications) {
                    peerConnections[peerId].send({
                        type: 'application',
                        application: application
                    });
                }
            }
        }

        // Request location permission
        function requestLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        if (currentUser) {
                            currentUser.location = `${position.coords.latitude}, ${position.coords.longitude}`;
                            updateUser(currentUser);
                        }
                    },
                    (error) => {
                        console.error('Error getting location:', error);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            }
        }

        // Get current position (with promise)
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(resolve, reject);
                } else {
                    reject(new Error('Geolocation is not supported by this browser.'));
                }
            });
        }

        // Calculate distance between two coordinates in km
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the earth in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c; // Distance in km
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // Database operations
        async function addUser(user) {
            const tx = db.transaction('users', 'readwrite');
            const store = tx.objectStore('users');
            await store.put(user);
            await tx.done;
        }

        async function getUserById(id) {
            const tx = db.transaction('users', 'readonly');
            const store = tx.objectStore('users');
            return await store.get(id);
        }

        async function updateUser(user) {
            const tx = db.transaction('users', 'readwrite');
            const store = tx.objectStore('users');
            await store.put(user);
            await tx.done;
        }

        async function getAllUsers() {
            const tx = db.transaction('users', 'readonly');
            const store = tx.objectStore('users');
            return await store.getAll();
        }

        async function getUsersCount() {
            const tx = db.transaction('users', 'readonly');
            const store = tx.objectStore('users');
            return await store.count();
        }

        async function getActiveUsersCount() {
            const tx = db.transaction('users', 'readonly');
            const store = tx.objectStore('users');
            const index = store.index('isOnline');
            return await index.count(IDBKeyRange.only(true));
        }

        async function getBannedUsersCount() {
            const tx = db.transaction('users', 'readonly');
            const store = tx.objectStore('users');
            const index = store.index('isBanned');
            return await index.count(IDBKeyRange.only(true));
        }

        async function addJob(job) {
            const tx = db.transaction('jobs', 'readwrite');
            const store = tx.objectStore('jobs');
            await store.put(job);
            await tx.done;
        }

        async function getJobById(id) {
            const tx = db.transaction('jobs', 'readonly');
            const store = tx.objectStore('jobs');
            return await store.get(id);
        }

        async function updateJob(job) {
            const tx = db.transaction('jobs', 'readwrite');
            const store = tx.objectStore('jobs');
            await store.put(job);
            await tx.done;
        }

        async function deleteJobById(id) {
            const tx = db.transaction('jobs', 'readwrite');
            const store = tx.objectStore('jobs');
            await store.delete(id);
            await tx.done;
        }

        async function getAllJobs() {
            const tx = db.transaction('jobs', 'readonly');
            const store = tx.objectStore('jobs');
            return await store.getAll();
        }

        async function getJobsCount() {
            const tx = db.transaction('jobs', 'readonly');
            const store = tx.objectStore('jobs');
            return await store.count();
        }

        async function getActiveJobsCount() {
            const now = new Date();
            const jobs = await getAllJobs();
            return jobs.filter(job => {
                const deadline = new Date(job.deadline);
                return deadline > now && !job.isUnderReview;
            }).length;
        }

        async function addApplication(application) {
            const tx = db.transaction('applications', 'readwrite');
            const store = tx.objectStore('applications');
            await store.put(application);
            await tx.done;
        }

        async function getApplicationById(id) {
            const tx = db.transaction('applications', 'readonly');
            const store = tx.objectStore('applications');
            return await store.get(id);
        }

        async function updateApplication(application) {
            const tx = db.transaction('applications', 'readwrite');
            const store = tx.objectStore('applications');
            await store.put(application);
            await tx.done;
        }

        async function getAllApplications() {
            const tx = db.transaction('applications', 'readonly');
            const store = tx.objectStore('applications');
            return await store.getAll();
        }

        async function addReport(report) {
            const tx = db.transaction('reports', 'readwrite');
            const store = tx.objectStore('reports');
            await store.put(report);
            await tx.done;
        }

        async function getReportById(id) {
            const tx = db.transaction('reports', 'readonly');
            const store = tx.objectStore('reports');
            return await store.get(id);
        }

        async function updateReport(report) {
            const tx = db.transaction('reports', 'readwrite');
            const store = tx.objectStore('reports');
            await store.put(report);
            await tx.done;
        }

        async function getAllReports() {
            const tx = db.transaction('reports', 'readonly');
            const store = tx.objectStore('reports');
            return await store.getAll();
        }

        async function getPendingReportsCount() {
            const tx = db.transaction('reports', 'readonly');
            const store = tx.objectStore('reports');
            const index = store.index('status');
            return await index.count(IDBKeyRange.only('pending'));
        }

        async function addMessage(message) {
            const tx = db.transaction('messages', 'readwrite');
            const store = tx.objectStore('messages');
            await store.put(message);
            await tx.done;
        }

        async function getMessagesBetweenUsers(userId1, userId2) {
            const tx = db.transaction('messages', 'readonly');
            const store = tx.objectStore('messages');
            const allMessages = await store.getAll();
            
            return allMessages.filter(message => 
                (message.senderId === userId1 && message.receiverId === userId2) ||
                (message.senderId === userId2 && message.receiverId === userId1)
            ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        }

        async function addInterview(interview) {
            const tx = db.transaction('interviews', 'readwrite');
            const store = tx.objectStore('interviews');
            await store.put(interview);
            await tx.done;
        }

        async function getInterviewById(id) {
            const tx = db.transaction('interviews', 'readonly');
            const store = tx.objectStore('interviews');
            return await store.get(id);
        }

        async function getInterviewByApplicationId(applicationId) {
            const tx = db.transaction('interviews', 'readonly');
            const store = tx.objectStore('interviews');
            const index = store.index('applicationId');
            return await index.get(applicationId);
        }

        async function addCompany(company) {
            const tx = db.transaction('companies', 'readwrite');
            const store = tx.objectStore('companies');
            await store.put(company);
            await tx.done;
        }

        async function getUserCompany(userId) {
            const tx = db.transaction('companies', 'readonly');
            const store = tx.objectStore('companies');
            const index = store.index('ownerId');
            return await index.get(userId);
        }

        async function getAllCategories() {
            const tx = db.transaction('categories', 'readonly');
            const store = tx.objectStore('categories');
            return await store.getAll();
        }

        async function setSetting(key, value) {
            const tx = db.transaction('settings', 'readwrite');
            const store = tx.objectStore('settings');
            await store.put({ id: key, value: value });
            await tx.done;
        }

        async function getSetting(key) {
            const tx = db.transaction('settings', 'readonly');
            const store = tx.objectStore('settings');
            const setting = await store.get(key);
            return setting ? setting.value : null;
        }

        async function addNotification(notification) {
            const tx = db.transaction('notifications', 'readwrite');
            const store = tx.objectStore('notifications');
            await store.put(notification);
            await tx.done;
        }

        async function addActivity(activity) {
            const tx = db.transaction('activity', 'readwrite');
            const store = tx.objectStore('activity');
            await store.put(activity);
            await tx.done;
        }

        async function addOrUpdateUser(user) {
            const existingUser = await getUserById(user.id);
            if (existingUser) {
                // Merge existing data with new data
                const mergedUser = { ...existingUser, ...user };
                await updateUser(mergedUser);
            } else {
                await addUser(user);
            }
        }

        async function addOrUpdateJob(job) {
            const existingJob = await getJobById(job.id);
            if (existingJob) {
                // Merge existing data with new data
                const mergedJob = { ...existingJob, ...job };
                await updateJob(mergedJob);
            } else {
                await addJob(job);
            }
        }

        async function addOrUpdateApplication(application) {
            const existingApp = await getApplicationById(application.id);
            if (existingApp) {
                // Merge existing data with new data
                const mergedApp = { ...existingApp, ...application };
                await updateApplication(mergedApp);
            } else {
                await addApplication(application);
            }
        }
    </script>
</body>
</html>
